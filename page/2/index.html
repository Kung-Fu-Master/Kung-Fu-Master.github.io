<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.1" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://kung-fu-master.github.io/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Kung-Fu-Master">
<meta name="twitter:card" content="summary"><title>Hexo</title><link ref="canonical" href="https://kung-fu-master.github.io/page/2/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-feather-alt"></i></span><span class="header-nav-menu-item__text">文章</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/categories/"><span class="header-nav-submenu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-submenu-item__text">分类</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/archives/"><span class="header-nav-submenu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-submenu-item__text">归档</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/tags/"><span class="header-nav-submenu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-submenu-item__text">标签</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hexo</div><div class="header-banner-info__subtitle"></div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/technologies/security/algorithm_security/">algorithm security</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.7k</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Certificates-Encryption-Algorithm"   >
          <a href="#Certificates-Encryption-Algorithm" class="heading-link"><i class="fas fa-link"></i></a>Certificates Encryption Algorithm</h1>
      
        <h2 id="RSA非对称加密算法"   >
          <a href="#RSA非对称加密算法" class="heading-link"><i class="fas fa-link"></i></a>RSA非对称加密算法</h2>
      <p>RSA(Rivest-Shamir-Adleman)</p>
<blockquote>
<p>RSA是1977年由罗纳德·李维斯特（Ron Rivest）、阿迪·萨莫尔（Adi Shamir）和伦纳德·阿德曼（Leonard Adleman）一起提出的。当时他们三人都在麻省理工学院工作。RSA就是他们三人姓氏开头字母拼在一起组成的  </p>
</blockquote>
<p>非对称加密，公钥加密，私钥解密，反之亦然。由于需要大数的乘幂求模等算法，运行速度慢，不易于硬件实现。</p>
<p>通常私钥长度有512bit，1024bit，2048bit，4096bit，长度越长，越安全，但是生成密钥越慢，加解密也越耗时。</p>
<p>既然是加密，那肯定是不希望别人知道我的消息，所以只有我才能解密，所以可得出公钥负责加密，私钥负责解密；</p>
<p>同理，既然是签名，那肯定是不希望有人冒充我发消息，只有我才能发布这个签名，所以可得出私钥负责签名，公钥负责验证。</p>
<blockquote>
<p>非对称加密算法实现机密信息交换的基本过程是：甲方生成一对密钥并将其中的一把作为公用密钥向其它方公开(用CA private key签名得到甲方证书)；用CA的public key解密得到该公用密钥的乙方使用该密钥对机密信息进行加密后再发送给甲方；甲方再用自己保存的另一把专用密钥对加密后的信息进行解密来获取信息.</p>
</blockquote>

        <h2 id="AES对称加密算法"   >
          <a href="#AES对称加密算法" class="heading-link"><i class="fas fa-link"></i></a>AES对称加密算法</h2>
      <p>AES,高级加密标准（Advanced Encryption Standard，缩写：AES）  </p>
<p>对称加密，密钥最长只有256个bit，执行速度快，易于硬件实现。由于是对称加密，密钥需要在传输前通讯双方获知。</p>
<p>基于以上特点，通常使用RSA来首先传输AES的密钥给对方，然后再使用AES来进行加密通讯。</p>
<p>AES128和AES256主要区别是密钥长度不同（分别是128bits,256bits)、加密处理轮数不同（分别是10轮，14轮），后者强度高于前者。当前AES是较为安全的公认的对称加密算法。  </p>
<p>现代密码学分为对称加密与非对称加密（公钥加密），代表算法分别有DES(现在发展为3DES）、AES与RSA等。非对称加密算法的资源消耗大于对称加密。一般是进行混合加密处理，例如使用RSA进行密钥分发、协商，使用AES进行业务数据的加解密。  </p>

        <h1 id="Signature-Algorithm"   >
          <a href="#Signature-Algorithm" class="heading-link"><i class="fas fa-link"></i></a>Signature Algorithm</h1>
      
        <h2 id="什么是SHA算法"   >
          <a href="#什么是SHA算法" class="heading-link"><i class="fas fa-link"></i></a>什么是SHA算法</h2>
      <blockquote>
<p>SHA的全称是“Secure Hash Algorithm”，中文翻译为：安全哈希算法，是由美国NSA和NIST两个组织共同发布的一系列密码散列函数，经历了SHA-0，SHA-1，SHA-2，SHA-3系列发展.</p>
</blockquote>

        <h3 id="什么是SHA-256算法"   >
          <a href="#什么是SHA-256算法" class="heading-link"><i class="fas fa-link"></i></a>什么是SHA-256算法</h3>
      <blockquote>
<p>SHA256算法属于SHA-2系列，SHA-256对于任意长度的消息，都会产生一个256bit长的哈希值，称作消息摘要. 这个摘要相当于是个长度为32个字节的数组，通常用一个长度为64的十六进制字符串来表示.</p>
</blockquote>

        <h3 id="把消息转换为位字符串"   >
          <a href="#把消息转换为位字符串" class="heading-link"><i class="fas fa-link"></i></a>把消息转换为位字符串</h3>
      <p>SHA-256算法是按照位作为输入，所以进行计算前必须把原始消息（比如字符串、文件等）转换成位字符串。<br>比如，对字符串“abc”产生消息摘要，‘a’=97 ‘b’=98 ‘c’=99，先转换成24位的字符串：</p>
<figure class="highlight basic"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">01100001 </span><span class="number">01100010</span> <span class="number">01100011</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="对转换得到的位字符串进行补位操作"   >
          <a href="#对转换得到的位字符串进行补位操作" class="heading-link"><i class="fas fa-link"></i></a>对转换得到的位字符串进行补位操作</h3>
      
        <h3 id="消息扩展、分组处理"   >
          <a href="#消息扩展、分组处理" class="heading-link"><i class="fas fa-link"></i></a>消息扩展、分组处理</h3>
      
        <h3 id="使用的常量和函数"   >
          <a href="#使用的常量和函数" class="heading-link"><i class="fas fa-link"></i></a>使用的常量和函数</h3>
      
        <h3 id="计算消息摘要"   >
          <a href="#计算消息摘要" class="heading-link"><i class="fas fa-link"></i></a>计算消息摘要</h3>
      
        <h3 id="SHA-256安全性分析"   >
          <a href="#SHA-256安全性分析" class="heading-link"><i class="fas fa-link"></i></a>SHA-256安全性分析</h3>
      <p>Hash函数的安全性很大程度上取决于抗强碰撞的能力，即攻击者找出两个消息M和Mt，M≠Mt，使得H(M)=HMt  ,因此，评价一个Hash函数的安全性，就是看攻击者在现有的条件下，是否可以找到该函数的一对碰撞。目前已有的对Hash函数攻击的方法包括生日攻击、彩虹表攻击、差分攻击等。</p>
<ul>
<li>生日攻击：生日攻击是一种可用于攻击任何类型函数Hash函数的攻击方法。从攻击原理上看，它没有利用Hash函数的结构和任何代数弱性质，只依赖与Hash值的长度。因此，<strong>抵御生日攻击最有效的方法是Hash值必须有足够的长度</strong>。</li>
<li>差分攻击：差分攻击是目前破译迭代Hash函数最有效的手法之一，其基本方法是利用明文的输入差值对输出差值的影响，运用差分的高概率的继承或者消除来产生最终的相同输出。</li>
</ul>
<p>用于消息唯一性和数据完整性验证的Hash函数，其安全性依赖于函数本身的属性和对抗碰撞的抵抗。Hash函数的算法结构特点和Hash值的长度是决定函数碰撞性的而主要因素，Hash值越长，越能抵御生日攻击。<strong>SHA-256有256比特Hash值，MD5和SHA-1分别有128和160比特的Hash值。</strong>因此，SHA-256比MD5和SHA-1能抵抗生日攻击。通过对Chabaud-Joux攻击SHA-256的分析，找到了SHA-256的一个部分碰撞，其复杂度为2^66，但无法找到SHA-256的一个整体碰撞，因此SHA-256算法也能抵御现有的差分攻击。由此可见，在抵御生日攻击和抵御已知差分攻击方面，SHA-256算法比现在广泛使用的MD5和SHA-1等更具安全性。</p>

        <h3 id="比特币为什么选择SHA-256算法"   >
          <a href="#比特币为什么选择SHA-256算法" class="heading-link"><i class="fas fa-link"></i></a>比特币为什么选择SHA-256算法</h3>
      <blockquote>
<p>SHA-256属于SHA-2系列，像之前的SHA0，SHA1都被证明是可以破解的，目前SHA2以及SHA3尚未被证实可以破解，至少目前来说是最安全的算法之一.<br>未来即使使用量子计算机挖比特币，也无非是速度更快一点，比特币有难度调整机制，可以通过调整难度来对抗量子计算机，还可以通过升级算法到SHA-3系列来增加挖矿的难度.<br>中本聪在设计比特币时，之所以选择SHA256，就是看中了SHA256的安全性，只要输入的数据有微小的区别，算出的结果就有天壤之别.</p>
</blockquote>

        <h1 id="AES-GCM加密算法"   >
          <a href="#AES-GCM加密算法" class="heading-link"><i class="fas fa-link"></i></a>AES-GCM加密算法</h1>
      
        <h1 id="查看系统支持的密码列表"   >
          <a href="#查看系统支持的密码列表" class="heading-link"><i class="fas fa-link"></i></a>查看系统支持的密码列表</h1>
      <p><strong>列出当前系统所支持的密码套件列表</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl ciphers -V <span class="string">'ALL:COMPLEMENTOFALL'</span></span></span><br></pre></td></tr></table></div></figure>
<p><strong>测试某个服务器是否支持特定的密码套件：</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl s_client -cipher <span class="string">"ECDHE-RSA-AES128-SHA"</span> -connect www.qq.com:443 -tls1_1</span></span><br></pre></td></tr></table></div></figure>
<p>参数说明: </p>
<ul>
<li>-cipher 参数表示本次连接支持的密码套件</li>
<li>-connect 表示连接服务器的 443 端口</li>
<li>-tls1_1 表示客户端最高支持的 TLS/SSL 版本是 TLS v1.1</li>
</ul>
<p>TLS deployment, viw version etc.<span class="exturl"><a class="exturl__link"   href="https://wiki.mozilla.org/Security/Server_Side_TLS"  target="_blank" rel="noopener">Security/Server Side TLS</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/technologies/security/cfssl/">cfssl</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">2.2k</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="Kubernetes-证书"   >
          <a href="#Kubernetes-证书" class="heading-link"><i class="fas fa-link"></i></a>Kubernetes 证书</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">使用的证书</th>
</tr>
</thead>
<tbody><tr>
<td align="center">etcd</td>
<td align="center">ca.pem, server.pem, server-key.pem</td>
</tr>
<tr>
<td align="center">kube-apiserver</td>
<td align="center">ca.pem, server.pem, server-key.pem</td>
</tr>
<tr>
<td align="center">kubelet</td>
<td align="center">ca.pem, ca-key.pem</td>
</tr>
<tr>
<td align="center">kube-proxy</td>
<td align="center">ca.pem, kube-proxy.pem, kube-proxy-key.pem</td>
</tr>
<tr>
<td align="center">kubectl</td>
<td align="center">ca.pem, admin.pem, admin-key.pem</td>
</tr>
</tbody></table></div>

        <h2 id="cfssl"   >
          <a href="#cfssl" class="heading-link"><i class="fas fa-link"></i></a>cfssl</h2>
      <p>cfssl用来生成证书比openssl要简单直观些</p>

        <h2 id="cfssl安装"   >
          <a href="#cfssl安装" class="heading-link"><i class="fas fa-link"></i></a>cfssl安装</h2>
      <p>安装cfssl相关的三个工具: </p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 生成证书</span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line">// 用于将json文本导入生成证书</span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line">// 查看证书相关信息</span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv cfssl_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv cfssljson_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssljson</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv cfssl-certinfo_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl-certinfo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cfssl --<span class="built_in">help</span></span></span><br></pre></td></tr></table></div></figure>


        <h2 id="cfssl-生成证书"   >
          <a href="#cfssl-生成证书" class="heading-link"><i class="fas fa-link"></i></a>cfssl 生成证书</h2>
      <p>生成证书模板</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl print-defaults config &gt; config.json</span><br><span class="line">&#123;</span><br><span class="line">    "signing": &#123;</span><br><span class="line">        "default": &#123;</span><br><span class="line">            "expiry": "168h"</span><br><span class="line">        &#125;,</span><br><span class="line">        "profiles": &#123;</span><br><span class="line">            "www": &#123;</span><br><span class="line">                "expiry": "8760h",</span><br><span class="line">                "usages": [</span><br><span class="line">                    "signing",</span><br><span class="line">                    "key encipherment",</span><br><span class="line">                    "server auth"</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            "client": &#123;</span><br><span class="line">                "expiry": "8760h",</span><br><span class="line">                "usages": [</span><br><span class="line">                    "signing",</span><br><span class="line">                    "key encipherment",</span><br><span class="line">                    "client auth"</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>生成证书请求模板</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl print-defaults csr &gt; csr.json</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "example.net",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "example.net",</span><br><span class="line">        "www.example.net"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "ecdsa",</span><br><span class="line">        "size": 256</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "US",</span><br><span class="line">            "L": "CA",</span><br><span class="line">            "ST": "San Francisco"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="k8s生成组件证书实例"   >
          <a href="#k8s生成组件证书实例" class="heading-link"><i class="fas fa-link"></i></a>k8s生成组件证书实例</h2>
      <p>所有k8s证书,配置,安装包都放到/opt/kubernetes/目录下</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;ssl,cfg,bin&#125;</span><br><span class="line">ls /opt/kubernetes/</span><br><span class="line">bin/  cfg/  ssl/</span><br></pre></td></tr></table></div></figure>


        <h3 id="1-生成ca-key-pem私匙和ca-pem证书"   >
          <a href="#1-生成ca-key-pem私匙和ca-pem证书" class="heading-link"><i class="fas fa-link"></i></a>1. 生成ca-key.pem私匙和ca.pem证书</h3>
      <figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "signing": &#123;</span><br><span class="line">        "default": &#123;</span><br><span class="line">            "expiry": "87600h"</span><br><span class="line">        &#125;,</span><br><span class="line">        "profiles": &#123;</span><br><span class="line">            "kubernetes": &#123;</span><br><span class="line">                "expiry": "87600h",</span><br><span class="line">                "usages": [</span><br><span class="line">                    "signing",</span><br><span class="line">                    "key encipherment",</span><br><span class="line">                    "server auth"</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "kubernetes",</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",			// 注意是algo而不是also</span><br><span class="line">        "size": 3072</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",			// 哪个国家的可以随便写</span><br><span class="line">            "L": "Beijing",		// 地点随便写</span><br><span class="line">            "ST": "Beijing",	// 地点随便写</span><br><span class="line">            "O": "k8s",			// 用户组, 固定的， 不能随便写</span><br><span class="line">            "OU": "System"		// 用户, 固定的，不能随便写</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>生成ca.pem和ca-key.pem</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// -bare ca 表示生成以ca开头的证书和key</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">ls ca*</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-生成server端证书和key-用于k8s的etcd和kube-apiserver"   >
          <a href="#2-生成server端证书和key-用于k8s的etcd和kube-apiserver" class="heading-link"><i class="fas fa-link"></i></a>2. 生成server端证书和key, 用于k8s的etcd和kube-apiserver</h3>
      <figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "kubernetes",</span><br><span class="line">    "hosts": [			// 包含了哪些机器IP和域名需要此server端证书</span><br><span class="line">        "127.0.0.1",</span><br><span class="line">        "10.239.140.133",		// 要使用改证书的etcd或其他服务部署所在节点IP地址或域名</span><br><span class="line">        "10.239.131.206",</span><br><span class="line">        "10.239.141.145",</span><br><span class="line">        "10.239.141.194",</span><br><span class="line">        "kubernetes.default",</span><br><span class="line">        "kubernetes.default.svc",</span><br><span class="line">        "kubernetes.default.svc.cluster",</span><br><span class="line">        "kubernetes.default.svc.cluster.local"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 3072</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "Beijing",</span><br><span class="line">            "ST": "Beijing",</span><br><span class="line">            "O": "k8s",			//和下面一起代表了用户和组去请求集群</span><br><span class="line">            "OU": "System"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>生成server端证书</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// -bare server 表示生成以server开头的证书和key</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line">ls server*</span><br><span class="line">server.csr  server-csr.json  server-key.pem  server.pem</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-生成admin证书-集群管理员通过证书访问集群"   >
          <a href="#3-生成admin证书-集群管理员通过证书访问集群" class="heading-link"><i class="fas fa-link"></i></a>3. 生成admin证书, 集群管理员通过证书访问集群</h3>
      <figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "admin",</span><br><span class="line">    "hosts": [],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 3072</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "Beijing",</span><br><span class="line">            "ST": "Beijing",</span><br><span class="line">            "O": "system:masters",	// 用户组, 不要改动, 否则会认证失败</span><br><span class="line">            "OU": "System"			// 用户</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>生成管理员证书和key</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// -bare admin 表示生成以admin开头的证书和key</span><br><span class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls admin*</span></span><br><span class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-生成kube-proxy证书"   >
          <a href="#4-生成kube-proxy证书" class="heading-link"><i class="fas fa-link"></i></a>4. 生成kube-proxy证书</h3>
      <p>工作节点通过kube-proxy组件访问api-server生成一些网络策略, 必须得有权限, 生成一个证书, 让kube-proxy携带证书去访问集群.</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "system:kube-proxy",		//固定,不能改变</span><br><span class="line">    "hosts": [],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 3072</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "Beijing",</span><br><span class="line">            "ST": "Beijing",</span><br><span class="line">            "O": "k8s",</span><br><span class="line">            "OU": "System"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
<p>生成kube-proxy证书和key</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">ls kube-proxy*</span><br><span class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></div></figure>


        <h3 id="5-只保留-pem-删除其它文件"   >
          <a href="#5-只保留-pem-删除其它文件" class="heading-link"><i class="fas fa-link"></i></a>5. 只保留*.pem, 删除其它文件</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls | grep -v pem | xargs -i rm &#123;&#125;</span><br><span class="line">ls</span><br><span class="line">admin-key.pem  admin.pem  ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  server-key.pem  server.pem</span><br></pre></td></tr></table></div></figure>


        <h2 id="关闭防火墙或开发端口"   >
          <a href="#关闭防火墙或开发端口" class="heading-link"><i class="fas fa-link"></i></a>关闭防火墙或开发端口</h2>
      
        <h3 id="关闭防火墙"   >
          <a href="#关闭防火墙" class="heading-link"><i class="fas fa-link"></i></a>关闭防火墙</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables=1</span><br></pre></td></tr></table></div></figure>


        <h3 id="如果使用firewalld作为防火墙，则需要开放端口"   >
          <a href="#如果使用firewalld作为防火墙，则需要开放端口" class="heading-link"><i class="fas fa-link"></i></a>如果使用firewalld作为防火墙，则需要开放端口</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=2379/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=2380/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></div></figure>


        <h2 id="etcd安装"   >
          <a href="#etcd安装" class="heading-link"><i class="fas fa-link"></i></a>etcd安装</h2>
      <p>etcd是由coreos公司开发在GitHub上开源的存储键值对的数据库</p>

        <h3 id="etcd-下载"   >
          <a href="#etcd-下载" class="heading-link"><i class="fas fa-link"></i></a>etcd 下载</h3>
      <p>本次测试安装etcd的3.2.12版本<br><span class="exturl"><a class="exturl__link"   href="https://github.com/etcd-io/etcd/releases/tag/v3.2.12"  target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/tag/v3.2.12</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>下载解压并移动到指定目录</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget -L https://github.com/etcd-io/etcd/releases/download/v3.2.12/etcd-v3.2.12-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf etcd-v3.2.12-linux-amd64.tar.gz</span><br><span class="line">ls etcd-v3.2.12-linux-amd64</span><br><span class="line">Documentation/  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md</span><br><span class="line">// 将解压后文件中的可执行文件etct和etcdctl移动到/opt/kubernetes/bin/目录下</span><br><span class="line">mv etcd-v3.2.12-linux-amd64/etcd /opt/kubernetes/bin/</span><br><span class="line">mv etcd-v3.2.12-linux-amd64/etcdctl /opt/kubernetes/bin/</span><br></pre></td></tr></table></div></figure>


        <h3 id="创建ETCD的配置文件"   >
          <a href="#创建ETCD的配置文件" class="heading-link"><i class="fas fa-link"></i></a>创建ETCD的配置文件</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/etcd &lt;&lt; EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">[Member]</span></span><br><span class="line">ETCD_NAME="etcd01"</span><br><span class="line">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://10.239.140.133:2380"</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://10.239.133:2379"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.239.140.133:2380"</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://10.239.140.133:2379"</span><br><span class="line">ETCD_INITIAL_CLUSTER="etcd01=https://10.239.140.133:2380,etcd02=https://10.239.131.206:2380,etcd03=https://10.239.141.145:2380"</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE="new"</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h3 id="使用systemd来管理etcd服务"   >
          <a href="#使用systemd来管理etcd服务" class="heading-link"><i class="fas fa-link"></i></a>使用systemd来管理etcd服务</h3>
      <figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]					//systemd依赖的一些服务, 网络服务启动之后再启动此服务</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/					//看网上配置有这个参数, 自己配置过程中没有加入</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/etcd		//指定服务启动配置文件</span><br><span class="line">ExecStart=/opt/kubernetes/bin/etcd \			//服务启动选项</span><br><span class="line">--name=$&#123;ETCD_NAME&#125; \</span><br><span class="line">--data-dir=$&#123;ETCD_DATA_DIR&#125; \</span><br><span class="line">--listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">--listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">--initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">--initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125; \</span><br><span class="line">--initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">--initial-cluster-state=new \</span><br><span class="line">--cert-file=/opt/kubernetes/ssl/server.pem \		// 指定数字证书</span><br><span class="line">--key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/opt/kubernetes/ssl/server.pem \</span><br><span class="line">--peer-key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/opt/kubernetes/ssl/ca.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>启动etcd服务</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 启动etcd服务发现卡住, 且过一会会报个错误, 原因是另外request另外两台etcd服务2380得不到响应</span><br><span class="line">// 待另外至少一台etcd服务启动后再回来查看etcd服务状态就正常了</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br><span class="line">// 完整的启动etcd服务命令其实就是运行以下命令:</span><br><span class="line">/opt/kubernetes/bin/etcd --name="etcd01" --data-dir="/var/lib/etcd/default.etcd" --listen-peer-urls="https://10.239.140.133:2380" --listen-client-urls="https://10.239.140.133:2379,http://127.0.0.1:2379" --advertise-client-urls="https://10.239.140.133:2379" --initial-advertise-peer-urls="https://10.239.140.133:2380" --initial-cluster="etcd01=https://10.239.140.133:2380,etcd02=https://10.239.131.206:2380,etcd03=https://10.239.141.145:2380" --initial-cluster-token="etcd-cluster" --initial-cluster-state="new" --cert-file=/opt/kubernetes/ssl/server.pem --key-file=/opt/kubernetes/ssl/server-key.pem --peer-cert-file=/opt/kubernetes/ssl/server.pem --peer-key-file=/opt/kubernetes/ssl/server-key.pem --trusted-ca-file=/opt/kubernetes/ssl/ca.pem --peer-trusted-ca-file=/opt/kubernetes/ssl/ca.pem</span><br></pre></td></tr></table></div></figure>

<p>查看服务</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef | grep etcd </span></span><br><span class="line">root     23726     1  5 21:41 ?        00:00:00 /opt/kubernetes/bin/etcd --name=etcd01 --data-dir=/var/lib/etcd/default.etcd --listen-peer-urls=https://10.239.140.133:2380 --listen-client-urls=https://10.239.140.133:2379,http://127.0.0.1:2379 --advertise-client-urls=https://10.239.140.133:2379 --initial-advertise-peer-urls=https://10.239.140.133:2380 --initial-cluster=etcd01=https://10.239.140.133:2380,etcd02=https://10.239.131.206:2380,etcd03=https://10.239.141.145:2380 --initial-cluster-token=etcd-cluster --initial-cluster-state=new --cert-file=/opt/kubernetes/ssl/server.pem --key-file=/opt/kubernetes/ssl/server-key.pem --peer-cert-file=/opt/kubernetes/ssl/server.pem --peer-key-file=/opt/kubernetes/ssl/server-key.pem --trusted-ca-file=/opt/kubernetes/ssl/ca.pem --peer-trusted-ca-file=/opt/kubernetes/ssl/ca.pem</span><br><span class="line">root     23744 14957  0 21:41 pts/1    00:00:00 grep --color=auto etcd</span><br><span class="line">// 查看etcd服务状态和日志发现etcd一直尝试request其它两台机器, 状态不正常, 在其它两台也部署etcd后就可以了</span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl status etcd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tail /var/<span class="built_in">log</span>/messages</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="etcd拷贝到其它机器"   >
          <a href="#etcd拷贝到其它机器" class="heading-link"><i class="fas fa-link"></i></a>etcd拷贝到其它机器</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> scp -r /opt/kubernetes root@10.239.131.206:/opt</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> scp /usr/lib/systemd/system/etcd.service  root@10.239.131.206:/usr/lib/systemd/system/etcd.service</span></span><br><span class="line">// 只需要修改其它机器上/opt/kubernetes/cfg/etcd文件里的ETCD_NAME和其它参数IP地址然后就可以直接运行命令启动etcd服务.</span><br><span class="line">// 并且启动后不会卡住</span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start etcd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> etcd</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="测试etcd集群状态是否正常"   >
          <a href="#测试etcd集群状态是否正常" class="heading-link"><i class="fas fa-link"></i></a>测试etcd集群状态是否正常</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/bin/etcdctl --ca-file=/opt/kubernetes/ssl/ca.pem --cert-file=/opt/kubernetes/ssl/server.pem --key-file=/opt/kubernetes/ssl/server-key.pem --endpoints="https://10.239.140.133:2379,https://10.239.131.206:2379,https://10.239.141.145:2379" cluster-health</span><br><span class="line">member 723f8ab932b4c3f6 is healthy: got healthy result from https://10.239.141.145:2379</span><br><span class="line">member 8af8f5fa5f0b0b39 is healthy: got healthy result from https://10.239.131.206:2379</span><br><span class="line">member 91dd39fb14e3de97 is healthy: got healthy result from https://10.239.140.133:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></div></figure>


        <h2 id="遇到的问题"   >
          <a href="#遇到的问题" class="heading-link"><i class="fas fa-link"></i></a>遇到的问题</h2>
      <p>查看Centos7系统日子</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /var/<span class="built_in">log</span>/messages</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl status etcd.service</span></span><br></pre></td></tr></table></div></figure>
<p>出现以下错误:</p>
<figure class="highlight routeros"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcd.service: main process exited, <span class="attribute">code</span>=exited, <span class="attribute">status</span>=2/INVALIDARGUMENT</span><br></pre></td></tr></table></div></figure>
<p>很明显是运行etcd命令时候的参数错误, 改对参数就可以了.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/technologies/security/jwt_jwks/">jwt jwks</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">426</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>referencd:<br><span class="exturl"><a class="exturl__link"   href="https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html"  target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://blog.unosquare.com/why-and-how-to-improve-jwt-security-with-jwks-key-rotation-in-java"  target="_blank" rel="noopener">https://blog.unosquare.com/why-and-how-to-improve-jwt-security-with-jwks-key-rotation-in-java</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p></div><div class="post-readmore"><a class="post-readmore__link" href="/2021/03/13/technologies/security/jwt_jwks/"><span class="post-readmore__text">阅读全文</span><span class="post-readmore__icon"><i class="fas fa-long-arrow-alt-right"></i></span></a></div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/technologies/security/openssl_certificates/">openssl certificates</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">3.8k</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="X-509证书标准定义的两种编码格式PEM和DER"   >
          <a href="#X-509证书标准定义的两种编码格式PEM和DER" class="heading-link"><i class="fas fa-link"></i></a>X.509证书标准定义的两种编码格式PEM和DER</h1>
      
        <h2 id="PEM编码（Privacy-Enhanced-Mail）"   >
          <a href="#PEM编码（Privacy-Enhanced-Mail）" class="heading-link"><i class="fas fa-link"></i></a>PEM编码（Privacy Enhanced Mail）</h2>
      <p>特点：纯文本文件, 以—–BEGIN CERTIFICATE—–开头, 以—–END CERTIFICATE—–结尾,<br>内容是 base64 编码. 但使用文本编辑器只能查看表面的结构, 需要输入命令例如  </p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> 某个PEM格式数字证书.pem -text -noout</span></span><br></pre></td></tr></table></div></figure>

<p>才能看到原始的数字证书信息.  </p>
<figure class="highlight jboss-cli"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">-----BEGIN</span> CERTIFICATE<span class="params">-----</span></span><br><span class="line">MIID7TCCAtWgAwIBAgIJAOIRDhOcxsx6MA0GCSqGSIb3DQEBCwUAMIGLMQswCQYD</span><br><span class="line">……</span><br><span class="line">xAJz+w8tjrDWcf826VN14IL+<span class="string">/Cmqlg/rIfB5CHdwVIfWwpuGB66q/UiPegZMNs8a</span></span><br><span class="line">3g==</span><br><span class="line"><span class="params">-----END</span> CERTIFICATE<span class="params">-----</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="DER编码（Distinguished-Encoding-Rules）"   >
          <a href="#DER编码（Distinguished-Encoding-Rules）" class="heading-link"><i class="fas fa-link"></i></a>DER编码（Distinguished Encoding Rules）</h2>
      <p>特点：二进制文件格式, 一般应使用 Windows/Java 开发工具打开, 也可以使用openssl命令行工具提取其中信息或进行编码转换.  </p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> 某个DER格式的数字证书.der -inform der -text -noout</span></span><br></pre></td></tr></table></div></figure>
<p>上面这个命令查看二进制文件中的证书信息.  </p>

        <h2 id="文件扩展名"   >
          <a href="#文件扩展名" class="heading-link"><i class="fas fa-link"></i></a>文件扩展名</h2>
      <div class="table-container"><table><tr><td bgcolor=#54FF9F><font face="fantasy" size=4>我们身边有很多常见的数字证书文件, 他们的扩展名通常既不叫".pem"也不叫".der", 但无论扩展名是什么, 其内部编码格式只能从PEM和DER这两种编码格式中选择一种.</font></td></tr></table></div>  
不同平台所偏好的编码格式不同, 不同类型的数字证书文件中存储的内容也略有差别, 不过对于大部分证书文件, 我们都可以借助命令行工具随时将其转换成另一种编码格式.  

<ul>
<li><strong>CRT</strong> - CRT应该是certificate的三个字母,其实还是证书的意思,常见于NIX系统,有可能是PEM编码,也有可能是DER编码,大多数应该是PEM编码,相信你已经知道怎么辨别. <strong>证书内容包含: signer(如CA:kubernetes),个人信息,过期时间,公钥public key,加密算法(非对称加密算法RSA2048, 对称机密算法AES256等),签名算法(sign algorithm)等信息.</strong>  </li>
<li><strong>KEY</strong> - 通常用来存放一个公钥或者私钥,并非X.509证书,编码同样的,可能是PEM,也可能是DER.<br>查看KEY的办法:  </li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> mykey.key -text -noout</span></span><br></pre></td></tr></table></div></figure>
<p>如果是DER格式的话,同理应该这样了:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> mykey.key -text -noout -inform der</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /home/zhan/istio-1.6.0/samples/certs/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> root-cert.pem -text -noout</span></span><br><span class="line">Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> root-cert.pem -text -noout | grep Validity -A 2</span></span><br><span class="line">Validity</span><br><span class="line">        Not Before: Jan 24 19:15:51 2018 GMT</span><br><span class="line">        Not After : Dec 31 19:15:51 2117 GMT</span><br><span class="line">-A n这样的shell写法，输出当前行之后的n行内容</span><br></pre></td></tr></table></div></figure>

<ul>
<li><strong>CSR - Certificate Signing Request</strong>,即证书签名请求,这个并不是证书,而是向权威证书颁发机构获得签名证书的申请,其核心内容是一个<strong>公钥和个人信息</strong>,在生成这个申请的时候, 要对应生成的有一个私钥,私钥要自己保管好, client端把包含public key的csr文件发给CA, 用CA的private key给csr文件做签名(sign)生成client端证书. <strong>CSR文件</strong>内容一般包含: <strong>个人信息,公钥public key,加密算法(非对称加密算法RSA2048, 对称机密算法AES256等),签名算法(sign algorithm)等信息.</strong><br>查看的办法:</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl req -noout -text -<span class="keyword">in</span> my.csr</span></span><br></pre></td></tr></table></div></figure>

<p>(如果是DER格式的话照旧命令行加上-inform der,这里不写了)</p>

        <h2 id="证书编码的转换"   >
          <a href="#证书编码的转换" class="heading-link"><i class="fas fa-link"></i></a>证书编码的转换</h2>
      <p> • PEM转为DER：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> cert.crt -outform der -out cert.der</span></span><br></pre></td></tr></table></div></figure>
<p> • DER转为PEM：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> cert.crt -inform der -outform pem -out cert.pem</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="获得证书的步骤"   >
          <a href="#获得证书的步骤" class="heading-link"><i class="fas fa-link"></i></a>获得证书的步骤</h2>
      <div class="table-container"><table><tr><td bgcolor=#54FF9F> • 向权威证书颁发机构申请证书</td></tr></table></div>
用以下命令生成一个csr:

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl req -newkey rsa:2048 -new -nodes -keyout my.key -out my.csr</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">my.csr  my.key</span><br></pre></td></tr></table></div></figure>
<p>把<strong>csr</strong>交给权威证书颁发机构,权威证书颁发机构对此进行签名,完成.保留好csr,<strong>当权威证书颁发机构颁发的证书过期的时候,你还可以用同样的csr来申请新的证书,key保持不变.</strong></p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F> • 或者生成自签名的证书</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">cert.pem  key.pem</span><br></pre></td></tr></table></div></figure>

<p>在生成证书的过程中会要你填一堆的东西,其实真正要填的只有Common Name,通常填写你服务器的域名,如”yourcompany.com”,或者你服务器的IP地址,其它都可以留空的.<br>生产环境中还是不要使用自签的证书,否则浏览器会不认,或者如果你是企业应用的话能够强制让用户的浏览器接受你的自签证书也行.向权威机构要证书通常是要钱的,但现在也有免费的,仅仅需要一个简单的域名验证即可.有兴趣的话查查”沃通数字证书”.</p>

        <h2 id="生成证书"   >
          <a href="#生成证书" class="heading-link"><i class="fas fa-link"></i></a>生成证书</h2>
      
        <h3 id="一：生成CA证书"   >
          <a href="#一：生成CA证书" class="heading-link"><i class="fas fa-link"></i></a>一：生成CA证书</h3>
      <p>目前不使用第三方权威机构的CA来认证，自己充当CA的角色。<br>网上下载一个openssl软件<br>1.创建私钥：<br>通常是rsa算法  </p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**ca-key.pem**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl genrsa -out ca/ca-key.pem 2048</span></span><br><span class="line">查看key</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> ca/ca-key.pem -text -noout</span></span><br><span class="line">如果是DER格式的话,同理应该这样</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> ca/ca-key.pem -text -noout -inform der</span></span><br></pre></td></tr></table></div></figure>

<p>2.创建证书请求：  </p>
<blockquote>
<p>因此在用户向CA申请数字证书时，用户首先需要在自己的电脑中先产生一个公私钥对。用户需要保管好自己的私钥，然后再把公钥和你的个人信息发送给CA机构，CA机构通过你的公钥和个人信息最终签发出数字证书。<br>而CSR文件，其实就是包含了用户公钥和个人信息的一个数据文件。用户产生出这个CSR文件，再把这个CSR文件发送给CA，CA就会根据CSR中的内容来签发出数字证书。  </p>
</blockquote>
<p>在制作csr文件的时，必须使用自己的私钥来签署申，还可以设定一个密钥.</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**ca-req.csr**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl req -new -out ca/ca-req.csr -key ca/ca-key.pem</span></span><br><span class="line">  Country Name (2 letter code) [AU]:cn</span><br><span class="line">  State or Province Name (full name) [Some-State]:zhejiang</span><br><span class="line">  Locality Name (eg, city) []:hangzhou</span><br><span class="line">  Organization Name (eg, company) [Internet Widgits Pty Ltd]:skyvision</span><br><span class="line">  Organizational Unit Name (eg, section) []:test</span><br><span class="line">  Common Name (eg, YOUR name) []:root</span><br><span class="line">  Email Address []:sky</span><br></pre></td></tr></table></div></figure>

<p>3.自签署证书 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**ca/ca-cert.pem**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -req -<span class="keyword">in</span> ca/ca-req.csr -out ca/ca-cert.pem -signkey ca/ca-key.pem -days 3650</span></span><br><span class="line">查看证书格式:</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> ca/ca-cert.pem -text -noout</span></span><br></pre></td></tr></table></div></figure>

<p>4.将证书导出成浏览器支持的.p12格式 ：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl pkcs12 -<span class="built_in">export</span> -clcerts -<span class="keyword">in</span> ca/ca-cert.pem -inkey ca/ca-key.pem -out ca/ca.p12</span></span><br></pre></td></tr></table></div></figure>
<p>密码：changeit</p>

        <h3 id="二-生成server证书。"   >
          <a href="#二-生成server证书。" class="heading-link"><i class="fas fa-link"></i></a>二.生成server证书。</h3>
      <p>1.创建私钥 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**server/server-key.pem**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl genrsa -out server/server-key.pem 2048</span></span><br><span class="line">查看key</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> server/server-key.pem -text -noout</span></span><br><span class="line">如果是DER格式的话,同理应该这样</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> server/server-key.pem -text -noout -inform der</span></span><br></pre></td></tr></table></div></figure>

<p>2.创建证书请求 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**server/server-req.csr**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl req -new -out server/server-req.csr -key server/server-key.pem</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Country Name (2 letter code) [AU]:cn</span><br><span class="line">State or Province Name (full name) [Some-State]:zhejiang</span><br><span class="line">Locality Name (eg, city) []:hangzhou</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:skyvision</span><br><span class="line">Organizational Unit Name (eg, section) []:test</span><br><span class="line">Common Name (eg, YOUR name) []:192.168.1.246 注释：一定要写服务器所在的ip地址</span><br><span class="line">Email Address []:sky</span><br></pre></td></tr></table></div></figure>
<p>查看csr文件内容:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> $ openssl req -<span class="keyword">in</span> server-req.csr -text -noout // -noout 不用输出csr文件原始内容</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Certificate Request:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 0 (0x0)</span><br><span class="line">        Subject: C&#x3D;XX, L&#x3D;Default City, O&#x3D;Default Company Ltd, CN&#x3D;10.239.140.186</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:e2:0c:a7:33:33:d9:9b:90:1b:29:30:3c:81:31:</span><br><span class="line">                    09:97:0a:a9:76:d5:54:be:63:17:21:0c:b9:3a:f0:</span><br><span class="line">                    a6:02:37:1a:d4:1e:53:4e:e0:c8:d9:5f:27:57:7f:</span><br><span class="line">                    f3:eb:7f:9d:ad:79:d6:e7:40:64:c8:bc:3d:f3:b4:</span><br><span class="line">                    16:d6:30:e9:16:04:b6:a0:0e:8f:75:e4:4b:d6:8e:</span><br><span class="line">                    0a:8e:75:d8:41:89:09:90:96:b0:8d:32:5f:b5:96:</span><br><span class="line">                    1d:65:d6:a6:b4:c7:eb:3d:3b:f9:62:36:69:7d:07:</span><br><span class="line">                    6d:05:89:ce:a6:a5:98:a0:b2:5f:ab:bc:25:ba:08:</span><br><span class="line">                    d8:86:0a:b9:c0:91:ca:f8:d3:bb:36:14:21:f9:c2:</span><br><span class="line">                    b5:53:43:a9:2c:03:39:9b:93:ef:1d:d9:20:ef:dd:</span><br><span class="line">                    ff:57:c6:b5:47:e8:bb:46:32:e3:1d:3b:2e:5b:15:</span><br><span class="line">                    11:80:72:f6:2e:f5:b2:cc:02:7f:b1:d6:e9:3d:8e:</span><br><span class="line">                    0e:66:f6:6d:45:0e:2f:8c:d5:c3:92:dc:a1:9a:d9:</span><br><span class="line">                    b0:33:82:30:69:0a:05:ee:08:1b:a6:81:f4:bb:31:</span><br><span class="line">                    0d:fa:26:37:eb:4f:c8:58:df:e5:be:cc:ac:9a:62:</span><br><span class="line">                    42:f1:af:8c:35:88:e4:f3:b4:76:8f:6c:13:1f:9a:</span><br><span class="line">                    61:e0:08:0f:f2:b1:d6:f3:61:b4:0a:5d:9a:61:5f:</span><br><span class="line">                    e1:0b</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        Attributes:</span><br><span class="line">            a0:00</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         5b:62:35:07:43:99:dc:af:7c:61:1e:76:4e:f8:ef:59:b2:27:</span><br><span class="line">         60:71:30:15:5d:f3:0b:b1:b4:53:29:ec:d1:7c:18:48:0a:b3:</span><br><span class="line">         fe:b7:6d:80:ef:dc:c6:24:04:3d:bd:c1:b8:61:49:f3:1e:fb:</span><br><span class="line">         22:0f:fb:06:99:ec:db:18:ac:34:ff:4b:15:f8:84:06:01:4d:</span><br><span class="line">         68:4f:0c:a2:a5:34:dc:1b:61:44:c7:ff:ef:5d:92:a1:09:3f:</span><br><span class="line">         11:27:1c:a7:30:8e:97:6a:08:03:99:e6:6a:8f:1d:d6:ea:e7:</span><br><span class="line">         cd:18:a7:eb:36:3d:e7:6b:5e:ef:72:85:ca:eb:89:97:02:cf:</span><br><span class="line">         fc:38:31:58:e1:66:85:d1:e7:49:e2:72:ef:b1:60:36:55:d7:</span><br><span class="line">         90:bd:8d:0e:d8:c6:8f:d2:bf:bf:43:85:36:04:2e:f1:ec:5f:</span><br><span class="line">         d8:1b:17:22:a4:6a:de:a7:b2:2b:00:30:27:e6:4b:32:4d:55:</span><br><span class="line">         70:b0:61:3d:3f:f2:9d:e7:24:f6:4c:1f:bf:63:6a:d9:16:ef:</span><br><span class="line">         cb:91:a3:a4:43:b5:1f:11:85:ad:0e:b1:57:39:f2:0a:56:ec:</span><br><span class="line">         52:90:b0:11:96:c6:28:e0:de:0c:eb:f2:b1:66:ce:04:48:7f:</span><br><span class="line">         11:90:09:1d:fd:ca:a7:25:66:32:a2:64:33:1a:5e:a9:85:50:</span><br><span class="line">         8a:2d:90:a5</span><br></pre></td></tr></table></div></figure>

<p>3.自签署证书 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**server/server-cert.pem**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -req -<span class="keyword">in</span> server/server-req.csr -out server/server-cert.pem -signkey server/server-key.pem -CA ca/ca-cert.pem -CAkey ca/ca-key.pem -CAcreateserial -days 3650</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight asciidoc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>-CA选项指明用于被签名的csr证书</span><br><span class="line"><span class="bullet">* </span>-CAkey选项指明用于签名的密钥</span><br><span class="line"><span class="bullet">* </span>-CAcreateserial指明文件不存在时自动生成</span><br></pre></td></tr></table></div></figure>
<p>查看证书格式:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> server/server-cert.pem -text -noout</span></span><br></pre></td></tr></table></div></figure>
<p>可以查看到证书里所包含的public key等相关信息:</p>
<figure class="highlight angelscript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Certificate:</span><br><span class="line">Data:</span><br><span class="line">    Version: <span class="number">1</span> (<span class="number">0x0</span>)</span><br><span class="line">    Serial Number:</span><br><span class="line">        cc:db:c0:f2:<span class="number">12</span>:e8:<span class="number">09</span>:<span class="number">27</span></span><br><span class="line">Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">    Issuer: C=XX, L=Default City, O=Default Company Ltd, CN=AI	<span class="comment">// 签发者(CA机构)</span></span><br><span class="line">    Validity</span><br><span class="line">        Not Before: Jul <span class="number">16</span> <span class="number">07</span>:<span class="number">01</span>:<span class="number">18</span> <span class="number">2020</span> GMT</span><br><span class="line">        Not After : Jul <span class="number">14</span> <span class="number">07</span>:<span class="number">01</span>:<span class="number">18</span> <span class="number">2030</span> GMT</span><br><span class="line">    Subject: C=XX, L=Default City, O=Default Company Ltd, CN=sky</span><br><span class="line">    Subject Public Key Info:</span><br><span class="line">        Public Key Algorithm: rsaEncryption</span><br><span class="line">            Public-Key: (<span class="number">2048</span> bit)			<span class="comment">// public key, 因此本地可以不需要再存储保留public key, 证书里已包含.</span></span><br><span class="line">            Modulus:</span><br><span class="line">                <span class="number">00</span>:cd:d7:ed:e9:c6:<span class="number">5</span>e:fa:bc:ef:<span class="number">1</span>e:<span class="number">4</span>e:<span class="number">92</span>:<span class="number">52</span>:<span class="number">99</span>:</span><br><span class="line">                f0:<span class="number">34</span>:<span class="number">96</span>:<span class="number">67</span>:<span class="number">7</span>b:<span class="number">32</span>:<span class="number">1</span>b:f6:<span class="number">53</span>:df:ca:<span class="number">7</span>b:e5:<span class="number">72</span>:<span class="number">6</span>a:</span><br><span class="line">                <span class="number">29</span>:e5:<span class="number">85</span>:<span class="number">27</span>:eb:<span class="number">71</span>:<span class="number">00</span>:c6:<span class="number">90</span>:ac:c1:<span class="number">64</span>:<span class="number">62</span>:<span class="number">0</span>d:<span class="number">2</span>b:</span><br><span class="line">                b1:bc:b8:ee:e1:d4:<span class="number">54</span>:b7:<span class="number">95</span>:<span class="number">21</span>:<span class="number">1</span>e:de:<span class="number">56</span>:c7:<span class="number">25</span>:</span><br><span class="line">                <span class="number">4</span>c:d4:<span class="number">2</span>d:<span class="number">29</span>:<span class="number">5f</span>:<span class="number">48</span>:<span class="number">19</span>:<span class="number">8</span>a:<span class="number">05</span>:c4:<span class="number">33</span>:d3:<span class="number">06</span>:<span class="number">16</span>:ec:</span><br><span class="line">                <span class="number">68</span>:e2:<span class="number">81</span>:<span class="number">07</span>:cf:f9:d1:<span class="number">15</span>:b2:<span class="number">68</span>:<span class="number">3</span>d:da:<span class="number">44</span>:c3:d5:</span><br><span class="line">                ba:a3:<span class="number">0f</span>:<span class="number">9</span>e:<span class="number">34</span>:<span class="number">34</span>:<span class="number">71</span>:<span class="number">53</span>:<span class="number">4f</span>:<span class="number">02</span>:<span class="number">4</span>b:eb:f8:de:fd:</span><br><span class="line">                <span class="number">94</span>:<span class="number">3f</span>:f4:ee:<span class="number">12</span>:<span class="number">48</span>:ea:b1:<span class="number">60</span>:<span class="number">62</span>:be:<span class="number">58</span>:<span class="number">47</span>:<span class="number">78</span>:<span class="number">29</span>:</span><br><span class="line">                <span class="number">59</span>:<span class="number">5</span>b:ae:<span class="number">57</span>:<span class="number">53</span>:<span class="number">23</span>:<span class="number">31</span>:aa:<span class="number">78</span>:cc:<span class="number">6</span>c:f0:f7:e9:<span class="number">76</span>:</span><br><span class="line">                <span class="number">4</span>a:b9:<span class="number">25</span>:<span class="number">79</span>:<span class="number">3f</span>:<span class="number">9</span>c:<span class="number">05</span>:<span class="number">4</span>e:f0:<span class="number">8</span>e:<span class="number">87</span>:<span class="number">32</span>:df:<span class="number">87</span>:<span class="number">72</span>:</span><br><span class="line">                <span class="number">67</span>:<span class="number">64</span>:<span class="number">2</span>e:<span class="number">9f</span>:<span class="number">85</span>:<span class="number">15</span>:<span class="number">64</span>:bf:ca:ce:<span class="number">33</span>:<span class="number">71</span>:ee:bb:<span class="number">1</span>a:</span><br><span class="line">                d3:<span class="number">26</span>:<span class="number">09</span>:<span class="number">34</span>:<span class="number">9</span>b:<span class="number">65</span>:b9:<span class="number">15</span>:<span class="number">71</span>:<span class="number">28</span>:<span class="number">14</span>:<span class="number">37</span>:<span class="number">48</span>:<span class="number">79</span>:<span class="number">1</span>b:</span><br><span class="line">                b1:<span class="number">99</span>:a4:<span class="number">8</span>c:cc:<span class="number">27</span>:a1:a4:c4:<span class="number">28</span>:<span class="number">8</span>e:<span class="number">01</span>:e5:<span class="number">08</span>:db:</span><br><span class="line">                e6:<span class="number">45</span>:<span class="number">6</span>e:<span class="number">3</span>d:d9:<span class="number">03</span>:a9:cb:<span class="number">17</span>:<span class="number">25</span>:b7:c9:c9:<span class="number">4</span>b:fb:</span><br><span class="line">                e5:<span class="number">93</span>:d1:de:<span class="number">31</span>:fe:a9:<span class="number">34</span>:<span class="number">29</span>:c3:<span class="number">29</span>:a4:<span class="number">27</span>:c2:eb:</span><br><span class="line">                <span class="number">66</span>:<span class="number">99</span>:c6:db:ba:<span class="number">52</span>:<span class="number">07</span>:<span class="number">30</span>:<span class="number">97</span>:d4:<span class="number">0</span>a:<span class="number">1</span>e:<span class="number">1</span>b:<span class="number">5</span>d:<span class="number">72</span>:</span><br><span class="line">                f6:ff:<span class="number">19</span>:<span class="number">92</span>:<span class="number">22</span>:c0:<span class="number">44</span>:<span class="number">76</span>:<span class="number">74</span>:f7:a7:<span class="number">0</span>d:c5:<span class="number">77</span>:c8:</span><br><span class="line">                <span class="number">1</span>c:<span class="number">55</span></span><br><span class="line">            Exponent: <span class="number">65537</span> (<span class="number">0x10001</span>)</span><br><span class="line">Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">     <span class="number">28</span>:d1:d9:<span class="number">29</span>:a5:<span class="number">40</span>:f3:d3:d6:<span class="number">95</span>:<span class="number">87</span>:fd:<span class="number">2</span>c:<span class="number">70</span>:dc:<span class="number">0f</span>:<span class="number">1</span>c:<span class="number">86</span>:</span><br><span class="line">     <span class="number">08</span>:<span class="number">35</span>:d0:a8:<span class="number">8</span>e:d0:<span class="number">5</span>d:<span class="number">78</span>:<span class="number">28</span>:ae:<span class="number">88</span>:<span class="number">33</span>:<span class="number">61</span>:db:cd:b6:<span class="number">80</span>:<span class="number">1</span>c:</span><br><span class="line">     <span class="number">88</span>:<span class="number">62</span>:b8:ce:cf:<span class="number">87</span>:<span class="number">14</span>:<span class="number">15</span>:bd:<span class="number">27</span>:<span class="number">9</span>a:<span class="number">3</span>e:<span class="number">77</span>:cb:a1:e0:<span class="number">11</span>:<span class="number">0</span>d:</span><br><span class="line">     <span class="number">89</span>:ef:f2:e8:b2:<span class="number">2</span>c:cf:<span class="number">96</span>:<span class="number">26</span>:bd:<span class="number">06</span>:<span class="number">3</span>a:<span class="number">7</span>b:<span class="number">8f</span>:<span class="number">4</span>b:fa:b2:c3:</span><br><span class="line">     f9:<span class="number">14</span>:<span class="number">3</span>e:<span class="number">18</span>:ef:<span class="number">57</span>:b5:<span class="number">37</span>:<span class="number">95</span>:<span class="number">01</span>:a0:<span class="number">0f</span>:bf:<span class="number">6</span>e:<span class="number">5</span>c:c9:<span class="number">47</span>:<span class="number">7</span>b:</span><br><span class="line">     <span class="number">1</span>a:ed:ca:<span class="number">7</span>a:<span class="number">31</span>:a1:<span class="number">89</span>:e8:<span class="number">0</span>d:<span class="number">4</span>d:<span class="number">95</span>:d2:<span class="number">61</span>:e3:b8:<span class="number">48</span>:e5:<span class="number">86</span>:</span><br><span class="line">     <span class="number">19</span>:<span class="number">91</span>:<span class="number">3</span>e:<span class="number">00</span>:<span class="number">86</span>:<span class="number">07</span>:<span class="number">50</span>:df:e2:<span class="number">57</span>:<span class="number">29</span>:<span class="number">69</span>:<span class="number">61</span>:c4:cc:<span class="number">55</span>:<span class="number">8f</span>:<span class="number">60</span>:</span><br><span class="line">     de:<span class="number">20</span>:c1:<span class="number">0</span>d:<span class="number">7</span>d:c7:<span class="number">98</span>:<span class="number">52</span>:f4:<span class="number">34</span>:<span class="number">08</span>:<span class="number">90</span>:c5:<span class="number">90</span>:<span class="number">34</span>:ec:<span class="number">86</span>:<span class="number">0f</span>:</span><br><span class="line">     ad:<span class="number">9</span>b:e7:<span class="number">1</span>a:d4:<span class="number">7</span>b:d9:dd:<span class="number">59</span>:<span class="number">82</span>:de:<span class="number">54</span>:d3:<span class="number">87</span>:<span class="number">8</span>e:e7:<span class="number">82</span>:ae:</span><br><span class="line">     <span class="number">22</span>:<span class="number">70</span>:cf:e7:d7:<span class="number">8</span>c:f1:<span class="number">55</span>:<span class="number">57</span>:<span class="number">6</span>d:<span class="number">41</span>:e6:<span class="number">44</span>:<span class="number">3</span>c:<span class="number">83</span>:b7:<span class="number">73</span>:<span class="number">7</span>e:</span><br><span class="line">     <span class="number">9</span>a:d5:<span class="number">1</span>d:af:<span class="number">72</span>:e9:<span class="number">4</span>e:<span class="number">88</span>:d4:<span class="number">4f</span>:<span class="number">9f</span>:<span class="number">33</span>:<span class="number">2f</span>:dc:<span class="number">1</span>b:<span class="number">50</span>:<span class="number">10</span>:<span class="number">8</span>b:</span><br><span class="line">     db:cd:e4:<span class="number">0</span>e:e6:<span class="number">96</span>:cd:c6:<span class="number">27</span>:c7:<span class="number">4</span>b:c7:<span class="number">9f</span>:<span class="number">05</span>:<span class="number">74</span>:<span class="number">32</span>:<span class="number">35</span>:<span class="number">7</span>e:</span><br><span class="line">     <span class="number">99</span>:<span class="number">78</span>:<span class="number">36</span>:<span class="number">30</span>:ae:<span class="number">78</span>:<span class="number">4</span>b:c3:<span class="number">1</span>a:<span class="number">6</span>b:b8:db:<span class="number">62</span>:<span class="number">23</span>:b8:ab:<span class="number">22</span>:<span class="number">11</span>:</span><br><span class="line">     <span class="number">11</span>:<span class="number">81</span>:<span class="number">95</span>:<span class="number">5</span>d:<span class="number">46</span>:f0:<span class="number">45</span>:<span class="number">15</span>:<span class="number">77</span>:<span class="number">1f</span>:<span class="number">6</span>b:c0:bf:<span class="number">9</span>d:a2:d2:b4:<span class="number">62</span>:</span><br><span class="line">     c9:b5:<span class="number">2</span>b:dd</span><br></pre></td></tr></table></div></figure>

<p>4.将证书导出成浏览器支持的.p12格式 ：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl pkcs12 -<span class="built_in">export</span> -clcerts -<span class="keyword">in</span> server/server-cert.pem -inkey server/server-key.pem -out server/server.p12</span></span><br></pre></td></tr></table></div></figure>
<p>密码：changeit</p>
<p>Additional：<br>因为server端的证书是由CA的private key签名(sign)server端的public key及其持有者的真实身份得到的, 因此server端证书里就包含server的public key.<br>就不需要用Openssl生成server端的public key. 用server端的<strong>csr（certificate signing requests）</strong>生成server证书即可. client端也一样.<br>client端只需要用CA的public key(CA的public key所有人都能获取)解密server端存放在CA的证书文件就可以得到Server端的public key.<br>然后client端就可以用解密得到的server端的public key对server端用自身private key加密的信息附带的摘要A(digest)进行解密.<br>client端将server端发过来的信息用Hash得到摘要B(digest)与解密得到的摘要A(digest)对比, 如果一直则说明信息没有被黑客篡改.<br>如果中间黑客把server端加密的摘要A(digest)修改了，则client用从CA的public key解密得到的server端的public key是解不开摘要A(digest)的, 说明摘要信息被黑客篡改, 内容不可靠.  </p>
<p>如果要生成RSA公钥, command如下:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> server/server-key.pem -pubout -out server/server-public-key.pem</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="三-生成client证书。"   >
          <a href="#三-生成client证书。" class="heading-link"><i class="fas fa-link"></i></a>三.生成client证书。</h3>
      <p>1.创建私钥 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**client/client-key.pem**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl genrsa -out client/client-key.pem 2048</span></span><br><span class="line">查看key</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> client/client-key.pem -text -noout</span></span><br><span class="line">如果是DER格式的话,同理应该这样</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> client/client-key.pem -text -noout -inform der</span></span><br></pre></td></tr></table></div></figure>

<p>2.创建证书请求 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**client/client-req.csr**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl req -new -out client/client-req.csr -key client/client-key.pem</span></span><br><span class="line">  Country Name (2 letter code) [AU]:cn</span><br><span class="line">  State or Province Name (full name) [Some-State]:zhejiang</span><br><span class="line">  Locality Name (eg, city) []:hangzhou</span><br><span class="line">  Organization Name (eg, company) [Internet Widgits Pty Ltd]:skyvision</span><br><span class="line">  Organizational Unit Name (eg, section) []:test</span><br><span class="line">  Common Name (eg, YOUR name) []:sky</span><br><span class="line">  Email Address []:sky 注释：就是登入中心的用户（本来用户名应该是Common Name，但是中山公安的不知道为什么使用的Email Address，其他版本没有测试）</span><br><span class="line">  Please enter the following ‘extra’ attributes</span><br><span class="line">  to be sent with your certificate request</span><br><span class="line">  A challenge password []:123456</span><br><span class="line">  An optional company name []:tsing</span><br></pre></td></tr></table></div></figure>

<p>3.自签署证书 ：</p>
<div class="table-container"><table><tr><td bgcolor=#54FF9F>**client/client-cert.pem**</td></tr></table></div>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -req -<span class="keyword">in</span> client/client-req.csr -out client/client-cert.pem -signkey client/client-key.pem -CA ca/ca-cert.pem -CAkey ca/ca-key.pem -CAcreateserial -days 3650</span></span><br><span class="line"> * -CA选项指明用于被签名的csr证书</span><br><span class="line"> * -CAkey选项指明用于签名的密钥</span><br><span class="line"> * -CAcreateserial指明文件不存在时自动生成</span><br><span class="line">查看证书格式:</span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -<span class="keyword">in</span> client/client-cert.pem -text -noout</span></span><br></pre></td></tr></table></div></figure>

<p>4.将证书导出成浏览器支持的.p12格式 ：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl pkcs12 -<span class="built_in">export</span> -clcerts -<span class="keyword">in</span> client/client-cert.pem -inkey client/client-key.pem -out client/client.p12</span></span><br></pre></td></tr></table></div></figure>
<p>密码：changeit</p>
<p>Additional. 生成RSA公钥:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> client/client-key.pem -pubout -out client/client-public-key.pem</span></span><br></pre></td></tr></table></div></figure>

<p>请一定严格根据里面的步骤来，待实验成功后，修改你自己想要修改的内容。我就是一开始没有安装该填写的来，结果生成的证书就无法配对成功。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/technologies/security/openssl/">openssl</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">552</span></span></div></header><div class="post-body"><div class="post-excerpt"><h2 id="openssl版本"   >
          <a href="#openssl版本" class="heading-link"><i class="fas fa-link"></i></a>openssl版本</h2>
      <figure class="highlight livecodeserver"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl <span class="built_in">version</span></span><br><span class="line">openssl <span class="built_in">version</span> -<span class="keyword">a</span></span><br></pre></td></tr></table></div></figure></div><div class="post-readmore"><a class="post-readmore__link" href="/2021/03/13/technologies/security/openssl/"><span class="post-readmore__text">阅读全文</span><span class="post-readmore__icon"><i class="fas fa-long-arrow-alt-right"></i></span></a></div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/technologies/security/token_jwt/">Token jwt</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">3.5k</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Reference"   >
          <a href="#Reference" class="heading-link"><i class="fas fa-link"></i></a>Reference</h1>
      <ul>
<li><span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/MyCode1990/p/13096423.html"  target="_blank" rel="noopener">csdn blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://www.jianshu.com/p/4941a269a9d8"  target="_blank" rel="noopener">简书</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>

        <h1 id="Json-Web-Token-JWT-简介"   >
          <a href="#Json-Web-Token-JWT-简介" class="heading-link"><i class="fas fa-link"></i></a>Json Web Token(JWT)简介</h1>
      <p>JWT属于Token验证方式的一种方法.</p>
<blockquote>
<p>JSON Web Token（JWT）是一个开放标准（RFC 7519），它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。此信息可以验证和信任，因为它是数字签名的。JWTs可以使用密钥（使用HMAC算法）或使用RSA或ECDSA的公钥/私钥对进行签名.</p>
</blockquote>

        <h1 id="传统服务端验证客户端身份的方法"   >
          <a href="#传统服务端验证客户端身份的方法" class="heading-link"><i class="fas fa-link"></i></a>传统服务端验证客户端身份的方法</h1>
      <p>HTTP 是一种没有状态的协议，也就是它并不知道是谁是访问应用。这里我们把用户看成是客户端，客户端使用用户名还有密码通过了身份验证，不过下回这个客户端再发送请求时候，还得再验证一下。</p>
<p>解决的方法就是，当用户请求登录的时候，如果没有问题，我们在服务端生成一条记录，这个记录里可以说明一下登录的用户是谁，然后把这条记录的 ID 号发送给客户端，客户端收到以后把这个 ID 号存储在 Cookie 里，下次这个用户再向服务端发送请求的时候，可以带着这个 Cookie ，这样服务端会验证一个这个 Cookie 里的信息，看看能不能在服务端这里找到对应的记录，如果可以，说明用户已经通过了身份验证，就把用户请求的数据返回给客户端。</p>
<p>上面说的就是 Session，我们需要在服务端存储为登录的用户生成的 Session ，这些 Session 可能会存储在内存，磁盘，或者数据库里。我们可能需要在服务端定期的去清理过期的 Session 。</p>

        <h1 id="基于-Token-的身份验证方法"   >
          <a href="#基于-Token-的身份验证方法" class="heading-link"><i class="fas fa-link"></i></a>基于 Token 的身份验证方法</h1>
      <p>Token是在客户端频繁向服务端请求数据，服务端频繁的去数据库查询用户名和密码并进行对比，判断用户名和密码正确与否，并作出相应提示，在这样的背景下，Token便应运而生。<br>Token是服务端生成的一串字符串，以作客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码。<br>使用基于 Token 的身份验证方法，在服务端不需要存储用户的登录记录。大概的流程是这样的：</p>
<ol>
<li>客户端使用用户名跟密码请求登录</li>
<li>服务端收到请求，去验证用户名与密码</li>
<li>验证成功后，服务端会签发一个 Token，再把这个 Token 发送给客户端</li>
<li>客户端收到 Token 以后可以把它存储起来，比如放在 Cookie 里或者 Local Storage 里</li>
<li>客户端每次向服务端请求资源的时候需要带着服务端签发的 Token</li>
<li>服务端收到请求，然后去验证客户端请求里面带着的 Token，如果验证成功，就向客户端返回请求的数据</li>
</ol>

        <h1 id="为什么要使用JSON-Web-Token"   >
          <a href="#为什么要使用JSON-Web-Token" class="heading-link"><i class="fas fa-link"></i></a>为什么要使用JSON Web Token</h1>
      <ul>
<li>Token的目的是为了减轻服务器的压力，减少频繁的查询数据库，使服务器更加健壮.</li>
<li>JSON比XML不那么冗长，当它被编码时，它的大小也更小，使得JWT比SAML更紧凑。这使得JWT成为在HTML和HTTP环境中传递的一个很好的选择。</li>
<li>安全方面，使用HMAC算法，SWT只能由共享密钥对称签名。但是，JWT和SAML令牌可以使用X.509证书形式的公钥/私钥对进行签名。与签名JSON的简单性相比，使用XML数字签名来签名XML而不引入隐藏的安全漏洞是非常困难的。</li>
<li>JSON解析器在大多数编程语言中都很常见，因为它们直接映射到对象。相反，XML没有自然的文档到对象的映射。这使得使用JWT比使用SAML断言更容易。</li>
<li>在使用方面，JWT是在互联网上使用的。这突出了JSON Web令牌在多个平台（尤其是移动平台）上客户端处理的方便性。</li>
<li>比较编码JWT和编码SAML的长度.</li>
</ul>

        <h1 id="JWT-Json-Web-Token-一种Token验证方法"   >
          <a href="#JWT-Json-Web-Token-一种Token验证方法" class="heading-link"><i class="fas fa-link"></i></a>JWT(Json Web Token 一种Token验证方法)</h1>
      <p>实施 Token 验证的方法挺多的，还有一些标准方法，比如 JWT，读作：jot ，表示：JSON Web Tokens 。JWT 标准的 Token 有三个部分：</p>
<ul>
<li>header（头部）</li>
<li>payload（荷载,数据）</li>
<li>signature（签名）<br>中间用点分隔开，并且都会使用 Base64 编码，所以真正的 Token 看起来像这样：</li>
</ul>
<figure class="highlight css"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">eyJhbGciOiJIUzI1NiJ9</span><span class="selector-class">.eyJpc3MiOiJuaW5naGFvLm5ldCIsImV4cCI6IjE0Mzg5NTU0NDUiLCJuYW1lIjoid2FuZ2hhbyIsImFkbWluIjp0cnVlfQ</span><span class="selector-class">.SwyHTEx_RQppr97g4J5lKXtabJecpejuef8AqKYMAJc</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Header-头部"   >
          <a href="#Header-头部" class="heading-link"><i class="fas fa-link"></i></a>Header 头部</h2>
      <ul>
<li>令牌的类型</li>
<li>正在使用的签名算法(HMAC, SHA256, RSA等)。</li>
</ul>
<p>每个 JWT token 里面都有一个 header，也就是头部数据。里面包含了使用的算法，这个 JWT 是不是带签名的或者加密的。主要就是说明一下怎么处理这个 JWT token 。<br>头部里包含的东西可能会根据 JWT 的类型有所变化，比如一个加密的 JWT 里面要包含使用的加密的算法。唯一在头部里面要包含的是 alg 这个属性，如果是加密的 JWT，这个属性的值就是使用的签名或者解密用的算法。如果是未加密的 JWT，这个属性的值要设置成 none。<br>示例：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span>,</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>意思是这个 JWT 用的算法是 HS256。上面的内容得用 base64url 的形式编码一下，所以就变成这样：</p>
<figure class="highlight gcode"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI<span class="number">1</span><span class="symbol">NiJ9</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="Payload-有效负载"   >
          <a href="#Payload-有效负载" class="heading-link"><i class="fas fa-link"></i></a>Payload 有效负载</h2>
      <p>有效负载包含了”声明(claims)”, 有三种类型的claims：</p>
<ul>
<li>registered claims 已注册的 (不是强制的，而是推荐,iss（发行者）、exp（到期时间）、sub（主题）、aud（受众）和其他)</li>
<li>public claims 公开的 (可以由使用JWT的用户随意定义, 为了避免冲突，应该在<span class="exturl"><a class="exturl__link"   href="https://www.iana.org/assignments/jwt/jwt.xhtml"  target="_blank" rel="noopener">IANA JSON Web令牌注册表</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中定义它们，或者将它们定义为包含防冲突命名空间的URI)</li>
<li>private claims 私有的</li>
</ul>
<p>Payload 里面是 Token 的具体内容，这些内容里面有一些是标准字段，你也可以添加其它需要的内容。下面是标准字段：</p>
<ul>
<li>iss：Issuer，发行者</li>
<li>sub：Subject，主题</li>
<li>aud：Audience，观众</li>
<li>exp：Expiration time，过期时间</li>
<li>nbf：Not before</li>
<li>iat：Issued at，发行时间</li>
<li>jti：JWT ID</li>
</ul>
<p>比如下面这个 Payload ，用到了 iss 发行人，还有 exp 过期时间这两个标准字段。另外还有两个自定义的字段，一个是 name ，还有一个是 admin 。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="string">"iss"</span>: <span class="string">"ninghao.net"</span>,</span><br><span class="line">  <span class="string">"exp"</span>: <span class="string">"1438955445"</span>,</span><br><span class="line">  <span class="string">"admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>使用 base64url 编码以后就变成了这个样子：</p>
<figure class="highlight gcode"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJpc<span class="number">3</span>MiOiJuaW<span class="number">5</span><span class="symbol">naGFvLm5</span>ldCIsImV<span class="number">4</span>cCI<span class="number">6</span>IjE<span class="number">0</span>Mz<span class="name">g5</span><span class="symbol">NTU0</span><span class="symbol">NDUiLCJuYW1</span>lIjoid<span class="number">2</span>FuZ<span class="number">2</span>hhbyIsImFkbWluIjp<span class="number">0</span>c<span class="symbol">nVlfQ</span></span><br></pre></td></tr></table></div></figure>
<p><strong>请注意，对于已签名的令牌，此信息虽然受保护不受篡改，但任何人都可以读取。除非经过加密，否则不要将机密信息放在JWT的有效负载或头部</strong>.</p>

        <h2 id="Signature-签名"   >
          <a href="#Signature-签名" class="heading-link"><i class="fas fa-link"></i></a>Signature 签名</h2>
      <p>要创建签名部分，您必须已经有了 经过编码的<strong>头部</strong>、经过编码的<strong>负载</strong>、一个<strong>秘钥</strong>、在头部中指定的<strong>算法</strong>，这样就可以进行签名了.<br>Signature这部分内容有三个部分，先是用 Base64 编码的 header.payload ，再用加密算法加密一下，加密的时候要放进去一个 Secret ，这个相当于是一个密码，这个密码秘密地存储在服务端。  </p>
<ul>
<li>header</li>
<li>payload</li>
<li>secret</li>
</ul>
<figure class="highlight lisp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const encodedString = base64UrlEncode(<span class="name">header</span>) + <span class="string">"."</span> + base64UrlEncode(<span class="name">payload</span>)<span class="comment">; </span></span><br><span class="line">HMACSHA256(<span class="name">encodedString</span>, 'secret')<span class="comment">;</span></span><br></pre></td></tr></table></div></figure>
<p>处理完成以后看起来像这样：</p>
<figure class="highlight gcode"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SwyHTEx_RQppr<span class="number">97</span><span class="name">g4</span>J<span class="number">5</span>lKXtabJecpejuef<span class="number">8</span>AqKYMAJc</span><br></pre></td></tr></table></div></figure>
<p>最后这个在服务端生成并且要发送给客户端的 Token 看起来像这样：</p>
<figure class="highlight css"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">eyJhbGciOiJIUzI1NiJ9</span><span class="selector-class">.eyJpc3MiOiJuaW5naGFvLm5ldCIsImV4cCI6IjE0Mzg5NTU0NDUiLCJuYW1lIjoid2FuZ2hhbyIsImFkbWluIjp0cnVlfQ</span><span class="selector-class">.SwyHTEx_RQppr97g4J5lKXtabJecpejuef8AqKYMAJc</span></span><br></pre></td></tr></table></div></figure>
<p>输出的内容是三个由点分隔的Base64 URL字符串。它可以在HTML和HTTP环境中轻松传递，它比XML的标准（如SAML）更加紧凑.<br>客户端收到这个 Token 以后把它存储下来，下回向服务端发送请求的时候就带着这个 Token 。服务端收到这个 Token ，然后进行验证，通过以后就会返回给客户端想要的资源。</p>

        <h2 id="签名的作用"   >
          <a href="#签名的作用" class="heading-link"><i class="fas fa-link"></i></a>签名的作用:</h2>
      <p>(1) 签名用于验证消息在传输过程中没有被更改。<br>(2) 使用私钥签名的令牌，还可以验证JWT的发送者是它所说的发送者。</p>

        <h1 id="签发-Json-Web-Token-JWT"   >
          <a href="#签发-Json-Web-Token-JWT" class="heading-link"><i class="fas fa-link"></i></a>签发 Json Web Token(JWT)</h1>
      <ul>
<li>JWT 对 “信息” 进行签名，产生一个令牌。</li>
<li>签名的令牌可以验证其中包含的内容的完整性（防篡改）。</li>
<li>也可对“信息”加密，加密的令牌则对其他方隐藏这些内容。</li>
<li>当令牌使用公钥/私钥对签名时，签名还证明只有持有私钥的一方才是签名方。可以非对称加密方式证明了</li>
</ul>

        <h2 id="HS256-算法签发Json-Web-Token-JWT"   >
          <a href="#HS256-算法签发Json-Web-Token-JWT" class="heading-link"><i class="fas fa-link"></i></a>HS256 算法签发Json Web Token(JWT)</h2>
      <p>这种算法需要一个密钥（密码）.<br>在项目里随便添加一个 .js 文件，比如 index.js，在文件里添加下面这些代码：  </p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br><span class="line"><span class="comment">// Token 数据</span></span><br><span class="line"><span class="keyword">const</span> payload = &#123;</span><br><span class="line">name: <span class="string">'wanghao'</span>,</span><br><span class="line">admin: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 密钥</span></span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">'ILOVENINGHAO'</span></span><br><span class="line"><span class="comment">// 签发 Token</span></span><br><span class="line"><span class="keyword">const</span> token = jwt.sign(payload, secret, &#123; <span class="attr">expiresIn</span>: <span class="string">'1day'</span> &#125;)</span><br><span class="line"><span class="comment">// 输出签发的 Token</span></span><br><span class="line"><span class="built_in">console</span>.log(token)</span><br></pre></td></tr></table></div></figure>
<p>非常简单，就是用了刚刚为项目安装的 jsonwebtoken 里面提供的 jwt.sign 功能，去签发一个 token。这个 sign 方法需要三个参数：</p>
<ul>
<li>playload：签发的 token 里面要包含的一些数据。</li>
<li>secret：签发 token 用的密钥，在验证 token 的时候同样需要用到这个密钥。</li>
<li>options：一些其它的选项。</li>
</ul>
<p>在命令行下面，用 node 命令，执行一下项目里的 index.js 这个文件（node index.js），会输出应用签发的 token：</p>
<figure class="highlight gcode"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI<span class="number">1</span><span class="symbol">NiIsInR5</span>cCI<span class="number">6</span>IkpX<span class="attr">VCJ9</span>.eyJuYW<span class="number">1</span>lIjoid<span class="number">2</span>FuZ<span class="number">2</span>hhbyIsImFkbWluIjp<span class="number">0</span>c<span class="symbol">nVlLCJpYXQiOjE1</span>MjkwMz<span class="name">M5</span>MDYsImV<span class="number">4</span>cCI<span class="number">6</span>MTUyOTEyMDMw<span class="symbol">Nn0</span>.DctA<span class="number">2</span>QlUCr<span class="name">M6</span>wLWkI<span class="meta">O78</span>wBV<span class="symbol">N0</span><span class="symbol">NLpjoIq4</span>T<span class="number">5</span>B_<span class="number">2</span>WJ-PU</span><br></pre></td></tr></table></div></figure>
<p>上面的 Token 内容并没有加密，所以如果用一些 JWT 解码功能，可以看到 Token 里面包含的内容，内容由三个部分组成，像这样：</p>
<figure class="highlight gcode"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// header</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>, </span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// payload</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"admin"</span>: true, </span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1529033906</span>, </span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"wanghao"</span>, </span><br><span class="line">  <span class="string">"exp"</span>: <span class="number">1529120306</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// signature</span></span><br><span class="line">DctA<span class="number">2</span>QlUCr<span class="name">M6</span>wLWkI<span class="meta">O78</span>wBV<span class="symbol">N0</span><span class="symbol">NLpjoIq4</span>T<span class="number">5</span>B_<span class="number">2</span>WJ-PU</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>假设用户通过了某种身份验证，你就可以使用上面的签发 Token 的功能为用户签发一个 Token。一般在客户端那里会把它保存在 Cookie 或 LocalStorage 里面。<br>用户下次向我们的应用请求受保护的资源的时候，可以在请求里带着我们给它签发的这个 Token，后端应用收到请求，检查签名，如果验证通过确定这个 Token 是我们自己签发的，那就可以为用户响应回他需要的资源。</p>
</blockquote>

        <h2 id="RS256-算法签发Json-Web-Token-JWT"   >
          <a href="#RS256-算法签发Json-Web-Token-JWT" class="heading-link"><i class="fas fa-link"></i></a>RS256 算法签发Json Web Token(JWT)</h2>
      <p>默认签发还有验证 Token 的时候用的是 HS256 算法，这种算法需要一个密钥（密码）。我们还可以使用 RS256 算法签发与验证 JWT。这种方法可以让我们分离开签发与验证，签发时需要用一个密钥，验证时使用公钥，也就是有公钥的地方只能做验证，但不能签发 JWT。</p>
<p>在项目下面创建一个新的目录，里面可以存储即将生成的密钥与公钥文件。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/desktop/jwt-demo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> config</span></span><br></pre></td></tr></table></div></figure>

<p><strong>密钥:</strong><br>先生成一个密钥文件：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 2048 -f private.key</span><br></pre></td></tr></table></div></figure>
<p><strong>公钥:</strong><br>基于上面生成的密钥，再去创建一个对应的公钥：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -in private.key -pubout -outform PEM -out public.key</span><br></pre></td></tr></table></div></figure>
<p><strong>签发 JWT（RS256 算法）</strong><br>用 RS256 算法签发 JWT 的时候，需要从文件系统上读取创建的密钥文件里的内容。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="comment">// 获取签发 JWT 时需要用的密钥</span></span><br><span class="line"><span class="keyword">const</span> privateKey = fs.readFileSync(<span class="string">'./config/private.key'</span>)</span><br><span class="line">签发仍然使用 jwt.sign 方法，只不过在选项参数里特别说明一下使用的算法是 RS256：</span><br><span class="line"><span class="comment">// 签发 Token</span></span><br><span class="line"><span class="keyword">const</span> tokenRS256 = jwt.sign(payload, privateKey, &#123; <span class="attr">algorithm</span>: <span class="string">'RS256'</span> &#125;)</span><br><span class="line"><span class="comment">// 输出签发的 Token</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'RS256 算法：'</span>, tokenRS256)</span><br></pre></td></tr></table></div></figure>


        <h1 id="验证Json-Web-Token-JWT"   >
          <a href="#验证Json-Web-Token-JWT" class="heading-link"><i class="fas fa-link"></i></a>验证Json Web Token(JWT)</h1>
      
        <h2 id="HS256-算法验证Json-Web-TOken-JWT"   >
          <a href="#HS256-算法验证Json-Web-TOken-JWT" class="heading-link"><i class="fas fa-link"></i></a>HS256 算法验证Json Web TOken(JWT)</h2>
      <p>需要一个签发token时候用的密钥（密码）来验证,这种算法需要一个密钥（密码）.<br>验证 JWT 的用效性，确定一下用户的 JWT 是我们自己签发的，首先要得到用户的这个 JWT Token，然后用 jwt.verify 这个方法去做一下验证。这个方法是 Node.js 的 jsonwebtoken 这个包里提供的，在其它的应用框架或者系统里，你可能会找到类似的方法来验证 JWT。<br>打开项目的 index.js 文件，里面添加几行代码：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证 Token</span></span><br><span class="line">jwt.verify(token, <span class="string">'bad secret'</span>, (error, decoded) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error.message)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(decoded)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>

<p>把要验证的 Token 数据，还有签发这个 Token 的时候用的那个密钥告诉 verify 这个方法，在一个回调里面有两个参数，error 表示错误，decoded 是解码之后的 Token 数据。</p>
<p>执行：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node ~/desktop/jwt-demo/index.js</span></span><br></pre></td></tr></table></div></figure>
<p>输出：</p>
<figure class="highlight css"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class="selector-class">.eyJuYW1lIjoid2FuZ2hhbyIsImFkbWluIjp0cnVlLCJpYXQiOjE1MjkwMzQ3MzMsImV4cCI6MTUyOTEyMTEzM30</span><span class="selector-class">.swXojmu7VimFu3BoIgAxxpmm2J05dvD0HT3yu10vuqU</span></span><br><span class="line"><span class="selector-tag">invalid</span> <span class="selector-tag">signature</span></span><br></pre></td></tr></table></div></figure>
<p>注意输出了一个 invalid signature ，表示 Token 里的签名不对，这是因为我们组长 verify 方法提供的密钥并不是签发 Token 的时候用的那个密钥。这样修改一下：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jwt.verify(token, secret, (error, decoded) =&gt; &#123; ...</span><br></pre></td></tr></table></div></figure>
<p>再次运行，会输出类似的数据：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoid2FuZ2hhbyIsImFkbWluIjp0cnVlLCJpYXQiOjE1MjkwMzUzODYsImV4cCI6MTUyOTEyMTc4Nn0.mkNrt4TfcfmP22xd3C_GQn8qnUmlB39dKT9SpIBTBGI</span></span><br><span class="line"><span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'wanghao'</span><span class="string">,</span> <span class="attr">admin:</span> <span class="literal">true</span><span class="string">,</span> <span class="attr">iat:</span> <span class="number">1529035386</span><span class="string">,</span> <span class="attr">exp:</span> <span class="number">1529121786</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="RS256-算法验证Json-Web-Token-JWT"   >
          <a href="#RS256-算法验证Json-Web-Token-JWT" class="heading-link"><i class="fas fa-link"></i></a>RS256 算法验证Json Web Token(JWT)</h2>
      <p>验证 JWT（RS256 算法）<br>验证使用 RS256 算法签发的 JWT，需要在文件系统上读取公钥文件里的内容。然后用 jwt 的 verify 方法去做验证。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取验证 JWT 时需要用的公钥</span></span><br><span class="line"><span class="keyword">const</span> publicKey = fs.readFileSync(<span class="string">'./config/public.key'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证 Token</span></span><br><span class="line">jwt.verify(tokenRS256, publicKey, (error, decoded) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error.message)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(decoded)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>


        <h1 id="使用场景"   >
          <a href="#使用场景" class="heading-link"><i class="fas fa-link"></i></a>使用场景</h1>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="token_scene1.png"  alt="">
      </p>
<ol>
<li>应用程序或客户端，向授权服务器请求授权。</li>
<li>当授权被通过时，授权服务器将向应用程序返回一个访问令牌token。</li>
<li>应用程序使用访问令牌访问受保护的资源。</li>
</ol>
<p><strong>请注意，使用签名的令牌，令牌中包含的所有信息都将公开给用户或其他方（虽然他们无法更改它，但可以阅读）。这意味着您不应将机密信息放入令牌中.</strong></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/windows/windows%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8D/">windows批量修改文件名</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-15</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">268</span></span></div></header><div class="post-body"><div class="post-excerpt"><h2 id="批量删除文件名中的空格"   >
          <a href="#批量删除文件名中的空格" class="heading-link"><i class="fas fa-link"></i></a>批量删除文件名中的空格</h2>
      <p>在要批量修改文件名的文件夹路径下创建新bat文件<code>delete_space.bat</code>, 内容如下:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">Setlocal Enabledelayedexpansion</span><br><span class="line">set "str= "</span><br><span class="line">for /f "delims=" %%i in ('dir /b *.*') do (</span><br><span class="line">set "var=%%i" &amp; ren "%%i" "!var:%str%=!")</span><br></pre></td></tr></table></div></figure>

<p>保存后直接双击即可</p></div><div class="post-readmore"><a class="post-readmore__link" href="/2021/03/13/windows/windows%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8D/"><span class="post-readmore__text">阅读全文</span><span class="post-readmore__icon"><i class="fas fa-long-arrow-alt-right"></i></span></a></div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/storage/greenplum/greenplum_01_deployment/">greenplum 01 deployment on Kubernetes</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.8k</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="Prerequisites"   >
          <a href="#Prerequisites" class="heading-link"><i class="fas fa-link"></i></a>Prerequisites</h2>
      <ol>
<li><span class="exturl"><a class="exturl__link"   href="http://greenplum-kubernetes.docs.pivotal.io/2-0/node-requirements.html"  target="_blank" rel="noopener">Kubernetes Node Configuration</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> describes the Linux kernel configuration requirements for each Kubernetes node that is used in a Pivotal Greenplum cluster. These requirements are common to all Pivotal Greenplum deployments, regardless of which Kubernetes environment you use.</li>
<li>Ensure that any previous Pivotal Greenplum installation has been uninstalled as described in Uninstalling Pivotal Greenplum.</li>
<li>kubectl configured to refer to a Kubernetes cluster.</li>
</ol>

        <h2 id="Install-Greenplum-Operator-for-Kubernetes"   >
          <a href="#Install-Greenplum-Operator-for-Kubernetes" class="heading-link"><i class="fas fa-link"></i></a>Install Greenplum Operator for Kubernetes</h2>
      <ol>
<li>Download the Pivotal Greenplum software from <span class="exturl"><a class="exturl__link"   href="https://network.pivotal.io/products/greenplum-for-kubernetes"  target="_blank" rel="noopener">VMware Tanzu Network</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> or skip to step 3 if have greenplum related files. The download file has the name: <code>greenplum-for-kubernetes-&lt;version&gt;.tar.gz.</code></li>
</ol>
<ol start="2">
<li>Go to the directory where you downloaded Greenplum for Kubernetes, and unpack the downloaded software. For example:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/Downloads</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar xzf greenplum-for-kubernetes-*.tar.gz</span></span><br></pre></td></tr></table></div></figure>
<p>The above command unpacks the distribution into a new directory named <code>greenplum-for-kubernetes-&lt;version&gt;</code>.<br>3. Go into the new greenplum-for-kubernetes-<version> directory:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ./greenplum-for-kubernetes-*</span></span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>Load the Greenplum for Kubernetes Docker image to the local Docker registry:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker load -i ./images/greenplum-for-kubernetes</span></span><br></pre></td></tr></table></div></figure>
<ol start="5">
<li>Load the Greenplum Operator Docker image to the Docker registry:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker load -i ./images/greenplum-operator</span></span><br></pre></td></tr></table></div></figure>
<ol start="6">
<li>Push the Greenplum docker images to the local container registry. For example:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> IMAGE_REPO=<span class="string">"hci-node01:5000"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> GREENPLUM_IMAGE_NAME=<span class="string">"<span class="variable">$&#123;IMAGE_REPO&#125;</span>/greenplum-for-kubernetes:<span class="variable">$(cat ./images/greenplum-for-kubernetes-tag)</span>"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker tag $(cat ./images/greenplum-for-kubernetes-id) <span class="variable">$&#123;GREENPLUM_IMAGE_NAME&#125;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker push <span class="variable">$&#123;GREENPLUM_IMAGE_NAME&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> OPERATOR_IMAGE_NAME=<span class="string">"<span class="variable">$&#123;IMAGE_REPO&#125;</span>/greenplum-operator:<span class="variable">$(cat ./images/greenplum-operator-tag)</span>"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker tag $(cat ./images/greenplum-operator-id) <span class="variable">$&#123;OPERATOR_IMAGE_NAME&#125;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker push <span class="variable">$&#123;OPERATOR_IMAGE_NAME&#125;</span></span></span><br></pre></td></tr></table></div></figure>
<ol start="7">
<li>Create a new YAML file in the workspace subdirectory with two lines to indicate the registry where you pushed the images</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;workspace/operator-values-overrides.yaml</span><br><span class="line">operatorImageRepository: $&#123;IMAGE_REPO&#125;/greenplum-operator</span><br><span class="line">greenplumImageRepository: $&#123;IMAGE_REPO&#125;/greenplum-for-kubernetes</span><br><span class="line">operatorWorkerSelector: &#123;</span><br><span class="line">greenplum-operator: "default"</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
<ol start="8">
<li>Use helm to create a new Greenplum Operator release.</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 先给某台机器添加标签来部署greenplum-operator</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label node hci-node02  greenplum-operator=default</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create namespace greenplum</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> helm install -n greenplum-operator -f workspace/operator-values-overrides.yaml operator/ --namespace greenplum</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> helm install greenplum-operator operator/</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Create-Local-Persistent-Volumes-for-Greenplum"   >
          <a href="#Create-Local-Persistent-Volumes-for-Greenplum" class="heading-link"><i class="fas fa-link"></i></a>Create Local Persistent Volumes for Greenplum</h2>
      <ol>
<li>Create the directory, partition, or logical volume that you want to use as a Kubernetes local volume.</li>
</ol>
<ol start="2">
<li>Create the StorageClass definition, specifying no-provisioner in order to manually provision local persistent volumes. Using volumeBindingMode: WaitForFirstConsumer is also recommended to delay binding the local PersistenVolume until a pod requires.</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vim gpdb-storage-class.yaml</span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: gpdb-storage</span><br><span class="line">provisioner: kubernetes.io/no-provisioner</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li>Create a PersistentVolume definition, specifying the local volume and the required NodeAffinity field. For example:</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ vim pv-master.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: greenplum-master-node02</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: gpdb-storage</span><br><span class="line">  local:</span><br><span class="line">    path: /mnt/disks/greenplum-master-vol0	// 需要提前在相应机器上创建此目录</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - hci-node02</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: greenplum-master-node02</span><br><span class="line">......重复上面的内容, 改变下local.path, nodeAffinity等在不同node机器上创建多个pv</span><br></pre></td></tr></table></div></figure>

<ol start="4">
<li><p>Repeat the previous step for each PersistentVolume required for your cluster. Remember that each Greenplum segment host requires a dedicated storage volume.</p>
</li>
<li><p>Use kubectl to apply the StorageClass and PersistentVolume configurations that you created.</p>
</li>
<li><p>Specify the local storage StorageClass name when you deploy a new Greenplum cluster as below.</p>
</li>
</ol>

        <h2 id="Deploy-a-greenplum-cluster"   >
          <a href="#Deploy-a-greenplum-cluster" class="heading-link"><i class="fas fa-link"></i></a>Deploy a greenplum cluster</h2>
      <ol>
<li>Go to the workspace subdirectory where you unpacked the Pivotal Greenplum distribution for Kubernetes:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ./greenplum-for-kubernetes-*/workspace</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>If necessary, create a Kubernetes manifest file to specify the configuration of your Greenplum cluster. A sample file is provided in workspace/my-gp-instance.yaml. my-gp-instance.yaml contains the minimal set of instructions necessary to create a demonstration cluster named “my-greenplum” with a single segment and default storage, memory, and CPU settings:</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: "greenplum.pivotal.io/v1"</span><br><span class="line">kind: "GreenplumCluster"</span><br><span class="line">metadata:</span><br><span class="line">  name: my-greenplum</span><br><span class="line">spec:</span><br><span class="line">  masterAndStandby:</span><br><span class="line">    hostBasedAuthentication: |</span><br><span class="line">      # host   all   gpadmin   1.2.3.4/32   trust</span><br><span class="line">      # host   all   gpuser    0.0.0.0/0   md5</span><br><span class="line">    memory: "800Mi"</span><br><span class="line">    cpu: "0.5"</span><br><span class="line">    storageClassName: gpdb-storage</span><br><span class="line">    storage: 1G</span><br><span class="line">    antiAffinity: "yes"</span><br><span class="line">    workerSelector: &#123;&#125;</span><br><span class="line">  segments:</span><br><span class="line">    primarySegmentCount: 2		# Expand the segment to 2</span><br><span class="line">    memory: "800Mi"</span><br><span class="line">    cpu: "0.5"</span><br><span class="line">    storageClassName: gpdb-storage		# Use the specify storageclass</span><br><span class="line">    storage: 10G				# Expand the storage to 10G</span><br><span class="line">    antiAffinity: "yes"</span><br><span class="line">    workerSelector: &#123;&#125;</span><br><span class="line">    mirrors: "yes"</span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li>Use kubectl apply command and specify your manifest file to send the deployment request to the Greenplum Operator. For example, to use the sample my-gp-instance.yaml file:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f ./my-gp-instance.yaml </span></span><br><span class="line">  greenplumcluster.greenplum.pivotal.io/my-greenplum created</span><br></pre></td></tr></table></div></figure>


        <h2 id="Deploy-multiple-greenplum-cluster"   >
          <a href="#Deploy-multiple-greenplum-cluster" class="heading-link"><i class="fas fa-link"></i></a>Deploy multiple greenplum cluster</h2>
      <ol>
<li>Create namespaces for greenplum cluster to deploy. Deploy two greenplum cluster instances:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create namespace gpinstance-1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create namespace gpinstance-2</span></span><br></pre></td></tr></table></div></figure>

<ol start="2">
<li>Deploy Greenplum cluster into the correspond namespace.</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> workspace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f ./my-gp-instance.yaml -n gpinstance-1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f ./my-gp-instance.yaml -n gpinstance-2</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="Test-whether-the-Greenplum-Cluster-deployment-is-successful"   >
          <a href="#Test-whether-the-Greenplum-Cluster-deployment-is-successful" class="heading-link"><i class="fas fa-link"></i></a>Test whether the Greenplum Cluster deployment is successful</h2>
      <p>查看greenplum logs</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> k logs po/master-0 -n greenplum</span></span><br><span class="line">......</span><br><span class="line">*******************************</span><br><span class="line">Adding host based authentication to master-0 pg_hba.conf</span><br><span class="line">*******************************</span><br><span class="line">......</span><br><span class="line">*******************************</span><br><span class="line">Running createdb</span><br><span class="line">*******************************</span><br></pre></td></tr></table></div></figure>
<p>需要等待一段时间才能执行下方操作</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> -it master-0 -n greenplum -- bash -c <span class="string">"source /opt/gpdb/greenplum_path.sh; psql"</span></span></span><br><span class="line"> psql (8.3.23)</span><br><span class="line"> Type "help" for help.</span><br><span class="line"></span><br><span class="line"> gpadmin=# select * from gp_segment_configuration;</span><br></pre></td></tr></table></div></figure>
<p>如果报一些错误无法执行可以:</p>
<ol>
<li>先进入master-0: kubectl exec -it master-0 -n greenplum – bash, 再查找greenplum_path.sh</li>
<li>执行<code>$ source /opt/gpdb/greenplum_path.sh</code>, 再 <code>$ exit</code>退出, 然后就可以用以上命令了</li>
</ol>
<p>(Enter <code>\q</code> to exit the psql utility.)</p>
<p><strong>If you are redeploying a cluster that configured to use a standby master, wait until all pods reach the Running status. Then connect to the master-0 pod and execute the gpstart command manually. For example:</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> -it master-0 -n greenplum -- bash -c <span class="string">"source /opt/gpdb/greenplum_path.sh; gpstart"</span></span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Delete-a-greenplum-cluster-and-uninstall-pivotal-greenplum-for-kubernetes"   >
          <a href="#Delete-a-greenplum-cluster-and-uninstall-pivotal-greenplum-for-kubernetes" class="heading-link"><i class="fas fa-link"></i></a>Delete a greenplum cluster and uninstall pivotal greenplum for kubernetes</h2>
      
        <h3 id="Delete-a-greenplum-cluster"   >
          <a href="#Delete-a-greenplum-cluster" class="heading-link"><i class="fas fa-link"></i></a>Delete a greenplum cluster</h3>
      <ol>
<li>Navigate to the workspace directory of the Pivotal Greenplum distribution (or to the location of the Kubernetes manifest that you used to deploy the cluster). For example:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ./greenplum-for-kubernetes-*/workspace</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>Execute the kubectl delete command, specifying the manifest that you used to deploy the cluster. For example:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f ./my-gp-instance.yaml --<span class="built_in">wait</span>=<span class="literal">false</span></span></span><br></pre></td></tr></table></div></figure>
<p><strong>Note:</strong> Use the optional –wait=false flag to return immediately without waiting for the deletion to complete.<br>3. Use kubectl to describe the Greenplum cluster to verify Status.Phase and Events:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe greenplumcluster my-greenplum</span></span><br><span class="line"> [...]</span><br><span class="line"> Status:</span><br><span class="line">   Instance Image:    greenplum-for-kubernetes:latest</span><br><span class="line">   Operator Version:  greenplum-operator:latest</span><br><span class="line">   Phase:             Deleting</span><br><span class="line"> Events:</span><br><span class="line">   Type    Reason                    Age   From               Message</span><br><span class="line">   ----    ------                    ----  ----               -------</span><br><span class="line">   Normal  CreatingGreenplumCluster  3m    greenplumOperator  Creating Greenplum cluster my-greenplum in default</span><br><span class="line">   Normal  CreatedGreenplumCluster   1m    greenplumOperator  Successfully created Greenplum cluster my-greenplum in default</span><br><span class="line">   Normal  DeletingGreenplumCluster  6s    greenplumOperator  Deleting Greenplum cluster my-greenplum in default</span><br></pre></td></tr></table></div></figure>
<p>If for any reason stopping the Greenplum instance fails, you should see a warning message in the greenplum-operator logs as shown below:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs -l app=greenplum-operator</span></span><br><span class="line">[...]</span><br><span class="line">&#123;"level":"INFO","ts":"2020-01-24T19:03:22.874Z","logger":"controllers.GreenplumCluster","msg":"DeletingGreenplumCluster","name":"my-greenplum","namespace":"default"&#125;</span><br><span class="line">&#123;"level":"INFO","ts":"2020-01-24T19:03:23.068Z","logger":"controllers.GreenplumCluster","msg":"initiating shutdown of the greenplum cluster"&#125;</span><br><span class="line">&#123;"level":"INFO","ts":"2020-01-24T19:03:31.971Z","logger":"controllers.GreenplumCluster","msg":"gpstop did not stop cleanly. Please check gpAdminLogs for more info."&#125;</span><br><span class="line">[...]</span><br><span class="line">&#123;"level":"INFO","ts":"2020-01-24T19:03:32.252Z","logger":"controllers.GreenplumCluster","msg":"DeletedGreenplumCluster","name":"my-greenplum","namespace":"default"&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>Use kubectl to monitor the progress of terminating Greenplum resources in your cluster. For example, if your cluster deployment was named my-greenplum:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get all -l greenplum-cluster=my-greenplum</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label nodes hci-node01 greenplum-affinity-greenplum-master-	// 去掉node上关于greenplum的label</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label nodes hci-node01 greenplum-affinity-greenplum-segment-</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="Delete-greenplum-persistent-volume-claims"   >
          <a href="#Delete-greenplum-persistent-volume-claims" class="heading-link"><i class="fas fa-link"></i></a>Delete greenplum persistent volume claims</h3>
      <p><strong>Caution:</strong> If the Persistent Volumes were created using dynamic provisioning, then deleting the PVCs will also delete the associated PVs. In this case, do not delete the PVCs unless you are certain that you no longer need the data.</p>
<ol>
<li>Verify that the PVCs are present for your cluster. For example, to show the Persistent Volume Claims created for a cluster named my-greenplum:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pvc -l greenplum-cluster=my-greenplum</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>Use kubectl to delete the PVCs associated with the cluster. For example, to delete all PersistentVolume Claims created for a cluster named my-greenplum:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete pvc -l greenplum-cluster=my-greenplum</span></span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>If the Persistent Volumes were provisioned manually, then deleting the PVCs does not delete the associated PVs. (You can check for the PVs using kubectl get pv.) To delete any remaining Persistent Volumes, execute the command:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete pv -l greenplum-cluster=my-greenplum</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="Uninstall-pivotal-greenplum-for-kubernetes"   >
          <a href="#Uninstall-pivotal-greenplum-for-kubernetes" class="heading-link"><i class="fas fa-link"></i></a>Uninstall pivotal greenplum for kubernetes</h3>
      <ol>
<li>Use the helm delete command to delete the greenplum-operator release:</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm delete greenplum-operator</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> helm del --purge greenplum-operator;</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>Delete the node label of greenplum operator when deployed on kubernetes</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label nodes hci-node02 greenplum-operator-</span></span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>Use docker rmi to delete images</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rmi &lt;ImageName or ImgaeID&gt;</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="FAQ"   >
          <a href="#FAQ" class="heading-link"><i class="fas fa-link"></i></a>FAQ</h2>
      <p>When uninstall greenplum, encountered this problem: Object is being deleted: customresourcedefinitions.apiextensions.k8s.io “greenplumclusters.greenplum.pivotal.io” already exists.</p>
<p>solution refer to this:<span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/kubernetes/issues/60538"  target="_blank" rel="noopener">delete crd</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="删除greenplum集群脚本"   >
          <a href="#删除greenplum集群脚本" class="heading-link"><i class="fas fa-link"></i></a>删除greenplum集群脚本</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">vim clean_greenplum.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">workspace=workspace</span><br><span class="line">node01=hci-node01</span><br><span class="line">node02=hci-node02</span><br><span class="line">node03=hci-node03</span><br><span class="line">node04=hci-node04</span><br><span class="line">greenplum_operator=hci-node02</span><br><span class="line"></span><br><span class="line">cd greenplum-for-kubernetes-v1.13.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete greenplum cluster</span></span><br><span class="line">kubectl delete -f $&#123;workspace&#125;/my-gp-instance.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete pvc</span></span><br><span class="line">pvc_results=$(kubectl get pvc -n greenplum | grep greenplum | awk '&#123;print $1&#125;')</span><br><span class="line">pvc_arr=($&#123;pvc_results&#125;)</span><br><span class="line">for ((i=0; i&lt;$&#123;#pvc_arr[*]&#125;; i++ ))</span><br><span class="line">do</span><br><span class="line">kubectl delete pvc $&#123;pvc_arr[i]&#125; -n greenplum</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete pv</span></span><br><span class="line">kubectl delete -f $&#123;workspace&#125;/pv-master.yaml</span><br><span class="line">kubectl delete -f $&#123;workspace&#125;/pv-segment.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete sc</span></span><br><span class="line">kubectl delete -f $&#123;workspace&#125;/workspacegpdb-storage-class.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete greenplum operator</span></span><br><span class="line">helm delete greenplum-operator</span><br><span class="line">helm del --purge greenplum-operator;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete label on nodes</span></span><br><span class="line">kubectl label nodes $&#123;node01&#125; greenplum-affinity-greenplum-master-</span><br><span class="line">kubectl label nodes $&#123;node01&#125; greenplum-affinity-greenplum-segment-</span><br><span class="line">kubectl label nodes $&#123;node02&#125; greenplum-affinity-greenplum-master-</span><br><span class="line">kubectl label nodes $&#123;node02&#125; greenplum-affinity-greenplum-segment-</span><br><span class="line">kubectl label nodes $&#123;node03&#125; greenplum-affinity-greenplum-master-</span><br><span class="line">kubectl label nodes $&#123;node03&#125; greenplum-affinity-greenplum-segment-</span><br><span class="line">kubectl label nodes $&#123;node04&#125; greenplum-affinity-greenplum-master-</span><br><span class="line">kubectl label nodes $&#123;node04&#125; greenplum-affinity-greenplum-segment-</span><br><span class="line">kubectl label nodes $&#123;greenplum_operator&#125; greenplum-operator-</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/storage/ceph/ceph_02_deployment/">Ceph 02 deployment on Kubernetes</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.9k</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>This document describes the steps to enable Ceph cluster in Kubernetes(k8s)  </p>

        <h2 id="Prerequisites"   >
          <a href="#Prerequisites" class="heading-link"><i class="fas fa-link"></i></a>Prerequisites</h2>
      <ol>
<li>A running Kubernetes environmen.  </li>
</ol>

        <h2 id="Setup-steps"   >
          <a href="#Setup-steps" class="heading-link"><i class="fas fa-link"></i></a>Setup steps</h2>
      <ol>
<li>The first step is to deploy the Rook operator. Check that you are using the example yaml files that correspond to your release of Rook.  </li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> --single-branch --branch release-1.3 https://github.com/rook/rook.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> cluster/examples/kubernetes/ceph</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f common.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f operator.yaml</span></span><br><span class="line"></span><br><span class="line">Verify the rook-ceph-operator is in the Running state before proceeding</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph get pod</span></span><br></pre></td></tr></table></div></figure>

<ol start="2">
<li>Now that the Rook operator is running we can create the Ceph cluster. For the cluster to survive reboots, make sure you set the dataDirHostPath property that is valid for your hosts.  </li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f cluster.yaml</span></span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li>Use kubectl to list pods in the rook-ceph namespace. You should be able to see the following pods once they are all running. The number of osd pods will depend on the number of nodes in the cluster and the number of devices configured. If you did not modify the cluster.yaml above, it is expected that one OSD will be created per node. The CSI, rook-ceph-agent, and rook-discover pods are also optional depending on your settings.  </li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph get pod</span></span><br><span class="line">  NAME                                                 READY   STATUS      RESTARTS   AGE</span><br><span class="line">  csi-cephfsplugin-provisioner-d77bb49c6-n5tgs         5/5     Running     0          140s</span><br><span class="line">  csi-cephfsplugin-provisioner-d77bb49c6-v9rvn         5/5     Running     0          140s</span><br><span class="line">  csi-cephfsplugin-rthrp                               3/3     Running     0          140s</span><br><span class="line">  csi-rbdplugin-hbsm7                                  3/3     Running     0          140s</span><br><span class="line">  csi-rbdplugin-provisioner-5b5cd64fd-nvk6c            6/6     Running     0          140s</span><br><span class="line">  csi-rbdplugin-provisioner-5b5cd64fd-q7bxl            6/6     Running     0          140s</span><br><span class="line">  rook-ceph-agent-4zkg8                                1/1     Running     0          140s</span><br><span class="line">  rook-ceph-crashcollector-minikube-5b57b7c5d4-hfldl   1/1     Running     0          105s</span><br><span class="line">  rook-ceph-mgr-a-64cd7cdf54-j8b5p                     1/1     Running     0          77s</span><br><span class="line">  rook-ceph-mon-a-694bb7987d-fp9w7                     1/1     Running     0          105s</span><br><span class="line">  rook-ceph-mon-b-856fdd5cb9-5h2qk                     1/1     Running     0          94s</span><br><span class="line">  rook-ceph-mon-c-57545897fc-j576h                     1/1     Running     0          85s</span><br><span class="line">  rook-ceph-operator-85f5b946bd-s8grz                  1/1     Running     0          92m</span><br><span class="line">  rook-ceph-osd-0-6bb747b6c5-lnvb6                     1/1     Running     0          23s</span><br><span class="line">  rook-ceph-osd-1-7f67f9646d-44p7v                     1/1     Running     0          24s</span><br><span class="line">  rook-ceph-osd-2-6cd4b776ff-v4d68                     1/1     Running     0          25s</span><br><span class="line">  rook-ceph-osd-prepare-node1-vx2rz                    0/2     Completed   0          60s</span><br><span class="line">  rook-ceph-osd-prepare-node2-ab3fd                    0/2     Completed   0          60s</span><br><span class="line">  rook-ceph-osd-prepare-node3-w4xyz                    0/2     Completed   0          60s</span><br><span class="line">  rook-discover-dhkb8                                  1/1     Running     0          140s</span><br></pre></td></tr></table></div></figure>

<ol start="4">
<li>To verify that the cluster is in a healthy state, connect to the Rook toolbox and run the ceph status command.  </li>
</ol>
<ul>
<li>All mons should be in quorum  </li>
<li>A mgr should be active  </li>
<li>At least one OSD should be active  </li>
<li>If the health is not HEALTH_OK, the warnings or errors should be investigated.  </li>
</ul>
<p>Running the Toolbox in Kubernetes:  </p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f toolbox.yaml</span></span><br></pre></td></tr></table></div></figure>

<p>Wait for the toolbox pod to download its container and get to the running state:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph get pod -l <span class="string">"app=rook-ceph-tools"</span></span></span><br></pre></td></tr></table></div></figure>

<p>Once the rook-ceph-tools pod is running, you can connect to it with:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph <span class="built_in">exec</span> -it $(kubectl -n rook-ceph get pod -l <span class="string">"app=rook-ceph-tools"</span> -o jsonpath=<span class="string">'&#123;.items[0].metadata.name&#125;'</span>) bash</span></span><br></pre></td></tr></table></div></figure>

<p>Example:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ceph status</span></span><br><span class="line">  cluster:</span><br><span class="line">    id:     a0452c76-30d9-4c1a-a948-5d8405f19a7c</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"></span><br><span class="line">  services:</span><br><span class="line">    mon: 3 daemons, quorum a,b,c (age 3m)</span><br><span class="line">    mgr: a(active, since 2m)</span><br><span class="line">    osd: 3 osds: 3 up (since 1m), 3 in (since 1m)</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>

<p>When you are done with the toolbox, you can remove the deployment, but if you want continue to doing other test experiments below, please keep the toolbox:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph delete deployment rook-ceph-tools</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Object-Store"   >
          <a href="#Object-Store" class="heading-link"><i class="fas fa-link"></i></a>Object Store</h2>
      
        <h3 id="1-Create-an-Object-Store"   >
          <a href="#1-Create-an-Object-Store" class="heading-link"><i class="fas fa-link"></i></a>1. Create an Object Store</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> cluster/examples/kubernetes/ceph</span></span><br><span class="line">// Create the object store</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f object.yaml</span></span><br><span class="line">// To confirm the object store is configured, wait for the rgw pod to start</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph get pod -l app=rook-ceph-rgw</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-Define-a-storage-class-that-will-allow-object-clients-to-create-a-bucket"   >
          <a href="#2-Define-a-storage-class-that-will-allow-object-clients-to-create-a-bucket" class="heading-link"><i class="fas fa-link"></i></a>2. Define a storage class that will allow object clients to create a bucket.</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Define the storage class that will allow object clients to create a bucket</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f storageclass-bucket-delete.yaml</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="3-1-Create-a-Bucket"   >
          <a href="#3-1-Create-a-Bucket" class="heading-link"><i class="fas fa-link"></i></a>3.1 Create a Bucket</h3>
      <p>An Object Bucket Claim (OBC) is custom resource which requests a bucket (new or existing) and is described by a Custom Resource Definition (CRD).</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Create an Object Bucket Claim (OBC) </span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f object-bucket-claim-delete.yaml</span></span><br></pre></td></tr></table></div></figure>

<p>When the OBC is created, the Rook-Ceph bucket provisioner will create a new bucket.A <code>secret</code> and <code>ConfigMap</code> are created with the same name as the OBC and in the same namespace. The secret contains credentials used by the application pod to access the bucket. The ConfigMap contains bucket endpoint information and is also consumed by the pod. </p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Check the created bucket name, "ceph-bkt-5124df41-7939-4aa6-b989-2bff0aa38deb" as shown below.</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe obc ceph-delete-bucket</span></span><br><span class="line">  ......</span><br><span class="line">  Spec:</span><br><span class="line">    Object Bucket Name:    obc-default-ceph-delete-bucket</span><br><span class="line">    Bucket Name:           ceph-bkt-5124df41-7939-4aa6-b989-2bff0aa38deb</span><br><span class="line">    Generate Bucket Name:  ceph-bkt</span><br><span class="line">    Storage Class Name:    rook-ceph-delete-bucket</span><br><span class="line">  Status:</span><br><span class="line">    Phase:  Bound		// [Notice]: The Status must be Bound, if `Pending`, please wait or delete and recreate the obc.</span><br><span class="line">  Events:   &lt;none&gt;</span><br></pre></td></tr></table></div></figure>
<p>An Object Bucket (OB) is a custom resource automatically generated when a bucket is provisioned. It is a global resource, typically not visible to non-admin users, and contains information specific to the bucket. It is described by an OB CRD.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Check the OB</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get ob</span></span><br><span class="line">  NAME                             AGE</span><br><span class="line">  obc-default-ceph-delete-bucket   5m16s</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-2-Create-another-Bucket"   >
          <a href="#3-2-Create-another-Bucket" class="heading-link"><i class="fas fa-link"></i></a>3.2 Create another Bucket</h3>
      <p>Change the ObjectBucketClaim metadata.name and create another bucket.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim object-bucket-claim-delete.yaml</span></span><br><span class="line">  apiVersion: objectbucket.io/v1alpha1</span><br><span class="line">  kind: ObjectBucketClaim</span><br><span class="line">  metadata:</span><br><span class="line">    name: ceph-bucket-new		# Change bucket name</span><br><span class="line">  spec:</span><br><span class="line">    generateBucketName: ceph-bkt</span><br><span class="line">    storageClassName: rook-ceph-bucket</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f object-bucket-claim-delete.yaml</span></span><br></pre></td></tr></table></div></figure>

<p><strong>Client Connections</strong><br>The following commands extract key pieces of information from the secret and configmap:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// config-map, secret, OBC will part of default if no specific name space mentioned</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_HOST=$(kubectl -n default get cm ceph-delete-bucket -o yaml | grep BUCKET_HOST | awk <span class="string">'&#123;print $2&#125;'</span> | awk <span class="string">'NR==1'</span>)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_ACCESS_KEY_ID=$(kubectl -n default get secret ceph-delete-bucket -o yaml | grep AWS_ACCESS_KEY_ID | awk <span class="string">'&#123;print $2&#125;'</span> | awk <span class="string">'NR==1'</span>| base64 --decode)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=$(kubectl -n default get secret ceph-delete-bucket -o yaml | grep AWS_SECRET_ACCESS_KEY | awk <span class="string">'&#123;print $2&#125;'</span> | awk <span class="string">'NR==1'</span>| base64 --decode)</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="4-Consume-the-Object-Storage"   >
          <a href="#4-Consume-the-Object-Storage" class="heading-link"><i class="fas fa-link"></i></a>4. Consume the Object Storage</h3>
      <p><strong>Enter into the toolbox</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec $(kubectl get po -l app=rook-ceph-tools -n rook-ceph -o jsonpath='&#123;.items[0].metadata.name&#125;') -it -n rook-ceph -- bash</span><br></pre></td></tr></table></div></figure>

<p>Connected to the Rook toolbox Pod and then set the four environment variables for use by your client(ie. inside the toolbox).</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_HOST=&lt;host&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_ENDPOINT=&lt;endpoint&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_ACCESS_KEY_ID=&lt;accessKey&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=&lt;secretKey&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>Endpoint: The endpoint where the rgw service is listening. Run <code>kubectl -n rook-ceph get svc rook-ceph-rgw-my-store</code>, then combine the clusterIP and the port.</p>
<p><strong>Install s3cmd</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> proxy=http://Proxy-Name:913 &gt;&gt; /etc/yum.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum --assumeyes install s3cmd</span></span><br></pre></td></tr></table></div></figure>
<p><strong>PUT or GET an object</strong><br>Upload a file to the newly created bucket</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"Hello Rook"</span> &gt; /tmp/rookObj</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> s3cmd put /tmp/rookObj --no-ssl --host=<span class="variable">$&#123;AWS_HOST&#125;</span> --host-bucket=  s3://&lt;-Your-Bucket-Name-&gt; // As follow.</span></span><br><span class="line">// $ s3cmd put /tmp/rookObj --no-ssl --host=$&#123;AWS_HOST&#125; --host-bucket=  s3://ceph-bkt-5124df41-7939-4aa6-b989-2bff0aa38deb</span><br><span class="line">  upload: '/tmp/rookObj' -&gt; 's3://ceph-bkt-5124df41-7939-4aa6-b989-2bff0aa38deb/rookObj'  [1 of 1]</span><br><span class="line">   11 of 11   100% in    0s   190.11 B/s  done</span><br></pre></td></tr></table></div></figure>

<p>Download and verify the file from the bucket</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> s3cmd get s3://&lt;-Your-Bucket-Name-&gt;/rookObj /tmp/rookObj-download --no-ssl --host=<span class="variable">$&#123;AWS_HOST&#125;</span> --host-bucket=</span></span><br><span class="line">  download: 's3://ceph-bkt-5124df41-7939-4aa6-b989-2bff0aa38deb/rookObj' -&gt; '/tmp/rookObj-download'  [1 of 1]</span><br><span class="line">   11 of 11   100% in    0s   254.34 B/s  done</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /tmp/rookObj-download</span></span><br></pre></td></tr></table></div></figure>
<p>List the buckets</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> s3cmd ls --no-ssl --host=<span class="variable">$&#123;AWS_HOST&#125;</span> --host-bucket=</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Teardown"   >
          <a href="#Teardown" class="heading-link"><i class="fas fa-link"></i></a>Teardown</h2>
      <ol>
<li>First you will need to clean up the resources created on top of the Rook cluster.  </li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -n rook-ceph cephblockpool replicapool</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete storageclass rook-ceph-block</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f csi/cephfs/kube-registry.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete storageclass csi-cephfs</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>Delete the CephCluster CRD</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph delete cephcluster rook-ceph</span></span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>Delete the Operator and related Resources</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f operator.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f common.yaml</span></span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>删掉未删除的crd, 如果以前创建过Object bucket的话.</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph patch crd objectbuckets.objectbucket.io --<span class="built_in">type</span> merge -p <span class="string">'&#123;"metadata":&#123;"finalizers": [null]&#125;&#125;'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph patch crd objectbucketclaims.objectbucket.io --<span class="built_in">type</span> merge -p <span class="string">'&#123;"metadata":&#123;"finalizers": [null]&#125;&#125;'</span></span></span><br></pre></td></tr></table></div></figure>
<ol start="5">
<li>/var/lib/rook: Path on each host in the cluster where configuration is cached by the ceph mons and osds. so need to clean the files in the path.</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rm -rf /var/lib/rook/</span></span><br></pre></td></tr></table></div></figure>
<p>Additional: If there are ceph related files in the “/var/lib/kubelet/plugins/“ and “/var/lib/kubelet/plugins_registry/“ path, delete them.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rm -rf /var/lib/kubelet/plugins/*</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rm -rf /var/lib/kubelet/plugins_registry/*</span></span><br></pre></td></tr></table></div></figure>
<ol start="6">
<li>Delete the data on hosts</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env bash</span></span><br><span class="line">DISK="/dev/sdb"</span><br><span class="line"><span class="meta">#</span><span class="bash"> Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You will have to run this step <span class="keyword">for</span> all disks.</span></span><br><span class="line">sgdisk --zap-all $DISK</span><br><span class="line">dd if=/dev/zero of="$DISK" bs=1M count=100 oflag=direct,dsync</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These steps only have to be run once on each node</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If rook sets up osds using ceph-volume, teardown leaves some devices mapped that lock the disks.</span></span><br><span class="line">ls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove %</span><br><span class="line"><span class="meta">#</span><span class="bash"> ceph-volume setup can leave ceph-&lt;UUID&gt; directories <span class="keyword">in</span> /dev (unnecessary clutter)</span></span><br><span class="line">rm -rf /dev/ceph-*</span><br></pre></td></tr></table></div></figure>

        <h2 id="FAQ"   >
          <a href="#FAQ" class="heading-link"><i class="fas fa-link"></i></a>FAQ</h2>
      <p>If the cluster resource still exists even though you have executed the delete command earlier, see the command below remove the finalizer.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl -n rook-ceph patch crd cephclusters.ceph.rook.io --<span class="built_in">type</span> merge -p <span class="string">'&#123;"metadata":&#123;"finalizers": [null]&#125;&#125;'</span></span></span><br></pre></td></tr></table></div></figure>


        <h2 id="遇到的问题"   >
          <a href="#遇到的问题" class="heading-link"><i class="fas fa-link"></i></a>遇到的问题</h2>
      <p>删除其它机器pvc绑定的/var/lib/kubelet/plugins/*出错</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rm -rf /var/lib/kubelet/plugins/*</span></span><br><span class="line">rm: cannot remove ‘/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-d6ea6990-2a0b-4f4b-9838-3a971424732d/globalmount’: Device or resource busy</span><br><span class="line">rm: cannot remove ‘/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-a08fed0b-b16d-4a74-a052-7936d6fb8340/globalmount’: Device or resource busy</span><br></pre></td></tr></table></div></figure>
<p>解决方法:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> umount /var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-d6ea6990-2a0b-4f4b-9838-3a971424732d/globalmount</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> umount /var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-a08fed0b-b16d-4a74-a052-7936d6fb8340/globalmount</span></span><br></pre></td></tr></table></div></figure>
<p>再进行删除即可</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/storage/greenplum/greenplum_K8s_%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/">greenplum(psql) 远程连接k8s部署的greenplum</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">508</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="第一种方式-本地主机连接Kubernetes上部署的greenplum"   >
          <a href="#第一种方式-本地主机连接Kubernetes上部署的greenplum" class="heading-link"><i class="fas fa-link"></i></a>第一种方式, 本地主机连接Kubernetes上部署的greenplum</h2>
      <p>查看greenplum在kubernetes上部署的service</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get svc -n greenplum</span></span><br><span class="line">NAME        TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">agent       ClusterIP      None            &lt;none&gt;        22/TCP           6m1s</span><br><span class="line">greenplum   LoadBalancer   10.99.154.225   &lt;pending&gt;     5432:32518/TCP   6m1s</span><br></pre></td></tr></table></div></figure>

<p>宿主主机安装psql客户端和服务端<br>Reference Link: <span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/zhi-leaf/p/11432054.html"  target="_blank" rel="noopener">https://www.cnblogs.com/zhi-leaf/p/11432054.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install postgresql10</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install postgresql10-server</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /usr/pgsql-10/bin/postgresql-10-setup initdb</span></span><br><span class="line">(option) $ systemctl start postgresql-10</span><br></pre></td></tr></table></div></figure>

<p>宿主主机安装完psql后会在如下路径生成配置文件</p>
<figure class="highlight crystal"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">pgsql</span>/10/<span class="title">data</span>/</span></span><br></pre></td></tr></table></div></figure>

<p><strong>遇到的问题</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> psql -Ugpadmin -p32518 -h10.67.108.211</span></span><br><span class="line">psql: FATAL:  no pg_hba.conf entry for host "10.32.0.1", user "gpadmin", database "gpadmin", SSL off</span><br></pre></td></tr></table></div></figure>

<p><strong>解决方法</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> po/master-0 -n greenplum -it -- /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /greenplum/data-1/pg_hba.conf</span></span><br></pre></td></tr></table></div></figure>
<p>添加如下内容:</p>
<figure class="highlight angelscript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host     all         gpadmin         <span class="number">10.46</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">32</span>    trust</span><br></pre></td></tr></table></div></figure>
<p>在上面登陆的greenplum的容器里运行如下命令Reload pg_hba.conf and postgresql.conf</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gpstop -u</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="第二种方式-编写dockerfile-程序在docker里连接greenplum"   >
          <a href="#第二种方式-编写dockerfile-程序在docker里连接greenplum" class="heading-link"><i class="fas fa-link"></i></a>第二种方式, 编写dockerfile, 程序在docker里连接greenplum</h2>
      <ol>
<li>psql_lib.py内容如下</li>
</ol>
<figure class="highlight py"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> psycopg2</span><br><span class="line"><span class="keyword">import</span> sqlparse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greenplum_psql</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, database, host, user, port)</span>:</span></span><br><span class="line">        self.__database = database</span><br><span class="line">        self.__host = host</span><br><span class="line">        self.__user = user</span><br><span class="line">        self.__port = port</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        conn = psycopg2.connect(</span><br><span class="line">            dbname=self.__database, host=self.__host, user=self.__user, port=self.__port)</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">        <span class="keyword">return</span> conn, cursor</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse_psql</span><span class="params">(self, sql_cmd)</span>:</span></span><br><span class="line">        parsed_cmd = sqlparse.split(sql_cmd)</span><br><span class="line">        <span class="keyword">return</span> parsed_cmd</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_psql</span><span class="params">(self, conn, cursor, cmd)</span>:</span></span><br><span class="line">        parsed_cmd = self.__parse_psql(cmd)</span><br><span class="line">        <span class="keyword">for</span> cmd <span class="keyword">in</span> parsed_cmd:</span><br><span class="line">            cursor.execute(cmd)</span><br><span class="line">        conn.commit()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self, conn, cursor)</span>:</span></span><br><span class="line">        cursor.close()</span><br><span class="line">        conn.close()</span><br></pre></td></tr></table></div></figure>

<ol start="2">
<li>main.py内容如下</li>
</ol>
<figure class="highlight py"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> psql_lib</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    dbname = <span class="string">"template1"</span></span><br><span class="line">    host = <span class="string">"10.99.154.225"</span></span><br><span class="line">    user = <span class="string">"gpadmin"</span></span><br><span class="line">    port = <span class="string">"5432"</span></span><br><span class="line">    cmd = <span class="string">"DROP TABLE test_conn1;\</span></span><br><span class="line"><span class="string">CREATE TABLE test_conn1(id int, mediaURI text, date text);\</span></span><br><span class="line"><span class="string">INSERT INTO test_conn1 values(111, 'URI-text', '2020-11-06, 10:05');\</span></span><br><span class="line"><span class="string">select * from test_conn1;"</span></span><br><span class="line"></span><br><span class="line">    psql = psql_lib.Greenplum_psql(dbname, host, user, port)</span><br><span class="line">    conn, cursor = psql.connect()</span><br><span class="line">    psql.process_psql(conn, cursor, cmd)</span><br><span class="line"></span><br><span class="line">    rows = cursor.fetchall()</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">        print(<span class="string">'id = '</span>, row[<span class="number">0</span>], <span class="string">'name = '</span>, row[<span class="number">1</span>], <span class="string">'date = '</span>, row[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    psql.close(conn, cursor)</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>Dockerfile 内容如下</li>
</ol>
<figure class="highlight routeros"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim Dockerfile</span><br><span class="line"><span class="keyword">FROM</span> python:3.6.8</span><br><span class="line">LABEL <span class="attribute">storage</span>=<span class="string">"greenplum-sdk"</span></span><br><span class="line">WORKDIR /home/</span><br><span class="line">COPY psql_lib.py main.py ./</span><br><span class="line">ARG proxy</span><br><span class="line"><span class="builtin-name">RUN</span> pip install <span class="attribute">psycopg2</span>==2.8.3 <span class="attribute">sqlparse</span>==0.4.1 --proxy <span class="variable">$&#123;proxy&#125;</span></span><br><span class="line">CMD [<span class="string">"python"</span>, <span class="string">"main.py"</span>]</span><br></pre></td></tr></table></div></figure>
<p><strong>Build the image</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build --build-arg proxy=http://child-prc.intel.com:913 -t greenplum-client:0.1 .</span></span><br></pre></td></tr></table></div></figure>
<p><strong>Run the container</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run --name python-greenplum greenplum-client:0.1</span></span><br></pre></td></tr></table></div></figure>






</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/3/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Kung-Fu-Master</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://plus.google.com/" target="_blank" rel="noopener" data-popover="Google" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-google"></i></span></a><a class="sidebar-ov-social-item" href="https://twitter.com/" target="_blank" rel="noopener" data-popover="Twitter" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-twitter"></i></span></a><a class="sidebar-ov-social-item" href="https://youtube.com/" target="_blank" rel="noopener" data-popover="Youtube" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-youtube"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">291</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">40</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Kung-Fu-Master</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v4.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.1"></script><script src="/js/stun-boot.js?v=2.6.1"></script><script src="/js/scroll.js?v=2.6.1"></script><script src="/js/header.js?v=2.6.1"></script><script src="/js/sidebar.js?v=2.6.1"></script><script type="application/json" src="/search.json"></script></body></html>