<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.1" type="image/png" sizes="32x32"><meta name="description" content="Kubernetes 简介">
<meta property="og:type" content="article">
<meta property="og:title" content="01 Kubernetes build with kubeadm">
<meta property="og:url" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Kubernetes 简介">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/1.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/2.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/K8s_arch1.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/3.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/4.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/5.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/K8s_arch2.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/K8s_arch3.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Pod_communication1.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Pod_communication2.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Pod_communication3.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/K8s_arch4.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Pod_Scaling.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Rolling_update1.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Rolling_update2.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/k8s_architecture1.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/k8s_architecture2.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Symmetric_encryption.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/Asymmetric_encryption.JPG">
<meta property="og:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/6.JPG">
<meta property="article:published_time" content="2021-03-13T05:00:42.872Z">
<meta property="article:modified_time" content="2021-03-13T05:00:42.872Z">
<meta property="article:author" content="Kung-Fu-Master">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/1.JPG"><title>01 Kubernetes build with kubeadm | Hexo</title><link ref="canonical" href="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-feather-alt"></i></span><span class="header-nav-menu-item__text">文章</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/categories/"><span class="header-nav-submenu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-submenu-item__text">分类</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/archives/"><span class="header-nav-submenu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-submenu-item__text">归档</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/tags/"><span class="header-nav-submenu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-submenu-item__text">标签</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">01 Kubernetes build with kubeadm</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">6.9k</span></span></div></header><div class="post-body">
        <h2 id="Kubernetes-简介"   >
          <a href="#Kubernetes-简介" class="heading-link"><i class="fas fa-link"></i></a>Kubernetes 简介</h2>
      <a id="more"></a>

<p> 
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="1.JPG"  alt="">
      <br> 
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="2.JPG"  alt="">
      </p>

        <h2 id="主要特征"   >
          <a href="#主要特征" class="heading-link"><i class="fas fa-link"></i></a>主要特征</h2>
      <blockquote>
<ul>
<li>以服务为中心: 不关心服务运行的环境和细节，所以构建在kubernetes上的系统可以部署在物理机、虚拟机、公有云、私有云，在什么地方运行都是无差别的.</li>
<li>自动化: 在kubernetes里的系统可以自动扩缩容、自动升级、更新、部署. 比如:<ul>
<li>K8s收到某个指令后，会触发调度流程，选中目标节点，部署或者停止响应服务.</li>
<li>如果有新的pod启动，会被自动加入负载均衡器，自动生效</li>
<li>服务运行过程中，K8s会定期的检查它们的实例数，以及这些实例的状态是否正常，当发现某个实例不可用的时候会自动销毁不可用的实例然后重新调度一个新的实例，以上所有都是自动化完成，不需要人工参与.</li>
</ul>
</li>
</ul>
</blockquote>

        <h2 id="架构"   >
          <a href="#架构" class="heading-link"><i class="fas fa-link"></i></a>架构</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="K8s_arch1.JPG"  alt="">
      </p>

        <h2 id="Kubernetes-VS-Docker"   >
          <a href="#Kubernetes-VS-Docker" class="heading-link"><i class="fas fa-link"></i></a>Kubernetes VS Docker</h2>
      <blockquote>
<p>K8s可以看成是Docker的上层架构, 就像是javaee和java的关系,Java是一问语言，J2EE是Java语言的一门使用技术，Java为J2EE提供了库和语法，J2EE使用Java的库和语法应用在WEB上。这是概念性的区别。</p>
<ul>
<li>Java SE（Java Platform，Standard Edition）。Java SE 以前称为 J2SE。它允许开发和部署在桌面、服务器、嵌入式环境和实时环境中使用的 Java 应用程序。Java SE 包含了支持 Java Web 服务开发的类，并为 Java Platform，Enterprise Edition（Java EE）提供基础。</li>
<li>Java EE（Java Platform，Enterprise Edition）。这个版本以前称为 J2EE。企业版本帮助开发和部署可移植、健壮、可伸缩且安全的服务器端 Java 应用程序。Java EE 是在 Java SE 的基础上构建的，它提供 Web 服务、组件模型、管理和通信 API，可以用来实现企业级的面向服务体系结构（service-oriented architecture，SOA）和 Web 2.0 应用程序。</li>
<li>Java ME（Java Platform，Micro Edition）。这个版本以前称为 J2ME。Java ME 为在移动设备和嵌入式设备（比如手机、PDA、电视机顶盒和打印机）上运行的应用程序提供一个健壮且灵活的环境。Java ME 包括灵活的用户界面、健壮的安全模型、许多内置的网络协议以及对可以动态下载的连网和离线应用程序的丰富支持。基于 Java ME 规范的应用程序只需编写一次，就可以用于许多设备，而且可以利用每个设备的本机功能。</li>
</ul>
</blockquote>
<blockquote>
<p>K8s是以Docker技术的标准为基础去打造一个全新的分布式架构系统，K8s不是一定要依赖Docker，Docker是一个产品，而Docker技术是一些列的标准，只要实现了这些标准的产品都可以替代Docker，所以说K8s在底层可以支持它自己的容器技术并且经过Google的持续优化，号称在某些方面做得比Docker更加优秀，所以用不用Docker可以自己选择.</p>
</blockquote>

        <h2 id="核心概念"   >
          <a href="#核心概念" class="heading-link"><i class="fas fa-link"></i></a>核心概念</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="3.JPG"  alt="">
      <br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="4.JPG"  alt="">
      <br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="5.JPG"  alt="">
      </p>

        <h2 id="Label-标签"   >
          <a href="#Label-标签" class="heading-link"><i class="fas fa-link"></i></a>Label 标签</h2>
      <blockquote>
<p>POD，Deployment，Node等都可以打标签启到标识作用.</p>
</blockquote>

        <h2 id="POD-可以称为实例"   >
          <a href="#POD-可以称为实例" class="heading-link"><i class="fas fa-link"></i></a>POD (可以称为实例)</h2>
      <blockquote>
<ul>
<li>所有的服务，所有的应用最终都是跑在Pod中,Pod是Kubernetes概念中最小的单元，可以理解为是Kubernetes的一个原子.</li>
<li>POD 里面可以有一个或多个容器，</li>
<li>POD里面所有的容器都是运行在一台机器上</li>
<li>POD里面的容器共享网络，有一个唯一的IP</li>
<li>POD里面都会有一个容器叫做Pause容器<ul>
<li>有特定的image镜像比如pause:v1.0</li>
<li>作为根容器，把POD里其它的容器都link到一起，当我们的业务里面有两个或多个容器关系非常紧密，这时候就可以考虑把它们放到同一个POD里</li>
<li>负责整个POD的健康检查，然后汇报给K8s<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="K8s_arch2.JPG"  alt="">
      <br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="K8s_arch3.JPG"  alt="">
      </li>
</ul>
</li>
</ul>
</blockquote>

        <h2 id="Pod-通讯"   >
          <a href="#Pod-通讯" class="heading-link"><i class="fas fa-link"></i></a>Pod 通讯</h2>
      <blockquote>
<ul>
<li>Pod内容器之间通讯: 通过localhost加上端口就可以访问.<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Pod_communication1.JPG"  alt="">
      </li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>同一个Node上不同Pod之间的通讯: 同一个Node上的Pod，它们默认的路由都是Docker0，都关联在同一个Docker0网桥，地址网段是相同的，它们之间可以直接通过网桥进行通讯，访问方式是可以通过 Pod IP 直接进行访问.<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Pod_communication2.JPG"  alt="">
      </li>
</ul>
</blockquote>
<blockquote>
<p>不同Node不同Pod直接通讯: Pod的IP不能冲突，Pod的IP和Node的IP关联起来，通过关联让Pod之间可以通讯.<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Pod_communication3.JPG"  alt="">
      </p>
</blockquote>

        <h2 id="Service"   >
          <a href="#Service" class="heading-link"><i class="fas fa-link"></i></a>Service</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="K8s_arch4.JPG"  alt="">
      </p>
<blockquote>
<p>Pod具体运行在某个Node上<br>Service在Pod外再包一层IP<br>当某个Pod提供服务出现问题，会在其它地方再启动一个Pod和新的Pod的IP，我们还可以通过Service IP找到新的Pod<br>上面2台Node，3个Pod可以看做同一个应用的多个副本，对一个应用进行扩容，从一个实例扩成三个实例对外提供相同服务<br>Service除了上面可以定位到Pod地址外还可以对Pod地址进行负载均衡，比如轮训访问每个Pod<br>Pod也不一定是一模一样的，也可以是同一个应用的不同版本</p>
</blockquote>
<blockquote>
<p>通过什么方式来确定哪些Pod是一个Service? 怎么定位哪个Pod或哪几个Pod属于某个Service?<br>Kubernetes使用的是Laber Selector<br>通过配置好的Service的Select()，选择标签然后自动寻找POD, Service 对外有一个ClusterIP(Kube-proxy)，其它服务或者Client客户端就可以通过ClusterIP访问到这个Service，进而访问到最底层的POD服务</p>
</blockquote>

        <h2 id="ReplicaSet-RS-副本集-副本集这一层运行的程序可以称为应用"   >
          <a href="#ReplicaSet-RS-副本集-副本集这一层运行的程序可以称为应用" class="heading-link"><i class="fas fa-link"></i></a>ReplicaSet(RS)副本集 (副本集这一层运行的程序可以称为应用)</h2>
      <blockquote>
<p>RS是POD的上一层, 管理关联POD，如果应用运行过程中某个POD出现了异常或异常退出，RS就会保证副本始终为R，会在另一台机器重新调度一个POD</p>
</blockquote>

        <h2 id="Deployment"   >
          <a href="#Deployment" class="heading-link"><i class="fas fa-link"></i></a>Deployment</h2>
      <blockquote>
<ul>
<li>扩容: 如对一个应用(Pod)扩容，把1个Pod扩容成四个实例，扩容的是Pod而不是Service, 4个Pod拥有相同标签，ServiceIP不变并对这4个Pod实行负载均衡<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Pod_Scaling.JPG"  alt="">
      </li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>滚动更新: 一个旧的应用(RS这一层)运行了两个实例(两个POD), 更新这个应用的时候，Deployment会自动帮我们创建一个RS，并且滚动的先启动一个新版本的不改变服务的POD, 修改的可能是image(login-image:V1-&gt;V2),这时候Deployment管理的是三个实例(3个POD)，新的POD启动完成，健康检查结束，会停掉原来的POD并删掉，然后RS会再新建一个与另一个旧版本提供相同服务的POD，然后停掉另外一个旧版本POD，旧版POD停掉之后Deployment会清理掉管理旧版本的RS, 服务更新完成.<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Rolling_update1.JPG"  alt="">
      <br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Rolling_update2.JPG"  alt="">
      </li>
</ul>
</blockquote>

        <h2 id="架构设计"   >
          <a href="#架构设计" class="heading-link"><i class="fas fa-link"></i></a>架构设计</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="k8s_architecture1.JPG"  alt="">
      <br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="k8s_architecture2.JPG"  alt="">
      </p>

        <h2 id="密码学原理"   >
          <a href="#密码学原理" class="heading-link"><i class="fas fa-link"></i></a>密码学原理</h2>
      <blockquote>
<ul>
<li>对称加密:<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Symmetric_encryption.JPG"  alt="">
      </li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>非对称加密:<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="Asymmetric_encryption.JPG"  alt="">
      </li>
</ul>
</blockquote>

        <h2 id="服务之间通信加密"   >
          <a href="#服务之间通信加密" class="heading-link"><i class="fas fa-link"></i></a>服务之间通信加密:</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="6.JPG"  alt="">
      </p>
<blockquote>
<p>非对称加密非常复杂，不管是加密还是解密都非常耗时， 如果每次通信都进行非对称加密性能损耗是无法接受的<br>对称加密性能非常高，因此考虑把两者结合在一起来通信</p>
<ul>
<li>Server B 公开了自己的公钥pub_key, 任何人都可以看到</li>
<li>第一次通信，Server A 用Server B的pub_key 加密自己的秘钥，把秘钥变成密文，然后发到Server B，除了Server B可以用自己的私钥解密看到是对称加密的秘钥，中间黑客因为没有Server B的私钥因此无法解密, Server B 就知道要跟 Server A 进行对称加密的通信，并且使用的就是这个秘钥</li>
<li>之后通信, Server A就可以用发送给Server B 的秘钥对要发送的信息使用对称加密算法进行加密变成密文，然后发送给Server B， Server B收到信息后再用第一次拿到的秘钥进行对称加密算法解密.</li>
</ul>
<ul>
<li>上面的就是 SSL/TLS 协议， https底层就是通过这两个协议进行通信.</li>
</ul>
<ul>
<li>上面有个不完美地方，Server B公开pub_key， 黑客截获后再把黑客自己Server的pub_key发送给Server A, Server A拿着这个pub_key加密了自己的私钥，之后又被黑客截获并解密，虽然这些工作对黑客来说很复杂，但这种情况是有可能发生的.</li>
<li>解决方法: CA 证书认证机构，一个中间商，给所有Server颁发证书,所有正常网站的证书都在这一个地方存储，当Server A 拿到 pub_key之后会向 CA 查询这个公钥是不是合法的是不是可以信任的，CA会查自己的数据库这个pub_key是哪个公司的，它的域名是什么，包括所有人是谁等各种信息在CA都有备案，CA告诉Server A这个pub_key是我颁发的没有问题，Server A再拿着这个公钥去通信, 有时候我们访问一些网站时候，https会显示红色警告，这就说明这个网站的证书不是通过CA认证过的，一般是自己生成的.</li>
</ul>
</blockquote>

        <h2 id="服务发现"   >
          <a href="#服务发现" class="heading-link"><i class="fas fa-link"></i></a>服务发现</h2>
      <blockquote>
<ul>
<li>Kube-proxy(ClusterIP)： 为Pod创建虚拟IP，只能在集群内部访问，并且是固定的, 只要Service不删除，这个IP是不变的.</li>
<li>Kube-proxy(NodePort): 在每个Node上都启一个线程端口，把服务暴露在节点上，这样就可以让集群外的服务通过Node IP 和 NodePort去访问集群内的服务.</li>
<li>Kube-DNS: Kubernetes的一个插件，负责集群内部的DNS解析，目的是让集群内部的Pod之间通过名字去访问</li>
</ul>
</blockquote>

        <h2 id="环境搭建一篇blog"   >
          <a href="#环境搭建一篇blog" class="heading-link"><i class="fas fa-link"></i></a>环境搭建一篇blog</h2>
      <blockquote>
<ul>
<li>官方推荐使用Kubeadmin进行方便快捷的搭建.</li>
<li>网上找的个人搭建的Kubernetes, 在绿色网络环境下安装kubernetes集群，并在安装过程中加深对Kubernetes组件以及架构的理解.<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/liuyi01/kubernetes-starter"  target="_blank" rel="noopener">https://github.com/liuyi01/kubernetes-starter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</li>
</ul>
</blockquote>

        <h2 id="Download-amp-Install"   >
          <a href="#Download-amp-Install" class="heading-link"><i class="fas fa-link"></i></a>Download &amp; Install</h2>
      <p>kubernetes集群部署三种方式</p>
<ol>
<li><p>kubeadm(安装起来简单)<br>kubeadm也是一个工具，提供kubeadm init和kubeadm join，用于快速部署kubernetes集群, 官网步骤参考:<br><span class="exturl"><a class="exturl__link"   href="https://kubernetes.io/docs/tasks/tools/install-kubectl/"  target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/"  target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p>二进制包 (生产环境安装方式,比较稳定)<br>从官方下载发行版的二进制包，手动部署每个组件，组成kubernetes集群<br>地址：<span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/kubernetes/releases"  target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/releases</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/kubernetes/releases?after=v1.13.1"  target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/releases?after=v1.13.1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p>minikube<br>minikube是一个工具，可以在本地快速运行一个单点的kubernetes，仅用于尝试K8S或日常开发的测试环境使用<br>部署地址：<span class="exturl"><a class="exturl__link"   href="https://kubernetes.io/docs/setup/minkube/"  target="_blank" rel="noopener">https://kubernetes.io/docs/setup/minkube/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ol>
<p><code>这里我们使用kubeadm安装的方式搭建 kubernetes</code></p>

        <h2 id="机器配置"   >
          <a href="#机器配置" class="heading-link"><i class="fas fa-link"></i></a>机器配置</h2>
      <p>搭建K8s集群只用了一台安装Ubuntu18.04的酷睿机器.</p>
<blockquote>
<ol>
<li>Ubuntu18.04宿主主机上 download &amp; install virtualbox<br>$ apt-get install virtualbox</li>
<li>下载Ubuntu18.04镜像: <span class="exturl"><a class="exturl__link"   href="http://releases.ubuntu.com/18.04/"  target="_blank" rel="noopener">http://releases.ubuntu.com/18.04/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 选择 ubuntu-18.04.4-live-server-amd64.iso 2020-02-03 18:36 870M    Server install image for 64-bit PC (AMD64) computers (standard download)</li>
<li>用virtualbox安装两台Ubuntu18.04虚拟机<ul>
<li>虚拟机server01 作为 master; </li>
<li>虚拟机server02 作为 worker01; </li>
<li>宿主主机 作为 worker02<br>每台虚拟机 内存要大于等于 2 G ，CPU核数需要大于等于 4 核</li>
</ul>
</li>
</ol>
</blockquote>

        <h3 id="每个node都在-etc-environment-添加如下信息"   >
          <a href="#每个node都在-etc-environment-添加如下信息" class="heading-link"><i class="fas fa-link"></i></a>每个node都在 /etc/environment 添加如下信息</h3>
      <figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http_proxy</span>=<span class="string">"http://child-prc.intel.com:913/"</span></span><br><span class="line"><span class="attr">https_proxy</span>=<span class="string">"http://child-prc.intel.com:913/"</span></span><br><span class="line"><span class="attr">ftp_proxy</span>=<span class="string">"ftp://child-prc.intel.com:913/"</span></span><br><span class="line"><span class="attr">no_proxy</span>=<span class="string">"K8S_MASTER_IP,K8S_MASTER_HostName"</span>  如: no_proxy=<span class="string">"10.67.108.200,hci-node01"</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="安装docker"   >
          <a href="#安装docker" class="heading-link"><i class="fas fa-link"></i></a>安装docker</h3>
      
        <h4 id="删除旧版本docker"   >
          <a href="#删除旧版本docker" class="heading-link"><i class="fas fa-link"></i></a>删除旧版本docker</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">步骤1:</span><br><span class="line"><span class="meta">$</span><span class="bash"> rpm -qa | grep docker – – 列出包含docker字段的软件的信息</span></span><br><span class="line">  docker-ce-cli-19.03.12-3.el7.x86_64</span><br><span class="line"><span class="meta">$</span><span class="bash"> yum remove docker-ce-cli-19.03.12-3.el7.x86_64</span></span><br><span class="line"></span><br><span class="line">(optional)步骤2:</span><br><span class="line">yum remove -y docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></div></figure>


        <h4 id="配置docker源"   >
          <a href="#配置docker源" class="heading-link"><i class="fas fa-link"></i></a>配置docker源</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">sudo yum-config-manager --add-repo  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></div></figure>


        <h4 id="yum-查看docker可用版本"   >
          <a href="#yum-查看docker可用版本" class="heading-link"><i class="fas fa-link"></i></a>yum 查看docker可用版本</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line">yum list docker-ce-cli --showduplicates | sort -r</span><br><span class="line">yum list containerd.io --showduplicates | sort -r</span><br></pre></td></tr></table></div></figure>


        <h4 id="安装docker-1"   >
          <a href="#安装docker-1" class="heading-link"><i class="fas fa-link"></i></a>安装docker</h4>
      <p><strong>第一种方法:</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 安装最新版docker</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io</span><br><span class="line">// 安装指定版docker</span><br><span class="line">yum install docker-ce-19.03.14-3.el7 docker-ce-cli-19.03.14-3.el7 containerd.io-1.3.9-3.1.el7</span><br></pre></td></tr></table></div></figure>
<p><strong>第二种方法: 使用curl升级到最新版</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line">sh get-docker.sh</span><br></pre></td></tr></table></div></figure>


        <h4 id="启动docker"   >
          <a href="#启动docker" class="heading-link"><i class="fas fa-link"></i></a>启动docker</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl daemon-reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> docker</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="设置docker的proxy"   >
          <a href="#设置docker的proxy" class="heading-link"><i class="fas fa-link"></i></a>设置docker的proxy</h4>
      <p><strong>NOTE:</strong><br>如果在系统的<strong><code>/etc/environment</code></strong>中添加proxy, 则k8s安装过程api-server等组件会先读取/etc/environment文件中的proxy信息.</p>
<figure class="highlight dns"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/environment</span><br><span class="line">http_proxy="http://child-prc.intel.com:<span class="number">913</span>"</span><br><span class="line">https_proxy="http://child-prc.intel.com:<span class="number">913</span>"</span><br><span class="line">no_proxy="<span class="number">10.67.108.211</span>,<span class="number">10.67.109.142</span>,<span class="number">10.67.109.147</span>,<span class="number">10.67.109.144</span>,<span class="number">10.67.108.220</span>,<span class="number">127.0.0.1</span>,hce-node01,hce-node02,hce-node03,hce-node04"</span><br></pre></td></tr></table></div></figure>

<p><strong>第一种:</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/systemd/system/docker.service.d</span><br><span class="line">touch /etc/systemd/system/docker.service.d</span><br><span class="line">// Add proxy in this newly created file</span><br><span class="line">vim /etc/systemd/system/docker.service.d/proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment="HTTP_PROXY=http://child-prc.intel.com:913"</span><br><span class="line">Environment="HTTPS_PROXY=http://child-prc.intel.com:913"</span><br><span class="line">Environment="NO_PROXY=10.67.108.211,10.67.109.142,10.67.109.147,10.67.109.144,10.67.108.220,127.0.0.1,hce-node01,hce-node02,hce-node03,hce-node04"</span><br></pre></td></tr></table></div></figure>

<p><strong>第二种:</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir /etc/systemd/system/docker.service.d</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/systemd/system/docker.service.d/http-proxy.conf</span></span><br><span class="line">[Service]</span><br><span class="line">Environment="HTTP_PROXY=http://child-prc.intel.com:913/"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/systemd/system/docker.service.d/https-proxy.conf</span></span><br><span class="line">[Service]</span><br><span class="line">Environment="HTTPS_PROXY=http://child-prc.intel.com:913/"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/systemd/system/docker.service.d/no-proxy.conf</span></span><br><span class="line">[Service]</span><br><span class="line">Environment="NO_PROXY=10.239.140.133,10.239.141.123,master-node,node-1"</span><br></pre></td></tr></table></div></figure>

<p>之后再次加载os系统配置项然后重启docker</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl daemon-reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start docker</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="Add-docker-daemon"   >
          <a href="#Add-docker-daemon" class="heading-link"><i class="fas fa-link"></i></a>Add docker daemon</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">	$</span><span class="bash"> vim /etc/docker/daemon.json</span></span><br><span class="line">	&#123;</span><br><span class="line">	"insecure-registries" :["hce-node01:5000"],</span><br><span class="line">	"registry-mirrors": ["http://hub-mirror.c.163.com", "https://registry.docker-cn.com"], // 或者"registry-mirrors": ["https://uxk0ognt.mirror.aliyuncs.com"]</span><br><span class="line">	"live-restore": true,</span><br><span class="line">	"data-root": "/home/zhan/docker/data"</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">// 重新加载docker daemon, 以后每次修改docker 的 daemon.json后可以只执行下面的reload操作就可以了</span><br><span class="line">	systemctl reload docker</span><br><span class="line"></span><br><span class="line">// 下面方法会重启doker运行时.</span><br><span class="line">	systemctl daemon-reload</span><br><span class="line">	systemctl restart docker</span><br></pre></td></tr></table></div></figure>


        <h4 id="镜像源"   >
          <a href="#镜像源" class="heading-link"><i class="fas fa-link"></i></a>镜像源</h4>
      <p>可以同事添加多个镜像源, 如上所示<br>Docker 官方中国区：<br>    <span class="exturl"><a class="exturl__link"   href="https://registry.docker-cn.com"  target="_blank" rel="noopener">https://registry.docker-cn.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>网易：<br>    <span class="exturl"><a class="exturl__link"   href="http://hub-mirror.c.163.com"  target="_blank" rel="noopener">http://hub-mirror.c.163.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>中国科技大学：<br>    <span class="exturl"><a class="exturl__link"   href="https://docker.mirrors.ustc.edu.cn"  target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>阿里云：<br>    <span class="exturl"><a class="exturl__link"   href="https://pee6w651.mirror.aliyuncs.com"  target="_blank" rel="noopener">https://pee6w651.mirror.aliyuncs.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="kubeadm-kubelet-kubectl"   >
          <a href="#kubeadm-kubelet-kubectl" class="heading-link"><i class="fas fa-link"></i></a>kubeadm, kubelet, kubectl</h3>
      <blockquote>
<p>每台机器都安装kubeadm(二进制文件工具), kubelet(服务), master上安装kubectl(二进制文件工具), 也可以在需要kubectl控制k8s资源的worknode上也安装(也就是下载或拷贝)kubectl二进制文件工具.</p>
</blockquote>

        <h4 id="卸载旧版本kubernetes"   >
          <a href="#卸载旧版本kubernetes" class="heading-link"><i class="fas fa-link"></i></a>卸载旧版本kubernetes</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete node --all</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> service <span class="keyword">in</span> kube-apiserver kube-controller-manager kubectl kubelet kube-proxy kube-scheduler; <span class="keyword">do</span></span></span><br><span class="line">  systemctl stop $service</span><br><span class="line">  done</span><br><span class="line"><span class="meta">$</span><span class="bash"> yum -y remove kubeadm kubectl kubelet</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="安装新版kubernetes"   >
          <a href="#安装新版kubernetes" class="heading-link"><i class="fas fa-link"></i></a>安装新版kubernetes</h4>
      <p>Ubuntu:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https gnupg2</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y kubectl</span><br><span class="line">sudo apt-get install -y kubeadm</span><br><span class="line">sudo apt-get install -y kubelet</span><br></pre></td></tr></table></div></figure>
<p>Centos:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// 关闭交换区</span><br><span class="line">swapoff -a</span><br><span class="line">	Edit /etc/fstab to comment out swap partition line so that it remains disabled after reboot</span><br><span class="line"></span><br><span class="line">vim /etc/sysctl.d/k8s.conf</span><br><span class="line">	net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">	net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line">// 关闭防火墙</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line">//Set SELinux in permissive mode (effectively disabling it)</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config</span><br><span class="line"></span><br><span class="line">// 配置kubernetes安装源</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">exclude=kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">// 安装kubernetes组件</span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes // 禁掉除了这个之外的别的仓库,也就是用这个新加的kubernetes仓库来安装kubeadm等.  </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> (特定版本)yum install -y kubectl-1.19.0 kubelet-1.19.0 kubeadm-1.19.0 --disableexcludes=kubernetes</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> --now kubelet</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm version		// 通过 kubectl 命令行客户端向运行在主节点上的 Kubemetes API 服务器发出 REST 请求以与集群交互</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl version		// 客户端工具</span></span><br><span class="line">// kubelet服务配置文件路径: /var/lib/kubelet/config.yaml</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubelet --version		// kubelet是一个服务，可通过systemctl restart kubelet重启服务，每台master和worker节点都需要安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> --now kubelet</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm reset</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo hostnamectl <span class="built_in">set</span>-hostname master-node //修改机器名字, 重开终端就可以看到机器名变了</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="k8s配置自动补全命令"   >
          <a href="#k8s配置自动补全命令" class="heading-link"><i class="fas fa-link"></i></a>k8s配置自动补全命令</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装bash自动补全插件</span></span><br><span class="line">yum install bash-completion -y</span><br><span class="line"><span class="meta">#</span><span class="bash">设置kubectl与kubeadm命令补全，下次login生效</span></span><br><span class="line">kubectl completion bash &gt;/etc/bash_completion.d/kubectl</span><br><span class="line">kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br></pre></td></tr></table></div></figure>


        <h3 id="机器环境配置"   >
          <a href="#机器环境配置" class="heading-link"><i class="fas fa-link"></i></a>机器环境配置</h3>
      <p>master-node和worknode都需要设置.<br>关闭交换区, K8s认为swap性能开销比较大, 性能会大幅降低, 使用swap做云基础架构会减少性能, 因此k8s关闭swap.<br>另外重新装系统OS时候就可以不给swap分配分区.  </p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> swapoff -a			// 临时关闭交换区，$ free -h 可以查看 Swap: 0B...</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/fstab  // 设置重启后自动关闭swapoff, 将含有swap的那一行前面加<span class="string">"#"</span>注释掉就可以了</span></span><br><span class="line">  /dev/mapper/centos-swap swap                    swap    defaults        0 0</span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'/swap/d'</span> /etc/fstab	//永久关闭</span></span><br><span class="line"></span><br><span class="line">关闭防火墙</span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl stop firewalld.service</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl status firewalld.service	// 查看防火墙是否有 Active: inactive (dead) since......</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">disable</span> firewalld 			// 设置开机不启动防火墙</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sysctl net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sysctl net.bridge.bridge-nf-call-ip6tables=1</span></span><br></pre></td></tr></table></div></figure>
<p>有的说明还可以关闭网络管理器,关闭核心防护,清空iptabels, 编辑主机名</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// systemctl list-unit-files --type=service | grep NetworkManager // 查看NetworkManager是否enabled</span><br><span class="line">// systemctl status NetworkManager	// 查看NetworkManager是否running</span><br><span class="line">// systemctl stop NetworkManager		// 关闭网络, 没有IP地址无法远程连接终端, 慎用.</span><br><span class="line">// systemctl disable NetworkManager</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">iptables -F	// 清空iptables</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>Iptables原理<br>linux的防火墙由netfilter和iptables组成<br>用户空间的iptables制定防火墙规则，内核空间的netfilter实现防火墙功能netfilter（内核空间）位于Linux内核中的包过滤防火墙功能体系，称为Linux防火墙的“内核态”<br>iptables(用户空间)位于/sbin/iptables，是用来管理防火墙的命令的工具，为防火墙体系提供过滤规则/策略，决定如何过滤或处理到达防火墙主机的数据包，称为Linux防火墙的“用户态”</p>
</blockquote>
<blockquote>
<p>$ getenforce // 获得当前SELinux的模式。</p>
<ul>
<li>－enforcing        强制模式：SELinux 被启动，并强制执行所有的安全策略规则。</li>
<li>－permissive     宽容模式：SELinux 被启用，但安全策略规则并没有被强制执行。当安全策略规则应该拒绝访问时，访问仍然被允许。然而，此时会向日志文件发送一条消息，表示该访问应该被拒绝。</li>
<li>－disabled         禁用模式：SELinux 被关闭，默认的 DAC 访问控制方式被使用。对于那些不需要增强安全性的环境来说，该模式是非常有用的。<br>$ setenforce // 修改当前SELinux的模式</li>
</ul>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关闭selinux:		// 限制访问linux资源文件上下文</span><br><span class="line">getenforce			// 查看是否disabled</span><br><span class="line">setenforce 0			//临时关闭selinux(Security-Enhanced Linux), 终端会输出"setenforce: SELinux is disabled"</span><br><span class="line">vim /etc/selinux/config --&gt; 将 SELINUX=permissive 改为 SELINUX=disabled, 设置重启后自动关闭selinux</span><br><span class="line">sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config	//永久关闭</span><br><span class="line">sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config(另一种)</span><br></pre></td></tr></table></div></figure>

        <h3 id="同步系统时间"   >
          <a href="#同步系统时间" class="heading-link"><i class="fas fa-link"></i></a>同步系统时间</h3>
      <blockquote>
<p>涉及到验证签发的证书的有效性, 如果签发证书的服务器时间比使用证书的服务器时间早, 就会导致校验不成功或证书错误, 一直等到使用证书的服务器时间也运行到证书开始生效的时间后才会解决这个问题.</p>
</blockquote>

        <h4 id="第一种-手动修改时间"   >
          <a href="#第一种-手动修改时间" class="heading-link"><i class="fas fa-link"></i></a>第一种: 手动修改时间</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//查看当前系统时间</span><br><span class="line"><span class="meta">$</span><span class="bash"> date</span></span><br><span class="line">//修改当前系统时间</span><br><span class="line"><span class="meta">$</span><span class="bash"> date -s “2018-2-22 19:10:30”</span></span><br><span class="line">//查看硬件时间</span><br><span class="line"><span class="meta">$</span><span class="bash"> hwclock –show</span></span><br><span class="line">//修改硬件时间</span><br><span class="line"><span class="meta">$</span><span class="bash"> hwclock –<span class="built_in">set</span> –date “2018-2-22 19:10:30”</span></span><br><span class="line">//同步系统时间和硬件时间</span><br><span class="line"><span class="meta">$</span><span class="bash"> hwclock –hctosys</span></span><br><span class="line">//保存时钟</span><br><span class="line"><span class="meta">$</span><span class="bash"> clock -w</span></span><br><span class="line">重启系统（init 6）后便发现系统时间被修改了</span><br></pre></td></tr></table></div></figure>

        <h4 id="第二种chrony"   >
          <a href="#第二种chrony" class="heading-link"><i class="fas fa-link"></i></a>第二种chrony</h4>
      <ol>
<li>配置master机器</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//master-node安装</span><br><span class="line">yum install chrony -y</span><br><span class="line">vim /etc/chrony.conf</span><br><span class="line">......</span><br><span class="line"><span class="meta">#</span><span class="bash"> Please consider joining the pool (http://www.pool.ntp.org/join.html)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 0.centos.pool.ntp.org iburst	//注释掉或删掉</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst	//注释掉或删掉</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst	//注释掉或删掉</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst	//注释掉或删掉</span></span><br><span class="line">server 127.127.1.0 iburst		//1. 添加master充当server</span><br><span class="line">......</span><br><span class="line"><span class="meta">#</span><span class="bash"> Allow NTP client access from <span class="built_in">local</span> network</span></span><br><span class="line">allow 10.239.0.0/16				// 2. # allow 192.168.31.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash"> Serve time even <span class="keyword">if</span> not synchronized to a time <span class="built_in">source</span>.</span></span><br><span class="line">local stratum 10				// 3.</span><br></pre></td></tr></table></div></figure>
<p>重启chrony</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl start chronyd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart chronyd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> chronyd</span></span><br></pre></td></tr></table></div></figure>
<p>查看chrony端口，判断服务是否起来</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ss -unl | grep 123</span></span><br><span class="line">UNCONN     0      0            *:123                      *:*</span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>配置node机器</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//work node安装</span><br><span class="line">yum install chrony -y</span><br><span class="line">vim /etc/chrony.conf	//只添加一行，指定从master获取时间</span><br><span class="line"><span class="meta">#</span><span class="bash"> Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 0.centos.pool.ntp.org iburst	//注释</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst	//注释</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst	//注释</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst	//注释</span></span><br><span class="line">server 10.239.140.133 iburst			//添加冲master获取时间</span><br></pre></td></tr></table></div></figure>
<p>重启chrony服务, 服务重启后就与master时间同步了</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl start chronyd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart chronyd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> chronyd</span></span><br></pre></td></tr></table></div></figure>
<p>work node上不需要查看端口, 因为node的chrony不需要开启接受请求时间端口, 因此可以没有</p>
<ol start="3">
<li>work node上执行执行chronyc命令查看与master机器时间同步情况</li>
</ol>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">	$</span><span class="bash"> chronyc sources</span></span><br><span class="line">	210 Number of sources = 1</span><br><span class="line">	MS Name/IP address         Stratum Poll Reach LastRx Last sample</span><br><span class="line">	^* master-node                  10   6    77    40    -10us[ -111us] +/-   67us</span><br><span class="line">^* 表示时间已经同步完成</span><br><span class="line">^? 表示还没有同步完成, 需要等一会, 如果等一会还不行说明配置出错需要找原因</span><br></pre></td></tr></table></div></figure>


        <h4 id="第三种timedatectl-实测没啥效果"   >
          <a href="#第三种timedatectl-实测没啥效果" class="heading-link"><i class="fas fa-link"></i></a>第三种timedatectl(实测没啥效果):</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//设置系统时区为 中国/上海</span><br><span class="line"><span class="meta">$</span><span class="bash"> timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai</span></span><br><span class="line">//将当前的UTC时间写入硬件时钟</span><br><span class="line"><span class="meta">$</span><span class="bash"> timedatectl <span class="built_in">set</span>-local-rtc 0</span></span><br><span class="line">// 重启依赖于系统时间的服务</span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart rsyslog</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart crond</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="第四种ntpdate"   >
          <a href="#第四种ntpdate" class="heading-link"><i class="fas fa-link"></i></a>第四种ntpdate:</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ntpdate time.windows.com 		// 同步 windows 系统时间</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="安装镜像-可跳过"   >
          <a href="#安装镜像-可跳过" class="heading-link"><i class="fas fa-link"></i></a>安装镜像(可跳过)</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list // 查看kubeadm 下载过的images</span><br><span class="line">docker images</span><br><span class="line">docker pull gcr.io/google_containers/kube-apiserver-amd64:v1.9.3</span><br><span class="line">docker pull gcr.io/google_containers/kube-controller-manager-amd64:v1.9.3</span><br><span class="line">docker pull gcr.io/google_containers/kube-scheduler-amd64:v1.9.3</span><br></pre></td></tr></table></div></figure>


        <h3 id="添加机器到K8s集群"   >
          <a href="#添加机器到K8s集群" class="heading-link"><i class="fas fa-link"></i></a>添加机器到K8s集群</h3>
      <blockquote>
<ol>
<li>在Master主机 server01 上运行</li>
</ol>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init</span><br></pre></td></tr></table></div></figure>
<p>返回部分数据如下</p>
<figure class="highlight applescript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">Then you can join any <span class="built_in">number</span> <span class="keyword">of</span> worker nodes <span class="keyword">by</span> <span class="built_in">running</span> <span class="keyword">the</span> following <span class="keyword">on</span> each <span class="keyword">as</span> root:</span><br><span class="line"></span><br><span class="line">kubeadm join <span class="number">10.239</span><span class="number">.141</span><span class="number">.112</span>:<span class="number">6443</span> <span class="comment">--token uvm0zr.ndg144wcga276j16 \</span></span><br><span class="line">    <span class="comment">--discovery-token-ca-cert-hash sha256:e1535452b32ed4039fa2f261197c0b91179fb168e8da3dd58b99fc11fe2213b8</span></span><br><span class="line">root@server01:~<span class="comment">#</span></span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>添加kubeadm部署k8s后生成的administrator访问证书到环境变量或~/.kube目录, 使得root或其它user登陆后可以通过kubectl访问或生成k8s资源如pod等, 有如下两种方式.</p>
</blockquote>
<p>第一种:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">echo "export KUBECONFIG=/etc/kubernetes/admin.conf" | tee -a ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></div></figure>

<p>第二种(其它user而非root登陆后需要做如下操作才能通过kubectl访问或生成k8s资源如pod等):</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></div></figure>

<p>添加容器之间的通信网络, 第三方资源weave, 官网上也推荐部署其它几种通信网络方式</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d <span class="string">'\n'</span>)</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<ol start="2">
<li>之后用上面命令返回的 kubeadm join 10.239.141.112:6443 –t … 复制 并 在其它node机器(server02和宿主主机) 上运行就可以把node加进上面创建的Cluster了</li>
</ol>
</blockquote>

        <h3 id="在master-server01-机器上查看集群节点信息"   >
          <a href="#在master-server01-机器上查看集群节点信息" class="heading-link"><i class="fas fa-link"></i></a>在master server01 机器上查看集群节点信息</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl get namespaces</span><br></pre></td></tr></table></div></figure>


        <h3 id="查看node节点信息"   >
          <a href="#查看node节点信息" class="heading-link"><i class="fas fa-link"></i></a>查看node节点信息</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe node server02</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="重新-reset-在原来机器上搭建k8s集群操作"   >
          <a href="#重新-reset-在原来机器上搭建k8s集群操作" class="heading-link"><i class="fas fa-link"></i></a>重新(reset)在原来机器上搭建k8s集群操作</h2>
      <blockquote>
<p>主机名和IP解析, 通过主机名访问机器, 修改下各个节点 /etc/hosts 文件内容(实验环境没有修改，跳过这个步骤), 也可以只在master上配置, 因为很多操作都是在master上执行</p>
</blockquote>
<figure class="highlight accesslog"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="number">10.239.141.106</span> server01</span><br><span class="line"><span class="number">10.239.140.184</span> server02</span><br><span class="line"><span class="number">10.239.140.186</span> alpha</span><br></pre></td></tr></table></div></figure>

<blockquote>
<ol>
<li>需要在master节点上执行 </li>
</ol>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/kubernetes/pki/etcd/</span><br><span class="line">rm -rf /var/lib/etcd</span><br><span class="line">rm -rf $HOME/.kube</span><br><span class="line">kubeadm reset		// 出现有什么没有清理干净的可以手动删除掉, 如cni等,再reset, 如果还出现,可以忽略掉没有清理干净的信息提示, 执行kubeadm init.</span><br><span class="line">systemctl stop kubelet</span><br><span class="line">systemctl stop docker</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl restart docker</span><br><span class="line">swapoff -a</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">kubeadm init		//再用返回的 "kubeadm join..." 在其它节点执行</span><br><span class="line">echo "export KUBECONFIG=/etc/kubernetes/admin.conf" | tee -a ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></div></figure>

<blockquote>
<ol start="2">
<li>在worker节点执行:<br>检查/etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf有没有残留的kubelet服务配置文件, 有的话删掉.<br>environment_initialization.sh</li>
</ol>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker.service</span><br><span class="line">kubeadm reset</span><br><span class="line">systemctl stop kubelet</span><br><span class="line">systemctl stop docker</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl restart docker</span><br><span class="line">swapoff -a</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></div></figure>
<p>加入集群</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// $ iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X		// will reset iptables</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm join ......</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<ol start="3">
<li>再次在master节点上执行<br>如果不执行下面命令安装weave pod, kube-system命名空间下的coredns会一直处于containercreating状态.</li>
</ol>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d <span class="string">'\n'</span>)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cs</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="k8s重新生成token"   >
          <a href="#k8s重新生成token" class="heading-link"><i class="fas fa-link"></i></a>k8s重新生成token</h2>
      <p>主机上执行如下命令，主机IP:10.239.140.186</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubeadm token create</span></span><br><span class="line">v6rgnu.ydqgkuujayykkanv</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm token list</span></span><br><span class="line">TOKEN                     TTL   EXPIRES                     USAGES                   DESCRIPTION   EXTRA GROUPS</span><br><span class="line">v6rgnu.ydqgkuujayykkanv   23h   2020-05-30T13:24:41+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">'s/^.* //'</span></span></span><br><span class="line">be6606e3e081afc6f9785fbe0e129e048e5a2a5557cb2e7747d727edd20c6ed4</span><br></pre></td></tr></table></div></figure>
<p>用上面master主机上生成的token在worker节点执行如下命令:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br><span class="line">swapoff -a</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">sysctl net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">kubeadm join --token v6rgnu.ydqgkuujayykkanv --discovery-token-ca-cert-hash sha256:be6606e3e081afc6f9785fbe0e129e048e5a2a5557cb2e7747d727edd20c6ed4  10.239.140.186:6443</span><br></pre></td></tr></table></div></figure>


        <h2 id="k8s命令自动补全"   >
          <a href="#k8s命令自动补全" class="heading-link"><i class="fas fa-link"></i></a>k8s命令自动补全</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion</span><br><span class="line">echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line">bash /usr/share/bash-completion/bash_completion</span><br><span class="line">bash</span><br></pre></td></tr></table></div></figure>
<p>试试 输入 <code>kubectl get n</code> 按 <code>tab</code> 查看提示.</p>

        <h2 id="reset-iptables"   >
          <a href="#reset-iptables" class="heading-link"><i class="fas fa-link"></i></a>reset iptables</h2>
      <p><span class="exturl"><a class="exturl__link"   href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/"  target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The reset process does not reset or clean up iptables rules or IPVS tables. If you wish to reset iptables, you must do so manually:</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span></span><br><span class="line">If you want to reset the IPVS tables, you must run the following command:</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ipvsadm -C</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Additional"   >
          <a href="#Additional" class="heading-link"><i class="fas fa-link"></i></a>Additional</h2>
      
        <h3 id="重新reset-K8s集群，然后kubeadm-init遇到如下问题"   >
          <a href="#重新reset-K8s集群，然后kubeadm-init遇到如下问题" class="heading-link"><i class="fas fa-link"></i></a>重新reset K8s集群，然后kubeadm init遇到如下问题</h3>
      
        <h3 id="问题1"   >
          <a href="#问题1" class="heading-link"><i class="fas fa-link"></i></a>问题1</h3>
      <blockquote>
<p>[kubelet-check] The HTTP call equal to ‘curl -sSL <span class="exturl"><a class="exturl__link"   href="http://localhost:10248/healthz&#39;"  target="_blank" rel="noopener">http://localhost:10248/healthz&#39;</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> failed with error: Get <span class="exturl"><a class="exturl__link"   href="http://localhost:10248/healthz"  target="_blank" rel="noopener">http://localhost:10248/healthz</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>: dial tcp [::1]:10248: connect: connection refused.<br>解决方法:</p>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br><span class="line">rm -rf /etc/systemd/system/kubelet.service.d/*</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></div></figure>

        <h3 id="问题2"   >
          <a href="#问题2" class="heading-link"><i class="fas fa-link"></i></a>问题2</h3>
      <p>Unable to connect to the server: x509: certificate signed by unknown authority<br>需要删除上一次部署后cp到~/.kube的证书文件, 再重新部署一遍k8s集群</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rm -rf <span class="variable">$HOME</span>/.kube</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="问题3"   >
          <a href="#问题3" class="heading-link"><i class="fas fa-link"></i></a>问题3</h3>
      <p>The connection to the server localhost:8080 was refused - did you specify the right host or port?<br>需要添加administrator访问证书<br>第一种:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">echo "export KUBECONFIG=/etc/kubernetes/admin.conf" | tee -a ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></div></figure>
<p>第二种:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></div></figure>

        <h3 id="问题n"   >
          <a href="#问题n" class="heading-link"><i class="fas fa-link"></i></a>问题n</h3>
      <p><span class="exturl"><a class="exturl__link"   href="https://istio.io/docs/examples/bookinfo/"  target="_blank" rel="noopener">https://istio.io/docs/examples/bookinfo/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>Istio 部署bookinfo 到bookinfo命名空间， 发现只部署了svc，RS，但是没有部署pod.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml -n bookinfo</span></span><br></pre></td></tr></table></div></figure>
<p>用以下命令可以查看出错信息, 发现是webhook相关错误</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe rs/RS-NAME -n bookinfo</span></span><br></pre></td></tr></table></div></figure>
<p>解决方法是注释掉kubernetes的proxy</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">	 env:									// K8s安装会用系统的proxy，加#注释掉.</span><br><span class="line">	#- name: HTTP_PROXY</span><br><span class="line">	#  value: http://child-prc.intel.com:913</span><br><span class="line">	#- name: https_proxy</span><br><span class="line">	#  value: http://child-prc.intel.com:913</span><br><span class="line">	#- name: http_proxy</span><br><span class="line">	#  value: http://child-prc.intel.com:913</span><br><span class="line">	#- name: HTTPS_PROXY</span><br><span class="line">	#  value: http://child-prc.intel.com:913</span><br><span class="line">	 - name: no_proxy</span><br><span class="line">	   value: 10.239.140.186,10.239.140.200		// master和一个worker节点的NodeIP.</span><br></pre></td></tr></table></div></figure>

<p>稍等一会$ kubectl get po -n bookinfo 就可以看到pod慢慢部署成功了.</p>

        <h3 id="部署网络weave出错"   >
          <a href="#部署网络weave出错" class="heading-link"><i class="fas fa-link"></i></a>部署网络weave出错</h3>
      <p>Unable to update cni config: No networks found in /etc/cni/net.d</p>
<p>由于设置了代理导致的错误, kubelet 无法通过代理链接到 kube-apiserve</p>
<p>解决办法:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">unset</span> http_proxy https_proxy</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> no_proxy=&lt;your_kube_apiserver_ip&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="去掉污点Taints"   >
          <a href="#去掉污点Taints" class="heading-link"><i class="fas fa-link"></i></a>去掉污点Taints</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 允许调度 pod</span></span><br><span class="line">kubectl taint node &#123;node name&#125; node-role.kubernetes.io/master-</span><br><span class="line"><span class="meta">#</span><span class="bash"> example</span></span><br><span class="line">kubectl taint node host1 node-role.kubernetes.io/master-</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止调度 pod</span></span><br><span class="line">kubectl taint node &#123;node name&#125; node-role.kubernetes.io/master=master</span><br><span class="line"><span class="meta">#</span><span class="bash"> example</span></span><br><span class="line">kubectl taint node host1 node-role.kubernetes.io/master=master</span><br></pre></td></tr></table></div></figure>


        <h3 id="重新生成证书"   >
          <a href="#重新生成证书" class="heading-link"><i class="fas fa-link"></i></a>重新生成证书</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">有时可能过了一段时间需要添加新的 node</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成一个 token</span></span><br><span class="line">kubeadm token generate</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取证书的 <span class="built_in">hash</span> 值</span></span><br><span class="line">openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | \</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">    openssl dgst -sha256 -hex | sed <span class="string">'s/^.* //'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;<span class="built_in">hash</span>&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> example</span></span><br><span class="line">kubeadm join --token xf96mj.aq2c5v14r62rf2aw 172.16.50.10:6443  --discovery-token-ca-cert-hash sha256:a18c59189884451f71305a0107d15b79a8ac091ef9a8b9e394cad5d4b9f18162</span><br></pre></td></tr></table></div></figure>

</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://kung-fu-master.github.io">Kung-Fu-Master</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/">https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/01_kubernetes_build/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://kung-fu-master.github.io/tags/kubernetes/">kubernetes</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/03/13/micro_service/kubernetes/01_kubernetes_high_availablity_build/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">01 Kubernetes build high availability</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/03/13/micro_service/kubernetes/01_kubernetes%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E5%92%8C%E9%85%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6/"><span class="paginator-prev__text">01 Kubernetes安装方式和配置条件</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes-简介"><span class="toc-number">1.</span> <span class="toc-text">
          Kubernetes 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主要特征"><span class="toc-number">2.</span> <span class="toc-text">
          主要特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#架构"><span class="toc-number">3.</span> <span class="toc-text">
          架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes-VS-Docker"><span class="toc-number">4.</span> <span class="toc-text">
          Kubernetes VS Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心概念"><span class="toc-number">5.</span> <span class="toc-text">
          核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Label-标签"><span class="toc-number">6.</span> <span class="toc-text">
          Label 标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POD-可以称为实例"><span class="toc-number">7.</span> <span class="toc-text">
          POD (可以称为实例)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-通讯"><span class="toc-number">8.</span> <span class="toc-text">
          Pod 通讯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service"><span class="toc-number">9.</span> <span class="toc-text">
          Service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicaSet-RS-副本集-副本集这一层运行的程序可以称为应用"><span class="toc-number">10.</span> <span class="toc-text">
          ReplicaSet(RS)副本集 (副本集这一层运行的程序可以称为应用)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment"><span class="toc-number">11.</span> <span class="toc-text">
          Deployment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#架构设计"><span class="toc-number">12.</span> <span class="toc-text">
          架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#密码学原理"><span class="toc-number">13.</span> <span class="toc-text">
          密码学原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务之间通信加密"><span class="toc-number">14.</span> <span class="toc-text">
          服务之间通信加密:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务发现"><span class="toc-number">15.</span> <span class="toc-text">
          服务发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建一篇blog"><span class="toc-number">16.</span> <span class="toc-text">
          环境搭建一篇blog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Download-amp-Install"><span class="toc-number">17.</span> <span class="toc-text">
          Download &amp; Install</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#机器配置"><span class="toc-number">18.</span> <span class="toc-text">
          机器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#每个node都在-etc-environment-添加如下信息"><span class="toc-number">18.1.</span> <span class="toc-text">
          每个node都在 &#x2F;etc&#x2F;environment 添加如下信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装docker"><span class="toc-number">18.2.</span> <span class="toc-text">
          安装docker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#删除旧版本docker"><span class="toc-number">18.2.1.</span> <span class="toc-text">
          删除旧版本docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置docker源"><span class="toc-number">18.2.2.</span> <span class="toc-text">
          配置docker源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yum-查看docker可用版本"><span class="toc-number">18.2.3.</span> <span class="toc-text">
          yum 查看docker可用版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装docker-1"><span class="toc-number">18.2.4.</span> <span class="toc-text">
          安装docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动docker"><span class="toc-number">18.2.5.</span> <span class="toc-text">
          启动docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置docker的proxy"><span class="toc-number">18.2.6.</span> <span class="toc-text">
          设置docker的proxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-docker-daemon"><span class="toc-number">18.2.7.</span> <span class="toc-text">
          Add docker daemon</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#镜像源"><span class="toc-number">18.2.8.</span> <span class="toc-text">
          镜像源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubeadm-kubelet-kubectl"><span class="toc-number">18.3.</span> <span class="toc-text">
          kubeadm, kubelet, kubectl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#卸载旧版本kubernetes"><span class="toc-number">18.3.1.</span> <span class="toc-text">
          卸载旧版本kubernetes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装新版kubernetes"><span class="toc-number">18.3.2.</span> <span class="toc-text">
          安装新版kubernetes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#k8s配置自动补全命令"><span class="toc-number">18.3.3.</span> <span class="toc-text">
          k8s配置自动补全命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#机器环境配置"><span class="toc-number">18.4.</span> <span class="toc-text">
          机器环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同步系统时间"><span class="toc-number">18.5.</span> <span class="toc-text">
          同步系统时间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一种-手动修改时间"><span class="toc-number">18.5.1.</span> <span class="toc-text">
          第一种: 手动修改时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二种chrony"><span class="toc-number">18.5.2.</span> <span class="toc-text">
          第二种chrony</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三种timedatectl-实测没啥效果"><span class="toc-number">18.5.3.</span> <span class="toc-text">
          第三种timedatectl(实测没啥效果):</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第四种ntpdate"><span class="toc-number">18.5.4.</span> <span class="toc-text">
          第四种ntpdate:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装镜像-可跳过"><span class="toc-number">18.6.</span> <span class="toc-text">
          安装镜像(可跳过)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加机器到K8s集群"><span class="toc-number">18.7.</span> <span class="toc-text">
          添加机器到K8s集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在master-server01-机器上查看集群节点信息"><span class="toc-number">18.8.</span> <span class="toc-text">
          在master server01 机器上查看集群节点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看node节点信息"><span class="toc-number">18.9.</span> <span class="toc-text">
          查看node节点信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重新-reset-在原来机器上搭建k8s集群操作"><span class="toc-number">19.</span> <span class="toc-text">
          重新(reset)在原来机器上搭建k8s集群操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s重新生成token"><span class="toc-number">20.</span> <span class="toc-text">
          k8s重新生成token</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s命令自动补全"><span class="toc-number">21.</span> <span class="toc-text">
          k8s命令自动补全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reset-iptables"><span class="toc-number">22.</span> <span class="toc-text">
          reset iptables</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Additional"><span class="toc-number">23.</span> <span class="toc-text">
          Additional</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#重新reset-K8s集群，然后kubeadm-init遇到如下问题"><span class="toc-number">23.1.</span> <span class="toc-text">
          重新reset K8s集群，然后kubeadm init遇到如下问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题1"><span class="toc-number">23.2.</span> <span class="toc-text">
          问题1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题2"><span class="toc-number">23.3.</span> <span class="toc-text">
          问题2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题3"><span class="toc-number">23.4.</span> <span class="toc-text">
          问题3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题n"><span class="toc-number">23.5.</span> <span class="toc-text">
          问题n</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署网络weave出错"><span class="toc-number">23.6.</span> <span class="toc-text">
          部署网络weave出错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#去掉污点Taints"><span class="toc-number">23.7.</span> <span class="toc-text">
          去掉污点Taints</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重新生成证书"><span class="toc-number">23.8.</span> <span class="toc-text">
          重新生成证书</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Kung-Fu-Master</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://plus.google.com/" target="_blank" rel="noopener" data-popover="Google" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-google"></i></span></a><a class="sidebar-ov-social-item" href="https://twitter.com/" target="_blank" rel="noopener" data-popover="Twitter" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-twitter"></i></span></a><a class="sidebar-ov-social-item" href="https://youtube.com/" target="_blank" rel="noopener" data-popover="Youtube" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-youtube"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">290</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">40</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Kung-Fu-Master</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v4.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.1"></script><script src="/js/stun-boot.js?v=2.6.1"></script><script src="/js/scroll.js?v=2.6.1"></script><script src="/js/header.js?v=2.6.1"></script><script src="/js/sidebar.js?v=2.6.1"></script><script type="application/json" src="/search.json"></script></body></html>