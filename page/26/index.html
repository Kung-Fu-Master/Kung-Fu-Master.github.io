<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.1" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://kung-fu-master.github.io/page/26/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Kung-Fu-Master">
<meta name="twitter:card" content="summary"><title>Hexo</title><link ref="canonical" href="https://kung-fu-master.github.io/page/26/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-feather-alt"></i></span><span class="header-nav-menu-item__text">文章</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/categories/"><span class="header-nav-submenu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-submenu-item__text">分类</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/archives/"><span class="header-nav-submenu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-submenu-item__text">归档</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/tags/"><span class="header-nav-submenu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-submenu-item__text">标签</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hexo</div><div class="header-banner-info__subtitle"></div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/micro_service/istio/istio_K8s_SpringCloud/">Istio_K8s_SpringCloud</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">123</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>SpringCloud、Istio比较</p>
<blockquote>
<p><span class="exturl"><a class="exturl__link"   href="https://blog.csdn.net/qq_33873431/article/details/89524554"  target="_blank" rel="noopener">https://blog.csdn.net/qq_33873431/article/details/89524554</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>Spring Cloud Netflix vs. Kubernetes＆Istio</p>
<blockquote>
<p><span class="exturl"><a class="exturl__link"   href="https://my.oschina.net/xiaominmin/blog/1859677"  target="_blank" rel="noopener">https://my.oschina.net/xiaominmin/blog/1859677</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://my.oschina.net/xiaominmin?tab=newest&amp;catalogId=5894416"  target="_blank" rel="noopener">https://my.oschina.net/xiaominmin?tab=newest&amp;catalogId=5894416</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>史上最简单的spark系列教程</p>
<blockquote>
<p><span class="exturl"><a class="exturl__link"   href="https://blog.csdn.net/youbitch1/article/details/89925790"  target="_blank" rel="noopener">https://blog.csdn.net/youbitch1/article/details/89925790</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>Spark教程视频:<br><span class="exturl"><a class="exturl__link"   href="https://www.bilibili.com/video/BV1JE411R7Xp?p=55"  target="_blank" rel="noopener">https://www.bilibili.com/video/BV1JE411R7Xp?p=55</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://www.bilibili.com/video/BV11J41147iP?p=1"  target="_blank" rel="noopener">https://www.bilibili.com/video/BV11J41147iP?p=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://www.bilibili.com/video/BV11J41147iP?p=1"  target="_blank" rel="noopener">https://www.bilibili.com/video/BV11J41147iP?p=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>Istio B站学习视频和对应的Gihub文档</p>
<blockquote>
<p><span class="exturl"><a class="exturl__link"   href="https://www.bilibili.com/video/BV1vt411H755/?spm_id_from=333.788.videocard.0"  target="_blank" rel="noopener">https://www.bilibili.com/video/BV1vt411H755/?spm_id_from=333.788.videocard.0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link"   href="https://github.com/Kung-Fu-Master/Document"  target="_blank" rel="noopener">https://github.com/Kung-Fu-Master/Document</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>Istio中文社区:</p>
<blockquote>
<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://istio.cn/"  target="_blank" rel="noopener">中文社区</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://istio.cn/t/topic/270"  target="_blank" rel="noopener">Istio 1.5发布</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</blockquote>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/micro_service/istio/istio_cert_manager/">istio cert-manager</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">43</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="cert-manager"   >
          <a href="#cert-manager" class="heading-link"><i class="fas fa-link"></i></a>cert-manager</h2>
      <p>Official website:<br><span class="exturl"><a class="exturl__link"   href="https://istio.io/latest/zh/docs/ops/integrations/certmanager/"  target="_blank" rel="noopener">https://istio.io/latest/zh/docs/ops/integrations/certmanager/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   href="https://cert-manager.io/"  target="_blank" rel="noopener">cert-manager</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是一种自动执行证书管理的工具，它可以与 Istio Gateway 集成以管理 TLS 证书。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/micro_service/istio/istio_problems/">Istio problems</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">111</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="istio-bookinfo部署不成功"   >
          <a href="#istio-bookinfo部署不成功" class="heading-link"><i class="fas fa-link"></i></a>istio bookinfo部署不成功</h2>
      <p>部署istio官网bookinfo出现以下错误</p>
<pre><code>$ kubectl describe replicaset.apps/details-v1-769468b8c -n book-info
  Warning  FailedCreate  3s (x13 over 24s)  replicaset-controller  Error creating: Internal error occurred: failed calling webhook &quot;sidecar-injector.istio.io&quot;: Post &quot;https://istiod.istio-system.svc:443/inject?timeout=30s&quot;: x509: certificate signed by unknown authority</code></pre><p>官网推荐解决方法: <span class="exturl"><a class="exturl__link"   href="https://istio.io/latest/docs/ops/common-problems/injection/#automatic-sidecar-injection-fails-if-the-kubernetes-api-server-has-proxy-settings"  target="_blank" rel="noopener">https://istio.io/latest/docs/ops/common-problems/injection/#automatic-sidecar-injection-fails-if-the-kubernetes-api-server-has-proxy-settings</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>注释掉  /etc/kubernetes/manifests/kube-apiserver.yaml 文件里的proxy</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/micro_service/istio/istio_%E6%9F%A5%E7%9C%8B%E5%92%8C%E5%BB%B6%E9%95%BF%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6/">istio 查看和延长自签名证书</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">13</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>Official website:<br><span class="exturl"><a class="exturl__link"   href="https://istio.io/latest/zh/docs/ops/configuration/security/root-transition/"  target="_blank" rel="noopener">https://istio.io/latest/zh/docs/ops/configuration/security/root-transition/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/micro_service/istio/istio_%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E7%AD%96%E7%95%A5/">istio 限制访问策略</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">26</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>Official website:<br><span class="exturl"><a class="exturl__link"   href="https://istio.io/latest/docs/concepts/security/#authorization-policies"  target="_blank" rel="noopener">https://istio.io/latest/docs/concepts/security/#authorization-policies</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>(已经弃用)<span class="exturl"><a class="exturl__link"   href="https://istio.io/latest/docs/tasks/policy-enforcement/denial-and-list/"  target="_blank" rel="noopener">https://istio.io/latest/docs/tasks/policy-enforcement/denial-and-list/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/linux/%E6%9F%A5%E7%9C%8BSSD/">查看SSD</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">348</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>[root@wlp10 ~]# lsscsi -ls<br>[6:0:0:0]    disk    ATA      INTEL SSDSC2BB48 0370  /dev/sda    480GB<br>  state=running queue_depth=32 scsi_level=6 type=0 device_blocked=0 timeout=30<br>[7:0:0:0]    disk    ATA      INTEL SSDSC2BB48 0101  /dev/sdb    480GB<br>  state=running queue_depth=32 scsi_level=6 type=0 device_blocked=0 timeout=30<br>[8:0:0:0]    disk    ATA      INTEL SSDSC2BB48 0370  /dev/sdc    480GB<br>  state=running queue_depth=32 scsi_level=6 type=0 device_blocked=0 timeout=30<br>[9:0:0:0]    disk    ATA      INTEL SSDSC2BG01 0015  /dev/sdd   1.20TB<br>  state=running queue_depth=32 scsi_level=6 type=0 device_blocked=0 timeout=30<br>[root@wlp10 ~]#<br>看第四列就知道是否是SSD硬盘了</p>
<p>[root@wlp10 ~]# lsscsi -h<br>Usage: lsscsi   [–classic] [–device] [–generic] [–help] [–hosts]<br>                [–kname] [–list] [–lunhex] [–long] [–protection]<br>                [–scsi_id] [–size] [–sysfsroot=PATH] [–transport]<br>                [–verbose] [–version] [–wwn] [&lt;h:c:t:l&gt;]<br>  where:<br>    –classic|-c      alternate output similar to ‘cat /proc/scsi/scsi’<br>    –device|-d       show device node’s major + minor numbers<br>    –generic|-g      show scsi generic device name<br>    –help|-h         this usage information<br>    –hosts|-H        lists scsi hosts rather than scsi devices<br>    –kname|-k        show kernel name instead of device node name<br>    –list|-L         additional information output one<br>                      attribute=value per line<br>    –long|-l         additional information output<br>    –lunhex|-x       show LUN part of tuple as hex number in T10 format;<br>                      use twice to get full 16 digit hexadecimal LUN<br>    –protection|-p   show target and initiator protection information<br>    –protmode|-P     show negotiated protection information mode<br>    –scsi_id|-i      show udev derived /dev/disk/by-id/scsi* entry<br>    –size|-s         show disk size<br>    –sysfsroot=PATH|-y PATH    set sysfs mount point to PATH (def: /sys)<br>    –transport|-t    transport information for target or, if ‘–hosts’<br>                      given, for initiator<br>    –verbose|-v      output path names where data is found<br>    –version|-V      output version string and exit<br>    –wwn|-w          output WWN for disks (from /dev/disk/by-id/wwn<em>)<br>    &lt;h:c:t:l&gt;         filter output list (def: ‘</em>:<em>:</em>:*’ (all))</p>
<p>List SCSI devices or hosts, optionally with additional information<br>[root@wlp10 ~]#</p>
<p>From <span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/laozhuang/p/7110438.html"  target="_blank" rel="noopener">https://www.cnblogs.com/laozhuang/p/7110438.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/linux/%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98-%E4%BD%BF%E7%94%A8dev_mem&amp;mmap/">用户态和内核共享内存----使用 /dev/mem &amp; mmap</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">938</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>想法的来源是看到chinaunix上有人转载了wheelz的博客，但是wheelz的代码在我的实验平台上是不能正常工作的，可能是wheelz的代码太过久远，我试验的内核版本是：3.4.13。wheelz的源代码如下：<br>// 内核模块<br>#include &lt;linux/config.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/mm.h&gt;<br>MODULE_LICENSE(“GPL”);<br>MODULE_AUTHOR(“Wheelz”);<br>MODULE_DESCRIPTION(“mmap demo”);<br>static unsigned long p = 0;<br>static int __init init(void)<br>{<br>        //分配共享内存（一个页面）<br>        p = __get_free_pages(GFP_KERNEL, 0);<br>        SetPageReserved(virt_to_page(p));<br>        printk(“&lt;1&gt; p = 0x%08x\n”, p);<br>    //p是内核中的虚拟地址<br>        //在共享内存中写上一个字符串<br>        strcpy(p, “Hello world!\n”);<br>        return 0;<br>}<br>static void __exit fini(void)<br>{<br>        ClearPageReserved(virt_to_page(p));<br>        free_pages(p, 0);<br>}<br>module_init(init);<br>module_exit(fini);</p>
<hr>
<p>// 用户态程序<br>#include &lt;sys/mman.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdio.h&gt;<br>#define PAGE_SIZE (4*1024)<br>#define PAGE_OFFSET                0xc0000000<br>#define KERNEL_VIRT_ADDR        0xc5e3c000<br>int main()<br>{<br>        char *buf;<br>        int fd;<br>        unsigned long phy_addr;<br>fd=open(“/dev/mem”,O_RDWR);<br>if(fd == -1)<br>                perror(“open”);<br>        phy_addr=KERNEL_VIRT_ADDR - PAGE_OFFSET;<br>        //此处不太懂，不能理解物理地址phy_addr的计算方法<br>        buf=mmap(0, PAGE_SIZE,<br>                PROT_READ|PROT_WRITE, MAP_SHARED,<br>                fd, phy_addr);<br>        if(buf == MAP_FAILED)<br>                perror(“mmap”);<br>puts(buf);//打印共享内存的内容<br>        munmap(buf,PAGE_SIZE);<br>        close(fd);<br>        return 0;<br>}<br>在网上找了一些资料，导致这段代码不工作的原因可能有一下几个：<br>（1）在编译内核时设置了CONFIG_STRICT_DEVMEM（某些版本中是CONFIG_NONPROMISC_DEVMEM），应该将此设置删除。<br>（2）请求的地址没有通过内核中devmem_is_allowed函数对/dev/mem的保护。<br>（3）物理地址phy_addr计算错误。（PS：wheelz的计算方法是怎么得到的？）</p>
<p>我对上面的几个问题一一做了修改：<br>（1）修改了.config文件</p>

        <h1 id="CONFIG-STRICT-DEVMEM-is-not-set"   >
          <a href="#CONFIG-STRICT-DEVMEM-is-not-set" class="heading-link"><i class="fas fa-link"></i></a>CONFIG_STRICT_DEVMEM is not set</h1>
      <p>（２）重写arch/x86/mm/init.c下的devmem_is_allowed函数，这里我没有做太细致的修改，只是让函数一直返回1。当然这可能会存在一些问题。</p>
<p>/*</p>
<ul>
<li>devmem_is_allowed() checks to see if /dev/mem access to a certain address</li>
<li>is valid. The argument is a physical page number.</li>
<li></li>
<li></li>
<li>On x86, access has to be given to the first megabyte of ram because that area</li>
<li>contains bios code and data regions used by X and dosemu and similar apps.</li>
<li>Access has to be given to non-kernel-ram areas as well, these contain the PCI</li>
<li>mmio resources as well as potential bios/acpi data regions.</li>
<li>/<br>int devmem_is_allowed(unsigned long pagenr)<br>{<br>return 1;<pre><code>if (pagenr &lt;= 256)
        return 1;
if (iomem_is_exclusive(pagenr &lt;&lt; PAGE_SHIFT))
        return 0;
if (!page_is_ram(pagenr))
        return 1;
return 0;</code></pre>}<br>（3）修改物理地址的计算，这里我们直接使用内核中提供的转换函数virt_to_phy()或者__pa()。</li>
</ul>
<p>// 内核模块<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/mm.h&gt;<br>MODULE_LICENSE(“GPL”);<br>MODULE_AUTHOR(“godjesse”);<br>MODULE_DESCRIPTION(“mmap demo”);<br>static unsigned long p = 0;<br>static unsigned long pp = 0;<br>static int __init init(void)<br>{<br>        p = __get_free_pages(GFP_KERNEL, 0);<br>if(!p)<br>        {<br>                printk(“Allocate memory failure!/n”);<br>        }<br>        else<br>        {<br>                SetPageReserved(virt_to_page(p));<br>// 使用virt_to_phys计算物理地址，供用户态程序使用<br>                pp = (unsigned long)virt_to_phys((void *)p);<br>                printk(“&lt;1&gt; page : pp = 0x%lx\n”,pp);<br>        }<br>        strcpy((char *)p, “Hello world !\n”);<br>        return 0;<br>}<br>static void __exit fini(void)<br>{<br>printk(“The content written by user is: %s/n”, (unsigned char *)p);<br>        ClearPageReserved(virt_to_page(p));<br>        free_pages(p, 0);<br>        printk(“ exit \n”);<br>}<br>module_init(init);<br>module_exit(fini);</p>
<hr>
<p>// 用户态程序<br>#include &lt;sys/mman.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;string.h&gt;<br>//hard coding read after the module installed<br>#define KERNEL_PHY_ADDR  0x3737c000<br>int main()<br>{<br>char *buf;<br>        int fd;<br>        unsigned long phy_addr;<br>        int  pagesize = getpagesize();<br>phy_addr=KERNEL_PHY_ADDR;<br>fd=open(“/dev/mem”,O_RDWR);<br>if(fd == -1)<br>                perror(“open”);<br>buf=mmap(0, pagesize, PROT_READ|PROT_WRITE, MAP_SHARED, fd, phy_addr);<br>if(buf == MAP_FAILED)<br>        {<br>                perror(“mmap”);<br>        }<br>printf(“buf : %s\n”,buf);<br>// test the write<br>        buf[0] = ‘X’;<br>munmap(buf,pagesize);<br>        close(fd);<br>        return 0;<br>}</p>
<p> 经过这些修改后，demo可以正常工作。<br>上文中提到修改devmem_is_allowed实际上是存在问题的，存在其他一些较为优雅的方法，如某牛人写的博客：bypassing devmem_is_allowed with kernel probes，博客链接：<br><span class="exturl"><a class="exturl__link"   href="http://www.libcrack.so/2012/09/02/bypassing-devmem_is_allowed-with-kprobes/"  target="_blank" rel="noopener">http://www.libcrack.so/2012/09/02/bypassing-devmem_is_allowed-with-kprobes/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>相关资料：<br><span class="exturl"><a class="exturl__link"   href="http://stackoverflow.com/questions/11891979/accessing-mmaped-dev-mem"  target="_blank" rel="noopener">http://stackoverflow.com/questions/11891979/accessing-mmaped-dev-mem</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
<p>From <span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/godjesse/archive/2012/11/23/2784093.html"  target="_blank" rel="noopener">https://www.cnblogs.com/godjesse/archive/2012/11/23/2784093.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/linux/%E7%A1%AC%E7%9B%98%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%8D%95%E4%BD%8DGB/">硬盘存储空间单位GB</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">101</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>信息技术的存储设备常用B、KB、MB、GB等作为存储设备的单位,例如,我们常说的某计算机的硬盘容量是320GB,某移动硬盘的容量是80GB,某个文件夹的大小是156KB等,其中1GB=210MB,1MB=210KB,1KB=210B(字节),对于一个容量为8GB的内存盘,其容量为____B(字节).<br>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="unit_GB.gif"  alt="">
      </p>
<p>From <span class="exturl"><a class="exturl__link"   href="http://www.manfen5.com/stinfo/CZ_SX/SYS201808030701323019115696/"  target="_blank" rel="noopener">http://www.manfen5.com/stinfo/CZ_SX/SYS201808030701323019115696/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/linux/%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E9%94%99%E8%AF%AF_r_command%20not%20found/">脚本执行错误 $'\r':command not found</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">221</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>shell脚本执行错误 $’\r’:command not found<br>第一种解决方案：<br>Linux下有命令dos2unix<br>你只要输入dos2unix *.sh就可以完成转换工作了<br>如果命令不存在的话就用如下命令安装<br>yum install dos2unix -y</p>
<p>第二种解决方案：<br>这种情况发生的原因是因为你所处理的文件换行符是dos格式的”\r\n”<br>可以使用cat -v 文件名 来查看换行符是否是，如果是上述的，则行结尾会是^m<br>需要转换成linux/unix格式的”\n<br>sed ‘s/\r//‘ 原文件 &gt;转换后文件<br>第三种解决方案：<br>首先要确保文件有可执行权限<br>#sh&gt;chmod a+x filename<br>利用如下命令查看文件格式<br>:set ff 或 :set fileformat<br>可以看到如下信息<br>fileformat=dos 或 fileformat=unix<br>利用如下命令修改文件格式<br>:set ff=unix 或 :set fileformat=unix</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/03/13/linux/%E8%BF%9E%E6%8E%A5router%E5%90%8E%E6%9C%BA%E5%99%A8%E8%BF%9E%E4%B8%8D%E4%B8%8A%E5%A4%96%E7%BD%91/">连接router后机器连不上外网</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">584</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>几台机器连接同一个路由器router后，centos机器连不上外网<br>[root@sphm001 ~]# route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.1.1    0.0.0.0         UG    100    0        0 enp0s31f6<br>0.0.0.0         10.239.173.1    0.0.0.0         UG    101    0        0 enp0s20f0u8<br>10.239.173.0    0.0.0.0         255.255.255.0   U     101    0        0 enp0s20f0u8<br>192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s31f6<br>[root@sphm001 ~]#<br>[root@sphm001 ~]# route del -net 0.0.0.0 gw 192.168.1.1<br>[root@sphm001 ~]# route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.239.173.1    0.0.0.0         UG    101    0        0 enp0s20f0u8<br>10.239.173.0    0.0.0.0         255.255.255.0   U     101    0        0 enp0s20f0u8<br>192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s31f6<br>[root@sphm001 ~]#<br>[root@sphm001 ~]# wget <span class="exturl"><a class="exturl__link"   href="http://www.baidu.com"  target="_blank" rel="noopener">www.baidu.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>–1998-01-29 23:28:17–  <span class="exturl"><a class="exturl__link"   href="http://www.baidu.com/"  target="_blank" rel="noopener">http://www.baidu.com/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>Resolving child-prc.intel.com (child-prc.intel.com)… 10.239.4.101<br>Connecting to child-prc.intel.com (child-prc.intel.com)|10.239.4.101|:913… connected.<br>Proxy request sent, awaiting response… 200 OK<br>Length: 2381 (2.3K) [text/html]<br>Saving to: ‘index.html.1’</p>
<p>100%[============================================================================================&gt;] 2,381       –.-K/s   in 0s</p>
<p>1998-01-29 23:28:17 (81.6 MB/s) - ‘index.html.1’ saved [2381/2381]<br>修改完路由如果还不行就重启机器试试<br>[root@sphm001 ~]#</p>
<p>linux上用route添加/删除路由</p>
<ol>
<li>查看<br>route -n<ol start="2">
<li>添加<br>route add -net 9.123.0.0 netmask 255.255.0.0 gw 9.123.0.1</li>
<li>删除<br>route del -net 9.123.0.0 netmask 255.255.0.0 gw 9.123.0.1</li>
</ol>
</li>
</ol>
<p>有些童鞋问怎么加永久路由，很简单，把 “route add -net 9.123.0.0 netmask 255.255.0.0 gw 9.123.0.1” 写到/etc/rc.local最后就行了，<br>或者复制编辑好执行也可以：<br>echo “route add -net 9.123.0.0 netmask 255.255.0.0 gw 9.123.0.1” &gt;&gt; /etc/rc.local</p>
<p>实际中发现，CentOS7.4默认环境下，rc.local中不会执行，需要赋权才可以<br>chmod +x /etc/rc.local</p>
<p>From <span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/lynsen/p/8027446.html"  target="_blank" rel="noopener">https://www.cnblogs.com/lynsen/p/8027446.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
<figure class="highlight haml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~~</span><br></pre></td></tr></table></div></figure>
<pre><code>SPH + RVP
root@imie:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.239.173.1    0.0.0.0         UG    0      0        0 eth1
10.239.173.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
root@imie:~#


root@imie:~# vim /etc/network/interfaces
iface lo inet loopback

# Wired interfaces
auto eth0 eth1
iface eth0 inet dhcp
iface eth1 inet dhcp

# iface eth0 inet manual
# iface eth1 inet manual

# Network bridge
# auto br0
# iface br0 inet dhcp
#   bridge_ports eth0 eth1</code></pre></div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/25/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><span class="page-number current">26</span><a class="page-number" href="/page/27/">27</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/27/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Kung-Fu-Master</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://plus.google.com/" target="_blank" rel="noopener" data-popover="Google" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-google"></i></span></a><a class="sidebar-ov-social-item" href="https://twitter.com/" target="_blank" rel="noopener" data-popover="Twitter" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-twitter"></i></span></a><a class="sidebar-ov-social-item" href="https://youtube.com/" target="_blank" rel="noopener" data-popover="Youtube" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-youtube"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">289</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">40</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Kung-Fu-Master</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v4.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.1"></script><script src="/js/stun-boot.js?v=2.6.1"></script><script src="/js/scroll.js?v=2.6.1"></script><script src="/js/header.js?v=2.6.1"></script><script src="/js/sidebar.js?v=2.6.1"></script><script type="application/json" src="/search.json"></script></body></html>