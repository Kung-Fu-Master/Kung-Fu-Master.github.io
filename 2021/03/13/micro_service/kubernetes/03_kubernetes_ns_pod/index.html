<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.1" type="image/png" sizes="32x32"><meta name="description" content="nodes       1234567891011$ kubectl get nodes -o wideNAME         STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CO">
<meta property="og:type" content="article">
<meta property="og:title" content="03 Kubernetes nodes, namespace, pod">
<meta property="og:url" content="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/03_kubernetes_ns_pod/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="nodes       1234567891011$ kubectl get nodes -o wideNAME         STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CO">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-13T05:00:42.872Z">
<meta property="article:modified_time" content="2021-03-13T05:00:42.872Z">
<meta property="article:author" content="Kung-Fu-Master">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary"><title>03 Kubernetes nodes, namespace, pod | Hexo</title><link ref="canonical" href="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/03_kubernetes_ns_pod/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-feather-alt"></i></span><span class="header-nav-menu-item__text">文章</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/categories/"><span class="header-nav-submenu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-submenu-item__text">分类</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/archives/"><span class="header-nav-submenu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-submenu-item__text">归档</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/tags/"><span class="header-nav-submenu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-submenu-item__text">标签</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">03 Kubernetes nodes, namespace, pod</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-13</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">9.4k</span></span></div></header><div class="post-body">
        <h2 id="nodes"   >
          <a href="#nodes" class="heading-link"><i class="fas fa-link"></i></a>nodes</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes -o wide</span></span><br><span class="line">NAME         STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">hci-node01   Ready    master   5d    v1.18.1   10.67.108.211   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.8</span><br><span class="line">hci-node02   Ready    &lt;none&gt;   5d    v1.18.1   10.67.109.142   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.8</span><br><span class="line">hci-node03   Ready    &lt;none&gt;   5d    v1.18.1   10.67.109.147   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.8</span><br><span class="line">hci-node04   Ready    &lt;none&gt;   5d    v1.18.1   10.67.109.144   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.8</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe node hci-node02</span></span><br><span class="line">输出显示了节点的状态、 CPU 和内存数据、系统信息、运行容器的节点等</span><br><span class="line"></span><br><span class="line">查看某台机器的资源</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe node hci-node01</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="创建别名和补全"   >
          <a href="#创建别名和补全" class="heading-link"><i class="fas fa-link"></i></a>创建别名和补全</h3>
      <p>kubectl 会被经常使用。很快你就会发现每次不得不打全命令是非常痛苦的。<br>将下面的代码添加到 ~/.bashrc 或类似的文件中 ：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">alias</span> k=kubectl</span></span><br></pre></td></tr></table></div></figure>
<p>为kuebctl配置 tab 补全<br>需要先安装一个叫作 bashcompletio口的包来启用 bash 中的 tab 命令补全， 然后可以运行接下来的命令（也需要加到 ~/.bashrc 或类似的文件中）</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> &lt;&#123;kubectl completion bash)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl desc&lt;TAB&gt; nod&lt;TAB&gt; hci&lt;TAB&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>但是需要注意的是， tab 命令行补全只在使用完整的 kubectl 命令时会起作用,(当使用别名 k 时不会起作用). 需要改变 kubectl completion 的输出来修复：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> &lt;(kubectl completion bash | sed s/kubectl/k/g)</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="node-标签"   >
          <a href="#node-标签" class="heading-link"><i class="fas fa-link"></i></a>node 标签</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label node server02 gpu=<span class="literal">false</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label node server02 gpu=<span class="literal">true</span> --overwrite	//修改node标签</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get node -L gpu		// 列出所有node，并添加GPU一列进行展示</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get node -l gpu		// 只列出含标签的key为gpu的node</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get node -l gpu=<span class="literal">false</span>	// 只列出含gpu=<span class="literal">false</span>的node</span></span><br></pre></td></tr></table></div></figure>

<p>将POD调度到指定的node上: kubia-gpu.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">name: kubia-gpu		// 指定生成的POD名字</span><br><span class="line">spec:</span><br><span class="line">nodeSelector:		// node选择器,选择含标签gpu=true的node机器</span><br><span class="line">	gpu: "true"		</span><br><span class="line">containers:</span><br><span class="line">- image: luksa/kubia	// 要拉取的 image 名字</span><br><span class="line">	name: kubia			// 生成的 container 名字</span><br></pre></td></tr></table></div></figure>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f kubia-gpu.yaml</span></span><br></pre></td></tr></table></div></figure>
<p>如果没有标签为gpu=true的合适node， 通过 $ kubectl describe pod/kubia-nogpu 查看Message， 会报 0/2 nodes are available: 2 node(s) didn’t match node selector.信息</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod/kubia-gpu</span></span><br><span class="line">......</span><br><span class="line">Node-Selectors:  gpu=true</span><br><span class="line">......</span><br></pre></td></tr></table></div></figure>


        <h3 id="taint污点"   >
          <a href="#taint污点" class="heading-link"><i class="fas fa-link"></i></a>taint污点</h3>
      <p>给Node添加污点可以让配置tolerations的Pod部署上来，而不让平常的Pod部署.<br>配置tolerations的Pod可以部署到添加污点的机器也可以部署到其它平常机器</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// 查看node机器污点</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe node/&lt;Node-Name&gt; | grep Taint</span></span><br><span class="line">  Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">// 去掉污点</span><br><span class="line"><span class="meta">$</span><span class="bash">  kubectl taint nodes &lt;Node-Name&gt; node-role.kubernetes.io/master:NoSchedule-</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl taint nodes NodeName gpu=<span class="literal">true</span>:NoSchedule</span></span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: web-demo</span><br><span class="line">  namespace: dev</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web-demo</span><br><span class="line">  replicas: 3			// 副本数3来测试能部署到哪些机器</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web-demo</span><br><span class="line">    spec:</span><br><span class="line">      selector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          app: web-demo</span><br><span class="line">      replicas: 1</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: web-demo</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: web-demo</span><br><span class="line">            image: hub.mooc.com/kubernetes/web:v1</span><br><span class="line">            ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">          tolerations:		// 可以部署到有设置taint的机器，也可以部署到其它机器</span><br><span class="line">          - key: "gpu"</span><br><span class="line">            operator: "Equal"</span><br><span class="line">            value: "true"</span><br><span class="line">            effect: "NoSchedule"</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>典型的使用kubeadm部署和初始化的Kubernetes集群，master节点被设置了一个node-role.kubernetes.io/master:NoSchedule的污点，可以使用kubectl describe node <node-name>命令查看<br>这个污点表示默认情况下master节点将不会调度运行Pod，即不运行工作负载, 对于使用二进制手动部署的集群设置和移除这个污点的命令如下:</p>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl taint nodes &lt;node-name&gt; node-role.kubernetes.io/master=:NoSchedule</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl taint nodes &lt;node-name&gt; node-role.kubernetes.io/master:NoSchedule-</span></span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>kubeadm初始化的Kubernetes集群，master节点也被打上了一个node-role.kubernetes.io/master=的label，标识这个节点的角色为master。给Node设置Label和设置污点是两个不同的操作。设置Label和移除Label的操作命令如下</p>
</blockquote>
<p>设置Label</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label node node1 node-role.kubernetes.io/master=</span></span><br></pre></td></tr></table></div></figure>

<p>移除Label</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label node node1 node-role.kubernetes.io/master-</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Namespace"   >
          <a href="#Namespace" class="heading-link"><i class="fas fa-link"></i></a>Namespace</h2>
      <blockquote>
<p>大多数对象的名称必须符合 RFC 1035 （域名）中规定的命名规范 ，这意味着它们可能只包含字母、数字、横杠（－）和点号，但命名空间（和另外几个）不允许包含点号</p>
</blockquote>

        <h3 id="隔离性"   >
          <a href="#隔离性" class="heading-link"><i class="fas fa-link"></i></a>隔离性</h3>
      <blockquote>
<p>名字的隔离只是 通过svc名称(DNS) 访问的隔离，通过svc的IP和Pod的IP再加上端口号(Port) 照样可以访问不同命名空间下的服务.</p>
</blockquote>

        <h3 id="设置默认命名空间"   >
          <a href="#设置默认命名空间" class="heading-link"><i class="fas fa-link"></i></a>设置默认命名空间</h3>
      <blockquote>
<p>默认Kubeclt获取default命名空间下的资源，可以通过设置K8s上下文配置文件如kube.config 使得某个命名空间变为默认namespace，获取pod时候不需要在加上 -n 参数</p>
</blockquote>

        <h3 id="创建命名空间"   >
          <a href="#创建命名空间" class="heading-link"><i class="fas fa-link"></i></a>创建命名空间</h3>
      <blockquote>
<p>namespace不提供网络隔离, 如果命名空间 foo 中的某个 pod 知道命名空间 bar 中 pod 的 IP 地址，那它就可以将流量（例如 HTTP 请求）发送到另一个 pod<br>第一种： commands方式</p>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create namespace custom-namespace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create ns custom-namespace</span></span><br></pre></td></tr></table></div></figure>

<p>第二种： Yaml方式， 之所以选择使用 YAML 文件，只是为了强化Kubemetes中的所有内容都是一 个 API 对象这一概念</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> touch custom-namespace.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-namespace</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f custom-namespace.yaml</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="划分方式"   >
          <a href="#划分方式" class="heading-link"><i class="fas fa-link"></i></a>划分方式</h3>
      <pre><code>* 按环境划分: dev(开发), test(测试)
* 按团队划分
* 自定义多级划分</code></pre>
        <h3 id="标记命名空间"   >
          <a href="#标记命名空间" class="heading-link"><i class="fas fa-link"></i></a>标记命名空间</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label namespace default istio-injection=enabled --overwrite         // enabled</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label namespace default istio-injection=disabled --overwrite        // disabled</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl label namespace default istio-injection= --overwrite                // cancel <span class="built_in">set</span></span></span><br><span class="line">namespace/default labeled</span><br></pre></td></tr></table></div></figure>


        <h3 id="查看标记-istio-injection-enabled-标签的命名空间"   >
          <a href="#查看标记-istio-injection-enabled-标签的命名空间" class="heading-link"><i class="fas fa-link"></i></a>查看标记 istio-injection=enabled 标签的命名空间</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get namespace -L istio-injection</span></span><br><span class="line">NAME              STATUS   AGE   ISTIO-INJECTION</span><br><span class="line">default           Active   85m   enabled</span><br><span class="line">istio-system      Active   25m   disabled</span><br><span class="line">kube-node-lease   Active   85m</span><br><span class="line">kube-public       Active   85m</span><br><span class="line">kube-system       Active   85m</span><br><span class="line">[root@hci-node01 istio-1.5.2]#</span><br></pre></td></tr></table></div></figure>


        <h3 id="删除namespace"   >
          <a href="#删除namespace" class="heading-link"><i class="fas fa-link"></i></a>删除namespace</h3>
      <p>删除当前命名空间中的所有资源，可以删除ReplicationCcontroller和pod,以及我们创建的所有service<br>第一个 all 指定正在删除所有资源类型, –all 选项指定将删除所有资源实例, 而不是按名称指定它们<br>使用 all 关键字删除所有内容并不是真的完全删除所有内容。 一些资源比如Secret会被保留下来， 并且需要被明确指定删除</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete all --all		// 命令也会删除名为 kubernetes 的Service, 但它应该会在几分钟后自动重新创建</span></span><br></pre></td></tr></table></div></figure>
<p>可以简单地删除整个命名空间（ pod 将会伴随命名空间 自动删除〉</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete ns custom-namespace</span></span><br></pre></td></tr></table></div></figure>
<p>强制删除NAMESPACE</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete namespace NAMESPACENAME --force --grace-period=0</span></span><br></pre></td></tr></table></div></figure>
<p>进入kube-system下得etcd pod 删除需要删除的NAMESPACE</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -n kube-system</span></span><br><span class="line">NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">etcd-hci-node01                      1/1     Running   5          16d</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> -it etcd-hci-node01 sh -n kube-system</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> etcdctl del /registry/namespaces/NAMESPACENAME</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="POD"   >
          <a href="#POD" class="heading-link"><i class="fas fa-link"></i></a>POD</h2>
      
        <h3 id="查看pod解释"   >
          <a href="#查看pod解释" class="heading-link"><i class="fas fa-link"></i></a>查看pod解释</h3>
      <figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">	Pod is a collection of containers that can run on a host. This resource is</span><br><span class="line">	created by clients and scheduled onto hosts.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">apiVersion   <span class="tag">&lt;<span class="name">string</span>&gt;</span></span><br><span class="line">	APIVersion defines the versioned schema of this representation of an</span><br><span class="line">	object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">	value, and may reject unrecognized values. More info:</span><br><span class="line">	https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span><br><span class="line"></span><br><span class="line">kind <span class="tag">&lt;<span class="name">string</span>&gt;</span></span><br><span class="line">	Kind is a string value representing the REST resource this object</span><br><span class="line">	represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">	requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">	https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span><br><span class="line"></span><br><span class="line">metadata     <span class="tag">&lt;<span class="name">Object</span>&gt;</span></span><br><span class="line">	Standard object's metadata. More info:</span><br><span class="line">	https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span><br><span class="line"></span><br><span class="line">spec <span class="tag">&lt;<span class="name">Object</span>&gt;</span></span><br><span class="line">	Specification of the desired behavior of the pod. More info:</span><br><span class="line">	https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span><br><span class="line"></span><br><span class="line">status       <span class="tag">&lt;<span class="name">Object</span>&gt;</span></span><br><span class="line">	Most recently observed status of the pod. This data may not be up to date.</span><br><span class="line">	Populated by the system. Read-only. More info:</span><br><span class="line">	https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span><br></pre></td></tr></table></div></figure>

<p>深入理解POD属性</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain pod.apiVersion</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain pod.kind</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl explain pod.spec</span></span><br></pre></td></tr></table></div></figure>
<p>pods 的缩写是 po, service 的缩写是 SVC, replicationcontroller 的缩写 rc</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -n kube-system</span></span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>我们提到过每个 pod 都有自己的 IP 地址，但是这个地址是集群 内部的，不能从集群外部访问。<br>要让 pod 能够从外部访问 ， 需要通过服务对象公开它， 要创建一个特殊的 LoadBalancer 类型的服务。<br>因为如果你创建一个常规服务（ 一个 Cluster IP 服务）， 比如 pod ，它也 只能从集群内部访问。<br>通过创建 LoadBalanc er 类型 的服务，将创建一个外部的负载均衡 ，可以通过 负载均衡的公共 IP 访问 pod </p>
</blockquote>

        <h3 id="创建POD"   >
          <a href="#创建POD" class="heading-link"><i class="fas fa-link"></i></a>创建POD</h3>
      <p>通过上传 JSON 或 YAML 描述文件到 Kubemetes API 服务器来创建 pod.<br>kubectl create -f 命令用于从YAML或JSON文件创建任何资源（不只是 pod).</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f kubia-manual.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f kubia-gpu.yaml -n custom-namespace	//创建pod到custom-namespace命名空间下</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod/kubia</span></span><br><span class="line">......</span><br><span class="line">Events:</span><br><span class="line">Type    Reason     Age    From               Message</span><br><span class="line">----    ------     ----   ----               -------</span><br><span class="line">Normal  Scheduled  5m12s  default-scheduler  Successfully assigned default/kubia-liveness to server02</span><br><span class="line">Normal  Pulling    5m8s   kubelet, server02  Pulling image "luksa/kubia-unhealthy"</span><br></pre></td></tr></table></div></figure>
<p>编写好yaml文件在本地某个目录后, cd到此目录, 用一条command全部创建或删除资源</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f .	// 添加所有资源</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f .	// 删除所有资源</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="一直查看pod状态"   >
          <a href="#一直查看pod状态" class="heading-link"><i class="fas fa-link"></i></a>一直查看pod状态</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -w</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="pod标签labels"   >
          <a href="#pod标签labels" class="heading-link"><i class="fas fa-link"></i></a>pod标签labels</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po --show-labels</span></span><br></pre></td></tr></table></div></figure>
<p>查看pod标签的key值为creation_method 和 env 的信息</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -L creation_method,env</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   CREATION_METHOD   ENV</span><br><span class="line">kubia                          1/1     Running   0          16h</span><br><span class="line">kubia-manual-v2                1/1     Running   0          34m   manual            pod</span><br></pre></td></tr></table></div></figure>
<p>POD添加标签</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label po kubia  creation_method=manual</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   CREATION_METHOD   ENV</span><br><span class="line">kubia                          1/1     Running   0          16h   manual</span><br><span class="line">kubia-manual-v2                1/1     Running   0          43m   manual            pod</span><br></pre></td></tr></table></div></figure>
<p>更改现有标签, 在更改现有标签时， 需要使用–overwrite选项</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label po kubia-manual-v2 env=debug --overwrite</span></span><br></pre></td></tr></table></div></figure>
<p>使用标签列出POD</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -1 creation_method=manual</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -l env</span></span><br></pre></td></tr></table></div></figure>
<p>同样列出没有env标签的pod<br>确保使用单引号来圈引 !env, 这样bash shell才不会解释感叹号（译者注：感叹号在bash中有特殊含义， 表示事件指示器)</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -l <span class="string">'!env'</span></span></span><br><span class="line">creation_method!=manual 选择带有creation_method标签， 并且值不等于manual的pod</span><br><span class="line">env in (prod, devel)选择带有env标签且值为prod或devel的pod</span><br><span class="line">env notin (prod, devel)选择带有env标签， 但其 值不是prod或devel的pod</span><br><span class="line">app=pc,rel=beta 选择pc微服务的beta版本pod</span><br></pre></td></tr></table></div></figure>


        <h3 id="pod-注解"   >
          <a href="#pod-注解" class="heading-link"><i class="fas fa-link"></i></a>pod 注解</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl annotate pod kubia-gpu mycompany.com/someannotion=<span class="string">"foo bar"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod/kubia-gpu</span></span><br><span class="line">......</span><br><span class="line">Annotations:  mycompany.com/someannotion: foo bar</span><br><span class="line">......</span><br></pre></td></tr></table></div></figure>

        <h3 id="查看该-pod-的完整描述文件："   >
          <a href="#查看该-pod-的完整描述文件：" class="heading-link"><i class="fas fa-link"></i></a>查看该 pod 的完整描述文件：</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po kubia-manual -o yaml	// 获取yaml格式信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubect1 get po kubia-manual -o json	// 获取json格式信息</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="执行pod容器"   >
          <a href="#执行pod容器" class="heading-link"><i class="fas fa-link"></i></a>执行pod容器</h3>
      <p>直接执行:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> fortioclient-f8d65c6bb-5k4td -c captured date -n twopods</span></span><br></pre></td></tr></table></div></figure>
<p>进入容器执行, 当pod中只有一个容器时可以不加-c参数指定某个容器</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl <span class="built_in">exec</span> fortioclient-f8d65c6bb-5k4td -c captured -i -t /bin/sh -n twopods</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="容器进程-网络等"   >
          <a href="#容器进程-网络等" class="heading-link"><i class="fas fa-link"></i></a>容器进程, 网络等</h3>
      <p>查看进程command完整信息</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps auxwww</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pa -ef</span></span><br></pre></td></tr></table></div></figure>
<p>查看网络</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> netstat -ntlp</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="查看Pod-svc日志"   >
          <a href="#查看Pod-svc日志" class="heading-link"><i class="fas fa-link"></i></a>查看Pod, svc日志</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs pod/istiod-774777b79-ddfk4 -n istio-system</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs -f pod/&lt;pod_name&gt; <span class="comment">#类似tail -f的方式查看(tail -f 实时查看日志文件 tail -f 日志文件log)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs svc/istiod -n istio-system</span></span><br><span class="line">如果该pod中有其他容器， 可以通过如下命令获取其日志：</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs kubia-manual -c kubia</span></span><br></pre></td></tr></table></div></figure>

<p>查看容器重启后前一个容器为什么重启的日志信息</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs mypod --previous</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="部署应用程序"   >
          <a href="#部署应用程序" class="heading-link"><i class="fas fa-link"></i></a>部署应用程序</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="重启Pod"   >
          <a href="#重启Pod" class="heading-link"><i class="fas fa-link"></i></a>重启Pod</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod &#123;podname&#125; -n &#123;namespace&#125; -o yaml | kubectl replace --force -f -</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="删除Pod"   >
          <a href="#删除Pod" class="heading-link"><i class="fas fa-link"></i></a>删除Pod</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete pod PODNAME -n custom-namespace		// 删除指定命名空间下的POD</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete po -l creation_method=manual			// 通过标签选择器来删除</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete po --all -n custom-namespace			// 删除当前命名空间中的所有 pod</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete all --all -n custom-namespace			// 删除所有pod和svc，系统带的kubernetes服务会过一会重启</span></span><br></pre></td></tr></table></div></figure>
<p>可使用kubectl中的强制删除命令删除POD</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete pod PODNAME --force --grace-period=0</span></span><br></pre></td></tr></table></div></figure>
<p>直接从ETCD中删除源数据<br>删除default namespace下的pod名为pod-to-be-deleted-0</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl del /registry/pods/default/pod-to-be-deleted-0</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="livenessProbe-存活探针-readinessProbe"   >
          <a href="#livenessProbe-存活探针-readinessProbe" class="heading-link"><i class="fas fa-link"></i></a>livenessProbe 存活探针, readinessProbe</h2>
      <p>Kubemetes 可以通过存活探针 (liveness probe) 检查容器是否还在运行.<br>Kubemetes 可以通过readinessProbe探针 检查容器是否准备完毕可以挂到负载均衡上供外部访问.<br>livenessProbe与readinessProbe探针用法完全一样, 都有三种，下面介绍这三种健康检查方式.</p>
<p>可以为 pod 中的每个容器单独指定存活探针。 如果探测失败， Kubemetes 将定期执行探针并重新启动容器</p>
<ul>
<li>第一种健康检查方式: 执行命令检查存活探针是否存活</li>
</ul>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: web-demo</span><br><span class="line">  namespace: dev</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web-demo</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web-demo</span><br><span class="line">    spec:</span><br><span class="line">      selector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          app: web-demo</span><br><span class="line">      replicas: 1</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: web-demo</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: web-demo</span><br><span class="line">            image: hub.mooc.com/kubernetes/web:v1</span><br><span class="line">            ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">            livenessProbe:				// 检查应用是否存活的探针, 和容器一个级别</span><br><span class="line">              exec:						// 第一种健康检查方式, 通过执行命令</span><br><span class="line">                command:</span><br><span class="line">                - /bin/sh</span><br><span class="line">                - -c</span><br><span class="line">                - ps -ef|grep java|grep -v grep</span><br><span class="line">              initialDelaySeconds: 10		// 容器起来后过10s开始检查</span><br><span class="line">              periodSeconds: 10				// 每隔10s检查一次</span><br><span class="line">              failureThreshold: 2			// 连续健康检查失败2次放弃检查, 重启容器</span><br><span class="line">              successThreshold: 1			// 检查一次满足条件就认为健康检查通过</span><br><span class="line">              timeoutSeconds: 5				// 每次健康检查delay时间是5s, 超时也认为健康检查失败, 重启容器</span><br><span class="line">            readinessProbe:				// readinessProbe与livenessProbe用法完全一样.</span><br><span class="line">              exec:						// 第一种检查方式, 通过执行命令</span><br><span class="line">                command:</span><br><span class="line">                - /bin/sh</span><br><span class="line">                - -c</span><br><span class="line">                - ps -ef|grep java|grep -v grep</span><br><span class="line">              initialDelaySeconds: 10		// 容器起来后过10s开始检查</span><br><span class="line">              periodSeconds: 10				// 每隔10s检查一次</span><br><span class="line">              failureThreshold: 2			// 连续健康检查失败2次放弃检查, 重启容器</span><br><span class="line">              successThreshold: 1			// 检查一次满足条件就认为健康检查通过</span><br><span class="line">              timeoutSeconds: 5				// 每次健康检查delay时间是5s, 超时也认为健康检查失败, 重启容器</span><br></pre></td></tr></table></div></figure>

<ul>
<li>第二种健康检查方式: 执行网络请求检查存活探针是否存活</li>
</ul>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ touch kubia-liveness-probe.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia-liveness</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: luksa/kubia-unhealthy</span><br><span class="line">    name: kubia</span><br><span class="line">    livenessProbe:		// 一个 HTTP GET 存活探针</span><br><span class="line">      httpGet:			// 第二种健康检查方式, 通过httpGet</span><br><span class="line">        path: /			// 应用要访问的路径</span><br><span class="line">        port: 8080		// 容器本身启动的端口</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 15		// 容器起来后过10s开始检查</span><br><span class="line">      periodSeconds: 5</span><br></pre></td></tr></table></div></figure>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-liveness                 1/1     Running   1          13m</span><br></pre></td></tr></table></div></figure>
<p>查看该pod描述</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod/kubia-liveness</span></span><br><span class="line">......</span><br><span class="line">Last State:     Terminated</span><br><span class="line">  Reason:       Error</span><br><span class="line">  Exit Code:    137</span><br><span class="line">  Started:      Wed, 13 May 2020 15:49:36 +0800</span><br><span class="line">  Finished:     Wed, 13 May 2020 15:51:25 +0800</span><br><span class="line">Ready:          True</span><br><span class="line">Restart Count:  1</span><br><span class="line">Liveness:       http-get http://:8080/ delay=0s timeout=1s period=10s #success=1 #failure=3</span><br><span class="line">......</span><br></pre></td></tr></table></div></figure>
<p>数字137是两个 数字的总和：128+x, 其中x是终止进程的信号编号.<br>在这个例子中，x等于9, 这是SIGKILL的信号编号，意味着这个进程被强行终止.<br>当容器被强行终止时，会创建一个全新的容器—-而不是重启原来的容器.<br>delay=Os部分显示在容器启动后立即开始探测.<br>timeout仅设置为1秒，因此容器必须在1秒内进行响应， 不然这次探测记作失败.<br>每10秒探测一次容器(period=lOs), 并在探测连续三次失败(#failure=3)后重启容器.<br>定义探 针时可以自定义这些附加参数。例如，要设 置初始延迟，请将initialDelaySeconds属性添加到存活探针的配置中.</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">livenessProbe:		// 一个 HTTP GET 存活探针</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /</span><br><span class="line">    port: 8080</span><br><span class="line">  initialDelaySeconds: 15	// Kubernetes会在第—次探测前等待15秒</span><br></pre></td></tr></table></div></figure>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod/kubia-liveness</span></span><br><span class="line">......</span><br><span class="line">Liveness:       http-get http://:8080/ delay=15s timeout=1s period=10s #success=1 #failure=3</span><br><span class="line"></span><br><span class="line">* 第三种健康检查方式: 通过TCP检查端口是否处于监听状态</span><br><span class="line">    livenessProbe:		// 一个 HTTP GET 存活探针</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 20	// Kubernetes会在第—次探测前等待15秒 </span><br><span class="line">      periodSeconds: 5</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>如果没有设置初始延迟，探针将在启动时立即开始探测容器， 这通常会导致探测失败， 因为应用程序还没准备好开始接收请求.<br>务必记得设置一个初始延迟未说明应用程序的启动时间.<br>对于在生产中运行的pod, 一定要定义一个存活探针。没有探针的话，Kubemetes无法知道你的应用是否还活着。只要进程还在运行， Kubemetes会认为容器是健康的<br>Kubernetes会在你的容器崩溃或其存活探针失败时， 通过重启容器来保持运行。 这项任务由承载pod的节点上的Kubelet 执行 一— 在主服务器上运行的Kubernetes Control Plane组件不会参与此过程.<br>但如果节点本身崩溃， 那么Control Plane 必须为所有随节点停止运行的pod创建替代品。 它不 会为你直接创建的pod执行此操作 。 这些pod只被Kubelet 管理.</p>
</blockquote>

        <h3 id="查看-readinessProbe-healthProbe"   >
          <a href="#查看-readinessProbe-healthProbe" class="heading-link"><i class="fas fa-link"></i></a>查看 readinessProbe, healthProbe</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl edit po -n istio-system istio-ingressgateway-6489d9556d-wjr58</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl edit deployment -n istio-system istio-ingressgateway</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs po/istio-ingressgateway-6489d9556d-wjr58 -n istio-system</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -A</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="affinity"   >
          <a href="#affinity" class="heading-link"><i class="fas fa-link"></i></a>affinity</h3>
      <p>匹配Node标签, Pod部署到哪台机器上.</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: web-demo</span><br><span class="line">  namespace: dev</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web-demo</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web-demo</span><br><span class="line">    spec:</span><br><span class="line">      selector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          app: web-demo</span><br><span class="line">      replicas: 1</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: web-demo</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: web-demo</span><br><span class="line">            image: hub.mooc.com/kubernetes/web:v1</span><br><span class="line">            ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">          affinity:</span><br><span class="line">            nodeAffinity:		// node亲和性, 要部署到哪台机器，不要部署到哪台机器</span><br><span class="line">              requiredDuringSchedulingIgnoredDuringExecution:	// 必须满足下面条件才会执行调度</span><br><span class="line">                nodeSelectorTerms:		// 数组形式, 下面可以定义多个Terms, 它们之间是或的关系</span><br><span class="line">                - matchExpressions:		// 数组形式, 如果定义多个matchExpressions它们之间是与的关系</span><br><span class="line">                  - key: beta.kubernetes.io/arch	// 节点的label含有的key名字, 这里的是由K8s根据机器自动生成的</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:				// 前提是Node机器有amd64标签K8s才会把容器部署到次Node机器</span><br><span class="line">                    - amd64				// 通过kubectl get nodes NodeName -o yaml进行查看</span><br><span class="line">              preferredDuringSchedulingIgnoredDuringExecution:	// 最好是怎样调度</span><br><span class="line">              - weight: 1				// 权重</span><br><span class="line">                perference:</span><br><span class="line">                  matchExpressions:</span><br><span class="line">                  - key: disktype		// 通过kubectl get nodes --show-labels查看</span><br><span class="line">                    operator: NotIn</span><br><span class="line">                    values:</span><br><span class="line">                    - ssd</span><br><span class="line">            podAffinity:		// Pod亲和性, 想和哪些Pod部署到一台机器, 不想和哪些Pod部署在一台机器</span><br><span class="line">              requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">              - labelSelector:</span><br><span class="line">                  matchExpressions:</span><br><span class="line">                  - key: app</span><br><span class="line">                    operator: In		// 要跟app=web-demo的Pod运行在同一个节点上</span><br><span class="line">                    values:</span><br><span class="line">                    - web-demo-node</span><br><span class="line">                topologyKey: kubernetes.io/hostname		// 节点的label名字</span><br><span class="line">              preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">              - weight: 100</span><br><span class="line">                podAffinityTerm:</span><br><span class="line">                  labelSelector:</span><br><span class="line">                    matchExpressions:</span><br><span class="line">                    - key: app</span><br><span class="line">                      operator: In</span><br><span class="line">                      values:</span><br><span class="line">                      - web-demo-node</span><br><span class="line">                  topologyKey: kubernetes.io/hostname</span><br><span class="line">            podAntiAffinity:		// Pod反亲和性, 不想和哪些Pod部署到一台机器, 用法和podAffinity用法完全一样</span><br><span class="line">            pod反亲和性用的很多的是上面的replicas: 的值 &gt;=2 时候会把容器副本分别部署到不同机器</span><br></pre></td></tr></table></div></figure>


        <h3 id="Pod启动停止控制"   >
          <a href="#Pod启动停止控制" class="heading-link"><i class="fas fa-link"></i></a>Pod启动停止控制</h3>
      <p>Pod容器启动时候和停止前所做的事</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: web-demo</span><br><span class="line">  namespace: dev</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web-demo</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web-demo</span><br><span class="line">    spec:</span><br><span class="line">      selector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          app: web-demo</span><br><span class="line">      replicas: 1</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: web-demo</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: web-demo</span><br><span class="line">            image: hub.mooc.com/kubernetes/web:v1</span><br><span class="line">            ports:</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">            volumeMounts:</span><br><span class="line">            - name: shared-volume</span><br><span class="line">              mounthPath: /shared-web</span><br><span class="line">            lifecycle:				Pod里容器启动前和停止前要做的事</span><br><span class="line">              postStart:</span><br><span class="line">                exec:</span><br><span class="line">                  command: ["/bin/sh", "-c", "echo web starting ... &gt;&gt; /var/log/messages"]</span><br><span class="line">              preStop:</span><br><span class="line">                exec:</span><br><span class="line">                  command: ["/bin/sh", "-c", "echo web stopping ... &gt;&gt; /var/log/messages &amp;&amp; sleep 3"]</span><br></pre></td></tr></table></div></figure>


        <h2 id="ReplicationController"   >
          <a href="#ReplicationController" class="heading-link"><i class="fas fa-link"></i></a>ReplicationController</h2>
      <p>一个ReplicationController有三个主要部分<br> • label selector ( 标签选择器）， 用于确定ReplicationController作用域中有哪些pod<br> • replica count (副本个数）， 指定应运行的pod 数量<br> • pod template (pod模板）， 用于创建新的pod 副本<br>使用 ReplicationController 的好处<br> •确保一 个 pod (或多个 pod副本）持续运行， 方法是在现有pod 丢失时启动一个新 pod。<br> • 集群节点发生故障时， 它将为故障节 点 上运 行的所有 pod (即受ReplicationController 控制的节点上的那些 pod) 创建替代副本。<br> • 它能轻松实现 pod的水平伸缩 手动和自动都可以</p>

        <h3 id="由RC创建POD"   >
          <a href="#由RC创建POD" class="heading-link"><i class="fas fa-link"></i></a>由RC创建POD</h3>
      <p>kubia-rc.yaml, 内容如下:</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController		// 这里的配置定义了ReplicationController(RC)</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia		// ReplicationController 的名字</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3		// pod 实例的目标数目</span><br><span class="line">  selector:			// selector也可以不写，replica 直接根据下面的template模板里的lables标签选择创建POD</span><br><span class="line">    app: kubia		// pod 选择器决定了 RC 的操作对象</span><br><span class="line">  template:			// 从此以下都是创建新 pod 所用的 pod 模板, 与单独创建的pod定义yaml文件内容几乎相同</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kubia</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubia</span><br><span class="line">        image: luksa/kubia</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br></pre></td></tr></table></div></figure>

<p>创建ReplicationController并由其创建pod</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f kubia-rc.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -o wide</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP          NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">kubia-6wnj5   1/1     Running   0          56s   10.44.0.3   server02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubia-788p8   1/1     Running   0          56s   10.44.0.2   server02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubia-c9kn6   1/1     Running   0          56s   10.44.0.1   server02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete po kubia-6wnj5</span></span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">kubia-6ntgt   0/1     ContainerCreating   0          12s</span><br><span class="line">kubia-6wnj5   1/1     Terminating         0          3m3s</span><br><span class="line">kubia-788p8   1/1     Running             0          3m3s</span><br><span class="line">kubia-c9kn6   1/1     Running             0          3m3s</span><br></pre></td></tr></table></div></figure>

<p>上面重新列出pod会显示四个， 因为你删除的pod己终止， 并且己创建一个新的pod<br>虽然ReplicationController会立即收到删除pod的通知 (API 服务器允许客户端监听资源和资源列表的更改），但这不是它创建替代pod的原因。<br>该通知会触发控制器检查实际的pod数量并采取适当的措施.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po -o wide</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     IP          NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">kubia-6ntgt   1/1     Running   0          53s     10.44.0.4   server02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubia-788p8   1/1     Running   0          3m44s   10.44.0.2   server02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubia-c9kn6   1/1     Running   0          3m44s   10.44.0.1   server02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></div></figure>


        <h3 id="获取有关-ReplicationController-的信息"   >
          <a href="#获取有关-ReplicationController-的信息" class="heading-link"><i class="fas fa-link"></i></a>获取有关 ReplicationController 的信息</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get rc -o wide</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get rc -o wide -n default		// RC是针对某个namespace下做的副本pod控制</span></span><br><span class="line">NAME    DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES        SELECTOR</span><br><span class="line">kubia   3         3         3       17m   kubia        luksa/kubia   app=kubia</span><br><span class="line">获取RC的详细信息</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe rc kubia</span></span><br></pre></td></tr></table></div></figure>

<p>如果你更改了 一个 pod 的标签，使它不再 与 ReplicationController 的标签选择器相匹配 ， 那么该 pod 就变得和其他手动创建的 pod 一样了<br>更改 pod 的标签时， ReplicationController 发现一个 pod 丢失了 ， 并启动一个新的pod替换它.</p>
<p>给其中一个 pod 添加了 type=special 标签，再次列出所有 pod 会显示和以前一样的三个 pod 。 因为从 ReplicationCon位oiler 角度而言， 没发生任何更改.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label pod/kubia-6ntgt <span class="built_in">type</span>=special</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod --show-labels</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">kubia-6ntgt   1/1     Running   0          27m   app=kubia,type=special</span><br><span class="line">kubia-788p8   1/1     Running   0          30m   app=kubia</span><br><span class="line">kubia-c9kn6   1/1     Running   0          30m   app=kubia</span><br></pre></td></tr></table></div></figure>

<p>更改app标签该 pod 不再与 RC 的标签选择器相匹配</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label pod/kubia-6ntgt app=foo --overwrite</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod --show-labels</span></span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE   LABELS</span><br><span class="line">kubia-6ntgt   1/1     Running             0          30m   app=foo,type=special</span><br><span class="line">kubia-788p8   1/1     Running             0          33m   app=kubia</span><br><span class="line">kubia-c9kn6   1/1     Running             0          33m   app=kubia</span><br><span class="line">kubia-dqshz   0/1     ContainerCreating   0          4s    app=kubia</span><br></pre></td></tr></table></div></figure>
<p>使用 -L app 选项在列 中显示 app 标签</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod -L app</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     APP</span><br><span class="line">kubia-6ntgt   1/1     Running   0          32m     foo</span><br><span class="line">kubia-788p8   1/1     Running   0          35m     kubia</span><br><span class="line">kubia-c9kn6   1/1     Running   0          35m     kubia</span><br><span class="line">kubia-dqshz   1/1     Running   0          2m17s   kubia</span><br></pre></td></tr></table></div></figure>
<p>可能有一个 bug 导致你的 pod 在特定时间或特定事件后开始出问题。<br>如果你知道某个 pod 发生了故障， 就可以将它从 Replication-Controller 的管理范围中移除， 让控制器将它替换为新 pod, 接着这个 pod 就任你处置了。 完成后删除该pod 即可。</p>

        <h3 id="编辑RC的YAML配置"   >
          <a href="#编辑RC的YAML配置" class="heading-link"><i class="fas fa-link"></i></a>编辑RC的YAML配置</h3>
      <p>用默认文本编辑器中打开ReplicationController的YAML配置，会在/tmp目录生成一个临时yaml文件，退出后/tmp目录下的yaml文件也会删掉<br>如果你想使用nano编辑Kubernetes资源，请执行以下命令（或将其放入 ~/.bashrc或等效文件中）<br>export KUBE_EDITOR=”/usr/bin/nano”</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit rc kubia</span><br><span class="line">......</span><br><span class="line"> spec:</span><br><span class="line">   replicas: 3</span><br><span class="line">   selector:</span><br><span class="line">     app: kubia1				 RC selector 修改，需要配合下面的label一起修改</span><br><span class="line">   template:</span><br><span class="line">     metadata:</span><br><span class="line">       creationTimestamp: null</span><br><span class="line">       labels:</span><br><span class="line">         app: kubia1			 Pod label 修改，需要配合上面的 RC selector 一起修改</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - image: luksa/kubia</span><br><span class="line">         imagePullPolicy: Always</span><br><span class="line">         name: kubia</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: 8080</span><br><span class="line">           protocol: TCP</span><br><span class="line">......</span><br></pre></td></tr></table></div></figure>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod</span></span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE   APP</span><br><span class="line">kubia-279wl   0/1     ContainerCreating   0          2s    kubia1</span><br><span class="line">kubia-6ntgt   1/1     Running             0          44m   foo</span><br><span class="line">kubia-788p8   1/1     Running             0          47m   kubia</span><br><span class="line">kubia-c9kn6   1/1     Running             0          47m   kubia</span><br><span class="line">kubia-dqshz   1/1     Running             0          14m   kubia</span><br><span class="line">kubia-m6vml   0/1     Pending             0          2s    kubia1</span><br><span class="line">kubia-xxjqr   0/1     ContainerCreating   0          2s    kubia1</span><br></pre></td></tr></table></div></figure>


        <h3 id="RC-扩容"   >
          <a href="#RC-扩容" class="heading-link"><i class="fas fa-link"></i></a>RC 扩容</h3>
      <p>扩展/缩容 RC管理的pod为5个<br>第一种，commands方式:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl scale rc kubia --replicas=5</span></span><br></pre></td></tr></table></div></figure>
<p>第二种， edit rc yaml文件</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl edit rc kubia</span></span><br><span class="line">......</span><br><span class="line">spec:</span><br><span class="line">  replicas: 5</span><br><span class="line">......</span><br></pre></td></tr></table></div></figure>


        <h3 id="删除RC"   >
          <a href="#删除RC" class="heading-link"><i class="fas fa-link"></i></a>删除RC</h3>
      <p>当使用 kubectl delete 删除 ReplicationController 时， 可以通过给命令增加 –cascade= false 选项来保持 pod 的运行.</p>
<pre><code>$ kubectl delete rc kubia --cascade=false</code></pre><p>已经删除了 ReplicationController, 所以这些 pod 独立了， 它们不再被管理。但是你始终可以使用适当的标签选择器创建新的 ReplicationController, 并再次将它们管理起来</p>

        <h2 id="ReplicaSet"   >
          <a href="#ReplicaSet" class="heading-link"><i class="fas fa-link"></i></a>ReplicaSet</h2>
      <blockquote>
<p>最 初， ReplicationController 是用于复制和在异常时重新调度节点的唯 一Kubemetes 组件， 后来又引入了 一个名为 ReplicaSet 的类似资源 。 它是新一代的ReplicationController, 并且将其完全替换掉 (ReplicationController 最终将被弃用）。<br>也就是说从现在起， 你应该始终创建 ReplicaSet 而不是 ReplicationController。 它们几乎完全相同， 所以你不会碰到任何麻烦<br>ReplicaSet 的行为与ReplicationController 完全相同， 但pod 选择器的表达能力更强<br>ReplicationController 都无法仅基千标签名的存在来匹配 pod, 而ReplicaSet 则可以。 例如， ReplicaSet 可匹配所有包含名为 env 的标签的 pod, 无论ReplicaSet 的实际值是什么（可以理解为 env=*)</p>
</blockquote>
<p>kubia-replicaset.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kubia</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kubia</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubia</span><br><span class="line">        image: luksa/kubia</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br></pre></td></tr></table></div></figure>
<p>检查replicaset:</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get rs</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="matchExpressions选择器"   >
          <a href="#matchExpressions选择器" class="heading-link"><i class="fas fa-link"></i></a>matchExpressions选择器</h3>
      <p>创建个yaml文件<br>kubia-replicaset-matchexpressions.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">selector:</span><br><span class="line">  matchExpressions:</span><br><span class="line">    - key: app</span><br><span class="line">      operator: In</span><br><span class="line">      values:</span><br><span class="line">        - kubia</span><br></pre></td></tr></table></div></figure>
<p>每个表达式都必须 包含一个key, 一个operator (运算符），并且可能还有一个values的列表（取决于 运算符）.<br>• In : Label的值 必须与其中 一个指定的values 匹配。<br>• Notln : Label的值与任何指定的values 不匹配。<br>• Exists : pod 必须包含一个指定名称的标签（值不重要）。使用此运算符时，<br>不应指定 values字段。<br>• DoesNotExist : pod不得包含有指定名称的标签。values属性不得指定<br>如果同时指定matchLabels和matchExpressions, 则所有标签都必须匹配，并且所有表达式必须计算为true以使该pod与选择器匹配.</p>

        <h3 id="查看-replicaset-和-deployment-的详细信息"   >
          <a href="#查看-replicaset-和-deployment-的详细信息" class="heading-link"><i class="fas fa-link"></i></a>查看 replicaset 和 deployment 的详细信息</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe deployment details-v1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe rs details-v1-6fc55d65c9</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="删除ReplicaSet"   >
          <a href="#删除ReplicaSet" class="heading-link"><i class="fas fa-link"></i></a>删除ReplicaSet</h3>
      <p>删除ReplicaSet会删除所有的pod,这种情况下是需要列出pod来确认.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete rs kubia</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="DaemonSet"   >
          <a href="#DaemonSet" class="heading-link"><i class="fas fa-link"></i></a>DaemonSet</h2>
      <p>如果节点下线， DaemonSet不会在其他地方重新创建pod。 但是， 当将一个新节点添加到集群中时， DaemonSet会立刻部署一个新的pod实例。<br>如果有人无意中删除了 一个 pod ， 那么它也会重新创建 一个新的 pod。<br>与 ReplicaSet一样，DaemonSet 从配置的 pod 模板创建 pod.</p>
<blockquote>
<p>如果节点可以被设置为不可调度的 ， 防止 pod 被部署到节点上. DaemonSet 甚至会将 pod 部署到这些节点上，因为无法调度的属性只会被调度器使用，而 DaemonSet 管理的 pod 则完全绕过调度器. 这是预期的，因为DaemonSet的目的是运行系统服务，即使是在不可调度的节点上，系统服务通常也需要运行.</p>
</blockquote>
<p>给node节点打上label</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl label node server02 disk=ssd</span></span><br></pre></td></tr></table></div></figure>

<p>ssd-monitor-daemonset.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1			// DaemooSet在apps的API组 中，版本是v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: ssd-monitor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ssd-monitor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ssd-monitor</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:			// pod模板包含 会选择有disk=ssd标签的节点 一个节点选择器</span><br><span class="line">        disk: ssd</span><br><span class="line">      containers:</span><br><span class="line">      - name: main</span><br><span class="line">        image: luksa/ssd-monitor</span><br></pre></td></tr></table></div></figure>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f ssd-monitor-daemonset.yaml</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="查看DaemonSet"   >
          <a href="#查看DaemonSet" class="heading-link"><i class="fas fa-link"></i></a>查看DaemonSet</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get ds</span></span><br><span class="line">NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE     CONTAINERS   IMAGES              SELECTOR</span><br><span class="line">ssd-monitor   1         1         1       1            1           disk=ssd        3m29s   main         luksa/ssd-monitor   app=ssd-monitor</span><br></pre></td></tr></table></div></figure>
<p>如果你有多个节点并且其他的节点也加上了同样的标签，将会看到 DaemonSet 在每个节点上都启动 pod.<br>给其中一个节点修改标签disk=hdd, 假设它的硬盘换成磁盘而不是SSD, 那个节点上的pod会如预期中被终止.<br>如果还有其他的 pod在运行， 删除 DaemonSet 也会一起删除这些 pod。</p>

        <h3 id="删除ds"   >
          <a href="#删除ds" class="heading-link"><i class="fas fa-link"></i></a>删除ds</h3>
      <p>删除ds会删除由ds控制schedule到每个节点的pod</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete ds ssd-monitor</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Job资源"   >
          <a href="#Job资源" class="heading-link"><i class="fas fa-link"></i></a>Job资源</h2>
      <p>Kubemetes 通过 Job 资源提供了对此的支持，它允许你运行一种 pod, 该 pod 在内部进程成功结束时， 不重启容器。<br>一旦任务完成， pod 就被认为处于完成状态.<br>由Job管理的pod会一直被重新安排，直到它们成功完成任务.</p>
<p>exporter.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: batch-job</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: batch-job</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: OnFailure		// 默认为Always,Job pod不能使用默认策略， 因为它们不是要无限期地运行</span><br><span class="line">      containers:</span><br><span class="line">      - name: main</span><br><span class="line">        image: luksa/batch-job		// 运行luksa/batch-job镜像，该镜像调用 一个运行120秒的进程，然后退出</span><br></pre></td></tr></table></div></figure>
<p>需要明确地将重启策略 restartPolicy 设置为 OnFailure 或 Never。 此设置防止容器在完成任务时重新启动</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f exporter.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">batch-job-lhnfg     1/1     Running   0          113s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get <span class="built_in">jobs</span></span></span><br><span class="line">NAME        COMPLETIONS   DURATION   AGE</span><br><span class="line">batch-job   0/1           111s       111s</span><br></pre></td></tr></table></div></figure>

<p>等待两三分钟后</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod</span></span><br><span class="line">NAME                READY   STATUS      RESTARTS   AGE</span><br><span class="line">batch-job-lhnfg     0/1     Completed   0          3m21s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get job</span></span><br><span class="line">NAME        COMPLETIONS   DURATION   AGE</span><br><span class="line">batch-job   1/1           2m41s      3m27s</span><br></pre></td></tr></table></div></figure>
<p>完成后pod未被删除的原因是允许你查阅其日志</p>
<figure class="highlight angelscript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs po/batch-job-lhnfg</span><br><span class="line">Thu May <span class="number">14</span> <span class="number">05</span>:<span class="number">04</span>:<span class="number">38</span> UTC <span class="number">2020</span> Batch job starting</span><br><span class="line">Thu May <span class="number">14</span> <span class="number">05</span>:<span class="number">06</span>:<span class="number">38</span> UTC <span class="number">2020</span> Finished succesfully</span><br></pre></td></tr></table></div></figure>
<p>pod 可以被直接删除， 或者在删除创建它的Job时被删除.<br>作业可以配置为创建多个pod实例，并以并行或串行方式运行它们.<br>在Job配置中设置 completions和parallelism属性来完成的.<br>如果你需要 一个Job运行多次，则可以将comple巨ons设为你希望作业的pod运行多少次.  </p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: multi-completion-batch-job</span><br><span class="line">spec:</span><br><span class="line">  completions: 5	// job将一个接一个地运行五个pod</span><br><span class="line">  parallelism: 2	// 最多两个pod可以并行运行</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: batch-job</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      containers:</span><br><span class="line">      - name: main</span><br><span class="line">        image: luksa/batch-job</span><br></pre></td></tr></table></div></figure>

<p>它最初创建一个pod, 当pod的容器运行完成时，它创建第二个pod, 以此类推，直到五个pod成功完成。<br>如果其中 一个pod发生故障，工作会创建一个新的pod, 所以Job总共可以创建五个以上的pod.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f multi-completion-batch-job.yaml</span></span><br><span class="line">NAME                               READY   STATUS              RESTARTS   AGE</span><br><span class="line">multi-completion-batch-job-8kzd5   0/1     ContainerCreating   0          4s</span><br><span class="line">multi-completion-batch-job-9rnxs   0/1     ContainerCreating   0          4s</span><br></pre></td></tr></table></div></figure>
<p>只要其中 一个pod完成任务，工作将运行下 一个pod, 直到五个pod都成功完成任务.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">multi-completion-batch-job-8kzd5   1/1     Running   0          2m8s</span><br><span class="line">multi-completion-batch-job-9rnxs   1/1     Running   0          2m8s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get job</span></span><br><span class="line">NAME                         COMPLETIONS   DURATION   AGE</span><br><span class="line">multi-completion-batch-job   0/5           2m13s      2m13s</span><br></pre></td></tr></table></div></figure>
<p>POD虽然创建，但是POD里的进程任务还没有完成，因此job显示任然是0/5没有一个pod任务完成<br>再等待一会时间</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po</span></span><br><span class="line">NAME                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">multi-completion-batch-job-8kzd5   0/1     Completed   0          4m18s</span><br><span class="line">multi-completion-batch-job-9rnxs   0/1     Completed   0          4m18s</span><br><span class="line">multi-completion-batch-job-blntb   1/1     Running     0          107s</span><br><span class="line">multi-completion-batch-job-qhsr5   1/1     Running     0          92s</span><br><span class="line">ssd-monitor-jbhpd                  1/1     Running     0          176m</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get job</span></span><br><span class="line">NAME                         COMPLETIONS   DURATION   AGE</span><br><span class="line">multi-completion-batch-job   2/5           4m16s      4m16s</span><br></pre></td></tr></table></div></figure>
<p>如上显示已经有2个POD任务完成，POD退出.<br>甚至可以在 Job 运行时更改 Job 的 parallelism 属性, command如下，实验环境没有成功使用</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl scale job multi-completion-batch-job --replicas 3</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>通过在 pod 配置中设置 activeDeadlineSeconds 属性，可以限制 pod的时间。如果 pod 运行时间超过此时间， 系统将尝试终止 pod, 并将 Job 标记为失败。<br>通过指定 Job manifest 中的 spec.backoff巨m辽字段， 可以配置 Job在被标记为失败之前可以重试的次数。 如果你没有明确指定它， 则默认为6</p>
</blockquote>

        <h3 id="删除job"   >
          <a href="#删除job" class="heading-link"><i class="fas fa-link"></i></a>删除job</h3>
      <p>删除job时，由job创建的pod也被直接删除</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete job multi-completion-batch-job</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="CornJob-资源"   >
          <a href="#CornJob-资源" class="heading-link"><i class="fas fa-link"></i></a>CornJob 资源</h2>
      <blockquote>
<p>批处理任务需要在特定的时间运行，或者在指定的时间间隔内重复运行,在 Linux 和类 UNIX 操作系统中， 这些任务通常被称为 cron 任务。 Kubemetes 也支持这种任务<br>Kubemetes 中的 cron 任务通过创建 CronJob 资源进行配置, 运行任务的时间表以知名的 cron 格式指定<br>时间表从左到右包含以下五个条目<br>• 分钟<br>• 小时<br>• 每月中的第几天<br>• 月<br>• 星期几</p>
</blockquote>
<p>创建资源文件(kube API 对象文件)cronjob.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1beta1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">  name: batch-job-every-fifteen-minutes</span><br><span class="line">spec:</span><br><span class="line">  schedule: "0,15,30,55 * * * *"</span><br><span class="line">  startingDeadlineSeconds: 15	// pod最迟必须在预定时间后15秒开始运行， 如果因为任何原因到该启动时间15s后仍不启动，任务将不会运行，并将显示为Failed</span><br><span class="line">  jobTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: periodic-batch-job</span><br><span class="line">        spec:</span><br><span class="line">          restartPolicy: OnFailure</span><br><span class="line">          containers:</span><br><span class="line">          - name: main</span><br><span class="line">            image: luksa/batch-job</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>希望每 15 分钟运行一 次任务因此 schedule 字段的值应该是”0, 15, 30, 45****” 这意味着每小时的 0 、 15 、 30和 45 分钟（第一个星号），每月的每一天（第二个星号），每月（第三个星号）和每周的每一天（第四个星号）。<br>相反，如果你希望每隔 30 分钟运行一 次，但仅在每月的第一天运行，则应将计划设置为 “0,30 * 1 * *”, 并且如果你希望它每个星期天的 3AM 运行，将它设置为 “0 3 * * 0” (最后一个零代表星期天）。</p>
</blockquote>

        <h3 id="查看cronjob"   >
          <a href="#查看cronjob" class="heading-link"><i class="fas fa-link"></i></a>查看cronjob</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cronjob -o wide</span></span><br><span class="line">NAME                              SCHEDULE             SUSPEND   ACTIVE   LAST SCHEDULE   AGE    CONTAINERS   IMAGES            SELECTOR</span><br><span class="line">batch-job-every-fifteen-minutes   0,15,30,55 * * * *   False     0        18m             112m   main         luksa/batch-job   &lt;none&gt;</span><br></pre></td></tr></table></div></figure>


        <h3 id="cronjob运行状态"   >
          <a href="#cronjob运行状态" class="heading-link"><i class="fas fa-link"></i></a>cronjob运行状态</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po</span></span><br><span class="line">NAME                                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">batch-job-every-fifteen-minutes-1589439300-4v8wd   0/1     Completed   0          36m</span><br><span class="line">batch-job-every-fifteen-minutes-1589439600-99pns   0/1     Completed   0          31m</span><br><span class="line">batch-job-every-fifteen-minutes-1589440500-vs5vm   0/1     Completed   0          16m</span><br><span class="line">batch-job-every-fifteen-minutes-1589441400-52rzb   1/1     Running     0          112s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get job</span></span><br><span class="line">NAME                                         COMPLETIONS   DURATION   AGE</span><br><span class="line">batch-job-every-fifteen-minutes-1589439300   1/1           2m24s      36m</span><br><span class="line">batch-job-every-fifteen-minutes-1589439600   1/1           2m24s      31m</span><br><span class="line">batch-job-every-fifteen-minutes-1589440500   1/1           2m22s      16m</span><br><span class="line">batch-job-every-fifteen-minutes-1589441400   0/1           116s       116s</span><br></pre></td></tr></table></div></figure>
<p>再过一点时间查看</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po</span></span><br><span class="line">NAME                                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">batch-job-every-fifteen-minutes-1589439600-99pns   0/1     Completed   0          32m</span><br><span class="line">batch-job-every-fifteen-minutes-1589440500-vs5vm   0/1     Completed   0          17m</span><br><span class="line">batch-job-every-fifteen-minutes-1589441400-52rzb   0/1     Completed   0          2m34s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get job</span></span><br><span class="line">NAME                                         COMPLETIONS   DURATION   AGE</span><br><span class="line">batch-job-every-fifteen-minutes-1589439600   1/1           2m24s      32m</span><br><span class="line">batch-job-every-fifteen-minutes-1589440500   1/1           2m22s      17m</span><br><span class="line">batch-job-every-fifteen-minutes-1589441400   1/1           2m20s      2m37s</span><br></pre></td></tr></table></div></figure>

<p>总结: CornJob过指定的时间执行一次POD，执行完退出，会保留三个POD和Job记录.</p>

        <h3 id="删除cronjob"   >
          <a href="#删除cronjob" class="heading-link"><i class="fas fa-link"></i></a>删除cronjob</h3>
      <p>运行中的 Job 将不会被终止，不会删除 Job 或 它们的 Pod。为了清理那些 Job 和 Pod，需要列出该 Cron Job 创建的Job，然后删除它们.</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> batch-job-every-fifteen-minutes</span></span><br><span class="line">cronjob.batch "batch-job-every-fifteen-minutes" deleted</span><br></pre></td></tr></table></div></figure>

        <h2 id="secret"   >
          <a href="#secret" class="heading-link"><i class="fas fa-link"></i></a>secret</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get secret -n default</span></span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-gtcjx   kubernetes.io/service-account-token   3      32d</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -o wide</span></span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE     IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">wordpress-7bfc545758-vtfvm         1/1     Running   5          10d     10.36.0.10   hci-node04   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">wordpress-mysql-764fc64f97-sjnjk   1/1     Running   0          10d     10.36.0.8    hci-node04   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get po/wordpress-7bfc545758-vtfvm -o yaml</span></span><br><span class="line">......</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - env:</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /var/www/html</span><br><span class="line">      name: wordpress-persistent-storage</span><br><span class="line">    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">      name: default-token-gtcjx</span><br><span class="line">      readOnly: true</span><br><span class="line">......</span><br><span class="line">  volumes:</span><br><span class="line">  - name: wordpress-persistent-storage</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: wp-pv-claim</span><br><span class="line">  - name: default-token-gtcjx</span><br><span class="line">    secret:</span><br><span class="line">      defaultMode: 420		// 访问权限</span><br><span class="line">      secretName: default-token-gtcjx</span><br><span class="line">......</span><br></pre></td></tr></table></div></figure>

<p>进入wordpress-7bfc545758-vtfvm所在机器的容器里查看/var/run/secrets/kubernetes.io/serviceaccount路径文件</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it daec0458a397 /bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls /var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">  ca.crt  namespace  token</span><br></pre></td></tr></table></div></figure>


        <h3 id="创建自己的Secret"   >
          <a href="#创建自己的Secret" class="heading-link"><i class="fas fa-link"></i></a>创建自己的Secret</h3>
      <p>serviceAccount 用来跟Apiserver通信，用来授权, 可以创建自己的Secret<br>编写Secret配置文件 secret.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: dbpass</span><br><span class="line">type: Opaque		// 不透明，浑浊的.</span><br><span class="line">data:</span><br><span class="line">  username: aW1vb2M=		// base64加密的用户名</span><br><span class="line">  passwd: aW1vb2MxMjM=		// base64加密的密码</span><br></pre></td></tr></table></div></figure>

<p>把字符串生成base64很简单，命令如下</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> -n imooc | base64	// -n 表示换行</span></span><br><span class="line">aW1vb2M=</span><br></pre></td></tr></table></div></figure>
<p>编写Pod资源配置文件 pod-secret.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: springbook-web</span><br><span class="line">    image: hub.mooc.com/kubernetes/springboot-web:v1</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: db-secret</span><br><span class="line">      mountPath: /db-secret</span><br><span class="line">      readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">  - name: db-secret</span><br><span class="line">    projected:</span><br><span class="line">      sources:			// secret 来源</span><br><span class="line">      - secret:</span><br><span class="line">        name: dbpass	// secret 名字</span><br></pre></td></tr></table></div></figure>
<p>生成Pod并进入查看</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> / <span class="comment"># cd /db-secret/</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">  passwd username</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat -n username		// 查看容器里存放的是base64解码过的数据</span></span><br><span class="line">  immoc</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat -n passwd</span></span><br><span class="line">  imooc123</span><br></pre></td></tr></table></div></figure>
<p>可以通过修改secret.yaml文件修改secret账号密码等再$ kubectl apply -f secret.yaml来更改密码.</p>

        <h2 id="Configmap"   >
          <a href="#Configmap" class="heading-link"><i class="fas fa-link"></i></a>Configmap</h2>
      <blockquote>
<p>configmap常用来存储不需要加密的数据, 比如应用的启动参数，一些参数的配置等</p>
</blockquote>
<ul>
<li>第一种向k8s添加很多key value的键值对属性值，就可以用configmap</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> touch game.properties</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim game.properties</span></span><br><span class="line">  enemies=aliens</span><br><span class="line">  lives=3</span><br><span class="line">  enemies.cheat=true</span><br><span class="line">  secret.code.allowed=true</span><br><span class="line">  ......</span><br></pre></td></tr></table></div></figure>
<p>配置到K8S里</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create configmap web-game --from-file game.properties</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cm</span></span><br></pre></td></tr></table></div></figure>

<p>使用configmap, Pod-game.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-game</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: web</span><br><span class="line">    image: hub.mooc.com/kubernetes/springboot-web:v1</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: game</span><br><span class="line">      mountPath: /etc/config/game</span><br><span class="line">      readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">  - name: game</span><br><span class="line">    configMap:</span><br><span class="line">      name: web-game</span><br></pre></td></tr></table></div></figure>
<p>生成Pod并进入查看</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /etc/config/game</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">  game.properties</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat game.properties</span></span><br><span class="line">  enemies=aliens</span><br><span class="line">  lives=3</span><br><span class="line">  enemies.cheat=true</span><br><span class="line">  secret.code.allowed=true</span><br><span class="line">  ......</span><br></pre></td></tr></table></div></figure>

<p>可以通过kubectl edit 修改configMap账号密码等</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl edit cm web-game -o yaml</span></span><br><span class="line">  enemies.cheat=false	//等等操作</span><br></pre></td></tr></table></div></figure>

<ul>
<li>第二种配置文件方式创建configMap<br>configmap.yaml</li>
</ul>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apeVersion: v1</span><br><span class="line">kind: Configmap</span><br><span class="line">metadata:</span><br><span class="line">  name: configs</span><br><span class="line">data:</span><br><span class="line">  Java_OPTS: -Xms1024m</span><br><span class="line">  LOG_LEVEL: DEBUG</span><br></pre></td></tr></table></div></figure>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f configmap.yaml</span></span><br></pre></td></tr></table></div></figure>

<p>编写资源配置文件pod-env.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-env</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: web</span><br><span class="line">    image: hub.mooc.com/kubernetes/springboot-web:v1</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    env:</span><br><span class="line">      - name: LOG_LEVEL_CONFIG</span><br><span class="line">        valueFrom:</span><br><span class="line">          configMapKeyRef:</span><br><span class="line">            name: configs		// 指定configMap名字</span><br><span class="line">            key: LOG_LEVEL		// configs下面的LOG_LEVEL</span><br></pre></td></tr></table></div></figure>
<p>进入容器查看环境变量</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> env | grep LOG</span></span><br><span class="line">  LOG_LEVEL_CONFIG=DEBUG</span><br></pre></td></tr></table></div></figure>
<p>之后次容器就可以通过环境变量获取值</p>
<ul>
<li>第三种 通过命令行方式传进参数<br>也是先跟第二种一样创建configMap资源</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f configmap.yaml</span></span><br></pre></td></tr></table></div></figure>
<p>编写资源配置文件pod-cmd.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-cmd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: web</span><br><span class="line">    image: hub.mooc.com/kubernetes/springboot-web:v1</span><br><span class="line">    command: ["/bin/sh", "-c", "java -jar /springboot-web.jar -DJAVA_OPTS=$(JAVA_OPTS)"]</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    env:</span><br><span class="line">      - name: Java_OPTS</span><br><span class="line">        valueFrom:</span><br><span class="line">          configMapKeyRef:</span><br><span class="line">            name: configs		// 指定configMap名字</span><br><span class="line">            key: Java_OPTS		// configs下面的LOG_LEVEL</span><br></pre></td></tr></table></div></figure>
<p>进入容器查看进程</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef</span></span><br><span class="line">  java -jar /springboot-web.jar -DJAVA_OPTS=-Xms1024m</span><br></pre></td></tr></table></div></figure>


        <h2 id="downwardAPI"   >
          <a href="#downwardAPI" class="heading-link"><i class="fas fa-link"></i></a>downwardAPI</h2>
      <p>downwardAPI主要作用是在程序中取得Pod对象本身的一些相关信息<br>pod-downwardapi.yaml</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-downwardapi</span><br><span class="line">  labels:</span><br><span class="line">    app： downwardapi</span><br><span class="line">    type: webapp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: web</span><br><span class="line">    image: hub.mooc.com/kubernetes/springboot-web:v1</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: podinfo</span><br><span class="line">        mountPath: /etc/podinfo</span><br><span class="line">  volumes:</span><br><span class="line">    - name: podinfo</span><br><span class="line">      projected:</span><br><span class="line">        sources:</span><br><span class="line">        - downwardAPI:</span><br><span class="line">          items:</span><br><span class="line">            - path: "labels"</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.labels</span><br><span class="line">            - path: "name"</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.name</span><br><span class="line">            - path: "namespace"</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.namespace</span><br><span class="line">            - path: "mem-request"</span><br><span class="line">              resourceFieldRef:</span><br><span class="line">                containerName: web</span><br><span class="line">                resource: limits.memory</span><br></pre></td></tr></table></div></figure>

<p>进入容器查看文件信息</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /etc/podinfo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -l</span></span><br><span class="line">  labels mem-request name namespace</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat -n labels</span></span><br><span class="line">  app="downwardapi"</span><br><span class="line">  type="webapp"</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat -n namespace</span></span><br><span class="line">  default</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat -n name</span></span><br><span class="line">  pod-downwardapi</span><br></pre></td></tr></table></div></figure>

</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://kung-fu-master.github.io">Kung-Fu-Master</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/03_kubernetes_ns_pod/">https://kung-fu-master.github.io/2021/03/13/micro_service/kubernetes/03_kubernetes_ns_pod/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://kung-fu-master.github.io/tags/kubernetes/">kubernetes</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/03/13/micro_service/kubernetes/06_kubernetes_deployment/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">06 Kubernetes deployment</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/03/13/micro_service/kubernetes/07_kubernetes_Etcd/"><span class="paginator-prev__text">07 Kubernetes Etcd</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#nodes"><span class="toc-number">1.</span> <span class="toc-text">
          nodes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建别名和补全"><span class="toc-number">1.1.</span> <span class="toc-text">
          创建别名和补全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-标签"><span class="toc-number">1.2.</span> <span class="toc-text">
          node 标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#taint污点"><span class="toc-number">1.3.</span> <span class="toc-text">
          taint污点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Namespace"><span class="toc-number">2.</span> <span class="toc-text">
          Namespace</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#隔离性"><span class="toc-number">2.1.</span> <span class="toc-text">
          隔离性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置默认命名空间"><span class="toc-number">2.2.</span> <span class="toc-text">
          设置默认命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建命名空间"><span class="toc-number">2.3.</span> <span class="toc-text">
          创建命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#划分方式"><span class="toc-number">2.4.</span> <span class="toc-text">
          划分方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#标记命名空间"><span class="toc-number">2.5.</span> <span class="toc-text">
          标记命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看标记-istio-injection-enabled-标签的命名空间"><span class="toc-number">2.6.</span> <span class="toc-text">
          查看标记 istio-injection&#x3D;enabled 标签的命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除namespace"><span class="toc-number">2.7.</span> <span class="toc-text">
          删除namespace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POD"><span class="toc-number">3.</span> <span class="toc-text">
          POD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查看pod解释"><span class="toc-number">3.1.</span> <span class="toc-text">
          查看pod解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建POD"><span class="toc-number">3.2.</span> <span class="toc-text">
          创建POD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一直查看pod状态"><span class="toc-number">3.3.</span> <span class="toc-text">
          一直查看pod状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod标签labels"><span class="toc-number">3.4.</span> <span class="toc-text">
          pod标签labels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod-注解"><span class="toc-number">3.5.</span> <span class="toc-text">
          pod 注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看该-pod-的完整描述文件："><span class="toc-number">3.6.</span> <span class="toc-text">
          查看该 pod 的完整描述文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行pod容器"><span class="toc-number">3.7.</span> <span class="toc-text">
          执行pod容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#容器进程-网络等"><span class="toc-number">3.8.</span> <span class="toc-text">
          容器进程, 网络等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看Pod-svc日志"><span class="toc-number">3.9.</span> <span class="toc-text">
          查看Pod, svc日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署应用程序"><span class="toc-number">3.10.</span> <span class="toc-text">
          部署应用程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重启Pod"><span class="toc-number">3.11.</span> <span class="toc-text">
          重启Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除Pod"><span class="toc-number">3.12.</span> <span class="toc-text">
          删除Pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#livenessProbe-存活探针-readinessProbe"><span class="toc-number">4.</span> <span class="toc-text">
          livenessProbe 存活探针, readinessProbe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查看-readinessProbe-healthProbe"><span class="toc-number">4.1.</span> <span class="toc-text">
          查看 readinessProbe, healthProbe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#affinity"><span class="toc-number">4.2.</span> <span class="toc-text">
          affinity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod启动停止控制"><span class="toc-number">4.3.</span> <span class="toc-text">
          Pod启动停止控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicationController"><span class="toc-number">5.</span> <span class="toc-text">
          ReplicationController</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#由RC创建POD"><span class="toc-number">5.1.</span> <span class="toc-text">
          由RC创建POD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取有关-ReplicationController-的信息"><span class="toc-number">5.2.</span> <span class="toc-text">
          获取有关 ReplicationController 的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编辑RC的YAML配置"><span class="toc-number">5.3.</span> <span class="toc-text">
          编辑RC的YAML配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RC-扩容"><span class="toc-number">5.4.</span> <span class="toc-text">
          RC 扩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除RC"><span class="toc-number">5.5.</span> <span class="toc-text">
          删除RC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">6.</span> <span class="toc-text">
          ReplicaSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#matchExpressions选择器"><span class="toc-number">6.1.</span> <span class="toc-text">
          matchExpressions选择器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看-replicaset-和-deployment-的详细信息"><span class="toc-number">6.2.</span> <span class="toc-text">
          查看 replicaset 和 deployment 的详细信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除ReplicaSet"><span class="toc-number">6.3.</span> <span class="toc-text">
          删除ReplicaSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet"><span class="toc-number">7.</span> <span class="toc-text">
          DaemonSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查看DaemonSet"><span class="toc-number">7.1.</span> <span class="toc-text">
          查看DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除ds"><span class="toc-number">7.2.</span> <span class="toc-text">
          删除ds</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Job资源"><span class="toc-number">8.</span> <span class="toc-text">
          Job资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#删除job"><span class="toc-number">8.1.</span> <span class="toc-text">
          删除job</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CornJob-资源"><span class="toc-number">9.</span> <span class="toc-text">
          CornJob 资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查看cronjob"><span class="toc-number">9.1.</span> <span class="toc-text">
          查看cronjob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cronjob运行状态"><span class="toc-number">9.2.</span> <span class="toc-text">
          cronjob运行状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除cronjob"><span class="toc-number">9.3.</span> <span class="toc-text">
          删除cronjob</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secret"><span class="toc-number">10.</span> <span class="toc-text">
          secret</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建自己的Secret"><span class="toc-number">10.1.</span> <span class="toc-text">
          创建自己的Secret</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configmap"><span class="toc-number">11.</span> <span class="toc-text">
          Configmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#downwardAPI"><span class="toc-number">12.</span> <span class="toc-text">
          downwardAPI</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Kung-Fu-Master</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://plus.google.com/" target="_blank" rel="noopener" data-popover="Google" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-google"></i></span></a><a class="sidebar-ov-social-item" href="https://twitter.com/" target="_blank" rel="noopener" data-popover="Twitter" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-twitter"></i></span></a><a class="sidebar-ov-social-item" href="https://youtube.com/" target="_blank" rel="noopener" data-popover="Youtube" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-youtube"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">291</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">40</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Kung-Fu-Master</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v4.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.1"></script><script src="/js/stun-boot.js?v=2.6.1"></script><script src="/js/scroll.js?v=2.6.1"></script><script src="/js/header.js?v=2.6.1"></script><script src="/js/sidebar.js?v=2.6.1"></script><script type="application/json" src="/search.json"></script></body></html>