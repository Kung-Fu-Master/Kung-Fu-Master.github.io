---
title: Docker Content Trust(DCT) and Notary
tags: docker
categories:
- technologies
- docker
---

reference: https://docs.docker.com/engine/security/trust/

## 生成根证书

A prerequisite for signing an image is a Docker Registry with a Notary server attached (Such as the Docker Hub ). Instructions for standing up a self-hosted environment can be found here [deploying_notary](https://docs.docker.com/engine/security/trust/deploying_notary/).

<!-- more -->
To sign a Docker Image you will need a delegation key pair. These keys can be generated locally using **`$ docker trust key generate`** or generated by a certificate authority.

```
openssl genrsa -out key.pem 3072
openssl req -new -sha512 -key key.pem -out key.csr
	填写信息直接回车, 到要填写CN处输入*然后回车
	Common Name (eg, your name or your server's hostname) []:*
openssl x509 -req -sha512 -days 365 -in key.csr -signkey key.pem -out key.crt
chmod 600 key.pem
export DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE="12345678" //有这一步后下面的命令就不需要再输入密码
docker trust key load key.pem --name jeff
	输入passphrase: 12345678
```

之后会在 **`~/.docker/trust/private/`** 生成相应的key


Within the Docker CLI we can sign and push a container image with the **`$ docker trust`** command syntax. This is built on top of the Notary feature set, more information on Notary can be found here [notary-get-start](https://docs.docker.com/notary/getting_started/).


## 部署notary server, signer, mysql

```
git clone https://github.com/theupdateframework/notary.git
cd notary
vim  -O server.Dockerfile signer.Dockerfile 添加如下两行配置proxy
	ENV http_proxy=http://child-prc.intel.com:913
	ENV https_proxy=http://child-prc.intel.com:913
docker-compose build
docker-compose up -d
mkdir -p ~/.notary && cp cmd/notary/config.json cmd/notary/root-ca.crt ~/.notary
```

修改~/.notary/config.json文件
```
	"url": "https://notary-server:4443",  -->> "url": "https://127.0.0.1:4443",
```

Add **`127.0.0.1 notary-server`** to your **`/etc/hosts`**, or if using docker-machine, add $(docker-machine ip) notary-server).
You can run through the examples in the getting started docs and advanced usage docs, but without the**` -s`** (server URL) argument to the **`notary`** command since the server URL is specified already in the configuration, file you copied.

You can also leave off the **`-d ~/.docker/trust`** argument if you do not care to use **`notary`** with Docker images.

```
docker ps | grep notary
	bcaa8af05a11        notary_server                    "/usr/bin/env sh -c …"   3 hours ago         Up 3 hours          0.0.0.0:4443->4443/tcp, 0.0.0.0:32769->8080/tcp   notary_server_1
	8a5f51586629        notary_signer                    "/usr/bin/env sh -c …"   3 hours ago         Up 3 hours                                                            notary_signer_1
	17920752ae65        mariadb:10.4                     "docker-entrypoint.s…"   3 hours ago         Up 3 hours          3306/tcp                                          notary_mysql_1
```

验证证书:
```
openssl verify -CAfile <(cat fixtures/intermediate-ca.crt fixtures/root-ca.crt) fixtures/notary-server.crt
```

测试 connect to notary server

```
openssl s_client -connect 10.239.140.65:4443 -CAfile fixtures/root-ca.crt -no_ssl3 -no_ssl2
openssl s_client -connect 10.239.140.65:4443 -CAfile ~/.notary/root-ca.crt -no_ssl3 -no_ssl2
```

配置notary server端证书到docker目录
```
export DOCKER_CONTENT_TRUST_SERVER=https://127.0.0.1:4443
export DOCKER_CONTENT_TRUST=1
mkdir ~/.docker/tls/127.0.0.1:4443 -p
cp notary/fixtures/notary-server.crt ~/.docker/tls/127.0.0.1\:4443/ca.crt
```

add the delegation public key to the Notary server; this is specific to a particular image repository in Notary known as a Global Unique Name (GUN).
By default, the **`$ docker trust`** commands expect the notary server URL to be the same as the registry URL specified in the image tag (following a similar logic to **`$ docker push`**). When using Docker Hub or DTR, the notary server URL is the same as the registry URL. However, for self-hosted environments or 3rd party registries, you will need to specify an alternative URL for the notary server. This is done with:

```
	//export DOCKER_CONTENT_TRUST_SERVER=https://<URL>:<PORT>
	export DOCKER_CONTENT_TRUST_SERVER=https://127.0.0.1:4443
```

私有仓库(如10.239.140.65:5000/python)先前已经存在, 上传签名key到此私有仓库，于此同时初始化此私有仓库
```
	docker trust signer add --key certs/key.crt jeff 10.239.140.65:5000/python
```
**`NOTE:`** 通过registry:2 搭建的private repository里的 **`python目录`** 就相当于一个私有仓库, 而其它目录如 **`dir02`** 就是另外的仓库.
如果用 **`trust signer`** 上传到 **`dir02`** 就会重新生成singer key到 **`dir02`**仓库, 此过程会需要你重新设置 **dir02**仓库singer key的PASSPHRASE
上面操作后应该是会在宿主机 **`ls ~/.docker/trust/private/`** 生成signer key, 下次操作时候可以注意下.

签名本地image并上传到private repository:
use the delegation private key to sign a particular tag and push it up to the registry：

```
	docker trust sign 10.239.140.65:5000/python:3.9.1-slim-security-01
```
Remote trust data for a tag or a repository can be viewed by the $ docker trust inspect command:
如果sign过的image显示信息如下:

```
	$ docker trust inspect --pretty 10.239.140.65:5000/python:3.9.1-slim-security-01
	Signatures for 10.239.140.65:5000/python:3.9.1-slim-security-01
	
	SIGNED TAG               DIGEST                                                             SIGNERS
	3.9.1-slim-security-01   b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33   jeff
	
	List of signers and their keys for 10.239.140.65:5000/python:3.9.1-slim-security-01
	
	SIGNER              KEYS
	jeff                3e6bcd979c6c
	
	Administrative keys for 10.239.140.65:5000/python:3.9.1-slim-security-01
	
	  Repository Key:       fd98d671f8da8902c3202891513c743408039cf747185ce74a3790142a0a2535
	  Root Key:     f6ee60c9640fb9ed3a3086c3d884a1fde655a31e5fd0eed70e07ba985c634f95
```

没有sign过的image显示信息如下, 缺少SIGNED TAG信息:
```
	$ docker trust inspect --pretty 10.239.140.65:5000/python:3.9.1-slim
	No signatures for 10.239.140.65:5000/python:3.9.1-slim
	
	List of signers and their keys for 10.239.140.65:5000/python:3.9.1-slim
	
	SIGNER              KEYS
	jeff                3e6bcd979c6c
	
	Administrative keys for 10.239.140.65:5000/python:3.9.1-slim
	
	  Repository Key:       fd98d671f8da8902c3202891513c743408039cf747185ce74a3790142a0a2535
	  Root Key:     f6ee60c9640fb9ed3a3086c3d884a1fde655a31e5fd0eed70e07ba985c634f95
```

去除Remote Trust data for a tag:
```
	docker trust revoke 10.239.140.65:5000/python:3.9.1-slim-security-01
```

使docker 客户端强制实行DCT
Content trust is disabled by default in the Docker Client. To enable it, set the DOCKER_CONTENT_TRUST environment variable to 1
```
	export DOCKER_CONTENT_TRUST=1
```

When DCT is enabled in the Docker client, **`docker`** CLI commands that operate on tagged images must either have content signatures or explicit content hashes. The commands that operate with DCT are:
 • push
 • build
 • create
 • pull
 • run

For example, with DCT enabled a docker pull someimage:latest only succeeds if someimage:latest is signed. However, an operation with an explicit content hash always succeeds as long as the hash exists:
```
	$ docker pull 10.239.140.65:5000/python:3.9.1-slim
	No valid trust data for 3.9.1-slim
	
	$ docker pull 10.239.140.65:5000/python:3.9.1-slim-security-01
	Pull (1 of 1): 10.239.140.65:5000/python:3.9.1-slim-security-01@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33: Pulling from python
	Digest: sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	Status: Image is up to date for 10.239.140.65:5000/python@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	Tagging 10.239.140.65:5000/python@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33 as 10.239.140.65:5000/python:3.9.1-slim-security-01
	10.239.140.65:5000/python:3.9.1-slim-security-01
	
	$ docker pull 10.239.140.65:5000/python:3.9.1-slim@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33: Pulling from python
	Digest: sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	Status: Image is up to date for 10.239.140.65:5000/python@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	10.239.140.65:5000/python:3.9.1-slim@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	
	$ docker images | grep python 
	看不到上面的10.239.140.65:5000/python:3.9.1-slim@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33
	
	但是可以通过tag命令给此image再添加标签如:
	$ docker tag 10.239.140.65:5000/python:3.9.1-slim@sha256:b2013807b8af03d66f60a979f20d4e93e4e4a111df1287d9632c8cfd41ecfa33 10.239.140.65:5000/python:test
	$ docker images | grep python
	10.239.140.65:5000/python                               test                           edd87973afe0        2 weeks ago         114MB
```

## 下载notary client
If you would like to use your own Notary server, it is important to use the same or a newer Notary version, as the client for feature compatibility (ex: client version 0.2, server/signer version >= 0.2). (reference: https://docs.docker.com/notary/getting_started/#inspect-a-docker-hub-repository)
查看nodary server signer版本

```
docker images | grep notary

wget https://github.com/theupdateframework/notary/releases/download/v0.6.1/notary-Linux-amd64
chmod +x notary-Linux-amd64
cp notary-Linux-amd64 /usr/local/bin/notary
notary version
```

The Notary client used in isolation does not know where the trust repositories are located. So, you must provide the **`-s`** (or long form **`--server`** ) flag to tell the client which repository server it should communicate with.

Additionally, Notary stores your own signing keys, and a cache of previously downloaded trust metadata in a directory, provided with the **`-d`** flag. When interacting with Docker Hub repositories, you must instruct the client to use the associated trust directory, which by default is found at **`.docker/trust`** within the calling user’s home directory (failing to use this directory may result in errors when publishing updates to your trust data):

```
$ notary -s https://notary.docker.io -d ~/.docker/trust list docker.io/library/alpine
   NAME                                 DIGEST                                SIZE (BYTES)    ROLE
------------------------------------------------------------------------------------------------------
  2.6      e9cec9aec697d8b9d450edd32860ecd363f2f3174c8338beb5f809422d182c63   1374           targets
  2.7      9f08005dff552038f0ad2f46b8e65ff3d25641747d3912e3ea8da6785046561a   1374           targets
  3.1      e876b57b2444813cd474523b9c74aacacc238230b288a22bccece9caf2862197   1374           targets
  3.2      4a8c62881c6237b4c1434125661cddf09434d37c6ef26bf26bfaef0b8c5e2f05   1374           targets
  3.3      2d4f890b7eddb390285e3afea9be98a078c2acd2fb311da8c9048e3d1e4864d3   1374           targets
  edge     878c1b1d668830f01c2b1622ebf1656e32ce830850775d26a387b2f11f541239   1374           targets
  latest   24a36bbc059b1345b7e8be0df20f1b23caa3602e85d42fff7ecd9d0bd255de56   1377           targets
```


## Rotate keys
Reference: https://github.com/theupdateframework/notary/blob/master/docs/advanced_usage.md#manage-keys













