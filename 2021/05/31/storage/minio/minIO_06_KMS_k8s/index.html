<!-- build time:Mon May 31 2021 11:46:07 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Hexo" href="https://kung-fu-master.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Hexo" href="https://kung-fu-master.github.io/atom.xml"><link rel="alternate" type="application/json" title="Hexo" href="https://kung-fu-master.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="storage"><link rel="canonical" href="https://kung-fu-master.github.io/2021/05/31/storage/minio/minIO_06_KMS_k8s/"><title>06 Deploy Vault, Consul, KES, MinIO on kubernetes - minio - storage | Kung Fu Master = Hexo</title><meta name="generator" content="Hexo 4.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">06 Deploy Vault, Consul, KES, MinIO on kubernetes</h1><div class="meta"><span class="item" title="创建时间：2021-05-31 11:28:46"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-05-31T11:28:46+08:00">2021-05-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>33k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>30 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Kung Fu Master</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclhfehz7j20zk0m8u0x.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclflwv2aj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclj9410cj20zk0m8h12.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeyonbf9j20zk0m8e81.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/storage/" itemprop="item" rel="index" title="分类于 storage"><span itemprop="name">storage</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/storage/minio/" itemprop="item" rel="index" title="分类于 minio"><span itemprop="name">minio</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://kung-fu-master.github.io/2021/05/31/storage/minio/minIO_06_KMS_k8s/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Kung-Fu-Master"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><div class="body md" itemprop="articleBody"><h2 id="总览"><a class="anchor" href="#总览">#</a> 总览</h2><p>Vault, Consul, KES, MinIO 都部署在 K8s.</p><h2 id="referenc-link"><a class="anchor" href="#referenc-link">#</a> referenc link</h2><p>vault:<br><span class="exturl" data-url="aHR0cDovL2RvY3MubWluaW8ub3JnLmNuL2RvY3MvbWFzdGVyL21pbmlvLWttcy1xdWlja3N0YXJ0LWd1aWRl">http://docs.minio.org.cn/docs/master/minio-kms-quickstart-guide</span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhc2hpY29ycC92YXVsdC1oZWxtL2Jsb2IvbWFzdGVyL3ZhbHVlcy55YW1s">https://github.com/hashicorp/vault-helm/blob/master/values.yaml</span><br><span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5oYXNoaWNvcnAuY29tL3R1dG9yaWFscy92YXVsdC9rdWJlcm5ldGVzLXJhZnQtZGVwbG95bWVudC1ndWlkZT9pbj12YXVsdC9rdWJlcm5ldGVz">https://learn.hashicorp.com/tutorials/vault/kubernetes-raft-deployment-guide?in=vault/kubernetes</span><br><span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5oYXNoaWNvcnAuY29tL3R1dG9yaWFscy92YXVsdC90cm91Ymxlc2hvb3RpbmctdmF1bHQ/aW49dmF1bHQvb3BlcmF0aW9ucyNzZXJ2ZXItZ2F2ZS1odHRwLXJlc3BvbnNlLXRvLWh0dHBzLWNsaWVudA==">https://learn.hashicorp.com/tutorials/vault/troubleshooting-vault?in=vault/operations#server-gave-http-response-to-https-client</span></p><p>KES:<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pbmlvL2tlcw==">https://github.com/minio/kes</span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pbmlvL2tlcy9ibG9iL21hc3Rlci9Eb2NrZXJmaWxlLnJlbGVhc2U=">https://github.com/minio/kes/blob/master/Dockerfile.release</span></p><h2 id="概念"><a class="anchor" href="#概念">#</a> 概念</h2><p>MinIO 使用密钥管理系统（KMS）支持 SSE-S3。如果客户端请求 SSE-S3，或 启用了自动加密，则 MinIO 服务器会使用唯一的对象密钥对每个对象进行加密，该对象密钥受 KMS 管理的主密钥保护。</p><p>KMS 将 MinIO 作为面向应用程序的存储系统与安全密钥存储区分开，并且 可以由专门的安全团队进行管理。MinIO 通过我们的 KES project 支持常用的 KMS 实现，例如 Hashicorp Vault。 通过 KES，可以利用存储基础架构（MinIO 群集）水平扩展 KMS。 通常，MinIO-KMS 基础结构如下所示：</p><pre><code>     ┌─────────┐         ┌────────────┐         ┌─────────┐  
     │  MinIO  ├─────────┤ KES Server ├─────────┤   KMS   │ 
     └─────────┘         └────────────┘         └─────────┘  
</code></pre><p>当您将存储基础架构扩展到多个 MinIO 群集时，您的架构应如下所示：</p><pre><code>    ┌────────────┐
    │ ┌──────────┴─┬─────╮          ┌────────────┐
    └─┤ ┌──────────┴─┬───┴──────────┤ ┌──────────┴─┬─────────────────╮
      └─┤ ┌──────────┴─┬─────┬──────┴─┤ KES Server ├─────────────────┤
        └─┤   MinIO    ├─────╯        └────────────┘            ┌────┴────┐
          └────────────┘                                        │   KMS   │
                                                                └─────────┘
</code></pre><p><strong><code>请注意</code> </strong>，所有 MinIO 群集均仅具有 <strong><code>其自己的</code> </strong>KES 实例的连接，而不能直接访问 Vault（作为一种可能的 KMS 实现）。 每个 KES 实例将处理 “其” MinIO 群集发出的所有加密 / 解密请求，从而使中央 KMS 实现不必处理 大量流量。相反，每个 KES 实例都将使用中央 KMS 实现作为安全密钥存储，并从中获取所需的主密钥。</p><p>该指南显示了如何使用 Hashicorp Vault 作为 KMS 实施来设置 MinIO-KMS 部署。 因此，它显示了如何设置和配置：</p><ul><li>Vault 服务器作为中央密钥库。</li><li>一个 KES 服务器实例，作为 MinIO 和保险柜之间的中间件。</li><li>MinIO 实例本身。</li></ul><div class="note info"><p><strong><code>请注意,</code> </strong>为简便起见，本指南使用自签名证书。在生产部署中，应使用 由<span class="blue"> “公共”</span>（例如，让我们加密）或组织内部的 CA 颁发的 X.509 证书。</p></div><p>本指南说明如何在同一台计算机上设置三台不同的服务器：</p><ul><li>Vault 服务器在 K8S 集群中为 <span class="exturl" data-url="aHR0cHM6Ly92YXVsdC5kZXYuc3ZjLmNsdXN0ZXIubG9jYWw6ODIwMA==">https://vault.dev.svc.cluster.local:8200</span></li><li>KES 服务器在 K8S 集群中为 <span class="exturl" data-url="aHR0cHM6Ly9rZXMtc3ZjLm1pbmlvLnN2Yy5jbHVzdGVyLmxvY2FsOjczNzM=">https://kes-svc.minio.svc.cluster.local:7373</span></li><li>MinIO 在 K8s 上部署后 9000 映射到主机端口位 30007, K8S 集群中服务地址:<span class="exturl" data-url="aHR0cHM6Ly9taW5pby1obC1zdmMubWluaW8uc3ZjLmNsdXN0ZXIubG9jYWw=">https://minio-hl-svc.minio.svc.cluster.local</span>; 映射到本地 30007 端口，所以本地 minio 服务地址为:<span class="exturl" data-url="aHR0cHM6Ly8xMC4yMzkuMTQwLjczOjMwMDA3">https://10.239.140.73:30007</span> or <span class="exturl" data-url="aHR0cHM6Ly8xMjcuMC4wLjE6MzAwMDc=">https://127.0.0.1:30007</span></li></ul><h2 id="download"><a class="anchor" href="#download">#</a> Download</h2><p>安装 MinIO，KES 和 Vault。对于 MinIO，请参阅 MinIO 快速入门指南。然后安装 KES 并下载 适用于您的操作系统和平台的最新 Vault 二进制文件.</p><h3 id="vault"><a class="anchor" href="#vault">#</a> Vault:</h3><figure class="highlight bash"><figcaption data-lang="bash"><span>h 命令行提示符</span></figcaption><table><tr class="marked"><td data-num="1"></td><td data-command="$"></td><td><pre><span class="token function">wget</span> https://releases.hashicorp.com/vault/1.7.0-rc1/vault_1.7.0-rc1_linux_amd64.zip</pre></td></tr><tr class="marked"><td data-num="2"></td><td data-command="$"></td><td><pre><span class="token function">unzip</span> vault_1.7.0-rc1_linux_amd64.zip</pre></td></tr><tr class="marked"><td data-num="3"></td><td data-command="$"></td><td><pre><span class="token function">mv</span> vault /usr/local/bin/ <span class="token comment"># 如果 cp 过去的话，下面启动 vault server 时候自动创建的 vault 文件夹会与此已存在的 vault 二进制文件冲突，因此直接 move 过去.</span></pre></td></tr><tr><td data-num="4"></td><td data-command=""></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td data-command="#"></td><td><pre><span class="token comment"># vault 可以在 Linux 系统上使用 mlock syscall 来防止 OS 将内存中的数据写入磁盘（交换）</span></pre></td></tr><tr><td data-num="6"></td><td data-command="$"></td><td><pre><span class="token function">sudo</span> setcap <span class="token assign-left variable">cap_ipc_lock</span><span class="token operator">=</span>+ep <span class="token variable"><span class="token variable">$(</span>readlink -f <span class="token punctuation">$(</span>which vault<span class="token punctuation">)</span><span class="token variable">)</span></span></pre></td></tr></table></figure><h3 id="kes"><a class="anchor" href="#kes">#</a> KES:</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pbmlvL2tlcyNiaW5hcnktcmVsZWFzZXM=">https://github.com/minio/kes#binary-releases</span></p><pre><code>wget https://github.com/minio/kes/releases/latest/download/kes-linux-amd64
mv kes-linux-amd64 kes
chmod +x kes
cp kes /usr/local/bin/
kes -h

# KES 可以在Linux系统上使用 mlock syscall 来防止 OS 将内存中的数据写入磁盘（交换）
sudo setcap cap_ipc_lock=+ep $(readlink -f $(which kes))
</code></pre><h3 id="minio"><a class="anchor" href="#minio">#</a> MinIO：</h3><pre><code>wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
cp minio /usr/local/bin/
</code></pre><h3 id="mc"><a class="anchor" href="#mc">#</a> mc:</h3><pre><code>wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
./mc --help
</code></pre><h2 id="机器配置"><a class="anchor" href="#机器配置">#</a> 机器配置</h2><table><thead><tr><th style="text-align:left">IP</th><th style="text-align:left">机器名</th><th style="text-align:left">用途</th></tr></thead><tbody><tr><td style="text-align:left">10.239.140.73</td><td style="text-align:left">master</td><td style="text-align:left">K8S 集群节点，master (去除污点), 部署 KMS, KES, MinIO 到 K8S 集群</td></tr><tr><td style="text-align:left">10.239.131.157</td><td style="text-align:left">laboratory</td><td style="text-align:left">K8S 集群节点，master (去除污点)</td></tr></tbody></table><p>openssl 版本：</p><pre><code>$ openssl version -a
OpenSSL 1.1.1j  16 Feb 2021
built on: Tue Mar 16 02:55:39 2021 UTC
platform: linux-x86_64
options:  bn(64,64) rc4(16x,int) des(int) idea(int) blowfish(ptr)
compiler: gcc -fPIC -pthread -m64 -Wa,--noexecstack -Wall -O3 -DOPENSSL_USE_NODELETE -DL_ENDIAN -DOPENSSL_PIC -DOPENSSL_CPUID_OBJ -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DKECCAK1600_ASM -DRC4_ASM -DMD5_ASM -DAESNI_ASM -DVPAES_ASM -DGHASH_ASM -DECP_NISTZ256_ASM -DX25519_ASM -DPOLY1305_ASM -DZLIB -DNDEBUG
OPENSSLDIR: &quot;/usr/local/openssl/ssl&quot;
ENGINESDIR: &quot;/usr/local/openssl/lib/engines-1.1&quot;
Seeding source: os-specific
</code></pre><h2 id="生成证书"><a class="anchor" href="#生成证书">#</a> 生成证书</h2><h3 id="根证书"><a class="anchor" href="#根证书">#</a> 根证书</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> pki</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> pki</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>openssl genrsa -out <span class="token string">"root-ca.key"</span> <span class="token number">4096</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 注意，csr 里 subj 的 CN 会覆盖下面生成证书配置文件的 CN.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>openssl req -new -key <span class="token string">"root-ca.key"</span> -out <span class="token string">"root-ca.csr"</span> -sha512 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        -subj <span class="token string">'/C=US/ST=CA/L=China/O=Hce/CN=Vault CA'</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">cat</span> <span class="token operator">></span> <span class="token string">"root-ca.conf"</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span></pre></td></tr><tr><td data-num="11"></td><td><pre>[root_ca]</pre></td></tr><tr><td data-num="12"></td><td><pre>basicConstraints = critical,CA:TRUE,pathlen:1</pre></td></tr><tr><td data-num="13"></td><td><pre>keyUsage = critical, nonRepudiation, cRLSign, keyCertSign</pre></td></tr><tr><td data-num="14"></td><td><pre>subjectKeyIdentifier=hash</pre></td></tr><tr><td data-num="15"></td><td><pre>EOF</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>openssl x509 -req -days <span class="token number">3650</span> -in <span class="token string">"root-ca.csr"</span> -signkey <span class="token string">"root-ca.key"</span> -sha512 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        -out <span class="token string">"root-ca.crt"</span> -extfile <span class="token string">"root-ca.conf"</span> -extensions root_ca</pre></td></tr></table></figure><p><strong><span class="blue">&quot;-extensions root_ca&quot;</span></strong> 指向 minio-crt.conf 配置文件中的 <strong><span class="blue">[root_ca]</span></strong>.</p><ul><li><p>CA 证书必须包含 **<span class="blue">basicConstraints</span>** 值，且 CA 参数需为 TRUE。终端用户证书必须将 CA 参数设置为 FALSE，或者不包含 basicConstraints 值。</p></li><li><p><strong><span class="blue">pathlen</span></strong> 参数指明了在证书链的当前证书之下允许存在的最大 CA 数量。当 CA 的 pathlen 值为 0 时，该 CA 仅能对终端用户证书进行签名，不能再对 CA 进行签名。</p></li></ul><h3 id="vault证书"><a class="anchor" href="#vault证书">#</a> vault 证书</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 生成 vault 证书</span></pre></td></tr><tr><td data-num="2"></td><td><pre>openssl ecparam -genkey -name prime256v1 <span class="token operator">|</span> openssl ec -out vault-server.key</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>openssl req -new  -key <span class="token string">"vault-server.key"</span> -out <span class="token string">"vault-server.csr"</span> -sha384 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        -subj <span class="token string">'/C=US/ST=CA/L=China/O=Hce/CN=vault.dev.svc.cluster.local'</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>openssl x509 -req -days <span class="token number">30</span>  -in <span class="token string">"vault-server.csr"</span> -CA <span class="token string">"root-ca.crt"</span> -CAkey <span class="token string">"root-ca.key"</span>  -CAcreateserial -out <span class="token string">"vault-server.crt"</span> -extfile <span class="token string">"vault-crt.conf"</span> -extensions vault_server</pre></td></tr></table></figure><p>vault-crt.conf 文件内容</p><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>vault_server<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre>authorityKeyIdentifier=keyid<span class="token punctuation">,</span>issuer</pre></td></tr><tr><td data-num="3"></td><td><pre>basicConstraints = critical<span class="token punctuation">,</span>CA<span class="token punctuation">:</span><span class="token boolean important">FALSE</span></pre></td></tr><tr><td data-num="4"></td><td><pre>extendedKeyUsage=serverAuth<span class="token punctuation">,</span>clientAuth</pre></td></tr><tr><td data-num="5"></td><td><pre>keyUsage = critical<span class="token punctuation">,</span> digitalSignature<span class="token punctuation">,</span> keyEncipherment</pre></td></tr><tr><td data-num="6"></td><td><pre>subjectAltName = DNS<span class="token punctuation">:</span>localhost<span class="token punctuation">,</span> DNS<span class="token punctuation">:</span>vault.dev.svc.cluster.local DNS<span class="token punctuation">:</span>master<span class="token punctuation">,</span> IP<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">,</span> IP<span class="token punctuation">:</span>10.239.140.73</pre></td></tr><tr><td data-num="7"></td><td><pre>subjectKeyIdentifier=hash</pre></td></tr></table></figure><ul><li><strong><span class="blue">subjectAltName</span></strong> 至少需要包含 <span class="blue">DNS:vault.dev.svc.cluster.local</span> 和 IP:<span class="blue">127.0.0.1</span>, 前者是用于集群间通信认证，后者是用于容器里带的 <span class="blude">valut</span> 客户端初始化等操作时候的认证.</li></ul><h3 id="kesminio证书"><a class="anchor" href="#kesminio证书">#</a> KES/minio 证书</h3><p>KES 和 minio 共用一样的密钥和证书，原因是目前没办法把 KES 证书挂载到 minio 容器，就先这样，后续会更新.</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>openssl ecparam -genkey -name prime256v1 <span class="token operator">|</span> openssl ec -out private.key</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#生成 csr, 此处 CN 可以随便指定</span></pre></td></tr><tr><td data-num="4"></td><td><pre>openssl req -new  -key <span class="token string">"private.key"</span> -out <span class="token string">"public.csr"</span> -sha384 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        -subj <span class="token string">'/C=US/ST=CA/L=China/O=Hce/CN=service'</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>openssl x509 -req -days <span class="token number">30</span>  -in <span class="token string">"public.csr"</span> -CA <span class="token string">"root-ca.crt"</span> -CAkey <span class="token string">"root-ca.key"</span>  -CAcreateserial -out <span class="token string">"public.crt"</span> -extfile <span class="token string">"minio-crt.conf"</span> -extensions minio_server</pre></td></tr></table></figure><p><strong><span class="blue">&quot;-extensions minio_server&quot;</span></strong> 指向 minio-crt.conf 配置文件中的 <strong><span class="blue">[minio_server]</span></strong>.</p><p>minio-crt.conf 文件内容</p><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>minio_server<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre>authorityKeyIdentifier=keyid<span class="token punctuation">,</span>issuer</pre></td></tr><tr><td data-num="3"></td><td><pre>basicConstraints = critical<span class="token punctuation">,</span>CA<span class="token punctuation">:</span><span class="token boolean important">FALSE</span></pre></td></tr><tr><td data-num="4"></td><td><pre>extendedKeyUsage=serverAuth<span class="token punctuation">,</span>clientAuth</pre></td></tr><tr><td data-num="5"></td><td><pre>keyUsage = critical<span class="token punctuation">,</span> digitalSignature<span class="token punctuation">,</span> keyEncipherment</pre></td></tr><tr><td data-num="6"></td><td><pre>subjectAltName = DNS<span class="token punctuation">:</span>localhost<span class="token punctuation">,</span> DNS<span class="token punctuation">:</span><span class="token important">*.minio-hl-svc.minio.svc.cluster.local</span><span class="token punctuation">,</span> DNS<span class="token punctuation">:</span>kes<span class="token punctuation">-</span>svc.minio.svc.cluster.local<span class="token punctuation">,</span> DNS<span class="token punctuation">:</span>master<span class="token punctuation">,</span> DNS<span class="token punctuation">:</span>laboratory<span class="token punctuation">,</span>IP<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">,</span> IP<span class="token punctuation">:</span>10.239.140.73<span class="token punctuation">,</span>IP<span class="token punctuation">:</span>10.239.131.157</pre></td></tr><tr><td data-num="7"></td><td><pre>subjectKeyIdentifier=hash</pre></td></tr></table></figure><ul><li><strong><span class="blue">subjectAltName</span></strong> 至少需要包含 <span class="blue">DNS:*.minio-hl-svc.minio.svc.cluster.local</span>, <span class="blue">DNS:kes-svc.minio.svc.cluster.local</span>, <span class="blue">IP:127.0.0.1</span></li></ul><div class="note info"><p><strong><span class="blue">&quot;subjectAltName&quot;</span></strong> 表明此证书属于列出的服务 A 所属的域名和 IP, 服务 B 访问此服务 A 时，会将服务 A 的所属的域名和 IP 与服务 A 的有效证书中包含的域名和 IP 比较，一致或包含则验证通过.</p></div><p>拷贝一份密钥和证书给 KES 用.</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">cp</span> public.crt kes-server.crt</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">cp</span> private.key kes-server.key</pre></td></tr></table></figure><h2 id="kmsvault"><a class="anchor" href="#kmsvault">#</a> KMS(Vault)</h2><h3 id="部署consul"><a class="anchor" href="#部署consul">#</a> 部署 consul</h3><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># helm 添加 repo</span></pre></td></tr><tr><td data-num="2"></td><td><pre>helm del consul -n dev</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看所有 Vault 版本:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>helm search repo hashicorp/vault --versions</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 安装指定版本:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>reference<span class="token punctuation">)</span>helm <span class="token function">install</span> vault hashicorp/vault --namespace vault --version <span class="token number">0.5</span>.0</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 安装默认最新版本</span></pre></td></tr><tr><td data-num="9"></td><td><pre>helm repo <span class="token function">add</span> hashicorp https://helm.releases.hashicorp.com</pre></td></tr><tr><td data-num="10"></td><td><pre>helm repo update</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 安装 local-storage-class</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">cat</span> <span class="token operator">></span> <span class="token string">"local-storage.yaml"</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span></pre></td></tr><tr><td data-num="14"></td><td><pre># Only create this for K8s 1.9+</pre></td></tr><tr><td data-num="15"></td><td><pre>apiVersion: storage.k8s.io/v1</pre></td></tr><tr><td data-num="16"></td><td><pre>kind: StorageClass</pre></td></tr><tr><td data-num="17"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="18"></td><td><pre>  name: local-storage</pre></td></tr><tr><td data-num="19"></td><td><pre>provisioner: kubernetes.io/no-provisioner</pre></td></tr><tr><td data-num="20"></td><td><pre>volumeBindingMode: WaitForFirstConsumer</pre></td></tr><tr><td data-num="21"></td><td><pre># Supported policies: Delete, Retain</pre></td></tr><tr><td data-num="22"></td><td><pre>reclaimPolicy: Delete</pre></td></tr><tr><td data-num="23"></td><td><pre>EOF</pre></td></tr><tr><td data-num="24"></td><td><pre>kubectl apply -f local-storage.yaml</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 安装 consul</span></pre></td></tr><tr><td data-num="27"></td><td><pre>kubectl create namespace dev</pre></td></tr><tr><td data-num="28"></td><td><pre>kubectl apply -f pv-consul.yaml</pre></td></tr><tr><td data-num="29"></td><td><pre>helm <span class="token function">install</span> consul hashicorp/consul -f consul-values.yaml --namespace dev</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># Verify the Consul cluster</span></pre></td></tr><tr><td data-num="32"></td><td><pre>kubectl get po -n dev</pre></td></tr><tr><td data-num="33"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it consul-server-0 -n dev -- consul members</pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># 清理:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>helm del consul -n dev</pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># 清理 pvc</span></pre></td></tr><tr><td data-num="39"></td><td><pre>kubectl delete pvc -l <span class="token assign-left variable">app</span><span class="token operator">=</span>consul -n dev</pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># 清理 pv</span></pre></td></tr><tr><td data-num="42"></td><td><pre>kubectl delete <span class="token function">pv</span> -l <span class="token assign-left variable">app</span><span class="token operator">=</span>consul</pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># 清理 consul 在主机存储的文件</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># 登陆 master 机器</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token function">rm</span> -rf /home/zhan/storage/minio/disks/local-pv-master-01/*</pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token function">rm</span> -rf /home/zhan/storage/minio/disks/local-pv-master-01/*</pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># 登陆 laboratory 机器</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token function">rm</span> -rf /home/zhan/storage/minio/disks/local-pv-laboratory-01/*</pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token function">rm</span> -rf /home/zhan/storage/minio/disks/local-pv-laboratory-01/*</pre></td></tr></table></figure><h3 id="部署vault"><a class="anchor" href="#部署vault">#</a> 部署 vault</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 secret 资源</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl --namespace<span class="token operator">=</span><span class="token string">'dev'</span> create secret tls tls-ca --cert ./pki/root-ca.crt --key ./pki/root-ca.key</pre></td></tr><tr><td data-num="3"></td><td><pre>kubectl --namespace<span class="token operator">=</span><span class="token string">'dev'</span> create secret tls tls-server --cert ./pki/vault-server.crt --key ./pki/vault-server.key</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 安装</span></pre></td></tr><tr><td data-num="6"></td><td><pre>helm <span class="token function">install</span> vault hashicorp/vault --namespace dev -f values.yaml</pre></td></tr><tr><td data-num="7"></td><td><pre>kubectl get pods --selector<span class="token operator">=</span><span class="token string">'app.kubernetes.io/name=vault'</span> --namespace<span class="token operator">=</span><span class="token string">'dev'</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 初始化</span></pre></td></tr><tr><td data-num="10"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- vault operator init</pre></td></tr><tr><td data-num="11"></td><td><pre>  Unseal Key <span class="token number">1</span>: +1/bK0rrP5ntXjvKXX2tsmsvb4HvKahE8jX+ht5IQiO4</pre></td></tr><tr><td data-num="12"></td><td><pre>  Unseal Key <span class="token number">2</span>: glBmkDM950AO0rl89ckI9M+HEE2zAnT8PVKOv7yxW55Z</pre></td></tr><tr><td data-num="13"></td><td><pre>  Unseal Key <span class="token number">3</span>: mJO6ULlGwaV+mxAyDC+mj+ggp0MFle0qhOdMiw8GSWMT</pre></td></tr><tr><td data-num="14"></td><td><pre>  Unseal Key <span class="token number">4</span>: 1pq9vUpAnRwMVufuCG1D6lxLKiseTZsgN+P2J0/qFfAl</pre></td></tr><tr><td data-num="15"></td><td><pre>  Unseal Key <span class="token number">5</span>: n/XARk8In6cxOtzjtO27h5AYL/JqPnst/a5oe6X/Zwty</pre></td></tr><tr><td data-num="16"></td><td><pre>  </pre></td></tr><tr><td data-num="17"></td><td><pre>  Initial Root Token: s.vmMwIUVY8fMIIdXUB35uZvGD</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 解封:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- vault operator unseal +1/bK0rrP5ntXjvKXX2tsmsvb4HvKahE8jX+ht5IQiO4</pre></td></tr><tr><td data-num="21"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- vault operator unseal glBmkDM950AO0rl89ckI9M+HEE2zAnT8PVKOv7yxW55Z</pre></td></tr><tr><td data-num="22"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- vault operator unseal mJO6ULlGwaV+mxAyDC+mj+ggp0MFle0qhOdMiw8GSWMT</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 查看解封状态</span></pre></td></tr><tr><td data-num="25"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- vault status</pre></td></tr><tr><td data-num="26"></td><td><pre>  Key             Value</pre></td></tr><tr><td data-num="27"></td><td><pre>  ---             -----</pre></td></tr><tr><td data-num="28"></td><td><pre>  Seal Type       shamir</pre></td></tr><tr><td data-num="29"></td><td><pre>  Initialized     <span class="token boolean">true</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  Sealed          <span class="token boolean">false</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  Total Shares    <span class="token number">5</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  Threshold       <span class="token number">3</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  Version         <span class="token number">1.6</span>.2</pre></td></tr><tr><td data-num="34"></td><td><pre>  Storage Type    consul</pre></td></tr><tr><td data-num="35"></td><td><pre>  Cluster Name    vault-cluster-a10c41b0</pre></td></tr><tr><td data-num="36"></td><td><pre>  Cluster ID      3e10ba0e-0f81-6c2d-3ef6-3565713cdc62</pre></td></tr><tr><td data-num="37"></td><td><pre>  HA Enabled      <span class="token boolean">true</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  HA Cluster      https://vault-0.vault-internal:8201</pre></td></tr><tr><td data-num="39"></td><td><pre>  HA Mode         active</pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">(</span>optional<span class="token punctuation">)</span><span class="token comment"># 本地映射端口，如果需要在本地 vaule 客户端操作 k8s 集群中搭建的 vault 服务，需要再生成的 vault 证书里 [subjectAltName]&#123;.blue&#125; 字段加上 [本地主机域名]&#123;.blue&#125; 或 [本地主机 IP]&#123;.blue&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">(</span>optional<span class="token punctuation">)</span>kubectl apply -f  nodePort-vault.yaml</pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># 使用:</span></pre></td></tr><tr><td data-num="45"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- /bin/sh -c <span class="token string">"export VAULT_TOKEN=s.vmMwIUVY8fMIIdXUB35uZvGD;vault secrets enable kv"</span></pre></td></tr><tr><td data-num="46"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- /bin/sh -c <span class="token string">"export VAULT_TOKEN=s.vmMwIUVY8fMIIdXUB35uZvGD;vault auth enable approle"</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># 登陆 pod 容器</span></pre></td></tr><tr><td data-num="49"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> -it vault-0 -n dev -- /bin/sh</pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token function">cat</span> <span class="token operator">></span> /tmp/minio-kes-policy.hcl <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span></pre></td></tr><tr><td data-num="52"></td><td><pre>path "kv/minio/*" &#123;</pre></td></tr><tr><td data-num="53"></td><td><pre>  capabilities = [ "create", "read", "delete" ]</pre></td></tr><tr><td data-num="54"></td><td><pre>&#125;</pre></td></tr><tr><td data-num="55"></td><td><pre>EOF</pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span>s.vmMwIUVY8fMIIdXUB35uZvGD</pre></td></tr><tr><td data-num="58"></td><td><pre>vault policy <span class="token function">write</span> minio-key-policy /tmp/minio-kes-policy.hcl</pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>vault <span class="token function">write</span> auth/approle/role/kes-role <span class="token assign-left variable">token_num_uses</span><span class="token operator">=</span><span class="token number">0</span>  <span class="token assign-left variable">secret_id_num_uses</span><span class="token operator">=</span><span class="token number">0</span>  <span class="token assign-left variable">period</span><span class="token operator">=</span>5m</pre></td></tr><tr><td data-num="61"></td><td><pre>vault <span class="token function">write</span> auth/approle/role/kes-role <span class="token assign-left variable">policies</span><span class="token operator">=</span>minio-key-policy</pre></td></tr><tr><td data-num="62"></td><td><pre>vault <span class="token builtin class-name">read</span> auth/approle/role/kes-role/role-id </pre></td></tr><tr><td data-num="63"></td><td><pre>  Key        Value</pre></td></tr><tr><td data-num="64"></td><td><pre>  ---        -----</pre></td></tr><tr><td data-num="65"></td><td><pre>  role_id    1e82b3a5-d935-dd04-a5cd-480ec74791d2</pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment"># 如果下面启动 KES 服务出现 "* Vault is sealed" 错误， 需要重新获取 secret-id，并填写进 KES 配置文件</span></pre></td></tr><tr><td data-num="68"></td><td><pre>vault <span class="token function">write</span> -f auth/approle/role/kes-role/secret-id    </pre></td></tr><tr><td data-num="69"></td><td><pre>  Key                   Value</pre></td></tr><tr><td data-num="70"></td><td><pre>  ---                   -----</pre></td></tr><tr><td data-num="71"></td><td><pre>  secret_id             c1625424-d82d-17cc-ac6d-84844306574c</pre></td></tr><tr><td data-num="72"></td><td><pre>  secret_id_accessor    cd6f5c1e-63f2-9b81-2637-56cb40a6c52b</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment"># Use the Vault CLI to inspect the K/V backend</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment"># 在下面部署 KES 生成新的 key 后才能运行下面命令看到</span></pre></td></tr><tr><td data-num="76"></td><td><pre>vault kv list kv/</pre></td></tr><tr><td data-num="77"></td><td><pre>  Keys</pre></td></tr><tr><td data-num="78"></td><td><pre>  ----</pre></td></tr><tr><td data-num="79"></td><td><pre>  minio/</pre></td></tr><tr><td data-num="80"></td><td><pre>vault kv list kv/minio</pre></td></tr><tr><td data-num="81"></td><td><pre>  Keys</pre></td></tr><tr><td data-num="82"></td><td><pre>  ----</pre></td></tr><tr><td data-num="83"></td><td><pre>  minio-key-1</pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># 退出 pod 容器</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token builtin class-name">exit</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment"># 清理:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>helm del vault -n dev</pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># 清理 secret</span></pre></td></tr><tr><td data-num="93"></td><td><pre>kubectl delete secret tls-ca -n dev</pre></td></tr><tr><td data-num="94"></td><td><pre>kubectl delete secret tls-server -n dev</pre></td></tr></table></figure><h3 id="pv-consulyaml"><a class="anchor" href="#pv-consulyaml">#</a> pv-consul.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">01</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> consul</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">local</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/zhan/storage/minio/disks/local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">01</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">required</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token punctuation">-</span> master</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">02</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> consul</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete</pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage</pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">local</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/zhan/storage/minio/disks/local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">02</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token key atrule">required</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></td></tr><tr><td data-num="45"></td><td><pre>          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token punctuation">-</span> master</pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>laboratory<span class="token punctuation">-</span><span class="token number">01</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> consul</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete</pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage</pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token key atrule">local</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/zhan/storage/minio/disks/local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>laboratory<span class="token punctuation">-</span><span class="token number">01</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token key atrule">required</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></td></tr><tr><td data-num="69"></td><td><pre>          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          <span class="token punctuation">-</span> laboratory</pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>laboratory<span class="token punctuation">-</span><span class="token number">02</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> consul</pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete</pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage</pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token key atrule">local</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/zhan/storage/minio/disks/local<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>laboratory<span class="token punctuation">-</span><span class="token number">02</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token key atrule">required</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></td></tr><tr><td data-num="93"></td><td><pre>          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="94"></td><td><pre>          <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="95"></td><td><pre>          <span class="token punctuation">-</span> laboratory</pre></td></tr></table></figure><h3 id="vault-nodeportyaml"><a class="anchor" href="#vault-nodeportyaml">#</a> vault-nodeport.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>nodeport</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> vault</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> vault</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">component</span><span class="token punctuation">:</span> server</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment"># By default and for convenience, the `targetPort` is set to the same value as the `port` field.</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8200</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8200</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token comment"># Optional field</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token comment"># By default and for convenience, the Kubernetes control plane will allocate a port from a range (default: 30000-32767)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30820</span></pre></td></tr></table></figure><h3 id="valuesyaml"><a class="anchor" href="#valuesyaml">#</a> values.yaml</h3><p>Referencd Link: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhc2hpY29ycC92YXVsdC1oZWxtL2Jsb2IvbWFzdGVyL3ZhbHVlcy55YW1s">https://github.com/hashicorp/vault-helm/blob/master/values.yaml</span></p><figure class="highlight raw"><figcaption data-lang=""><span>w</span></figcaption><table><tr><td data-num="1"></td><td><pre>global:</pre></td></tr><tr><td data-num="2"></td><td><pre>  enabled: true</pre></td></tr><tr><td data-num="3"></td><td><pre>  imagePullSecrets: []</pre></td></tr><tr><td data-num="4"></td><td><pre>  tlsDisable: false</pre></td></tr><tr><td data-num="5"></td><td><pre>  openshift: false</pre></td></tr><tr><td data-num="6"></td><td><pre>  psp:</pre></td></tr><tr><td data-num="7"></td><td><pre>    enable: false</pre></td></tr><tr><td data-num="8"></td><td><pre>    annotations: |</pre></td></tr><tr><td data-num="9"></td><td><pre>      seccomp.security.alpha.kubernetes.io&#x2F;allowedProfileNames: docker&#x2F;default,runtime&#x2F;default</pre></td></tr><tr><td data-num="10"></td><td><pre>      apparmor.security.beta.kubernetes.io&#x2F;allowedProfileNames: runtime&#x2F;default</pre></td></tr><tr><td data-num="11"></td><td><pre>      seccomp.security.alpha.kubernetes.io&#x2F;defaultProfileName:  runtime&#x2F;default</pre></td></tr><tr><td data-num="12"></td><td><pre>      apparmor.security.beta.kubernetes.io&#x2F;defaultProfileName:  runtime&#x2F;default</pre></td></tr><tr><td data-num="13"></td><td><pre>injector:</pre></td></tr><tr><td data-num="14"></td><td><pre>  enabled: true</pre></td></tr><tr><td data-num="15"></td><td><pre>  replicas: 1</pre></td></tr><tr><td data-num="16"></td><td><pre>  leaderElector:</pre></td></tr><tr><td data-num="17"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="18"></td><td><pre>    image:</pre></td></tr><tr><td data-num="19"></td><td><pre>      repository: &quot;gcr.io&#x2F;google_containers&#x2F;leader-elector&quot;</pre></td></tr><tr><td data-num="20"></td><td><pre>      tag: &quot;0.4&quot;</pre></td></tr><tr><td data-num="21"></td><td><pre>    ttl: 60s</pre></td></tr><tr><td data-num="22"></td><td><pre>  metrics:</pre></td></tr><tr><td data-num="23"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="24"></td><td><pre>  externalVaultAddr: &quot;&quot;</pre></td></tr><tr><td data-num="25"></td><td><pre>  image:</pre></td></tr><tr><td data-num="26"></td><td><pre>    repository: &quot;hashicorp&#x2F;vault-k8s&quot;</pre></td></tr><tr><td data-num="27"></td><td><pre>    tag: &quot;0.8.0&quot;</pre></td></tr><tr><td data-num="28"></td><td><pre>    pullPolicy: IfNotPresent</pre></td></tr><tr><td data-num="29"></td><td><pre>  agentImage:</pre></td></tr><tr><td data-num="30"></td><td><pre>    repository: &quot;vault&quot;</pre></td></tr><tr><td data-num="31"></td><td><pre>    tag: &quot;1.6.2&quot;</pre></td></tr><tr><td data-num="32"></td><td><pre>  authPath: &quot;auth&#x2F;kubernetes&quot;</pre></td></tr><tr><td data-num="33"></td><td><pre>  logLevel: &quot;info&quot;</pre></td></tr><tr><td data-num="34"></td><td><pre>  logFormat: &quot;standard&quot;</pre></td></tr><tr><td data-num="35"></td><td><pre>  revokeOnShutdown: false</pre></td></tr><tr><td data-num="36"></td><td><pre>  namespaceSelector: &#123;&#125;</pre></td></tr><tr><td data-num="37"></td><td><pre>  failurePolicy: Ignore</pre></td></tr><tr><td data-num="38"></td><td><pre>  certs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    secretName: null</pre></td></tr><tr><td data-num="40"></td><td><pre>    caBundle: &quot;&quot;</pre></td></tr><tr><td data-num="41"></td><td><pre>    certName: tls.crt</pre></td></tr><tr><td data-num="42"></td><td><pre>    keyName: tls.key</pre></td></tr><tr><td data-num="43"></td><td><pre>  resources: &#123;&#125;</pre></td></tr><tr><td data-num="44"></td><td><pre>  extraEnvironmentVars: &#123;&#125;</pre></td></tr><tr><td data-num="45"></td><td><pre>  affinity: |</pre></td></tr><tr><td data-num="46"></td><td><pre>    podAntiAffinity:</pre></td></tr><tr><td data-num="47"></td><td><pre>      requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num="48"></td><td><pre>        - labelSelector:</pre></td></tr><tr><td data-num="49"></td><td><pre>            matchLabels:</pre></td></tr><tr><td data-num="50"></td><td><pre>
              app.kubernetes.io/name: {{ template "vault.name" . }}-agent-injector
              app.kubernetes.io/instance: "{{ .Release.Name }}"
</pre></td></tr><tr><td data-num="51"></td><td><pre>              component: webhook</pre></td></tr><tr><td data-num="52"></td><td><pre>          topologyKey: kubernetes.io&#x2F;hostname</pre></td></tr><tr><td data-num="53"></td><td><pre>  tolerations: null</pre></td></tr><tr><td data-num="54"></td><td><pre>  nodeSelector: null</pre></td></tr><tr><td data-num="55"></td><td><pre>  priorityClassName: &quot;&quot;</pre></td></tr><tr><td data-num="56"></td><td><pre>  annotations: &#123;&#125;</pre></td></tr><tr><td data-num="57"></td><td><pre>  extraLabels: &#123;&#125;</pre></td></tr><tr><td data-num="58"></td><td><pre>  service:</pre></td></tr><tr><td data-num="59"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="60"></td><td><pre>server:</pre></td></tr><tr><td data-num="61"></td><td><pre>  image:</pre></td></tr><tr><td data-num="62"></td><td><pre>    repository: &quot;vault&quot;</pre></td></tr><tr><td data-num="63"></td><td><pre>    tag: &quot;1.6.2&quot;</pre></td></tr><tr><td data-num="64"></td><td><pre>    pullPolicy: IfNotPresent</pre></td></tr><tr><td data-num="65"></td><td><pre>  updateStrategyType: &quot;OnDelete&quot;</pre></td></tr><tr><td data-num="66"></td><td><pre>  resources: &#123;&#125;</pre></td></tr><tr><td data-num="67"></td><td><pre>  ingress:</pre></td></tr><tr><td data-num="68"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="69"></td><td><pre>    labels: &#123;&#125;</pre></td></tr><tr><td data-num="70"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="71"></td><td><pre>    hosts:</pre></td></tr><tr><td data-num="72"></td><td><pre>      - host: chart-example.local</pre></td></tr><tr><td data-num="73"></td><td><pre>        paths: []</pre></td></tr><tr><td data-num="74"></td><td><pre>    tls: []</pre></td></tr><tr><td data-num="75"></td><td><pre>  route:</pre></td></tr><tr><td data-num="76"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="77"></td><td><pre>    labels: &#123;&#125;</pre></td></tr><tr><td data-num="78"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="79"></td><td><pre>    host: chart-example.local</pre></td></tr><tr><td data-num="80"></td><td><pre>  authDelegator:</pre></td></tr><tr><td data-num="81"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="82"></td><td><pre>  extraInitContainers: null</pre></td></tr><tr><td data-num="83"></td><td><pre>  extraContainers: null</pre></td></tr><tr><td data-num="84"></td><td><pre>  shareProcessNamespace: false</pre></td></tr><tr><td data-num="85"></td><td><pre>  extraArgs: &quot;&quot;</pre></td></tr><tr><td data-num="86"></td><td><pre>  readinessProbe:</pre></td></tr><tr><td data-num="87"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="88"></td><td><pre>    failureThreshold: 2</pre></td></tr><tr><td data-num="89"></td><td><pre>    initialDelaySeconds: 5</pre></td></tr><tr><td data-num="90"></td><td><pre>    periodSeconds: 5</pre></td></tr><tr><td data-num="91"></td><td><pre>    successThreshold: 1</pre></td></tr><tr><td data-num="92"></td><td><pre>    timeoutSeconds: 3</pre></td></tr><tr><td data-num="93"></td><td><pre>  livenessProbe:</pre></td></tr><tr><td data-num="94"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="95"></td><td><pre>    path: &quot;&#x2F;v1&#x2F;sys&#x2F;health?standbyok&#x3D;true&quot;</pre></td></tr><tr><td data-num="96"></td><td><pre>    failureThreshold: 2</pre></td></tr><tr><td data-num="97"></td><td><pre>    initialDelaySeconds: 60</pre></td></tr><tr><td data-num="98"></td><td><pre>    periodSeconds: 5</pre></td></tr><tr><td data-num="99"></td><td><pre>    successThreshold: 1</pre></td></tr><tr><td data-num="100"></td><td><pre>    timeoutSeconds: 3</pre></td></tr><tr><td data-num="101"></td><td><pre>  preStopSleepSeconds: 5</pre></td></tr><tr><td data-num="102"></td><td><pre>  postStart: []</pre></td></tr><tr><td data-num="103"></td><td><pre>  extraEnvironmentVars:</pre></td></tr><tr><td data-num="104"></td><td><pre>    VAULT_CACERT: &#x2F;vault&#x2F;userconfig&#x2F;tls-ca&#x2F;tls.crt</pre></td></tr><tr><td data-num="105"></td><td><pre>  extraSecretEnvironmentVars: [].</pre></td></tr><tr><td data-num="106"></td><td><pre>  extraVolumes:</pre></td></tr><tr><td data-num="107"></td><td><pre>    - type: secret</pre></td></tr><tr><td data-num="108"></td><td><pre>      name: tls-server</pre></td></tr><tr><td data-num="109"></td><td><pre>    - type: secret</pre></td></tr><tr><td data-num="110"></td><td><pre>      name: tls-ca</pre></td></tr><tr><td data-num="111"></td><td><pre>  volumes: null</pre></td></tr><tr><td data-num="112"></td><td><pre>  volumeMounts: null</pre></td></tr><tr><td data-num="113"></td><td><pre>  affinity: |</pre></td></tr><tr><td data-num="114"></td><td><pre>    podAntiAffinity:</pre></td></tr><tr><td data-num="115"></td><td><pre>      requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num="116"></td><td><pre>        - labelSelector:</pre></td></tr><tr><td data-num="117"></td><td><pre>            matchLabels:</pre></td></tr><tr><td data-num="118"></td><td><pre>
              app.kubernetes.io/name: {{ template "vault.name" . }}
              app.kubernetes.io/instance: "{{ .Release.Name }}"
</pre></td></tr><tr><td data-num="119"></td><td><pre>              component: server</pre></td></tr><tr><td data-num="120"></td><td><pre>          topologyKey: kubernetes.io&#x2F;hostname</pre></td></tr><tr><td data-num="121"></td><td><pre>  tolerations: null</pre></td></tr><tr><td data-num="122"></td><td><pre>  nodeSelector: null</pre></td></tr><tr><td data-num="123"></td><td><pre>  networkPolicy:</pre></td></tr><tr><td data-num="124"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="125"></td><td><pre>    egress: []</pre></td></tr><tr><td data-num="126"></td><td><pre>  priorityClassName: &quot;&quot;</pre></td></tr><tr><td data-num="127"></td><td><pre>  extraLabels: &#123;&#125;</pre></td></tr><tr><td data-num="128"></td><td><pre>  annotations: &#123;&#125;</pre></td></tr><tr><td data-num="129"></td><td><pre>  service:</pre></td></tr><tr><td data-num="130"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="131"></td><td><pre>    port: 8200</pre></td></tr><tr><td data-num="132"></td><td><pre>    targetPort: 8200</pre></td></tr><tr><td data-num="133"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="134"></td><td><pre>  dataStorage:</pre></td></tr><tr><td data-num="135"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="136"></td><td><pre>    size: 10Gi</pre></td></tr><tr><td data-num="137"></td><td><pre>    mountPath: &quot;&#x2F;vault&#x2F;data&quot;</pre></td></tr><tr><td data-num="138"></td><td><pre>    storageClass: local-storage</pre></td></tr><tr><td data-num="139"></td><td><pre>    accessMode: ReadWriteOnce</pre></td></tr><tr><td data-num="140"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="141"></td><td><pre>  auditStorage:</pre></td></tr><tr><td data-num="142"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="143"></td><td><pre>    size: 10Gi</pre></td></tr><tr><td data-num="144"></td><td><pre>    mountPath: &quot;&#x2F;vault&#x2F;audit&quot;</pre></td></tr><tr><td data-num="145"></td><td><pre>    storageClass: local-storage</pre></td></tr><tr><td data-num="146"></td><td><pre>    accessMode: ReadWriteOnce</pre></td></tr><tr><td data-num="147"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="148"></td><td><pre>  dev:</pre></td></tr><tr><td data-num="149"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="150"></td><td><pre>    devRootToken: &quot;root&quot;</pre></td></tr><tr><td data-num="151"></td><td><pre>  standalone:</pre></td></tr><tr><td data-num="152"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="153"></td><td><pre>    config: |</pre></td></tr><tr><td data-num="154"></td><td><pre>      ui &#x3D; true</pre></td></tr><tr><td data-num="155"></td><td><pre>      listener &quot;tcp&quot; &#123;</pre></td></tr><tr><td data-num="156"></td><td><pre>        tls_disable &#x3D; 1</pre></td></tr><tr><td data-num="157"></td><td><pre>        address &#x3D; &quot;[::]:8200&quot;</pre></td></tr><tr><td data-num="158"></td><td><pre>        cluster_address &#x3D; &quot;[::]:8201&quot;</pre></td></tr><tr><td data-num="159"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="160"></td><td><pre>      storage &quot;file&quot; &#123;</pre></td></tr><tr><td data-num="161"></td><td><pre>        path &#x3D; &quot;&#x2F;vault&#x2F;data&quot;</pre></td></tr><tr><td data-num="162"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="163"></td><td><pre>  ha:</pre></td></tr><tr><td data-num="164"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="165"></td><td><pre>    replicas: 2</pre></td></tr><tr><td data-num="166"></td><td><pre>    apiAddr: null</pre></td></tr><tr><td data-num="167"></td><td><pre>    raft:</pre></td></tr><tr><td data-num="168"></td><td><pre>      enabled: false</pre></td></tr><tr><td data-num="169"></td><td><pre>      setNodeId: false</pre></td></tr><tr><td data-num="170"></td><td><pre>      config: |</pre></td></tr><tr><td data-num="171"></td><td><pre>        ui &#x3D; true</pre></td></tr><tr><td data-num="172"></td><td><pre>        listener &quot;tcp&quot; &#123;</pre></td></tr><tr><td data-num="173"></td><td><pre>          tls_disable &#x3D; 1</pre></td></tr><tr><td data-num="174"></td><td><pre>          address &#x3D; &quot;[::]:8200&quot;</pre></td></tr><tr><td data-num="175"></td><td><pre>          cluster_address &#x3D; &quot;[::]:8201&quot;</pre></td></tr><tr><td data-num="176"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num="177"></td><td><pre>        storage &quot;raft&quot; &#123;</pre></td></tr><tr><td data-num="178"></td><td><pre>          path &#x3D; &quot;&#x2F;vault&#x2F;data&quot;</pre></td></tr><tr><td data-num="179"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num="180"></td><td><pre>        service_registration &quot;kubernetes&quot; &#123;&#125;</pre></td></tr><tr><td data-num="181"></td><td><pre>    config: |</pre></td></tr><tr><td data-num="182"></td><td><pre>      ui &#x3D; true</pre></td></tr><tr><td data-num="183"></td><td><pre>      listener &quot;tcp&quot; &#123;</pre></td></tr><tr><td data-num="184"></td><td><pre>        tls_disable &#x3D; 0</pre></td></tr><tr><td data-num="185"></td><td><pre>        address &#x3D; &quot;[::]:8200&quot;</pre></td></tr><tr><td data-num="186"></td><td><pre>        cluster_address &#x3D; &quot;[::]:8201&quot;</pre></td></tr><tr><td data-num="187"></td><td><pre>        tls_cert_file &#x3D; &quot;&#x2F;vault&#x2F;userconfig&#x2F;tls-server&#x2F;tls.crt&quot;</pre></td></tr><tr><td data-num="188"></td><td><pre>        tls_key_file &#x3D; &quot;&#x2F;vault&#x2F;userconfig&#x2F;tls-server&#x2F;tls.key&quot;</pre></td></tr><tr><td data-num="189"></td><td><pre>        tls_ca_cert_file &#x3D; &quot;&#x2F;vault&#x2F;userconfig&#x2F;tls-ca&#x2F;tls.crt&quot;</pre></td></tr><tr><td data-num="190"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="191"></td><td><pre>      storage &quot;consul&quot; &#123;</pre></td></tr><tr><td data-num="192"></td><td><pre>        path &#x3D; &quot;vault&quot;</pre></td></tr><tr><td data-num="193"></td><td><pre>        address &#x3D; &quot;consul-server.dev:8500&quot;</pre></td></tr><tr><td data-num="194"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="195"></td><td><pre>      service_registration &quot;kubernetes&quot; &#123;&#125;</pre></td></tr><tr><td data-num="196"></td><td><pre>    disruptionBudget:</pre></td></tr><tr><td data-num="197"></td><td><pre>      enabled: true</pre></td></tr><tr><td data-num="198"></td><td><pre>      maxUnavailable: null</pre></td></tr><tr><td data-num="199"></td><td><pre>  serviceAccount:</pre></td></tr><tr><td data-num="200"></td><td><pre>    create: true</pre></td></tr><tr><td data-num="201"></td><td><pre>    name: &quot;&quot;</pre></td></tr><tr><td data-num="202"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="203"></td><td><pre>  statefulSet:</pre></td></tr><tr><td data-num="204"></td><td><pre>    annotations: &#123;&#125;</pre></td></tr><tr><td data-num="205"></td><td><pre>ui:</pre></td></tr><tr><td data-num="206"></td><td><pre>  enabled: false</pre></td></tr><tr><td data-num="207"></td><td><pre>  publishNotReadyAddresses: true</pre></td></tr><tr><td data-num="208"></td><td><pre>  activeVaultPodOnly: false</pre></td></tr><tr><td data-num="209"></td><td><pre>  serviceType: &quot;ClusterIP&quot;</pre></td></tr><tr><td data-num="210"></td><td><pre>  serviceNodePort: null</pre></td></tr><tr><td data-num="211"></td><td><pre>  externalPort: 8200</pre></td></tr><tr><td data-num="212"></td><td><pre>  annotations: &#123;&#125;</pre></td></tr></table></figure><h3 id="consul-valuesyaml"><a class="anchor" href="#consul-valuesyaml">#</a> consul-values.yaml</h3><figure class="highlight raw"><figcaption data-lang=""><span>w</span></figcaption><table><tr><td data-num="1"></td><td><pre>global:</pre></td></tr><tr><td data-num="2"></td><td><pre>  enabled: true</pre></td></tr><tr><td data-num="3"></td><td><pre>  name: consul</pre></td></tr><tr><td data-num="4"></td><td><pre>  domain: consul</pre></td></tr><tr><td data-num="5"></td><td><pre>  image: &quot;hashicorp&#x2F;consul:1.9.2&quot;</pre></td></tr><tr><td data-num="6"></td><td><pre>  imagePullSecrets: []</pre></td></tr><tr><td data-num="7"></td><td><pre>  imageK8S: &quot;hashicorp&#x2F;consul-k8s:0.23.0&quot;</pre></td></tr><tr><td data-num="8"></td><td><pre>  datacenter: dc1</pre></td></tr><tr><td data-num="9"></td><td><pre>  enablePodSecurityPolicies: false</pre></td></tr><tr><td data-num="10"></td><td><pre>  gossipEncryption:</pre></td></tr><tr><td data-num="11"></td><td><pre>    secretName: &quot;&quot;</pre></td></tr><tr><td data-num="12"></td><td><pre>    secretKey: &quot;&quot;</pre></td></tr><tr><td data-num="13"></td><td><pre>  tls:</pre></td></tr><tr><td data-num="14"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="15"></td><td><pre>    enableAutoEncrypt: false</pre></td></tr><tr><td data-num="16"></td><td><pre>    serverAdditionalDNSSANs: []</pre></td></tr><tr><td data-num="17"></td><td><pre>    serverAdditionalIPSANs: []</pre></td></tr><tr><td data-num="18"></td><td><pre>    verify: true</pre></td></tr><tr><td data-num="19"></td><td><pre>    httpsOnly: true</pre></td></tr><tr><td data-num="20"></td><td><pre>    caCert:</pre></td></tr><tr><td data-num="21"></td><td><pre>      secretName: null</pre></td></tr><tr><td data-num="22"></td><td><pre>      secretKey: null</pre></td></tr><tr><td data-num="23"></td><td><pre>    caKey:</pre></td></tr><tr><td data-num="24"></td><td><pre>      secretName: null</pre></td></tr><tr><td data-num="25"></td><td><pre>      secretKey: null</pre></td></tr><tr><td data-num="26"></td><td><pre>  enableConsulNamespaces: false</pre></td></tr><tr><td data-num="27"></td><td><pre>  acls:</pre></td></tr><tr><td data-num="28"></td><td><pre>    manageSystemACLs: false</pre></td></tr><tr><td data-num="29"></td><td><pre>    bootstrapToken:</pre></td></tr><tr><td data-num="30"></td><td><pre>      secretName: null</pre></td></tr><tr><td data-num="31"></td><td><pre>      secretKey: null</pre></td></tr><tr><td data-num="32"></td><td><pre>    createReplicationToken: false</pre></td></tr><tr><td data-num="33"></td><td><pre>    replicationToken:</pre></td></tr><tr><td data-num="34"></td><td><pre>      # The name of the Kubernetes secret.</pre></td></tr><tr><td data-num="35"></td><td><pre>      secretName: null</pre></td></tr><tr><td data-num="36"></td><td><pre>      # The key of the Kubernetes secret.</pre></td></tr><tr><td data-num="37"></td><td><pre>      secretKey: null</pre></td></tr><tr><td data-num="38"></td><td><pre>  federation:</pre></td></tr><tr><td data-num="39"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="40"></td><td><pre>    createFederationSecret: false</pre></td></tr><tr><td data-num="41"></td><td><pre>  lifecycleSidecarContainer:</pre></td></tr><tr><td data-num="42"></td><td><pre>    resources:</pre></td></tr><tr><td data-num="43"></td><td><pre>      requests:</pre></td></tr><tr><td data-num="44"></td><td><pre>        memory: &quot;25Mi&quot;</pre></td></tr><tr><td data-num="45"></td><td><pre>        cpu: &quot;20m&quot;</pre></td></tr><tr><td data-num="46"></td><td><pre>      limits:</pre></td></tr><tr><td data-num="47"></td><td><pre>        memory: &quot;50Mi&quot;</pre></td></tr><tr><td data-num="48"></td><td><pre>        cpu: &quot;20m&quot;</pre></td></tr><tr><td data-num="49"></td><td><pre>  imageEnvoy: &quot;envoyproxy&#x2F;envoy-alpine:v1.16.0&quot;</pre></td></tr><tr><td data-num="50"></td><td><pre>  openshift:</pre></td></tr><tr><td data-num="51"></td><td><pre>    enabled: false</pre></td></tr><tr><td data-num="52"></td><td><pre>server:</pre></td></tr><tr><td data-num="53"></td><td><pre>  enabled: &quot;-&quot;</pre></td></tr><tr><td data-num="54"></td><td><pre>  image: null</pre></td></tr><tr><td data-num="55"></td><td><pre>  replicas: 2</pre></td></tr><tr><td data-num="56"></td><td><pre>  bootstrapExpect: null</pre></td></tr><tr><td data-num="57"></td><td><pre>  enterpriseLicense:</pre></td></tr><tr><td data-num="58"></td><td><pre>    secretName: null</pre></td></tr><tr><td data-num="59"></td><td><pre>    secretKey: null</pre></td></tr><tr><td data-num="60"></td><td><pre>  exposeGossipAndRPCPorts: false</pre></td></tr><tr><td data-num="61"></td><td><pre>  ports:</pre></td></tr><tr><td data-num="62"></td><td><pre>    serflan:</pre></td></tr><tr><td data-num="63"></td><td><pre>      port: 8301</pre></td></tr><tr><td data-num="64"></td><td><pre>  storage: 4.9Gi</pre></td></tr><tr><td data-num="65"></td><td><pre>  storageClass: local-storage</pre></td></tr><tr><td data-num="66"></td><td><pre>  connect: true</pre></td></tr><tr><td data-num="67"></td><td><pre>  resources:</pre></td></tr><tr><td data-num="68"></td><td><pre>    requests:</pre></td></tr><tr><td data-num="69"></td><td><pre>      memory: &quot;100Mi&quot;</pre></td></tr><tr><td data-num="70"></td><td><pre>      cpu: &quot;100m&quot;</pre></td></tr><tr><td data-num="71"></td><td><pre>    limits:</pre></td></tr><tr><td data-num="72"></td><td><pre>      memory: &quot;100Mi&quot;</pre></td></tr><tr><td data-num="73"></td><td><pre>      cpu: &quot;100m&quot;</pre></td></tr><tr><td data-num="74"></td><td><pre>  securityContext:</pre></td></tr><tr><td data-num="75"></td><td><pre>    runAsNonRoot: true</pre></td></tr><tr><td data-num="76"></td><td><pre>    runAsGroup: 1000</pre></td></tr><tr><td data-num="77"></td><td><pre>    runAsUser: 100</pre></td></tr><tr><td data-num="78"></td><td><pre>    fsGroup: 1000</pre></td></tr><tr><td data-num="79"></td><td><pre>  updatePartition: 0</pre></td></tr><tr><td data-num="80"></td><td><pre>  disruptionBudget:</pre></td></tr><tr><td data-num="81"></td><td><pre>    enabled: true</pre></td></tr><tr><td data-num="82"></td><td><pre>    maxUnavailable: null</pre></td></tr><tr><td data-num="83"></td><td><pre>  extraConfig: |</pre></td></tr><tr><td data-num="84"></td><td><pre>    &#123;&#125;</pre></td></tr><tr><td data-num="85"></td><td><pre>  extraVolumes: []</pre></td></tr><tr><td data-num="86"></td><td><pre>  affinity: |</pre></td></tr><tr><td data-num="87"></td><td><pre>    podAntiAffinity:</pre></td></tr><tr><td data-num="88"></td><td><pre>      requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num="89"></td><td><pre>        - labelSelector:</pre></td></tr><tr><td data-num="90"></td><td><pre>            matchLabels:</pre></td></tr><tr><td data-num="91"></td><td><pre>
              app: {{ template "consul.name" . }}
              release: "{{ .Release.Name }}"
</pre></td></tr><tr><td data-num="92"></td><td><pre>              component: server</pre></td></tr><tr><td data-num="93"></td><td><pre>          topologyKey: kubernetes.io&#x2F;hostname</pre></td></tr><tr><td data-num="94"></td><td><pre>  tolerations: &quot;&quot;</pre></td></tr><tr><td data-num="95"></td><td><pre>  nodeSelector: null</pre></td></tr><tr><td data-num="96"></td><td><pre>  priorityClassName: &quot;&quot;</pre></td></tr><tr><td data-num="97"></td><td><pre>  extraLabels: null</pre></td></tr><tr><td data-num="98"></td><td><pre>  annotations: null</pre></td></tr><tr><td data-num="99"></td><td><pre>  service:</pre></td></tr><tr><td data-num="100"></td><td><pre>    annotations: null</pre></td></tr><tr><td data-num="101"></td><td><pre>  extraEnvironmentVars: &#123;&#125;</pre></td></tr><tr><td data-num="102"></td><td><pre>externalServers:</pre></td></tr><tr><td data-num="103"></td><td><pre>  enabled: false</pre></td></tr><tr><td data-num="104"></td><td><pre>  hosts: []</pre></td></tr><tr><td data-num="105"></td><td><pre>  httpsPort: 8501</pre></td></tr><tr><td data-num="106"></td><td><pre>  tlsServerName: null</pre></td></tr></table></figure><h2 id="kes-2"><a class="anchor" href="#kes-2">#</a> KES</h2><h3 id="配置"><a class="anchor" href="#配置">#</a> 配置</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 获取 minio 证书 id</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kes tool identity of pki/public.crt</pre></td></tr><tr><td data-num="3"></td><td><pre> Identity:  03ebeb2c14c4584b7ba3b487ad2cef8a57b4a8e40fb5d1ffd163b887082058b9</pre></td></tr></table></figure><h3 id="kes-configyaml"><a class="anchor" href="#kes-configyaml">#</a> kes-config.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">address</span><span class="token punctuation">:</span> 0.0.0.0<span class="token punctuation">:</span><span class="token number">7373</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">root</span><span class="token punctuation">:</span>    disabled  <span class="token comment"># We disable the root identity since we don't need it in this guide</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">tls</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">key</span><span class="token punctuation">:</span>  /pki/kes<span class="token punctuation">-</span>server.key</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">cert</span><span class="token punctuation">:</span> /pki/kes<span class="token punctuation">-</span>server.crt</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">policy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">minio</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> /v1/key/create/minio<span class="token punctuation">-</span>*</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">-</span> /v1/key/generate/minio<span class="token punctuation">-</span>*</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> /v1/key/decrypt/minio<span class="token punctuation">-</span>*</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">identities</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span>APP_IDENTITY<span class="token punctuation">&#125;</span> <span class="token comment"># $ 最好不要写成 03ebeb2c14c4584b7ba3b487ad2cef8a57b4a8e40fb5d1ffd163b887082058b9, 否则证书变了就必须重新 build image</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">cache</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">expiry</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">any</span><span class="token punctuation">:</span>    5m0s</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">unused</span><span class="token punctuation">:</span> 20s</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token key atrule">keys</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">vault</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//vault.dev.svc.cluster.local<span class="token punctuation">:</span><span class="token number">8200</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">approle</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token key atrule">id</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>APP_ROLE_ID<span class="token punctuation">&#125;</span> <span class="token comment"># Your AppRole ID</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">secret</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>APP_SECRET_ID<span class="token punctuation">&#125;</span> <span class="token comment"># Your AppRole Secret ID</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">retry</span><span class="token punctuation">:</span>  15s</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">status</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token key atrule">ping</span><span class="token punctuation">:</span> 10s</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">tls</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">ca</span><span class="token punctuation">:</span> <span class="token string">"/pki/vault-server.crt"</span> <span class="token comment"># Since we use self-signed certificates</span></pre></td></tr></table></figure><h3 id="构建kes-image"><a class="anchor" href="#构建kes-image">#</a> 构建 KES image</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 构建 image</span></pre></td></tr><tr><td data-num="2"></td><td><pre>docker build -t kes:0.1 --build-arg <span class="token assign-left variable">HTTP_PROXY</span><span class="token operator">=</span>http://child-prc.intel.com:913 --build-arg <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span>http://child-prc.intel.com:913 <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># image 拷贝到 laboratory 机器</span></pre></td></tr><tr><td data-num="4"></td><td><pre>docker save -o kes-0.1.tar kes:0.1</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">scp</span> kes-0.1.tar root@10.239.131.157:/home/zhan/docker-images/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">ssh</span> root@10.239.131.157</pre></td></tr><tr><td data-num="7"></td><td><pre>docker load -i kes-0.1.tar</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token builtin class-name">exit</span></pre></td></tr></table></figure><h3 id="部署kes"><a class="anchor" href="#部署kes">#</a> 部署 KES</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 namespace</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl create ns minio</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 创建 secret</span></pre></td></tr><tr><td data-num="5"></td><td><pre>Reference:</pre></td></tr><tr><td data-num="6"></td><td><pre>https://github.com/minio/operator/blob/master/docs/tls.md  </pre></td></tr><tr><td data-num="7"></td><td><pre>https://kubernetes.io/docs/concepts/configuration/secret/<span class="token comment">#using-secrets  </span></pre></td></tr><tr><td data-num="8"></td><td><pre>kubectl create secret generic kes-crts --from-file<span class="token operator">=</span>pki/private.key --from-file<span class="token operator">=</span>pki/public.crt --from-file<span class="token operator">=</span>pki/kes-server.crt --from-file<span class="token operator">=</span>pki/kes-server.key --from-file<span class="token operator">=</span>pki/vault-server.crt -n minio</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 部署 kes</span></pre></td></tr><tr><td data-num="11"></td><td><pre>kubectl apply -f kes-k8s.yaml</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 查看 log</span></pre></td></tr><tr><td data-num="14"></td><td><pre>kubectl logs -l <span class="token assign-left variable">app</span><span class="token operator">=</span>kes -n minio --tail<span class="token operator">=</span>-1</pre></td></tr><tr><td data-num="15"></td><td><pre>  Authenticating to Hashicorp Vault <span class="token string">'https://vault.dev.svc.cluster.local:8200'</span> <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="16"></td><td><pre>  Endpoint: https://127.0.0.1:7373        https://10.32.0.11:7373</pre></td></tr><tr><td data-num="17"></td><td><pre>  </pre></td></tr><tr><td data-num="18"></td><td><pre>  Root:     _     <span class="token punctuation">[</span> disabled <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  Auth:     off   <span class="token punctuation">[</span> any client can connect but policies still apply <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  </pre></td></tr><tr><td data-num="21"></td><td><pre>  Keys:     Hashicorp Vault: https://vault.dev.svc.cluster.local:8200</pre></td></tr><tr><td data-num="22"></td><td><pre>  </pre></td></tr><tr><td data-num="23"></td><td><pre>  CLI:      <span class="token builtin class-name">export</span> <span class="token assign-left variable">KES_SERVER</span><span class="token operator">=</span>https://127.0.0.1:7373</pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token builtin class-name">export</span> <span class="token assign-left variable">KES_CLIENT_KEY</span><span class="token operator">=</span><span class="token operator">&lt;</span>client-private-key<span class="token operator">></span>   // e.g. <span class="token environment constant">$HOME</span>/root.key</pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token builtin class-name">export</span> <span class="token assign-left variable">KES_CLIENT_CERT</span><span class="token operator">=</span><span class="token operator">&lt;</span>client-certificate<span class="token operator">></span>  // e.g. <span class="token environment constant">$HOME</span>/root.cert</pre></td></tr><tr><td data-num="26"></td><td><pre>            kes --help</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 创建主密钥</span></pre></td></tr><tr><td data-num="29"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>kubectl get pod -l <span class="token assign-left variable">app</span><span class="token operator">=</span>kes -n minio -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'&#123;.items[0].metadata.name&#125;'</span><span class="token variable">)</span></span>"</span> -n minio -it -- /bin/bash</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_SKIP_VERIFY</span><span class="token operator">=</span>true</pre></td></tr><tr><td data-num="31"></td><td><pre>./kes key create -k minio-key-1</pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">#  Derive data keys from the previously created minio-key-1</span></pre></td></tr><tr><td data-num="34"></td><td><pre>./kes key derive -k minio-key-1</pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    plaintext <span class="token builtin class-name">:</span> <span class="token assign-left variable">TPq3GqKMYx8Y1TrzhI8kyKMlKnqLZjcpw3HQ2MU1YIg</span><span class="token operator">=</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    ciphertext: <span class="token assign-left variable">eyJhZWFkIjoiQUVTLTI1Ni1HQ00tSE1BQy1TSEEtMjU2IiwiaXYiOiJoOGRRbk9tSmdzRS9tQ0pDU21LdkV3PT0iLCJub25jZSI6Im0rNzdyTjBJMFRPT0Njd2YiLCJieXRlcyI6Imh5aDM5SVBXMEt3VGYxeEt6QWdSdTQ0QTlmSC9jQXR6ckNkWGk5TXo3My9EdkRxMXczTUZYaFlwVWNBVzVlbUYifQ</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># Decrypt data keys from the previously created minio-key-1</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># ./kes key decrypt -k my-app-key &lt;base64-ciphertext></span></pre></td></tr><tr><td data-num="42"></td><td><pre>./kes key decrypt -k minio-key-1 <span class="token assign-left variable">eyJhZWFkIjoiQUVTLTI1Ni1HQ00tSE1BQy1TSEEtMjU2IiwiaXYiOiJoOGRRbk9tSmdzRS9tQ0pDU21LdkV3PT0iLCJub25jZSI6Im0rNzdyTjBJMFRPT0Njd2YiLCJieXRlcyI6Imh5aDM5SVBXMEt3VGYxeEt6QWdSdTQ0QTlmSC9jQXR6ckNkWGk5TXo3My9EdkRxMXczTUZYaFlwVWNBVzVlbUYifQ</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  plaintext: <span class="token assign-left variable">TPq3GqKMYx8Y1TrzhI8kyKMlKnqLZjcpw3HQ2MU1YIg</span><span class="token operator">=</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># 退出 pod</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token builtin class-name">exit</span></pre></td></tr></table></figure><div class="note primary"><p><strong><span class="blue">KES derive</span></strong> 命令的用法参考 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhcnNoYXZhcmRoYW5hL2tlcyMzLWdlbmVyYXRlLWEtbmV3LWRhdGEtZW5jcnlwdGlvbi1rZXktZGVr">KES Github</span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pbmlvL2tlcy93aWtpL0dldHRpbmctU3RhcnRlZCMzMy1kZXJpdmUtYS1uZXctZGF0YS1rZXktcGxhaW50ZXh0Y2lwaGVydGV4dC1wYWly">KES Github wiki</span></p></div><div class="note primary"><p>Now, you can use that master key to derive a new data encryption key.<br>You will get a plaintext and a ciphertext data key. The ciphertext data key is the encrypted version of the plaintext key. Your application would use the plaintext key to e.g. encrypt some application data but only remember the ciphertext key version.</p></div><p>上面 KES derive 内容再结合 <strong><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pbi5pby9kb2NzL21pbmlvLXNlY3VyaXR5LW92ZXJ2aWV3Lmh0bWw=">MinIO 官网</span></strong> 的 <strong><span class="blue">Key rotation - Basic Operation</span></strong> 部分看.</p><h3 id="dockerfile"><a class="anchor" href="#dockerfile">#</a> Dockerfile</h3><figure class="highlight docker"><figcaption data-lang="docker"><span>r</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">FROM</span> registry.access.redhat.com/ubi8/ubi<span class="token punctuation">-</span>minimal<span class="token punctuation">:</span>8.3</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">LABEL</span> name=<span class="token string">"MinIO"</span> \</pre></td></tr><tr><td data-num="4"></td><td><pre>      vendor=<span class="token string">"MinIO Inc &lt;dev@min.io>"</span> \</pre></td></tr><tr><td data-num="5"></td><td><pre>      maintainer=<span class="token string">"MinIO Inc &lt;dev@min.io>"</span> \</pre></td></tr><tr><td data-num="6"></td><td><pre>      version=<span class="token string">"v0.13.4"</span> \</pre></td></tr><tr><td data-num="7"></td><td><pre>      release=<span class="token string">"v0.13.4"</span> \</pre></td></tr><tr><td data-num="8"></td><td><pre>      summary=<span class="token string">"KES is a stateless and distributed key-management system for high-performance applications."</span> \</pre></td></tr><tr><td data-num="9"></td><td><pre>      description=<span class="token string">"KES as the bridge between modern applications - running as containers on Kubernetes - and centralized KMS solutions. Therefore, KES has been designed to be simple, scalable and secure by default. It has just a few knobs to tweak instead of a complex configuration and does not require a deep understanding of secure key-management or cryptography."</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">ARG</span> HTTP_PROXY</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">ARG</span> HTTPS_PROXY</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">RUN</span> \</pre></td></tr><tr><td data-num="15"></td><td><pre>    microdnf update <span class="token punctuation">-</span><span class="token punctuation">-</span>nodocs &amp;&amp; \</pre></td></tr><tr><td data-num="16"></td><td><pre>    microdnf install ca<span class="token punctuation">-</span>certificates <span class="token punctuation">-</span><span class="token punctuation">-</span>nodocs &amp;&amp; \</pre></td></tr><tr><td data-num="17"></td><td><pre>    microdnf clean all &amp;&amp; \</pre></td></tr><tr><td data-num="18"></td><td><pre>    mkdir /licenses &amp;&amp; \</pre></td></tr><tr><td data-num="19"></td><td><pre>    curl <span class="token punctuation">-</span>s <span class="token punctuation">-</span>q https<span class="token punctuation">:</span>//raw.githubusercontent.com/minio/kes/master/CREDITS <span class="token punctuation">-</span>o /licenses/CREDITS &amp;&amp; \</pre></td></tr><tr><td data-num="20"></td><td><pre>    curl <span class="token punctuation">-</span>s <span class="token punctuation">-</span>q https<span class="token punctuation">:</span>//raw.githubusercontent.com/minio/kes/master/LICENSE <span class="token punctuation">-</span>o /licenses/LICENSE</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">COPY</span> kes /kes</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">COPY</span> ./kes<span class="token punctuation">-</span>config.yaml /kes<span class="token punctuation">-</span>config.yaml</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">ENV</span> VAULT_SKIP_VERIFY true</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">ENV</span> KES_CLIENT_CERT /pki/public.crt</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">ENV</span> KES_CLIENT_KEY /pki/private.key</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">EXPOSE</span> 7373</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">WORKDIR</span> /</pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"/kes"</span><span class="token punctuation">,</span> <span class="token string">"server"</span><span class="token punctuation">,</span> <span class="token string">"--config=kes-config.yaml"</span><span class="token punctuation">,</span> <span class="token string">"--root=disabled"</span><span class="token punctuation">,</span> <span class="token string">"--auth=off"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><h3 id="kes-k8syaml"><a class="anchor" href="#kes-k8syaml">#</a> kes-k8s.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kes<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7373</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7373</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kes<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>node</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7373</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7373</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30737</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kes</pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token key atrule">image</span><span class="token punctuation">:</span> kes<span class="token punctuation">:</span><span class="token number">0.1</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token key atrule">env</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> APP_IDENTITY</pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token key atrule">value</span><span class="token punctuation">:</span> 03ebeb2c14c4584b7ba3b487ad2cef8a57b4a8e40fb5d1ffd163b887082058b9</pre></td></tr><tr><td data-num="53"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> APP_ROLE_ID</pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token key atrule">value</span><span class="token punctuation">:</span> 1e82b3a5<span class="token punctuation">-</span>d935<span class="token punctuation">-</span>dd04<span class="token punctuation">-</span>a5cd<span class="token punctuation">-</span>480ec74791d2</pre></td></tr><tr><td data-num="55"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> APP_SECRET_ID</pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token key atrule">value</span><span class="token punctuation">:</span> c1625424<span class="token punctuation">-</span>d82d<span class="token punctuation">-</span>17cc<span class="token punctuation">-</span>ac6d<span class="token punctuation">-</span>84844306574c</pre></td></tr><tr><td data-num="57"></td><td><pre>          <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">7373</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kes<span class="token punctuation">-</span>crts</pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/pki"</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kes<span class="token punctuation">-</span>crts</pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token key atrule">secret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token key atrule">secretName</span><span class="token punctuation">:</span> kes<span class="token punctuation">-</span>crts</pre></td></tr></table></figure><h2 id="minio-2"><a class="anchor" href="#minio-2">#</a> MinIO</h2><h3 id="磁盘分区"><a class="anchor" href="#磁盘分区">#</a> 磁盘分区</h3><p>参考 linux parted 命令，如下将 /dev/sdb 磁盘分出 7 个 50GB 大小的磁盘分区.<br>如果系统上没有 <code>parted</code> 工具需要用 yum 或 apt-get 下载.</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">parted</span> --script /dev/sdb <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    mklabel gpt <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    mkpart primary 4096s 51200MiB <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    mkpart primary 51200MiB 102400MiB  <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    mkpart primary 102400MiB 153600MiB <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    mkpart primary 153600MiB 204800MiB <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mkpart primary 204800MiB 256000MiB <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    mkpart primary 256000MiB 307200MiB <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    mkpart primary 307200MiB 358400MiB</pre></td></tr></table></figure><h3 id="mount磁盘"><a class="anchor" href="#mount磁盘">#</a> mount 磁盘</h3><p>登陆到每台机器操作</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> -p /mnt/minio</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mount</span> /dev/sd* /mnt/minio</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> -p /mnt/minio/data</pre></td></tr></table></figure><div class="note info"><p>mount 磁盘一定要在最初做，否则后边在部署 direct-csi 后再 mount 磁盘的话会导致 minio 数据存放不到 mount 到的磁盘.</p></div><h3 id="mkdir_minio_nodesh"><a class="anchor" href="#mkdir_minio_nodesh">#</a> mkdir_minio_node.sh</h3><p>用来自动登陆 master 和 laboratory 机器创建文件夹.</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token shebang important">#!/bin/bash</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#usecase: ./bash_shell_commands.sh -u &lt;username> -p &lt;pwd>  --node01 &lt;node01-ip> --node02 &lt;node02-ip> --node03 &lt;node03-ip> --node04=&lt;node04-ip></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#./mkdir_minio_node.sh -u root -p 123456 --node01 10.239.140.73 --node02 10.239.131.157</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">ARGS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>getopt -o u:p: --long username:,password:,node01_ip:,node02_ip:,node03_ip:,node04_ip:: -n <span class="token string">'mkdir_node_minio.sh'</span> -- <span class="token string">"<span class="token variable">$@</span>"</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token builtin class-name">echo</span> <span class="token string">"Terminating..."</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token builtin class-name">exit</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">fi</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token builtin class-name">eval</span> <span class="token builtin class-name">set</span> -- <span class="token string">"<span class="token variable">$&#123;ARGS&#125;</span>"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token builtin class-name">echo</span> <span class="token variable">$&#123;ARGS&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">while</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">do</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                -u<span class="token operator">|</span>--username<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                -p<span class="token operator">|</span>--password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                --node01_ip<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                        <span class="token assign-left variable">node01_ip</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token assign-left variable">nodes</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$&#123;node01_ip&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                --node02_ip<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        <span class="token assign-left variable">node02_ip</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token assign-left variable">nodes</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$&#123;node02_ip&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                --node03_ip<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                        <span class="token assign-left variable">node03_ip</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                        <span class="token assign-left variable">nodes</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$&#123;node03_ip&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                --node04_ip<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                        <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$2</span>"</span> <span class="token keyword">in</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                                <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                                *<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                                        <span class="token assign-left variable">node04_ip</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                                        <span class="token assign-left variable">nodes</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$&#123;node04_ip&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                                        <span class="token builtin class-name">shift</span> <span class="token number">2</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token keyword">esac</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                --<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token builtin class-name">shift</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        <span class="token builtin class-name">break</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                *<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                        <span class="token builtin class-name">echo</span> <span class="token string">"Error!"</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                        <span class="token builtin class-name">exit</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">esac</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">done</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">for</span> <span class="token for-or-select variable">node</span> <span class="token keyword">in</span> <span class="token variable">$&#123;nodes<span class="token punctuation">[</span>*<span class="token punctuation">]</span>&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">do</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token function">expect</span> <span class="token operator">&lt;&lt;-</span><span class="token string">EOF</span></pre></td></tr><tr><td data-num="57"></td><td><pre>spawn ssh <span class="token variable">$username</span>@<span class="token variable">$&#123;node&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>expect &#123;</pre></td></tr><tr><td data-num="59"></td><td><pre>        "yes/no" &#123; send "yes<span class="token entity" title="\r">\r</span>"; exp_continue &#125;</pre></td></tr><tr><td data-num="60"></td><td><pre>        "password" &#123; send "<span class="token variable">$&#123;password&#125;</span><span class="token entity" title="\r">\r</span>"; exp_continue &#125;</pre></td></tr><tr><td data-num="61"></td><td><pre>        "Last login" &#123; send "<span class="token entity" title="\r">\r</span>" &#125;</pre></td></tr><tr><td data-num="62"></td><td><pre>&#125;</pre></td></tr><tr><td data-num="63"></td><td><pre>expect "*#"</pre></td></tr><tr><td data-num="64"></td><td><pre>send "rm -rf /mnt/minio/data <span class="token entity" title="\r">\r</span>"</pre></td></tr><tr><td data-num="65"></td><td><pre>send "mkdir -p /mnt/minio/data <span class="token entity" title="\r">\r</span>"</pre></td></tr><tr><td data-num="66"></td><td><pre>expect "*#"</pre></td></tr><tr><td data-num="67"></td><td><pre>send "exit<span class="token entity" title="\r">\r</span>"</pre></td></tr><tr><td data-num="68"></td><td><pre>expect "eof"</pre></td></tr><tr><td data-num="69"></td><td><pre>EOF</pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token keyword">done</span></pre></td></tr></table></figure><h3 id="minioinstanceyaml"><a class="anchor" href="#minioinstanceyaml">#</a> minioinstance.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>creds<span class="token punctuation">-</span>secret</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">accesskey</span><span class="token punctuation">:</span> aGNlbWluaW8= <span class="token comment"># base 64 encoded "hceminio" (echo -n 'hceminio' | base64)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">secretkey</span><span class="token punctuation">:</span> aGNlbWluaW8xMjM= <span class="token comment"># based 64 encoded "hceminio123" (echo -n 'hceminio123' | base64)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> operator.min.io/v1</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> MinIOInstance</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">prometheus.io/path</span><span class="token punctuation">:</span> /minio/prometheus/metrics</pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"9000"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/minio<span class="token punctuation">:</span>RELEASE.2020<span class="token punctuation">-</span>06<span class="token punctuation">-</span>18T02<span class="token punctuation">-</span>23<span class="token punctuation">-</span>35Z</pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>internal<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">zones</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"zone-0"</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token key atrule">servers</span><span class="token punctuation">:</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token key atrule">volumesPerServer</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /export</pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> data</pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token comment">#storage: 1Ti</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> direct.csi.min.io</pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token key atrule">credsSecret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>creds<span class="token punctuation">-</span>secret</pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> Parallel</pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token key atrule">externalCertSecret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>ssl<span class="token punctuation">-</span>minio</pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token key atrule">requestAutoCert</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token key atrule">certConfig</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token key atrule">commonName</span><span class="token punctuation">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token key atrule">organizationName</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token key atrule">dnsNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token key atrule">env</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_KMS_KES_ENDPOINT</pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//kes<span class="token punctuation">-</span>svc.minio.svc.cluster.local<span class="token punctuation">:</span><span class="token number">7373</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_KMS_KES_KEY_FILE</pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> /tmp/certs/private.key</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_KMS_KES_CERT_FILE</pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> /tmp/certs/public.crt</pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_KMS_KES_KEY_NAME    <span class="token comment"># 要根 KES 创建的 master key 一致</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>key<span class="token punctuation">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_KMS_KES_CA_PATH</pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token key atrule">value</span><span class="token punctuation">:</span> /tmp/certs/public.crt</pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token key atrule">liveness</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr></table></figure><h3 id="minio-operatoryaml"><a class="anchor" href="#minio-operatoryaml">#</a> minio-operator.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minioinstances.operator.min.io</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">group</span><span class="token punctuation">:</span> operator.min.io</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">names</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">kind</span><span class="token punctuation">:</span> MinIOInstance</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">singular</span><span class="token punctuation">:</span> minioinstance</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">plural</span><span class="token punctuation">:</span> minioinstances</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">versions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">served</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">schema</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token comment"># openAPIV3Schema is the schema for validating custom objects.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token comment"># Refer https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#specifying-a-structural-schema</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token comment"># for more details</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>              <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="25"></td><td><pre>              <span class="token key atrule">x-kubernetes-preserve-unknown-fields</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="26"></td><td><pre>              <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token key atrule">replicas</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> integer</pre></td></tr><tr><td data-num="29"></td><td><pre>                  <span class="token key atrule">minimum</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                  <span class="token key atrule">maximum</span><span class="token punctuation">:</span> <span class="token number">32</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token key atrule">image</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token key atrule">serviceName</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token key atrule">volumesPerServer</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> integer</pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token key atrule">mountPath</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="41"></td><td><pre>                  <span class="token key atrule">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Parallel<span class="token punctuation">,</span>OrderedReady<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                  <span class="token key atrule">default</span><span class="token punctuation">:</span> Parallel</pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token key atrule">requestAutoCert</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> boolean</pre></td></tr><tr><td data-num="45"></td><td><pre>                  <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token key atrule">version</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token key atrule">mountpath</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token key atrule">subpath</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token key atrule">mcs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="54"></td><td><pre>                  <span class="token key atrule">x-kubernetes-preserve-unknown-fields</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                  <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token key atrule">image</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                      <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="58"></td><td><pre>                    <span class="token key atrule">replicas</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                      <span class="token key atrule">type</span><span class="token punctuation">:</span> integer</pre></td></tr><tr><td data-num="60"></td><td><pre>                      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                    <span class="token key atrule">mcsSecret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                      <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="63"></td><td><pre>                      <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                        <span class="token key atrule">name</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                          <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token key atrule">kes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="68"></td><td><pre>                  <span class="token key atrule">x-kubernetes-preserve-unknown-fields</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                  <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                    <span class="token key atrule">image</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                      <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token key atrule">replicas</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                      <span class="token key atrule">type</span><span class="token punctuation">:</span> integer</pre></td></tr><tr><td data-num="74"></td><td><pre>                      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                    <span class="token key atrule">kesSecret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                      <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="77"></td><td><pre>                      <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                        <span class="token key atrule">name</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                          <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token key atrule">status</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="81"></td><td><pre>              <span class="token key atrule">type</span><span class="token punctuation">:</span> object</pre></td></tr><tr><td data-num="82"></td><td><pre>              <span class="token key atrule">properties</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token key atrule">currentState</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token key atrule">subresources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token comment"># status enables the status subresource.</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token key atrule">additionalPrinterColumns</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Current State</pre></td></tr><tr><td data-num="90"></td><td><pre>          <span class="token key atrule">type</span><span class="token punctuation">:</span> string</pre></td></tr><tr><td data-num="91"></td><td><pre>          <span class="token key atrule">jsonPath</span><span class="token punctuation">:</span> <span class="token string">".status.currentState"</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token punctuation">-</span> namespaces</pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token punctuation">-</span> secrets</pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token punctuation">-</span> pods</pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token punctuation">-</span> services</pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token punctuation">-</span> events</pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token punctuation">-</span> watch</pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token punctuation">-</span> create</pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token punctuation">-</span> list</pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token punctuation">-</span> delete</pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token punctuation">-</span> apps</pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token punctuation">-</span> statefulsets</pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token punctuation">-</span> deployments</pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token punctuation">-</span> create</pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token punctuation">-</span> list</pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token punctuation">-</span> patch</pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token punctuation">-</span> watch</pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token punctuation">-</span> update</pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token punctuation">-</span> delete</pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token punctuation">-</span> batch</pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token punctuation">-</span> jobs</pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="131"></td><td><pre>  <span class="token punctuation">-</span> create</pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token punctuation">-</span> list</pre></td></tr><tr><td data-num="133"></td><td><pre>  <span class="token punctuation">-</span> patch</pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token punctuation">-</span> watch</pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token punctuation">-</span> update</pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token punctuation">-</span> delete</pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"certificates.k8s.io"</span></pre></td></tr><tr><td data-num="139"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"certificatesigningrequests"</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"certificatesigningrequests/approval"</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"certificatesigningrequests/status"</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  <span class="token punctuation">-</span> update</pre></td></tr><tr><td data-num="145"></td><td><pre>  <span class="token punctuation">-</span> create</pre></td></tr><tr><td data-num="146"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="147"></td><td><pre>  <span class="token punctuation">-</span> delete</pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token punctuation">-</span> operator.min.io</pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="152"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="153"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="155"></td><td><pre>  <span class="token punctuation">-</span> min.io</pre></td></tr><tr><td data-num="156"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="157"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="164"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="165"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="170"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="173"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="174"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</pre></td></tr><tr><td data-num="177"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="178"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="183"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="184"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="186"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="189"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="190"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="192"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="193"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="195"></td><td><pre>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="196"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="197"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>operator</pre></td></tr><tr><td data-num="198"></td><td><pre>          <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/k8s<span class="token punctuation">-</span>operator<span class="token punctuation">:</span>2.0.6</pre></td></tr><tr><td data-num="199"></td><td><pre>          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="200"></td><td><pre>          <span class="token comment"># To specify cluster domain, un comment the following:</span></pre></td></tr><tr><td data-num="201"></td><td><pre>          <span class="token comment"># env:</span></pre></td></tr><tr><td data-num="202"></td><td><pre>          <span class="token comment">#   - name: CLUSTER_DOMAIN</span></pre></td></tr><tr><td data-num="203"></td><td><pre>          <span class="token comment">#     value: mycluster.mydomain</span></pre></td></tr></table></figure><h3 id="direct-csi"><a class="anchor" href="#direct-csi">#</a> direct-csi</h3><p>用来自动生成 pv</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> default.env</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token assign-left variable">DIRECT_CSI_DRIVES</span><span class="token operator">=</span>data  <span class="token comment"># minio 数据存放位置</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token assign-left variable">DIRECT_CSI_DRIVES_DIR</span><span class="token operator">=</span>/mnt/minio  <span class="token comment"># direct-csi 的一些控制组件存放路径</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token assign-left variable">KUBELET_DIR_PATH</span><span class="token operator">=</span>/var/lib/kubelet</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">git</span> clone https://github.com/minio/direct-csi.git</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token builtin class-name">cd</span> direct-csi/</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">git</span> checkout v0.2.1</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token builtin class-name">export</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> default.env<span class="token variable">)</span></span></pre></td></tr></table></figure><h3 id="搭建minio"><a class="anchor" href="#搭建minio">#</a> 搭建 minio</h3><p>vim build_minio.sh</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token shebang important">#!/bin/bash</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>kubectl create ns minio</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>kubectl create secret generic tls-ssl-minio --from-file<span class="token operator">=</span>pki/private.key --from-file<span class="token operator">=</span>pki/public.crt -n minio</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># Create key and crt</span></pre></td></tr><tr><td data-num="8"></td><td><pre>:<span class="token operator">&lt;&lt;</span><span class="token string">block</span></pre></td></tr><tr><td data-num="9"></td><td><pre>rm -rf pki</pre></td></tr><tr><td data-num="10"></td><td><pre>mkdir pki -p</pre></td></tr><tr><td data-num="11"></td><td><pre>openssl genrsa -out pki/private.key 2048</pre></td></tr><tr><td data-num="12"></td><td><pre>sleep 1</pre></td></tr><tr><td data-num="13"></td><td><pre>openssl req -new -x509 -days 3650 -key pki/private.key -out pki/public.crt -subj "/C=US/ST=state/L=location/O=organization/CN=*.minio-hl-svc.minio.svc.cluster.local"</pre></td></tr><tr><td data-num="14"></td><td><pre>sleep 1</pre></td></tr><tr><td data-num="15"></td><td><pre>block</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># Using Direct CSI Driver</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#cat &lt;&lt; EOF > default.env</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">## 这种写法表示一个 minio server 挂载 4 个 volume, 如果想挂载一个 volume 就不要写成这样，直接写成下面的 `data`</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#DIRECT_CSI_DRIVES=data&#123;1...4&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#DIRECT_CSI_DRIVES_DIR=/mnt/minio</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#EOF</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> default.env</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>DIRECT_CSI_DRIVES=data</pre></td></tr><tr><td data-num="25"></td><td><pre>DIRECT_CSI_DRIVES_DIR=/mnt/minio</pre></td></tr><tr><td data-num="26"></td><td><pre>EOF</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token builtin class-name">export</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> default.env<span class="token variable">)</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>kubectl apply -k direct-csi</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">sleep</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># Create Operator Deployment</span></pre></td></tr><tr><td data-num="33"></td><td><pre>kubectl apply -f minio-operator.yaml -n minio</pre></td></tr><tr><td data-num="34"></td><td><pre>kubectl apply -f minioinstance.yaml -n minio</pre></td></tr></table></figure><h3 id="nodeport-minioyaml"><a class="anchor" href="#nodeport-minioyaml">#</a> nodePort-minio.yaml</h3><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>service<span class="token punctuation">-</span>nodeport</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30007</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> minio</pre></td></tr></table></figure><h3 id="clean"><a class="anchor" href="#clean">#</a> clean</h3><p>vim <span class="exturl" data-url="aHR0cDovL2NsZWFuLnNo">clean.sh</span></p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token shebang important">#!/bin/bash</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># delete minio pod</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kubectl delete -f minioinstance.yaml -n minio</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># delete pvc</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">pvc_results</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pvc -n minio <span class="token operator">|</span> <span class="token function">grep</span> minio <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print <span class="token variable">$1</span>&#125;'</span><span class="token variable">)</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">pvc_arr</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$&#123;pvc_results&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>$&#123;#pvc_arr[<span class="token operator">*</span>]&#125;<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">))</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">do</span></pre></td></tr><tr><td data-num="11"></td><td><pre>kubectl delete pvc <span class="token variable">$&#123;pvc_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>&#125;</span> -n minio</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">done</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># delete pv</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">pv_results</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get <span class="token function">pv</span> <span class="token operator">|</span> <span class="token function">grep</span> minio <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print <span class="token variable">$1</span>&#125;'</span><span class="token variable">)</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token assign-left variable">pv_arr</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$&#123;pv_results&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>$&#123;#pv_arr[<span class="token operator">*</span>]&#125;<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">))</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">do</span></pre></td></tr><tr><td data-num="19"></td><td><pre>kubectl delete <span class="token function">pv</span> <span class="token variable">$&#123;pv_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">done</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># delete minio operator</span></pre></td></tr><tr><td data-num="23"></td><td><pre>kubectl delete -f minio-operator.yaml -n minio</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># delete minio sc</span></pre></td></tr><tr><td data-num="26"></td><td><pre>kubectl delete -k direct-csi</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 登陆到每台机器删除 direct-csi 插件</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token function">rm</span> -rf /var/lib/kubelet/plugins/direct-*</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">rm</span> -rf /var/lib/kubelet/plugins_registry/direct.csi.min.io-reg.sock</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># delete secret</span></pre></td></tr><tr><td data-num="33"></td><td><pre>kubectl delete secret tls-ssl-minio -n minio</pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># delete ns</span></pre></td></tr><tr><td data-num="36"></td><td><pre>kubectl delete ns minio</pre></td></tr></table></figure><h3 id="清理direct-csi-host上文件"><a class="anchor" href="#清理direct-csi-host上文件">#</a> 清理 direct-csi Host 上文件</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">rm</span> -rf /var/lib/kubelet/plugins/direct-csi-*</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">rm</span> -rf /var/lib/kubelet/plugins_registry/direct.csi.min.io-reg.sock</pre></td></tr></table></figure><h2 id="mc实例"><a class="anchor" href="#mc实例">#</a> mc 实例</h2><h3 id="加密minio数据"><a class="anchor" href="#加密minio数据">#</a> 加密 minio 数据</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 minio host 列表</span></pre></td></tr><tr><td data-num="2"></td><td><pre>./mc config <span class="token function">host</span> list</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 本地创建 minio 服务地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre>./mc <span class="token builtin class-name">alias</span> <span class="token builtin class-name">set</span> hceminio https://10.239.140.73:30007 hceminio hceminio123 --insecure</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 上传数据加密</span></pre></td></tr><tr><td data-num="8"></td><td><pre>./mc mb hceminio/test01 --insecure</pre></td></tr><tr><td data-num="9"></td><td><pre>./mc encrypt <span class="token builtin class-name">set</span> sse-s3 hceminio/test01 --insecure</pre></td></tr><tr><td data-num="10"></td><td><pre>./mc encrypt info hceminio/test01 --insecure</pre></td></tr><tr><td data-num="11"></td><td><pre>./mc <span class="token function">cp</span> k8s.jpg hceminio/test01 --insecure</pre></td></tr><tr><td data-num="12"></td><td><pre>./mc <span class="token function">stat</span> hceminio/test01/k8s.jpg --insecure</pre></td></tr></table></figure><h3 id="查看key"><a class="anchor" href="#查看key">#</a> 查看 key</h3><p>Reference Link: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pbmlvL21jL2Jsb2IvbWFzdGVyL2RvY3MvbWluaW8tYWRtaW4tY29tcGxldGUtZ3VpZGUubWQ=">https://github.com/minio/mc/blob/master/docs/minio-admin-complete-guide.md</span><br>Display status information for the default master key.</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>./mc admin kms key status hceminio --insecure</pre></td></tr><tr><td data-num="2"></td><td><pre>  Key: minio-key-1</pre></td></tr><tr><td data-num="3"></td><td><pre>     - Encryption ✔</pre></td></tr><tr><td data-num="4"></td><td><pre>     - Decryption ✔</pre></td></tr><tr><td data-num="5"></td><td><pre>./mc admin kms key status hceminio minio-key-1 --insecure</pre></td></tr><tr><td data-num="6"></td><td><pre>  Key: minio-key-1</pre></td></tr><tr><td data-num="7"></td><td><pre>           • Encryption ✔</pre></td></tr><tr><td data-num="8"></td><td><pre>           • Decryption ✔</pre></td></tr></table></figure><h3 id="查看minio日志"><a class="anchor" href="#查看minio日志">#</a> 查看 minio 日志</h3><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>./mc admin console hceminio --insecure</pre></td></tr></table></figure><div class="tags"><a href="/tags/storage/" rel="tag"><i class="ic i-tag"></i> storage</a></div></div><footer><div class="meta"></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Kung-Fu-Master 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Kung-Fu-Master 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Kung-Fu-Master 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Kung-Fu-Master <i class="ic i-at"><em>@</em></i>Hexo</li><li class="link"><strong>本文链接：</strong> <a href="https://kung-fu-master.github.io/2021/05/31/storage/minio/minIO_06_KMS_k8s/" title="06 Deploy Vault, Consul, KES, MinIO on kubernetes">https://kung-fu-master.github.io/2021/05/31/storage/minio/minIO_06_KMS_k8s/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/05/31/technologies/bigdata/kafka_nifi/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipetfk5zwj20zk0m8e81.jpg" title="kafka nifi"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> bigdata</span><h3>kafka nifi</h3></a></div><div class="item right"><a href="/2021/05/31/technologies/security/openssl_certificates/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeu7txpzj20zk0m81kx.jpg" title="openssl certificates"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> security</span><h3>openssl certificates</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#总览"><span class="toc-number">1.</span> <span class="toc-text"># 总览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#referenc-link"><span class="toc-number">2.</span> <span class="toc-text"># referenc link</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#概念"><span class="toc-number">3.</span> <span class="toc-text"># 概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#download"><span class="toc-number">4.</span> <span class="toc-text"># Download</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vault"><span class="toc-number">4.1.</span> <span class="toc-text"># Vault:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kes"><span class="toc-number">4.2.</span> <span class="toc-text"># KES:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#minio"><span class="toc-number">4.3.</span> <span class="toc-text"># MinIO：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mc"><span class="toc-number">4.4.</span> <span class="toc-text"># mc:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#机器配置"><span class="toc-number">5.</span> <span class="toc-text"># 机器配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生成证书"><span class="toc-number">6.</span> <span class="toc-text"># 生成证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#根证书"><span class="toc-number">6.1.</span> <span class="toc-text"># 根证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vault证书"><span class="toc-number">6.2.</span> <span class="toc-text"># vault 证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kesminio证书"><span class="toc-number">6.3.</span> <span class="toc-text"># KES&#x2F;minio 证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kmsvault"><span class="toc-number">7.</span> <span class="toc-text"># KMS(Vault)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署consul"><span class="toc-number">7.1.</span> <span class="toc-text"># 部署 consul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署vault"><span class="toc-number">7.2.</span> <span class="toc-text"># 部署 vault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pv-consulyaml"><span class="toc-number">7.3.</span> <span class="toc-text"># pv-consul.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vault-nodeportyaml"><span class="toc-number">7.4.</span> <span class="toc-text"># vault-nodeport.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#valuesyaml"><span class="toc-number">7.5.</span> <span class="toc-text"># values.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consul-valuesyaml"><span class="toc-number">7.6.</span> <span class="toc-text"># consul-values.yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kes-2"><span class="toc-number">8.</span> <span class="toc-text"># KES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">8.1.</span> <span class="toc-text"># 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kes-configyaml"><span class="toc-number">8.2.</span> <span class="toc-text"># kes-config.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建kes-image"><span class="toc-number">8.3.</span> <span class="toc-text"># 构建 KES image</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署kes"><span class="toc-number">8.4.</span> <span class="toc-text"># 部署 KES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile"><span class="toc-number">8.5.</span> <span class="toc-text"># Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kes-k8syaml"><span class="toc-number">8.6.</span> <span class="toc-text"># kes-k8s.yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#minio-2"><span class="toc-number">9.</span> <span class="toc-text"># MinIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#磁盘分区"><span class="toc-number">9.1.</span> <span class="toc-text"># 磁盘分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mount磁盘"><span class="toc-number">9.2.</span> <span class="toc-text"># mount 磁盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mkdir_minio_nodesh"><span class="toc-number">9.3.</span> <span class="toc-text"># mkdir_minio_node.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#minioinstanceyaml"><span class="toc-number">9.4.</span> <span class="toc-text"># minioinstance.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#minio-operatoryaml"><span class="toc-number">9.5.</span> <span class="toc-text"># minio-operator.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#direct-csi"><span class="toc-number">9.6.</span> <span class="toc-text"># direct-csi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建minio"><span class="toc-number">9.7.</span> <span class="toc-text"># 搭建 minio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nodeport-minioyaml"><span class="toc-number">9.8.</span> <span class="toc-text"># nodePort-minio.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clean"><span class="toc-number">9.9.</span> <span class="toc-text"># clean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#清理direct-csi-host上文件"><span class="toc-number">9.10.</span> <span class="toc-text"># 清理 direct-csi Host 上文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mc实例"><span class="toc-number">10.</span> <span class="toc-text"># mc 实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#加密minio数据"><span class="toc-number">10.1.</span> <span class="toc-text"># 加密 minio 数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看key"><span class="toc-number">10.2.</span> <span class="toc-text"># 查看 key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看minio日志"><span class="toc-number">10.3.</span> <span class="toc-text"># 查看 minio 日志</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/03/13/storage/minio/minIO_01_conception/" rel="bookmark" title="MinIO 01 conception">MinIO 01 conception</a></li><li><a href="/2021/03/13/storage/minio/minIO_04_client_SDK/" rel="bookmark" title="MinIO 04 client SDK">MinIO 04 client SDK</a></li><li><a href="/2021/03/13/storage/minio/minIO_03_client.md/" rel="bookmark" title="MinIO 03 client">MinIO 03 client</a></li><li><a href="/2021/03/15/storage/minio/minIO_05_KMS/" rel="bookmark" title="05 Deploy MinIO with KMS(vault)">05 Deploy MinIO with KMS(vault)</a></li><li><a href="/2021/05/31/storage/minio/minIO_02_deployment_on_kubernetes/" rel="bookmark" title="MinIO 02 deployment on kubernetes">MinIO 02 deployment on kubernetes</a></li><li class="active"><a href="/2021/05/31/storage/minio/minIO_06_KMS_k8s/" rel="bookmark" title="06 Deploy Vault, Consul, KES, MinIO on kubernetes">06 Deploy Vault, Consul, KES, MinIO on kubernetes</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Kung-Fu-Master" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Kung-Fu-Master</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">311</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">42</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="https:&#x2F;&#x2F;github.com&#x2F;yourname"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/05/31/technologies/bigdata/kafka_nifi/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/05/31/technologies/security/openssl_certificates/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2021/03/13/linux/yum%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" title="yum 遇到的问题">yum 遇到的问题</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/technologies/" title="分类于 technologies">technologies</a> <i class="ic i-angle-right"></i> <a href="/categories/technologies/security/" title="分类于 security">security</a></div><span><a href="/2021/03/21/technologies/security/kms_vault/" title="KMS vault">KMS vault</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/reference/" title="分类于 reference">reference</a> <i class="ic i-angle-right"></i> <a href="/categories/reference/k8s/" title="分类于 k8s">k8s</a></div><span><a href="/2021/03/13/reference/k8s/43.Kubernetes%E9%BB%98%E8%AE%A4%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8E%E6%8A%A2%E5%8D%A0%E6%9C%BA%E5%88%B6/" title="43 | Kubernetes默认调度器的优先级与抢占机制">43 | Kubernetes默认调度器的优先级与抢占机制</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/reference/" title="分类于 reference">reference</a> <i class="ic i-angle-right"></i> <a href="/categories/reference/k8s/" title="分类于 k8s">k8s</a></div><span><a href="/2021/03/13/reference/k8s/52.%E7%AD%94%E7%96%91%EF%BC%9A%E5%9C%A8%E9%97%AE%E9%A2%98%E4%B8%AD%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%EF%BC%8C%E5%9C%A8%E6%80%9D%E8%80%83%E4%B8%AD%E4%BA%A7%E7%94%9F%E6%80%9D%E8%80%83/" title="52 | 答疑：在问题中解决问题，在思考中产生思考">52 | 答疑：在问题中解决问题，在思考中产生思考</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/MLearning/" title="分类于 MLearning">MLearning</a> <i class="ic i-angle-right"></i> <a href="/categories/MLearning/numpy/" title="分类于 numpy">numpy</a></div><span><a href="/2021/03/13/MLearning/numpy/numpy/" title="numpy 基本操作">numpy 基本操作</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/entertainment/" title="分类于 entertainment">entertainment</a></div><span><a href="/2021/03/13/entertainment/entertainment/" title="entertainment">entertainment</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/blogs/" title="分类于 blogs">blogs</a> <i class="ic i-angle-right"></i> <a href="/categories/blogs/blog%E6%90%AD%E5%BB%BA/" title="分类于 blog搭建">blog搭建</a></div><span><a href="/2021/03/13/blogs/blog%E6%90%AD%E5%BB%BA/Hexo_02_git_clone_blog%E5%90%8E%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8C/" title="Hexo 02 git clone blog后如何运行">Hexo 02 git clone blog后如何运行</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/microService/" title="分类于 microService">microService</a> <i class="ic i-angle-right"></i> <a href="/categories/microService/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/2021/03/13/microService/kubernetes/k8s_port_forward/" title="使用端口转发(Port Forwarding)来访问集群中的应用">使用端口转发(Port Forwarding)来访问集群中的应用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/blogs/" title="分类于 blogs">blogs</a> <i class="ic i-angle-right"></i> <a href="/categories/blogs/blogs/" title="分类于 blogs">blogs</a></div><span><a href="/2021/03/13/blogs/blogs/windows%E9%9F%B3%E7%AE%B1%E6%89%BE%E4%B8%8D%E5%88%B0/" title="windows音箱找不到, 没有声音">windows音箱找不到, 没有声音</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/reference/" title="分类于 reference">reference</a> <i class="ic i-angle-right"></i> <a href="/categories/reference/k8s/" title="分类于 k8s">k8s</a></div><span><a href="/2021/03/13/reference/k8s/35.%E8%A7%A3%E8%AF%BBKubernetes%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88/" title="35 | 解读Kubernetes三层网络方案">35 | 解读Kubernetes三层网络方案</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Kung-Fu-Master @ Kung Fu Master</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.2m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">18:13</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/05/31/storage/minio/minIO_06_KMS_k8s/",favicon:{show:"（●´3｀●）",hide:"（●´3｀●）"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->