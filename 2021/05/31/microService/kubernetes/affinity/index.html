<!-- build time:Wed Jun 09 2021 20:03:42 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Hexo" href="https://kung-fu-master.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Hexo" href="https://kung-fu-master.github.io/atom.xml"><link rel="alternate" type="application/json" title="Hexo" href="https://kung-fu-master.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="k8s"><link rel="canonical" href="https://kung-fu-master.github.io/2021/05/31/microService/kubernetes/affinity/"><title>affinity - kubernetes - microService | Kung Fu Master = Hexo</title><meta name="generator" content="Hexo 4.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">affinity</h1><div class="meta"><span class="item" title="创建时间：2021-05-31 11:28:46"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-05-31T11:28:46+08:00">2021-05-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>6.2k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>6 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Kung Fu Master</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciukx8a7j20zk0m8aio.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclx6phq6j20zk0m8e36.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclhpw3lwj20zk0m8gvw.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclj61ylzj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicitcxhpij20zk0m8hdt.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/microService/" itemprop="item" rel="index" title="分类于 microService"><span itemprop="name">microService</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/microService/kubernetes/" itemprop="item" rel="index" title="分类于 kubernetes"><span itemprop="name">kubernetes</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://kung-fu-master.github.io/2021/05/31/microService/kubernetes/affinity/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Kung-Fu-Master"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><div class="body md" itemprop="articleBody"><h2 id="attach-a-label-to-the-node"><a class="anchor" href="#attach-a-label-to-the-node">#</a> Attach a label to the node</h2><p>Add a label to the node you've chosen</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl label nodes <span class="token operator">&lt;</span>node-name<span class="token operator">></span> <span class="token operator">&lt;</span>label-key<span class="token operator">></span><span class="token operator">=</span><span class="token operator">&lt;</span>label-value<span class="token operator">></span></pre></td></tr></table></figure><p>Check the node now has a label you set.</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl get nodes --show-labels</pre></td></tr></table></figure><h2 id="nodeselector"><a class="anchor" href="#nodeselector">#</a> nodeSelector</h2><p>Take whatever pod config file you want to run, and add a nodeSelector section to it.</p><p>cat pod-nginx.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">env</span><span class="token punctuation">:</span> test</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">kubernetes.io/hostname</span><span class="token punctuation">:</span> laboratory</pre></td></tr></table></figure><h2 id="affinity-and-anti-affinity"><a class="anchor" href="#affinity-and-anti-affinity">#</a> Affinity and anti-affinity</h2><h3 id="node-affinity"><a class="anchor" href="#node-affinity">#</a> Node affinity</h3><p>Node affinity is conceptually similar to <span class="blue">nodeSelector</span> -- it allows you to constrain which nodes your pod is eligible to be scheduled on, based on labels on the node.</p><p>There are currently two types of node affinity, called:</p><ul><li>requiredDuringSchedulingIgnoredDuringExecution</li><li>preferredDuringSchedulingIgnoredDuringExecution</li></ul><p>You can think of them as <span class="blue">&quot;hard&quot;</span> and <span class="blue">&quot;soft&quot;</span> respectively, in the sense that the former specifies rules that must be met for a pod to be scheduled onto a node (similar to <span class="blue">nodeSelector</span> but using a more expressive syntax), while the latter specifies preferences that the scheduler will try to enforce but will not guarantee. The <span class="blue">&quot;IgnoredDuringExecution&quot;</span> part of the names means that, similar to how <span class="blue">nodeSelector</span> works, if labels on a node change at runtime such that the affinity rules on a pod are no longer met, the pod continues to run on the node. In the future we plan to offer <span class="blue">requiredDuringSchedulingRequiredDuringExecution</span> which will be identical to <span class="blue">requiredDuringSchedulingIgnoredDuringExecution</span> except that it will evict pods from nodes that cease to satisfy the pods' node affinity requirements.</p><p>Thus an example of <span class="red">requiredDuringSchedulingIgnoredDuringExecution</span> would be &quot;only run the pod on nodes with Intel CPUs&quot; and an example <span class="red">preferredDuringSchedulingIgnoredDuringExecution</span> would be &quot;try to run this set of pods in failure zone XYZ, but if it's not possible, then allow some to run elsewhere&quot;.</p><p>Node affinity is specified as field <span class="red">nodeAffinity</span> of field <span class="red">affinity</span> in the PodSpec.</p><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/e2e<span class="token punctuation">-</span>az<span class="token punctuation">-</span>name</pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">-</span> e2e<span class="token punctuation">-</span>az1</pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">-</span> e2e<span class="token punctuation">-</span>az2</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">preference</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>key</pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">-</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>value</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/pause<span class="token punctuation">:</span><span class="token number">2.0</span></pre></td></tr></table></figure><p>This node affinity rule says the pod can only be placed on a node with a label whose key is <span class="red"><span class="exturl" data-url="aHR0cDovL2t1YmVybmV0ZXMuaW8vZTJlLWF6LW5hbWU=">kubernetes.io/e2e-az-name</span></span> and whose value is either <span class="red">e2e-az1</span> or <span class="red">e2e-az2</span>. In addition, among nodes that meet that criteria, nodes with a label whose key is <span class="red">another-node-label-key</span> and whose value is <span class="red">another-node-label-value</span> should be preferred.</p><p>You can see the operator In being used in the example. The new node affinity syntax supports the following operators: <span class="red">In</span>, <span class="red">NotIn</span>, <span class="red">Exists</span>, <span class="red">DoesNotExist</span>, <span class="red">Gt</span>, <span class="red">Lt</span>. You can use <span class="red">NotIn</span> and <span class="red">DoesNotExist</span> to achieve node anti-affinity behavior, or use node taints to repel pods from specific nodes.</p><ol><li><p>If you specify both <span class="red">nodeSelector</span> and <span class="red">nodeAffinity</span>, both must be satisfied for the pod to be scheduled onto a candidate node.</p></li><li><p>If you specify multiple <span class="red">nodeSelectorTerms</span> associated with <span class="red">nodeAffinity</span> types, then the pod can be scheduled onto a node if one of the <span class="red">nodeSelectorTerms</span> can be satisfied.</p></li><li><p>If you specify multiple <span class="red">matchExpressions</span> associated with <span class="red">nodeSelectorTerms</span>, then the pod can be scheduled onto a node only if all <span class="red">matchExpressions</span> is satisfied.</p></li><li><p>If you remove or change the label of the node where the pod is scheduled, the pod won't be removed. In other words, the affinity selection works only at the time of scheduling the pod.</p></li></ol><p>The <span class="red">weight</span> field in <span class="red">preferredDuringSchedulingIgnoredDuringExecution</span> is in the range <span class="red">1-100</span>. For each node that meets all of the scheduling requirements (resource request, RequiredDuringScheduling affinity expressions, etc.), the scheduler will compute a sum by iterating through the elements of this field and adding &quot;weight&quot; to the sum if the node matches the corresponding MatchExpressions. This score is then combined with the scores of other priority functions for the node. The node(s) with the highest total score are the most preferred.</p><h3 id="pod-affinity"><a class="anchor" href="#pod-affinity">#</a> Pod affinity</h3><p>Pod 间亲和性与反亲和性需要大量的处理，这可能会显著减慢大规模集群中的调度。 我们不建议在超过数百个节点的集群中使用它们.</p><p>Inter-pod affinity and anti-affinity allow you to constrain which nodes your pod is eligible to be scheduled based on labels on pods that are already running on the node rather than based on labels on nodes. The rules are of the form &quot;this pod should (or, in the case of anti-affinity, should not) run in an X if that X is already running one or more pods that meet rule Y&quot;. Y is expressed as a LabelSelector with an optional associated list of namespaces; unlike nodes, because pods are namespaced (and therefore the labels on pods are implicitly namespaced), a label selector over pod labels must specify which namespaces the selector should apply to. Conceptually X is a topology domain like node, rack, cloud provider zone, cloud provider region, etc. You express it using a topologyKey which is the key for the node label that the system uses to denote such a topology domain.</p><p>As with node affinity, there are currently two types of pod affinity and anti-affinity, called requiredDuringSchedulingIgnoredDuringExecution and preferredDuringSchedulingIgnoredDuringExecution which denote &quot;hard&quot; vs. &quot;soft&quot; requirements. See the description in the node affinity section earlier. An example of requiredDuringSchedulingIgnoredDuringExecution affinity would be &quot;co-locate the pods of service A and service B in the same zone, since they communicate a lot with each other&quot; and an example preferredDuringSchedulingIgnoredDuringExecution anti-affinity would be &quot;spread the pods from this service across zones&quot; (a hard requirement wouldn't make sense, since you probably have more pods than zones).</p><p>cat redis.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cache</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> store</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> store</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app</pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">-</span> store</pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/hostname"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>3.2<span class="token punctuation">-</span>alpine</pre></td></tr></table></figure><p>cat web-server.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>store</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>store</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app</pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">-</span> web<span class="token punctuation">-</span>store</pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/hostname"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app</pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token key atrule">values</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">-</span> store</pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/hostname"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>app</pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16<span class="token punctuation">-</span>alpine</pre></td></tr></table></figure><div class="tags"><a href="/tags/k8s/" rel="tag"><i class="ic i-tag"></i> k8s</a></div></div><footer><div class="meta"></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Kung-Fu-Master 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Kung-Fu-Master 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Kung-Fu-Master 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Kung-Fu-Master <i class="ic i-at"><em>@</em></i>Hexo</li><li class="link"><strong>本文链接：</strong> <a href="https://kung-fu-master.github.io/2021/05/31/microService/kubernetes/affinity/" title="affinity">https://kung-fu-master.github.io/2021/05/31/microService/kubernetes/affinity/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/05/31/microService/kubernetes/delete_pod_pv_pvc%E7%AD%89%E8%B5%84%E6%BA%90/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipey0a334j20zk0m8qpt.jpg" title="删除crd,pod,pv,pvc等资源"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> kubernetes</span><h3>删除crd,pod,pv,pvc等资源</h3></a></div><div class="item right"><a href="/2021/05/31/microService/kubernetes/k8s_cert_manager/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevuctzzj20zk0m84qp.jpg" title="k8s cert manager"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> kubernetes</span><h3>k8s cert manager</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#attach-a-label-to-the-node"><span class="toc-number">1.</span> <span class="toc-text"># Attach a label to the node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodeselector"><span class="toc-number">2.</span> <span class="toc-text"># nodeSelector</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#affinity-and-anti-affinity"><span class="toc-number">3.</span> <span class="toc-text"># Affinity and anti-affinity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#node-affinity"><span class="toc-number">3.1.</span> <span class="toc-text"># Node affinity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod-affinity"><span class="toc-number">3.2.</span> <span class="toc-text"># Pod affinity</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/03/13/microService/kubernetes/02_kubernetes_roles_introduction/" rel="bookmark" title="02 kubernetes introduction">02 kubernetes introduction</a></li><li><a href="/2021/03/13/microService/kubernetes/01_etcd_high_availablity/" rel="bookmark" title="01 部署external etcd集群">01 部署external etcd集群</a></li><li><a href="/2021/03/13/microService/kubernetes/01_kubernetes%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E5%92%8C%E9%85%8D%E7%BD%AE%E6%9D%A1%E4%BB%B6/" rel="bookmark" title="01 Kubernetes安装方式和配置条件">01 Kubernetes安装方式和配置条件</a></li><li><a href="/2021/03/13/microService/kubernetes/05_kubernetes_volume/" rel="bookmark" title="05 Kubernetes volumes">05 Kubernetes volumes</a></li><li><a href="/2021/03/13/microService/kubernetes/07_kubernetes_Etcd/" rel="bookmark" title="07 Kubernetes Etcd">07 Kubernetes Etcd</a></li><li><a href="/2021/03/13/microService/kubernetes/04_kubernetes_service/" rel="bookmark" title="04 Kubernetes service">04 Kubernetes service</a></li><li><a href="/2021/03/13/microService/kubernetes/03_kubernetes_ns_pod/" rel="bookmark" title="03 Kubernetes nodes, namespace, pod">03 Kubernetes nodes, namespace, pod</a></li><li><a href="/2021/03/13/microService/kubernetes/06_kubernetes_deployment/" rel="bookmark" title="06 Kubernetes deployment">06 Kubernetes deployment</a></li><li><a href="/2021/03/13/microService/kubernetes/08_kubernetes_samples_problems/" rel="bookmark" title="08 Kubernetes samples and problems">08 Kubernetes samples and problems</a></li><li><a href="/2021/03/13/microService/kubernetes/09_kubernetes_certificate/" rel="bookmark" title="09 Kubernetes Certificates">09 Kubernetes Certificates</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_command_args_entrypoint_cmd%E5%8C%BA%E5%88%AB/" rel="bookmark" title="k8s command, args, entrypoint, cmd 区别">k8s command, args, entrypoint, cmd 区别</a></li><li><a href="/2021/03/13/microService/kubernetes/10_kubernetes_plugin/" rel="bookmark" title="10 Kubernetes plugin">10 Kubernetes plugin</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_port_forward/" rel="bookmark" title="使用端口转发(Port Forwarding)来访问集群中的应用">使用端口转发(Port Forwarding)来访问集群中的应用</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_configmap/" rel="bookmark" title="k8s configmap">k8s configmap</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_%E5%AF%B9%E8%B1%A1%E5%90%8D%E7%A7%B0%E5%92%8CIDs/" rel="bookmark" title="k8s_对象名称和IDs">k8s_对象名称和IDs</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_resources%E5%92%8C%E9%A9%B1%E9%80%90%E7%AD%96%E7%95%A5/" rel="bookmark" title="k8s resources和驱逐策略">k8s resources和驱逐策略</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_node%E8%8A%82%E7%82%B9reset%E5%90%8E%E9%87%8D%E6%96%B0%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4/" rel="bookmark" title="k8s node 节点reset后重新加入集群">k8s node 节点reset后重新加入集群</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s_secret/" rel="bookmark" title="k8s secret">k8s secret</a></li><li><a href="/2021/03/13/microService/kubernetes/kubernetes_%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6/" rel="bookmark" title="kubernetes 准入控制">kubernetes 准入控制</a></li><li><a href="/2021/03/13/microService/kubernetes/kubernetes_upgrade/" rel="bookmark" title="kubernetes upgrade">kubernetes upgrade</a></li><li><a href="/2021/03/13/microService/kubernetes/metrics-server,kubernetes-dashboard/" rel="bookmark" title="Metrics-Server, Kubernetes-Dashboard">Metrics-Server, Kubernetes-Dashboard</a></li><li><a href="/2021/03/13/microService/kubernetes/k8s%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8pod%E7%AD%89%E8%B5%84%E6%BA%90/" rel="bookmark" title="k8s重新启动pod等资源">k8s重新启动pod等资源</a></li><li><a href="/2021/03/21/linux/%E5%88%A0%E9%99%A4crd,pod,pv,pvc%E7%AD%89%E8%B5%84%E6%BA%90/" rel="bookmark" title="删除crd,pod,pv,pvc等资源">删除crd,pod,pv,pvc等资源</a></li><li><a href="/2021/05/31/microService/kubernetes/01_kubernetes_build/" rel="bookmark" title="01 Kubernetes build with kubeadm">01 Kubernetes build with kubeadm</a></li><li><a href="/2021/05/31/microService/kubernetes/01_kubernetes_high_availablity_build/" rel="bookmark" title="01 Kubernetes build high availability">01 Kubernetes build high availability</a></li><li><a href="/2021/05/31/microService/kubernetes/k8s_cert_manager/" rel="bookmark" title="k8s cert manager">k8s cert manager</a></li><li class="active"><a href="/2021/05/31/microService/kubernetes/affinity/" rel="bookmark" title="affinity">affinity</a></li><li><a href="/2021/05/31/microService/kubernetes/delete_pod_pv_pvc%E7%AD%89%E8%B5%84%E6%BA%90/" rel="bookmark" title="删除crd,pod,pv,pvc等资源">删除crd,pod,pv,pvc等资源</a></li><li><a href="/2021/05/31/microService/kubernetes/k8s_commands/" rel="bookmark" title="k8s操作命令">k8s操作命令</a></li><li><a href="/2021/05/31/microService/kubernetes/k8s_encounter_problem/" rel="bookmark" title="k8s部署遇到的问题">k8s部署遇到的问题</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Kung-Fu-Master" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Kung-Fu-Master</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">317</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">42</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="https:&#x2F;&#x2F;github.com&#x2F;yourname"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/05/31/microService/kubernetes/delete_pod_pv_pvc%E7%AD%89%E8%B5%84%E6%BA%90/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/05/31/microService/kubernetes/k8s_cert_manager/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/technologies/" title="分类于 technologies">technologies</a> <i class="ic i-angle-right"></i> <a href="/categories/technologies/web%E5%89%8D%E7%AB%AF/" title="分类于 web前端">web前端</a></div><span><a href="/2021/03/13/technologies/web/HTML/" title="HTML">HTML</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/blogs/" title="分类于 blogs">blogs</a> <i class="ic i-angle-right"></i> <a href="/categories/blogs/blog%E6%90%AD%E5%BB%BA/" title="分类于 blog搭建">blog搭建</a></div><span><a href="/2021/03/13/blogs/blog%E6%90%AD%E5%BB%BA/hexo%E9%83%A8%E7%BD%B2%E5%8D%9A%E5%AE%A2%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" title="Hexo部署博客遇到的问题">Hexo部署博客遇到的问题</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2021/03/13/linux/RHEL8.0%E5%BC%80%E6%9C%BA%E6%80%BB%E6%98%AF%E8%A6%81dhclient%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96IP/" title="RHEL8.0开机总是要dhclient手动获取IP">RHEL8.0开机总是要dhclient手动获取IP</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2021/03/13/linux/python%E5%AE%89%E8%A3%85/" title="python 安装">python 安装</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2021/03/13/linux/curl_wget/" title="curl &amp; wget">curl & wget</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2021/05/31/linux/%E7%A3%81%E7%9B%98%E5%88%86%E5%8C%BA_mount/" title="磁盘分区fdisk, parted, mount操作">磁盘分区fdisk, parted, mount操作</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux/" title="分类于 linux">linux</a></div><span><a href="/2021/03/13/linux/rpm_yum/" title="RPM, yum">RPM, yum</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/entertainment/" title="分类于 entertainment">entertainment</a></div><span><a href="/2021/03/13/entertainment/test/" title="test">test</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/microService/" title="分类于 microService">microService</a> <i class="ic i-angle-right"></i> <a href="/categories/microService/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/2021/03/13/microService/kubernetes/kubernetes_upgrade/" title="kubernetes upgrade">kubernetes upgrade</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/technologies/" title="分类于 technologies">technologies</a> <i class="ic i-angle-right"></i> <a href="/categories/technologies/docker/" title="分类于 docker">docker</a></div><span><a href="/2021/05/31/technologies/docker/docker_01_installation/" title="docker 01 installation and control commands">docker 01 installation and control commands</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Kung-Fu-Master @ Kung Fu Master</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.2m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">18:23</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/05/31/microService/kubernetes/affinity/",favicon:{show:"（●´3｀●）",hide:"（●´3｀●）"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->